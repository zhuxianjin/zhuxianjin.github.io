<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="基于 AST（抽象语法树）解 PHP 混淆"><meta name="keywords" content="PHP,AST,混淆"><meta name="author" content="J0k3r"><meta name="copyright" content="J0k3r"><title>基于 AST（抽象语法树）解 PHP 混淆 | J0k3r's Blog</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?9e8a6ba1f41c0d7b000fcfd73f1c7929";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-159554347-1', 'auto');
ga('send', 'pageview');</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-php-parser"><span class="toc-number">1.</span> <span class="toc-text">0x01 php-parser</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-解混淆-（Deobfuscate）"><span class="toc-number">2.</span> <span class="toc-text">0x02 解混淆 （Deobfuscate）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#解变量名"><span class="toc-number">2.1.</span> <span class="toc-text">解变量名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解-unserialize-base64-decode-混淆"><span class="toc-number">2.2.</span> <span class="toc-text">解 unserialize + base64_decode 混淆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解-GLOBALS-键名混淆"><span class="toc-number">2.3.</span> <span class="toc-text">解 GLOBALS 键名混淆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#计算数字表达式"><span class="toc-number">2.4.</span> <span class="toc-text">计算数字表达式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解-chr-函数混淆"><span class="toc-number">2.5.</span> <span class="toc-text">解 chr 函数混淆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解字符拼接混淆"><span class="toc-number">2.6.</span> <span class="toc-text">解字符拼接混淆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解-str-rot13-函数混淆"><span class="toc-number">2.7.</span> <span class="toc-text">解 str_rot13 函数混淆</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解-call-user-func-array-函数混淆"><span class="toc-number">2.8.</span> <span class="toc-text">解 call_user_func_array 函数混淆</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">3.</span> <span class="toc-text">Reference</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">J0k3r</div><div class="author-info__description text-center">求知若饥，虚心若愚</div><div class="follow-button"><a href="https://github.com/zhuxianjin">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">46</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">44</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友链</div><a class="author-info-links__name text-center" href="https://p0sec.net/">p0神</a><a class="author-info-links__name text-center" href="http://seaii-blog.com/">seaii</a><a class="author-info-links__name text-center" href="http://0sec.com.cn/">everglow</a><a class="author-info-links__name text-center" href="http://mengsec.com/">MengChen</a><a class="author-info-links__name text-center" href="http://windylh.com/">Windylh</a><a class="author-info-links__name text-center" href="http://p0desta.com/">p0desta</a><a class="author-info-links__name text-center" href="http://lanvnal.com/">LANVNAL</a><a class="author-info-links__name text-center" href="http://syf.ac.cn/">7N1ght</a><a class="author-info-links__name text-center" href="http://wzt.ac.cn/">WCatalpa.T</a><a class="author-info-links__name text-center" href="https://daolgts.github.io/">daolgts</a><a class="author-info-links__name text-center" href="https://qingchenldl.github.io">V0W</a><a class="author-info-links__name text-center" href="https://fancyking.ml/">fancyking</a><a class="author-info-links__name text-center" href="http://asa9ao.xyz/">Asa9ao</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/wallhaven-j5k275.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">J0k3r's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">主页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/links/">友链</a><a class="site-page" href="/kindle/">kindle 读书</a><a class="site-page" href="/about/">关于我</a></span></div><div id="post-info"><div id="post-title">基于 AST（抽象语法树）解 PHP 混淆</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-03-24</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>以前段时间 XCTF 抗疫赛中的 hardphp 为例，该题目最终只有一只战队解出，题目作者 zsx 也在随后的文章中点了下解混淆的思路，不过在各 writeup 中没有找到有关解混淆的完整的代码，于是学习一下通过修改 AST 节点解混淆的方法</p>
<a id="more"></a>
<h2 id="0x01-php-parser"><a href="#0x01-php-parser" class="headerlink" title="0x01 php-parser"></a>0x01 php-parser</h2><p>php-parser 是一个 PHP 库，可以将 PHP 5 或 PHP 7 代码解析为抽象语法树（AST）</p>
<p><a href="https://github.com/nikic/php-parser/releases" target="_blank" rel="noopener">https://github.com/nikic/php-parser/releases</a></p>
<p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer require nikic/php-parser</span><br></pre></td></tr></table></figure>
<p>安装好之后就可以直接引用了， <code>require dirname(__FILE__).&#39;/vendor/autoload.php&#39;;</code> </p>
<p>官方文档中有说 XDebug 容易使 php-parser 的运行速度慢五倍以上，最好还是禁用吧</p>
<p>解析代码时首先创建一个解析器 ( parser instance )</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">ParserFactory</span>;</span><br><span class="line">$parser = (<span class="keyword">new</span> ParserFactory)-&gt;create(ParserFactory::PREFER_PHP7);</span><br></pre></td></tr></table></figure>
<p>使用 PREFER_PHP7 优先解析 PHP7 代码</p>
<p>使用 ParserFactory 的 parse 方法解析代码，得到一个 statement 节点数组，语法错误可以通过 <code>PhpParser\Error</code> 来捕获</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Error</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">ParserFactory</span>;</span><br><span class="line"><span class="keyword">require</span> dirname(<span class="keyword">__FILE__</span>).<span class="string">'/vendor/autoload.php'</span>;</span><br><span class="line">$code = <span class="string">&lt;&lt;&lt;'CODE'</span></span><br><span class="line"><span class="string">&lt;?php</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo 'Hello PHP';</span></span><br><span class="line"><span class="string">CODE;</span></span><br><span class="line"></span><br><span class="line">$parser = (<span class="keyword">new</span> ParserFactory)-&gt;create(ParserFactory::PREFER_PHP7);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $stmts = $parser-&gt;parse($code);</span><br><span class="line">    var_dump($stmts);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Error $e) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'Parse Error: '</span>, $e-&gt;getMessage();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到 statement 节点数组如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">array</span>(<span class="number">1</span>) &#123;</span><br><span class="line">  [<span class="number">0</span>]=&gt;</span><br><span class="line">  object(PhpParser\Node\Stmt\Echo_)<span class="comment">#1100 (2) &#123;</span></span><br><span class="line">    [<span class="string">"exprs"</span>]=&gt;</span><br><span class="line">    <span class="keyword">array</span>(<span class="number">1</span>) &#123;</span><br><span class="line">      [<span class="number">0</span>]=&gt;</span><br><span class="line">      object(PhpParser\Node\Scalar\String_)<span class="comment">#1099 (2) &#123;</span></span><br><span class="line">        [<span class="string">"value"</span>]=&gt;</span><br><span class="line">        string(<span class="number">9</span>) <span class="string">"Hello PHP"</span></span><br><span class="line">        [<span class="string">"attributes"</span>:<span class="keyword">protected</span>]=&gt;</span><br><span class="line">        <span class="keyword">array</span>(<span class="number">3</span>) &#123;</span><br><span class="line">          [<span class="string">"startLine"</span>]=&gt;</span><br><span class="line">          int(<span class="number">3</span>)</span><br><span class="line">          [<span class="string">"endLine"</span>]=&gt;</span><br><span class="line">          int(<span class="number">3</span>)</span><br><span class="line">          [<span class="string">"kind"</span>]=&gt;</span><br><span class="line">          int(<span class="number">1</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="string">"attributes"</span>:<span class="keyword">protected</span>]=&gt;</span><br><span class="line">    <span class="keyword">array</span>(<span class="number">2</span>) &#123;</span><br><span class="line">      [<span class="string">"startLine"</span>]=&gt;</span><br><span class="line">      int(<span class="number">3</span>)</span><br><span class="line">      [<span class="string">"endLine"</span>]=&gt;</span><br><span class="line">      int(<span class="number">3</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 NodeDumper 跟直观得查看 AST </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">NodeDumper</span>;</span><br><span class="line"></span><br><span class="line">$nodeDumper = <span class="keyword">new</span> NodeDumper;</span><br><span class="line"><span class="keyword">echo</span> $nodeDumper-&gt;dump($stmts), <span class="string">"\n"</span>;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">array</span>(</span><br><span class="line">    <span class="number">0</span>: Stmt_Echo(</span><br><span class="line">        exprs: <span class="keyword">array</span>(</span><br><span class="line">            <span class="number">0</span>: Scalar_String(</span><br><span class="line">                value: Hello PHP</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>通过 AST 可以方便查看或者修改代码中的某些值，比如通过 <code>($stmts[0]-&gt;exprs)[0]-&gt;value = &#39;Hello Word&#39;;</code>即可修改 Hello PHP 为  Hello Word。但是这是在代码结构已知的情况下做的修改，效率并不高，php-parser 提供了一种用于遍历和访问节点树的组件 <code>PhpParser\NodeTraverser</code></p>
<p>例如下面代码就可以将原本代码中的 <code>echo &#39;Hello PHP&#39;;</code> 换成 <code>print &#39;Hello Word&#39;;</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Error</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">ParserFactory</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">NodeDumper</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">NodeTraverser</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">NodeVisitorAbstract</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">PrettyPrinter</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> dirname(<span class="keyword">__FILE__</span>).<span class="string">'/vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line">$code = <span class="string">&lt;&lt;&lt;'CODE'</span></span><br><span class="line"><span class="string">&lt;?php</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo 'Hello PHP';</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">CODE;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyNodeVisitor</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leaveNode</span><span class="params">(Node $node)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($node <span class="keyword">instanceof</span> Node\Scalar\String_) &#123;</span><br><span class="line">            $node-&gt;value = <span class="string">'Hello Word'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintNodeVisitor</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leaveNode</span><span class="params">(Node $node)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($node <span class="keyword">instanceof</span> Node\Stmt\Echo_) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PhpParser\Node\Stmt\Expression( <span class="keyword">new</span> Node\Expr\Print_(<span class="keyword">new</span> Node\Scalar\String_(($node-&gt;exprs)[<span class="number">0</span>]-&gt;value)) );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$parser = (<span class="keyword">new</span> ParserFactory)-&gt;create(ParserFactory::PREFER_PHP7);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $stmts = $parser-&gt;parse($code);</span><br><span class="line">    $traverser = <span class="keyword">new</span> NodeTraverser;</span><br><span class="line">    <span class="comment">// 添加 node visitors</span></span><br><span class="line">    $traverser-&gt;addVisitor(<span class="keyword">new</span> MyNodeVisitor);</span><br><span class="line">    $traverser-&gt;addVisitor(<span class="keyword">new</span> PrintNodeVisitor);</span><br><span class="line">    <span class="comment">// 遍历 AST</span></span><br><span class="line">    $new_stmts = $traverser-&gt;traverse($stmts);</span><br><span class="line">    <span class="comment">// 将 AST 转为 PHP 代码</span></span><br><span class="line">    $prettyPrinter = <span class="keyword">new</span> PrettyPrinter\Standard;</span><br><span class="line">    $new_code = $prettyPrinter-&gt;prettyPrintFile($new_stmts);</span><br><span class="line">    <span class="keyword">echo</span> $code.PHP_EOL;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"--After parser:--\n\n"</span>.$new_code;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (Error $e) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'Parse Error: '</span>, $e-&gt;getMessage();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/php-Deobfuscator.assets/image-20200321215310182.png" alt></p>
<h2 id="0x02-解混淆-（Deobfuscate）"><a href="#0x02-解混淆-（Deobfuscate）" class="headerlink" title="0x02 解混淆 （Deobfuscate）"></a>0x02 解混淆 （Deobfuscate）</h2><p>熟悉 php-parser 对 AST 节点的操作就可以解混淆了</p>
<p>比如这个 index.php，可以看出混淆后的基本代码格式为</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/php-Deobfuscator.assets/image-20200324013546190.png" alt></p>
<p>unserialize + base64_decode 的方式赋值给 GLOBALS 数组，后面全都是基于 GLOBALS 数组的取值、运算和嵌套操作</p>
<p>思路也很简单，就是首先获取  <code>$GLOBALS = unserialize(base64_decode(&quot;xxxx&quot;))</code> 模式的 PHP 代码得到的变量（数组），后面在发现调用该数组值时进行替换，然后运算表达式，将得到的字符串进行拼接，换一下变量名。</p>
<h3 id="解变量名"><a href="#解变量名" class="headerlink" title="解变量名"></a>解变量名</h3><p>通过正则判断变量名，然后替换节点为新变量名即可</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 变量重命名</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">reNameVar</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $varCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> $varReName = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leaveNode</span><span class="params">(Node $node)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($node <span class="keyword">instanceof</span> Node\Expr\Variable) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!preg_match(<span class="string">'/^[a-zA-Z0-9_]+$/'</span>, $node-&gt;name)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (in_array($node-&gt;name, array_keys(<span class="keyword">$this</span>-&gt;varReName)))&#123;</span><br><span class="line">                    $new_var_name = str_replace($node-&gt;name, <span class="string">'var_'</span> . <span class="keyword">$this</span>-&gt;varReName[$node-&gt;name], $node-&gt;name);</span><br><span class="line">                    <span class="keyword">return</span> (<span class="keyword">new</span> Node\Expr\Variable($new_var_name));    </span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;varReName[$node-&gt;name] = <span class="keyword">$this</span>-&gt;varCount++;</span><br><span class="line">                    $new_var_name = str_replace($node-&gt;name, <span class="string">'var_'</span> . <span class="keyword">$this</span>-&gt;varReName[$node-&gt;name], $node-&gt;name);</span><br><span class="line">                    <span class="keyword">return</span> (<span class="keyword">new</span> Node\Expr\Variable($new_var_name));    </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="解-unserialize-base64-decode-混淆"><a href="#解-unserialize-base64-decode-混淆" class="headerlink" title="解 unserialize + base64_decode 混淆"></a>解 unserialize + base64_decode 混淆</h3><p>在作者 zsx 的 <a href="https://blog.zsxsoft.com/post/42" target="_blank" rel="noopener">开发简单的PHP混淆器与解混淆器</a> 这篇文章中有一个简单的 demo，不过要改下，直接拿来是不行的，后面数组的值会获取不到，因为这里有两次 unserialize + base64_decode 混淆，而且后面是   <code>(&#39;unserialize&#39;)((&#39;base64_decode&#39;)(&#39;xxx&#39;)</code>  这种代码形式，还要控制获取 GLOBALS 数组内容为 NULL 时的返回结果，所以要加这两个判断</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArrayToConstant</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $_variableName = <span class="string">''</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $_constants = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">enterNode</span><span class="params">(Node $node)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 判断 unserialize(base64_decode('xxx'))</span></span><br><span class="line">        <span class="keyword">if</span> ($node <span class="keyword">instanceof</span> Node\Expr\Assign &amp;&amp;</span><br><span class="line">            $node-&gt;expr <span class="keyword">instanceof</span> Node\Expr\FuncCall &amp;&amp;</span><br><span class="line">            $node-&gt;expr-&gt;name <span class="keyword">instanceof</span> Node\Name &amp;&amp;</span><br><span class="line">            is_string($node-&gt;expr-&gt;name-&gt;parts[<span class="number">0</span>]) &amp;&amp;</span><br><span class="line">            $node-&gt;expr-&gt;name-&gt;parts[<span class="number">0</span>] == <span class="string">'unserialize'</span> &amp;&amp;</span><br><span class="line">            count($node-&gt;expr-&gt;args) === <span class="number">1</span> &amp;&amp;</span><br><span class="line">            $node-&gt;expr-&gt;args[<span class="number">0</span>] <span class="keyword">instanceof</span> Node\Arg &amp;&amp;</span><br><span class="line">            $node-&gt;expr-&gt;args[<span class="number">0</span>]-&gt;value <span class="keyword">instanceof</span> Node\Expr\FuncCall &amp;&amp;</span><br><span class="line">            $node-&gt;expr-&gt;args[<span class="number">0</span>]-&gt;value-&gt;name <span class="keyword">instanceof</span> Node\Name &amp;&amp;</span><br><span class="line">            is_string($node-&gt;expr-&gt;args[<span class="number">0</span>]-&gt;value-&gt;name-&gt;parts[<span class="number">0</span>]) &amp;&amp;</span><br><span class="line">            $node-&gt;expr-&gt;args[<span class="number">0</span>]-&gt;value-&gt;name-&gt;parts[<span class="number">0</span>] == <span class="string">'base64_decode'</span></span><br><span class="line">        ) &#123;</span><br><span class="line">            $string = $node-&gt;expr-&gt;args[<span class="number">0</span>]-&gt;value-&gt;args[<span class="number">0</span>]-&gt;value-&gt;value;</span><br><span class="line">            $array = unserialize(base64_decode($string));</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_variableName = $node-&gt;var-&gt;name;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;_constants = $array;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Node\Expr\Assign($node-&gt;var, Node\Scalar\LNumber::fromString(<span class="string">"0"</span>));</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>( <span class="comment">// 判断 ('unserialize')(('base64_decode')('xxx') </span></span><br><span class="line">                $node <span class="keyword">instanceof</span> Node\Expr\Assign &amp;&amp;</span><br><span class="line">                $node-&gt;expr <span class="keyword">instanceof</span> Node\Expr\FuncCall &amp;&amp;</span><br><span class="line">                $node-&gt;expr-&gt;name <span class="keyword">instanceof</span> Node\Scalar\String_ &amp;&amp;</span><br><span class="line">                is_string($node-&gt;expr-&gt;name-&gt;value) &amp;&amp;</span><br><span class="line">                $node-&gt;expr-&gt;name-&gt;value == <span class="string">'unserialize'</span> &amp;&amp;</span><br><span class="line">                count($node-&gt;expr-&gt;args) === <span class="number">1</span> &amp;&amp;</span><br><span class="line">                $node-&gt;expr-&gt;args[<span class="number">0</span>] <span class="keyword">instanceof</span> Node\Arg &amp;&amp;</span><br><span class="line">                $node-&gt;expr-&gt;args[<span class="number">0</span>]-&gt;value <span class="keyword">instanceof</span> Node\Expr\FuncCall &amp;&amp;</span><br><span class="line">                $node-&gt;expr-&gt;args[<span class="number">0</span>]-&gt;value-&gt;name <span class="keyword">instanceof</span> Node\Scalar\String_ &amp;&amp;</span><br><span class="line">                is_string($node-&gt;expr-&gt;args[<span class="number">0</span>]-&gt;value-&gt;name-&gt;value) &amp;&amp; </span><br><span class="line">                $node-&gt;expr-&gt;args[<span class="number">0</span>]-&gt;value-&gt;name-&gt;value == <span class="string">'base64_decode'</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    $string = $node-&gt;expr-&gt;args[<span class="number">0</span>]-&gt;value-&gt;args[<span class="number">0</span>]-&gt;value-&gt;value;</span><br><span class="line">                    $array = unserialize(base64_decode($string));</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;_variableName = $node-&gt;var-&gt;name;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;_constants = $array;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Node\Expr\Assign($node-&gt;var, Node\Scalar\LNumber::fromString(<span class="string">"0"</span>));</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leaveNode</span><span class="params">(Node $node)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;_variableName === <span class="string">''</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            $node <span class="keyword">instanceof</span> Node\Expr\ArrayDimFetch &amp;&amp;</span><br><span class="line">            $node-&gt;var-&gt;name === <span class="keyword">$this</span>-&gt;_variableName</span><br><span class="line">        ) &#123;</span><br><span class="line">            $val = <span class="keyword">$this</span>-&gt;_constants[$node-&gt;dim-&gt;value];</span><br><span class="line">            <span class="keyword">if</span> ($val === <span class="keyword">null</span>)&#123;  <span class="comment">// 判断该 GLOBALS 值是否存在</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (is_string($val)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Node\Scalar\String_($val);</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (is_double($val)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Node\Scalar\DNumber($val);</span><br><span class="line">            &#125; <span class="keyword">elseif</span> (is_int($val)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Node\Scalar\LNumber($val);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Node\Expr\ConstFetch(<span class="keyword">new</span> Node\Name\FullyQualified(json_encode($val)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="解-GLOBALS-键名混淆"><a href="#解-GLOBALS-键名混淆" class="headerlink" title="解 GLOBALS 键名混淆"></a>解 GLOBALS 键名混淆</h3><p>这个其实不是很必要，对逻辑没啥影响，不过看起来会工整些</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GLOBALS 键值重命名</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">reNameArr</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计数</span></span><br><span class="line">    <span class="keyword">private</span> $arrCount = [];</span><br><span class="line">    <span class="comment">// 替换数组</span></span><br><span class="line">    <span class="keyword">private</span> $arrReName = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leaveNode</span><span class="params">(Node $node)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( $node <span class="keyword">instanceof</span> Node\Expr\ArrayDimFetch &amp;&amp; !($node-&gt;var <span class="keyword">instanceof</span> Node\Expr\ArrayDimFetch) &amp;&amp; !($node-&gt;dim <span class="keyword">instanceof</span> Node\Expr\ArrayDimFetch) ) &#123;</span><br><span class="line">            $key = $node-&gt;dim-&gt;value;</span><br><span class="line">            $arrName = $node-&gt;var-&gt;name;</span><br><span class="line">            <span class="keyword">if</span> (!preg_match(<span class="string">'/^[a-zA-Z0-9_]+$/'</span>, $key)) &#123;</span><br><span class="line">                <span class="comment">// 计数数组有改数组名记录</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;arrCount[$arrName] !== <span class="keyword">null</span>)&#123;</span><br><span class="line">                    <span class="comment">// 判断该数组当前键值</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;arrReName[$arrName][$key]  !== <span class="keyword">null</span>)&#123;</span><br><span class="line">                        $new_key_name = str_replace($key, <span class="string">'key_'</span> . <span class="keyword">$this</span>-&gt;arrReName[$arrName][$key], $key);</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> Node\Expr\ArrayDimFetch( <span class="keyword">new</span> Node\Expr\Variable($arrName), <span class="keyword">new</span> Node\Scalar\String_($new_key_name) );</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123; <span class="comment">// 未替换该键值的操作</span></span><br><span class="line">                        <span class="keyword">$this</span>-&gt;arrReName[$arrName][$key] = <span class="keyword">$this</span>-&gt;arrCount[$arrName]++;</span><br><span class="line">                        $new_key_name = str_replace($key, <span class="string">'key_'</span> . <span class="keyword">$this</span>-&gt;arrReName[$arrName][$key], $key);</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> Node\Expr\ArrayDimFetch( <span class="keyword">new</span> Node\Expr\Variable($arrName), <span class="keyword">new</span> Node\Scalar\String_($new_key_name) );</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123; <span class="comment">// 未记录该数组</span></span><br><span class="line">                    <span class="comment">// 创建</span></span><br><span class="line">                    <span class="keyword">$this</span>-&gt;arrReName[$arrName] = [];</span><br><span class="line">                    <span class="comment">// 该数组计数</span></span><br><span class="line">                    <span class="keyword">$this</span>-&gt;arrCount[$arrName] = <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;arrReName[$arrName][$key] = <span class="keyword">$this</span>-&gt;arrCount[$arrName]++;</span><br><span class="line">                    $new_key_name = str_replace($key, <span class="string">'key_'</span> . <span class="keyword">$this</span>-&gt;arrReName[$arrName][$key], $key);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Node\Expr\ArrayDimFetch( <span class="keyword">new</span> Node\Expr\Variable($arrName), <span class="keyword">new</span> Node\Scalar\String_($new_key_name) );</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="计算数字表达式"><a href="#计算数字表达式" class="headerlink" title="计算数字表达式"></a>计算数字表达式</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 计算表达式</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExpressionToNumber</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leaveNode</span><span class="params">(Node $node)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($node <span class="keyword">instanceof</span> Node\Expr\BinaryOp\Plus &amp;&amp;</span><br><span class="line">            ($node-&gt;left <span class="keyword">instanceof</span> Node\Scalar\LNumber || $node-&gt;left <span class="keyword">instanceof</span> Node\Scalar\String_ || $node-&gt;left <span class="keyword">instanceof</span> Node\Expr\UnaryMinus) &amp;&amp; $node-&gt;right <span class="keyword">instanceof</span> Node\Expr\BinaryOp\Minus &amp;&amp; ($node-&gt;right-&gt;left <span class="keyword">instanceof</span> Node\Scalar\LNumber || $node-&gt;right-&gt;left <span class="keyword">instanceof</span> Node\Scalar\String_) &amp;&amp; ($node-&gt;right-&gt;right <span class="keyword">instanceof</span> Node\Scalar\LNumber || $node-&gt;right-&gt;right <span class="keyword">instanceof</span> Node\Scalar\String_)) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> ($node-&gt;left <span class="keyword">instanceof</span> Node\Expr\UnaryMinus) &#123;</span><br><span class="line">                $a = -($node-&gt;left-&gt;expr-&gt;value);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    $a = $node-&gt;left-&gt;value;</span><br><span class="line">            &#125;</span><br><span class="line">            $b = $node-&gt;right-&gt;left-&gt;value;</span><br><span class="line">            $c = $node-&gt;right-&gt;right-&gt;value;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Node\Scalar\LNumber($a + $b - $c);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时通过再次使用 ArrayToConstant 遍历一下各节点就可以很好的去掉 unserialize + base64_decode 和 GLOBALS 混淆了</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/php-Deobfuscator.assets/image-20200324023908673.png" alt="image-20200324023908673"></p>
<h3 id="解-chr-函数混淆"><a href="#解-chr-函数混淆" class="headerlink" title="解 chr 函数混淆"></a>解 chr 函数混淆</h3><p>遍历 AST 找到  <code>(chr)(101)</code> 这类节点使用 chr 函数获取字符串值然后替换该节点</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解 chr 函数混淆</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">chr2Str</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leaveNode</span><span class="params">(Node $node)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($node <span class="keyword">instanceof</span> Node\Expr\FuncCall &amp;&amp;</span><br><span class="line">            is_string($node-&gt;name-&gt;value) &amp;&amp;</span><br><span class="line">            $node-&gt;name-&gt;value == <span class="string">'chr'</span> &amp;&amp;</span><br><span class="line">            count($node-&gt;args) === <span class="number">1</span> &amp;&amp;</span><br><span class="line">            $node-&gt;args[<span class="number">0</span>] <span class="keyword">instanceof</span> Node\Arg &amp;&amp;</span><br><span class="line">            $node-&gt;args[<span class="number">0</span>]-&gt;value <span class="keyword">instanceof</span> Node\Scalar\LNumber</span><br><span class="line">        )&#123;</span><br><span class="line">            $the_num = $node-&gt;args[<span class="number">0</span>]-&gt;value-&gt;value;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Node\Scalar\String_(chr($the_num));</span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时再计算一次数字表达式然后去 chr 函数，看看效果</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/php-Deobfuscator.assets/image-20200324024355732.png" alt="image-20200324024355732"></p>
<h3 id="解字符拼接混淆"><a href="#解字符拼接混淆" class="headerlink" title="解字符拼接混淆"></a>解字符拼接混淆</h3><p>找到 concat 节点，拼接左右的字符串</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解字符拼接混淆</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">concat2Str</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leaveNode</span><span class="params">(Node $node)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($node <span class="keyword">instanceof</span> Node\Expr\BinaryOp\Concat)&#123;</span><br><span class="line">            <span class="keyword">if</span> ($node-&gt;left <span class="keyword">instanceof</span> Node\Scalar\String_ &amp;&amp; </span><br><span class="line">                is_string($node-&gt;left-&gt;value) &amp;&amp;</span><br><span class="line">                $node-&gt;right <span class="keyword">instanceof</span> Node\Scalar\String_ &amp;&amp;</span><br><span class="line">                is_string($node-&gt;right-&gt;value) </span><br><span class="line">                )&#123;</span><br><span class="line">                <span class="keyword">return</span>  <span class="keyword">new</span> Node\Scalar\String_($node-&gt;left-&gt;value . $node-&gt;right-&gt;value);    </span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/php-Deobfuscator.assets/image-20200324024553982.png" alt="image-20200324024553982"></p>
<h3 id="解-str-rot13-函数混淆"><a href="#解-str-rot13-函数混淆" class="headerlink" title="解 str_rot13 函数混淆"></a>解 str_rot13 函数混淆</h3><p>和上面解 chr 函数混淆差不多</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解 str_rot13 函数混淆</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">rot13Decoder</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leaveNode</span><span class="params">(Node $node)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( $node <span class="keyword">instanceof</span>  Node\Expr\FuncCall &amp;&amp;</span><br><span class="line">            $node-&gt;name <span class="keyword">instanceof</span> Node\Scalar\String_ &amp;&amp;</span><br><span class="line">            is_string( $node-&gt;name-&gt;value ) &amp;&amp;</span><br><span class="line">            $node-&gt;name-&gt;value == <span class="string">'str_rot13'</span> &amp;&amp;</span><br><span class="line">            count( $node-&gt;args ) === <span class="number">1</span> &amp;&amp;</span><br><span class="line">            $node-&gt;args[<span class="number">0</span>] <span class="keyword">instanceof</span> Node\Arg &amp;&amp;</span><br><span class="line">            $node-&gt;args[<span class="number">0</span>]-&gt;value <span class="keyword">instanceof</span> Node\Scalar\String_ &amp;&amp;</span><br><span class="line">            is_string($node-&gt;args[<span class="number">0</span>]-&gt;value-&gt;value)</span><br><span class="line">            )&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Node\Scalar\String_(str_rot13($node-&gt;args[<span class="number">0</span>]-&gt;value-&gt;value));</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="解-call-user-func-array-函数混淆"><a href="#解-call-user-func-array-函数混淆" class="headerlink" title="解 call_user_func_array 函数混淆"></a>解 call_user_func_array 函数混淆</h3><p>最后如果觉得 <code>(&#39;call_user_func_array&#39;)(&#39;call_user_func_array&#39;, $var_1)</code> 这种样子不太直观也可以替换一下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">callUserFuncDecoder</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leaveNode</span> <span class="params">(Node $node)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ( $node <span class="keyword">instanceof</span>  Node\Expr\FuncCall &amp;&amp;</span><br><span class="line">        $node-&gt;name <span class="keyword">instanceof</span> Node\Scalar\String_ &amp;&amp;</span><br><span class="line">        is_string( $node-&gt;name-&gt;value ) &amp;&amp;</span><br><span class="line">        $node-&gt;name-&gt;value == <span class="string">'call_user_func_array'</span> &amp;&amp;</span><br><span class="line">        count( $node-&gt;args ) === <span class="number">2</span> &amp;&amp;</span><br><span class="line">        $node-&gt;args[<span class="number">0</span>] <span class="keyword">instanceof</span> Node\Arg &amp;&amp;</span><br><span class="line">        $node-&gt;args[<span class="number">1</span>] <span class="keyword">instanceof</span> Node\Arg &amp;&amp;</span><br><span class="line">        $node-&gt;args[<span class="number">0</span>]-&gt;value <span class="keyword">instanceof</span> Node\Scalar\String_ &amp;&amp;</span><br><span class="line">        is_string($node-&gt;args[<span class="number">0</span>]-&gt;value-&gt;value) &amp;&amp;</span><br><span class="line">        $node-&gt;args[<span class="number">0</span>]-&gt;value-&gt;value == <span class="string">'call_user_func_array'</span></span><br><span class="line">        )&#123;</span><br><span class="line">            $varName = $node-&gt;args[<span class="number">1</span>]-&gt;value-&gt;name;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Node\Expr\FuncCall(<span class="keyword">new</span> Node\Name(<span class="string">'call_user_func_array'</span>),[<span class="keyword">new</span> Node\Scalar\String_(<span class="string">'call_user_func_array'</span>), <span class="keyword">new</span> Node\Expr\Variable($varName)]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时已经基本没啥阅读障碍了</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/php-Deobfuscator.assets/image-20200324024953338.png" alt="image-20200324024953338"></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://blog.zsxsoft.com/post/42" target="_blank" rel="noopener">https://blog.zsxsoft.com/post/42</a></p>
<p><a href="https://github.com/nikic/PHP-Parser/blob/master/doc" target="_blank" rel="noopener">https://github.com/nikic/PHP-Parser/blob/master/doc</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">J0k3r</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://j0k3r.top/2020/03/24/php-Deobfuscator/">http://j0k3r.top/2020/03/24/php-Deobfuscator/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://j0k3r.top">J0k3r's Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PHP/">PHP</a><a class="post-meta__tags" href="/tags/AST/">AST</a><a class="post-meta__tags" href="/tags/混淆/">混淆</a></div><div class="social-share"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/08/11/java-jndi-inject/"><i class="fa fa-chevron-left">  </i><span>Java JNDI 注入原理与高 JDK 版本绕过</span></a></div><div class="next-post pull-right"><a href="/2020/03/12/GYCTF-2020-WriteUp/"><span>高校战“疫”网络安全分享赛 Web Partial WriteUp</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'true' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'yeOeLCiDRMa7CAnJy2jxA2IY-gzGzoHsz',
  appKey:'eAgtubAYTMshS76hpc1F1UBG',
  placeholder:'Just go go',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/wallhaven-j5k275.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2021 By J0k3r</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/assets/katou_01.model.json"},"display":{"superSample":2,"width":300,"height":600,"position":"left","hOffset":-20,"vOffset":-80},"log":false,"tagMode":false});</script></body></html>